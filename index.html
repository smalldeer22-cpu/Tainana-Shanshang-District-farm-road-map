<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>è‡ºå—å¸‚å±±ä¸Šå€å…¬çœ¾é€šè¡Œé“è·¯åœ–è³‡ (v.0208V2)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<style>
  /* === 1. å…¨å±€è¨­å®š === */
  :root {
    --primary-color: #004080; /* æ·±è— */
    --accent-color: #ff9800;  /* æ©˜é»ƒ */
    --bg-light: #f8faff;
    --text-dark: #333;
    --sidebar-width: 350px;
    
    /* é…è‰²è®Šæ•¸ */
    --popup-bg: #f2fcf5;
    --popup-border: #d1fae5;
    --popup-text-main: #064e3b; 
    --popup-text-sub: #059669;  
    --popup-accent: #10b981;    
  }
  
  /* å¼·åˆ¶é–å®šè¦–çª—ï¼Œé˜²æ­¢ç‰ˆé¢æº¢å‡º */
  html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: var(--bg-light); color: var(--text-dark); }

  /* === 2. ä½ˆå±€å®¹å™¨ === */
  #container { display: flex; width: 100%; height: 100%; position: relative; overflow: hidden; }
  
  /* å´é‚Šæ¬„ (ä¿®æ­£ Z-Index å•é¡Œï¼Œç¢ºä¿æ‰‹æ©Ÿç‰ˆå¯é»æ“Šï¼Œè¨­ç‚º 2001 é«˜æ–¼é®ç½©å±¤) */
  #sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-width);
    background: #fff;
    box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    z-index: 2001; 
    transition: margin-left 0.3s ease;
    position: relative;
    height: 100%;
  }
  
  /* æ¼¢å ¡æŒ‰éˆ•æ§åˆ¶ (Desktop) */
  body.collapsed #sidebar { margin-left: calc(var(--sidebar-width) * -1); }
  
  /* åœ°åœ–å€ */
  #map { flex-grow: 1; height: 100%; position: relative; z-index: 1; width: calc(100% - var(--sidebar-width)); transition: width 0.3s ease; }
  body.collapsed #map { width: 100%; }

  /* æ‡¸æµ®æ¼¢å ¡æŒ‰éˆ• */
  #toggleSidebarBtn {
    position: absolute; top: 10px; left: 360px; width: 40px; height: 40px;
    background: #fff; color: var(--text-dark); border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;
    cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: left 0.3s ease; 
  }
  #toggleSidebarBtn:hover { background: #f4f4f4; }
  body.collapsed #toggleSidebarBtn { left: 10px; }

  /* === 3. å´é‚Šæ¬„å…§å®¹çµ„ä»¶ === */
  .sidebar-header { padding: 15px; background: var(--primary-color); color: white; text-align: center; flex-shrink: 0; }
  .sidebar-header h3 { margin: 0; font-size: 16px; font-weight: bold; line-height: 1.4; }
  
  /* åˆ†é ç±¤æ¨£å¼ */
  .tabs-nav { display: flex; background: #eef2f6; padding: 5px 5px 0 5px; flex-shrink: 0; overflow-x: auto; }
  .tab-btn { flex: 1; padding: 10px 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: bold; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; white-space: nowrap; }
  .tab-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 -2px 5px rgba(0,0,0,0.05); position: relative; top: 1px; }
  
  .tab-content-container { flex: 1; overflow-y: auto; padding: 15px; background: #fff; position: relative; }
  .tab-pane { display: none; animation: fadeIn 0.3s; }
  .tab-pane.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  .sidebar-footer {
      flex-shrink: 0; 
      padding: 10px 15px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      font-size: 11px;
      color: #64748b;
      line-height: 1.6; 
      text-align: center;
      white-space: normal; 
  }

  /* å¡ç‰‡å€å¡Šæ¨£å¼ */
  .card-section { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
  .card-title { font-size: 14px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #f0f0f0; }
  
  /* å¹´åº¦æ‘ºç–Šé¸å–® */
  .year-group { margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
  .year-header { background: #f8fafc; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #475569; user-select: none; }
  .year-header:hover { background: #e2e8f0; }
  .year-content { display: none; padding: 8px 12px; background: #fff; border-top: 1px solid #eee; }
  .year-group.open .year-content { display: block; }
  .year-group.open .toggle-icon { transform: rotate(90deg); }
  .toggle-icon { display:inline-block; transition: transform 0.2s; width:12px; margin-right:5px;}
  .year-select-all { font-size: 12px; color: var(--primary-color); cursor: pointer; }
  .checkbox-item { margin-bottom: 6px; display: flex; align-items: center; gap: 6px; font-size: 13px; }
  .checkbox-item input { margin: 0; accent-color: var(--primary-color); }

  /* V3 Added: å¤šé¸æ‘ºç–Šæ¨£å¼ */
  .multiselect-group { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; background: #fff; }
  .multiselect-header { 
      padding: 10px; cursor: pointer; background: #fff; color: #555; font-size: 14px; 
      display: flex; justify-content: space-between; align-items: center; border-radius: 6px;
      transition: background 0.2s;
  }
  .multiselect-header:hover { background: #f5f5f5; }
  .multiselect-header i { transition: transform 0.2s; font-size: 12px; color: #999; }
  .multiselect-group.open .multiselect-header { background: #f0f7ff; border-radius: 6px 6px 0 0; color: var(--primary-color); font-weight: bold; border-bottom: 1px solid #e0e0e0; }
  .multiselect-group.open .multiselect-header i { transform: rotate(180deg); color: var(--primary-color); }
  .multiselect-content { display: none; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; border-radius: 0 0 6px 6px; }
  .multiselect-group.open .multiselect-content { display: block; }
  .select-all-row { border-bottom: 1px dashed #ddd; padding-bottom: 5px; margin-bottom: 5px; font-weight: bold; color: #004080; }

  select, textarea, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  
  button.primary { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: none; background: var(--primary-color); color: #fff; font-size: 14px; font-weight: bold; }
  button.primary:hover { background: #003366; }
  button.secondary { width: 100%; padding: 8px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #555; font-size: 13px; }
  button.secondary:hover { background: #f5f5f5; }
  button:disabled { background: #ccc !important; cursor: not-allowed; color: #666 !important; }

  /* === ç™»é©ç†±å°ˆç”¨æ¨£å¼ === */
  .dengue-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: #555; }
  .dengue-option input { width: auto; margin: 0; transform: scale(1.2); }
  .gray-dot-marker { width: 14px; height: 14px; background: #7f8c8d; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.4); }

  /* === åœ°åœ–æ§åˆ¶é … === */
  .map-floating-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
  .float-btn { width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; color: #444; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
  .float-btn:hover { background: #f0f0f0; color: var(--primary-color); transform: scale(1.1); }
  .float-btn.active { background: var(--accent-color); color: #000; }
  .float-btn::after { content: attr(data-title); position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .float-btn:hover::after { opacity: 1; }

  /* å®šä½å¥—ä»¶æ¨£å¼è¦†å¯« */
  .leaflet-control-locate { border: none !important; box-shadow: none !important; margin: 0 !important; }
  .leaflet-control-locate a { width: 40px !important; height: 40px !important; border-radius: 50% !important; background: #fff !important; color: #444 !important; font-size: 16px !important; line-height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important; cursor: pointer !important; }
  .leaflet-control-locate a:hover { background: #f0f0f0 !important; color: #004080 !important; transform: scale(1.1); }
  .leaflet-control-locate.active a { color: #2074b6 !important; background: #fff !important; }
  .leaflet-control-locate.following a { color: #e65100 !important; border: 2px solid #e65100 !important; }
  .leaflet-control-locate a .leaflet-control-locate-location-arrow { display: none; }

  /* èšåˆåœ–æ¨™ */
  .marker-cluster-custom { background-color: rgba(46, 204, 113, 0.6); border-radius: 50%; }
  .marker-cluster-custom div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 50%; color: white; font-weight: bold; background-color: rgba(39, 174, 96, 0.9); line-height: 30px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* èšåˆæ§åˆ¶é¢æ¿ */
  #clusterControlPanel {
    position: absolute; bottom: 220px; left: 360px; z-index: 1000;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
    padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    width: 220px; border: 1px solid rgba(255,255,255,0.2);
    display: none; transition: left 0.3s ease;
  }
  body.collapsed #clusterControlPanel { left: 20px; } 

  .cluster-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .cluster-title { font-size:14px; font-weight:bold; color:var(--primary-color); display:flex; align-items:center; gap:6px; }
  .cluster-value-badge { background: var(--accent-color); color:#fff; padding:2px 6px; border-radius:4px; font-size:12px; }
  input[type=range].custom-range { -webkit-appearance: none; width: 100%; background: transparent; }
  input[type=range].custom-range::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  input[type=range].custom-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }

  /* === 6. åº•éƒ¨æ™‚é–“è»¸é¢æ¿ === */
  #bottomPanel { 
      position: absolute; bottom: 0; left: var(--sidebar-width); right: 0; 
      height: 280px; background: rgba(255, 255, 255, 0.98); 
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1); z-index: 1400; 
      display: flex; flex-direction: column; transform: translateY(100%); 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease; 
      border-top: 1px solid #e0e0e0; overflow: hidden; 
  }
  body.collapsed #bottomPanel { left: 0; } 
  #bottomPanel.open { transform: translateY(0); }
  #bottomPanel.minimized { height: auto !important; transform: translateY(0) !important; }
  #bottomPanel.minimized #timelineFilterBar, #bottomPanel.minimized #timelineContainer { display: none !important; }

  #bottomPanelHeader { padding: 8px 20px; min-height: 50px; height: auto; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .header-left { display: flex; flex-direction: column; gap: 2px; justify-content: center; overflow: hidden; }
  #panelTitle { font-size: 15px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #timelineStats { font-size: 13px; color: #ffeb3b; font-weight: normal; opacity: 1; white-space: normal; line-height: 1.5; margin-top: 2px; }
  @media (max-width: 768px) { #timelineStats { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.6; } .stat-divider { display: none; } }
  .header-right { display: flex; gap: 15px; align-items: center; flex-shrink: 0;}
  .control-btn { background:none; border:none; color:#fff; font-size:16px; cursor:pointer; padding: 5px; transition: color 0.2s; }
  .control-btn:hover { color: #ffeb3b; }

  #timelineFilterBar { 
      background: #f1f5f9; padding: 8px 10px; 
      border-bottom: 1px solid #e0e0e0; 
      display: flex; gap: 6px; 
      align-items: center; flex-shrink: 0; 
      height: auto; min-height: 50px; box-sizing: border-box; 
      flex-wrap: nowrap; 
      overflow-x: auto; 
  }
  #timelineFilterBar::-webkit-scrollbar { height: 0px; background: transparent; }
  
  .filter-label { font-size: 12px; color: #333; font-weight: bold; white-space: nowrap; display: flex; align-items: center; gap: 4px; margin-right: 2px; flex-shrink: 0; }
  
  .timeline-select-pill {
      padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 20px; background-color: #fff;
      font-size: 12px; font-weight: bold; color: #334155; cursor: pointer; outline: none; transition: all 0.2s;
      min-width: auto; max-width: 180px; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      background-image: linear-gradient(to bottom, #fff, #f8fafc);
  }
  .timeline-select-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
  .timeline-select-pill:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
  
  #timelineContainer { flex: 1; overflow-x: auto; padding: 15px 20px; display: flex; align-items: flex-start; gap: 0; }
  .h-item { width: 160px; text-align: center; cursor: pointer; position: relative; transition: transform 0.2s; }
  .h-item:hover { transform: translateY(-5px); }
  .h-date { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 8px; }
  .h-line-container { position: relative; height: 24px; display: flex; align-items: center; justify-content: center; }
  .h-line-container::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: #ddd; z-index: 0; }
  .h-item.alert-right .h-line-container::after { content: ''; position: absolute; left: 50%; right: -50%; top: 50%; height: 4px; background: repeating-linear-gradient(45deg, #d32f2f, #d32f2f 5px, #ffcdd2 5px, #ffcdd2 10px); z-index: 0; animation: alertPulse 1.5s infinite; }
  @keyframes alertPulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  .h-dot { background: var(--primary-color); border: 2px solid #fff; border-radius: 50%; z-index: 1; position: relative; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .h-item:hover .h-dot { transform: scale(1.3); background: var(--accent-color); border-color: #fff; }
  .dot-sm { width: 12px; height: 12px; }
  .dot-md { width: 16px; height: 16px; }
  .dot-lg { width: 22px; height: 22px; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.3); }
  .h-badge { margin-top: 8px; display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; position: relative; z-index: 2; }
  .badge-normal { background-color: var(--primary-color); border: 1px solid #fff; }
  .badge-urgent { background-color: #d32f2f; border: 1px solid #fff; }

  /* === 7. å³éµé¸å–® === */
  #contextMenu { display: none; position: fixed; z-index: 5000; background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; min-width: 160px; border: 1px solid #ddd; top: 0; left: 0; }
  .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
  .ctx-item:hover { background: #f5faff; color: var(--primary-color); }
  .ctx-item i { width: 20px; text-align: center; }

  /* === é—œéµä¿®æ”¹ï¼š3æ¬„å¼ Popup CSS (v.0109-3Column) + æ‰‹æ©Ÿç‰ˆå„ªåŒ– === */
  .custom-popup .leaflet-popup-content-wrapper { padding: 0 !important; border-radius: 20px !important; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; border: 2px solid var(--popup-border) !important; background: rgba(242, 252, 245, 0.95) !important; backdrop-filter: blur(5px); }
  .custom-popup .leaflet-popup-content { margin: 0 !important; width: 960px !important; max-width: 90vw !important; }
  .custom-popup .leaflet-popup-tip { background: var(--popup-border) !important; }

  .popup-card { display: flex; flex-direction: row; min-height: 320px; }
  .popup-deco-strip { width: 8px; background: var(--popup-text-sub); flex-shrink: 0; }
  
  /* å·¦æ¬„ï¼šè³‡è¨Šå€ */
  .popup-col-info { width: 280px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid #e0e0e0; flex-shrink: 0; background: rgba(255,255,255,0.6); }
  
  /* ç…§ç‰‡å€ */
  .popup-col-photo { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #e0e0e0; background: #fff; min-width: 0; }
  .popup-col-photo:last-child { border-right: none; }

  /* è³‡è¨Šå…ƒä»¶ */
  /* Remove OLD Status Pill for Desktop, keep for Mobile header if needed */
  .status-pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 900; letter-spacing: 0.5px; color: #fff; align-self: flex-start; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .pill-working { background: #10b981; } .pill-done { background: #64748b; } .pill-urgent { background: #f59e0b; }  
  
  /* å­—é«”æ”¾å¤§å„ªåŒ–å€åŸŸ */
  .case-id { font-size: 26px; font-weight: 900; color: #000; line-height: 1.2; letter-spacing: -0.5px; margin-bottom: 6px; }
  .case-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #3d5a80; margin-bottom: 10px; }
  .file-tag { background: #ecfdf5; padding: 2px 6px; border-radius: 4px; font-family: monospace; letter-spacing: -0.5px; opacity: 0.8; }
  
  /* V0129 æ–°å¢ï¼šå¤šé¡å‹æ¨™ç±¤æ¨£å¼ */
  .type-tag-group { display: inline-flex; gap: 4px; align-items: center; flex-wrap: wrap; }
  .type-pill { background: rgba(16, 185, 129, 0.1); color: var(--popup-text-sub); padding: 2px 6px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
  .type-pill-more { background: #e0f2fe; color: #0284c7; cursor: pointer; font-weight: bold; border-radius: 4px; padding: 2px 6px; font-size: 11px; transition: all 0.2s; }
  .type-pill-more:hover { background: #bae6fd; transform: scale(1.05); }

  .price-block { margin: 10px 0; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
  .price-label { font-size: 10px; color: var(--popup-text-sub); font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
  .price-val { font-size: 30px; font-weight: 900; color: #064e3b; font-style: italic; letter-spacing: -0.5px; line-height: 1.2; }

  .compact-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
  .compact-item { font-size: 13px; line-height: 1.4; color: #334155; }
  .compact-label { font-weight: 900; color: #047857; background: #d1fae5; padding: 2px 6px; border-radius: 4px; font-size: 12px; display: inline-block; margin-bottom: 2px; }
  .compact-val { font-weight: bold; font-size: 15px; color: #1f2937; word-break: break-word; }
  .compact-row { display: flex; gap: 10px; }
  .popup-tags { display: flex; gap: 6px; margin-bottom: 15px; flex-wrap: wrap; }
  .tag-pill { padding: 3px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 4px; }
  .tag-dark { background: var(--popup-text-sub); color: white; }
  .tag-light { background: white; border: 1px solid var(--popup-border); color: var(--popup-text-main); }

  /* ===========================================
     â˜… é—œéµä¿®æ­£ï¼šæ³¡æ³¡çª—æŒ‰éˆ•é…ç½® â˜…
     ===========================================
  */
  /* ğŸ’» é›»è…¦ç‰ˆï¼šå¼·åˆ¶ 2x2 Grid æ’ç‰ˆ */
  .popup-btns.view-desktop { 
      display: grid !important; 
      grid-template-columns: 1fr 1fr; /* å¼·åˆ¶å…©æ¬„ */
      gap: 10px; /* å¢åŠ é–“è· */
      margin-top: auto; 
      padding-top: 10px;
  }
  
  /* ğŸ“± æ‰‹æ©Ÿç‰ˆï¼šå¼·åˆ¶ 1x4 Grid æ’ç‰ˆ (ç”±å·¦è‡³å³å–®è¡Œ) */
  .popup-btns.view-mobile {
      display: grid !important;
      grid-template-columns: repeat(4, 1fr); /* å¼·åˆ¶å››æ¬„ */
      gap: 5px;
      margin-top: 10px;
  }

  .popup-btn-new { 
      background: white; 
      color: #065f46; /* æ·±ç¶ è‰²æ–‡å­— */
      border: 1.5px solid #6ee7b7; /* æ·ºç¶ è‰²é‚Šæ¡† */
      padding: 12px 0; /* å¢åŠ æŒ‰éˆ•é«˜åº¦ */
      border-radius: 30px; /* è† å›Šç‹€åœ“è§’ Pill Shape */
      font-size: 14px; 
      font-weight: bold; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 6px; 
      text-decoration: none; 
      transition: all 0.2s; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
      white-space: nowrap;
  }
  
  /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å¾®èª¿ï¼Œé©æ‡‰ç‹¹çª„ç©ºé–“ */
  .popup-btns.view-mobile .popup-btn-new {
      padding: 8px 0;
      font-size: 12px;
      gap: 4px;
      flex-direction: column; /* ç©ºé–“ä¸è¶³æ™‚ï¼Œåœ–ç¤ºèˆ‡æ–‡å­—å‚ç›´æ’åˆ—ï¼Œè‹¥éœ€æ°´å¹³å¯ç§»é™¤æ­¤è¡Œ */
  }
  .popup-btns.view-mobile .popup-btn-new i {
      font-size: 14px;
      margin-bottom: 2px;
  }
  
  .popup-btn-new:hover { 
      background: #f0fdf4; 
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      border-color: #10b981;
      color: #047857;
  }
  
  .popup-btn-new i { font-size: 16px; }

  /* Reset old styles just in case */
  .btn-full { grid-column: auto; }

  /* 0116V2 Added: Sibling Dot Navigation Style */
  .sibling-nav-container { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; align-items: center; }
  .sibling-nav-container.mobile { justify-content: center; margin-bottom: 5px; margin-top: -2px; }
  .sibling-dot {
      width: 20px; height: 20px; border-radius: 50%;
      background: #fff; border: 1px solid #6f42c1;
      color: #6f42c1; font-size: 10px; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; user-select: none;
  }
  .sibling-dot:hover { background: #f3e5f5; transform: scale(1.1); }
  .sibling-dot.active {
      background: #6f42c1; color: white;
      box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.3);
      cursor: default; transform: scale(1.05);
  }

  /* ç…§ç‰‡è¼ªæ’­ */
  .photo-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .photo-title { font-size: 11px; font-weight: 900; color: var(--popup-text-main); display: flex; align-items: center; gap: 5px; }
  .photo-viewer { flex: 1; position: relative; border-radius: 8px; border: 1px solid var(--popup-border); background: #f1f5f9; overflow: hidden; display: flex; align-items: center; justify-content: center; }
  .photo-viewer img { 
      width: 100%; height: 100%; object-fit: cover; display: none;
      /* V13V5 Added: ç…§ç‰‡é˜²ä¸‹è¼‰ä¿è­· */
      -webkit-user-drag: none;
      user-select: none;
      -webkit-touch-callout: none;
  }
  .photo-viewer img.active { display: block; }
  .photo-viewer .no-photo { color: #666; font-size: 24px; display: flex; flex-direction: column; align-items: center; gap:5px; background: #f0fdf4; width:100%; height:100%; justify-content:center; }
  .photo-viewer .no-photo span { font-size: 10px; font-weight: bold; }
  .carousel-dots { display: flex; justify-content: center; gap: 8px; margin-top: 10px; height: 22px; }
  .dot { width: 22px; height: 22px; border-radius: 50%; background: #e2e8f0; color: #64748b; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; border: 1px solid #cbd5e1; user-select: none; }
  .dot:hover { background: #cbd5e1; }
  .dot.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* === Progress Bar Styles (0206V3-Progress) === */
  .progress-container { 
      display: flex; justify-content: space-between; align-items: center; 
      position: relative; margin: 12px 0 15px 0; padding: 0 5px; /* å¢åŠ é–“è·é¿å…é‡ç–Š */
  }
  .progress-track { position: absolute; top: 12px; left: 10px; right: 10px; height: 4px; background: #e0e0e0; z-index: 0; border-radius: 2px; }
  .progress-fill { position: absolute; top: 12px; left: 10px; height: 4px; background: var(--popup-accent); z-index: 0; border-radius: 2px; transition: width 0.3s ease; }
  .progress-step { z-index: 1; text-align: center; width: 33%; position: relative; display: flex; flex-direction: column; align-items: center; }
  .step-circle { width: 24px; height: 24px; background: #e0e0e0; border-radius: 50%; margin-bottom: 4px; border: 2px solid #fff; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #fff; font-weight: bold; transition: background 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .progress-step.active .step-circle { background: var(--popup-accent); }
  .step-label { font-size: 11px; color: #666; font-weight: bold; margin-bottom: 2px; }
  .step-date { font-size: 10px; color: #999; font-family: monospace; }
  .progress-step.active .step-label { color: var(--popup-text-main); }
  .progress-step.active .step-date { color: #555; }

  /* === AI é¢¨éšªé æ¸¬å°ˆç”¨æ¨£å¼ (Added in v.0206V1-AI-Plus) === */
  .ai-pulse-marker {
    width: 24px; height: 24px;
    background: rgba(155, 89, 182, 0.9); /* ç´«è‰²ç³» */
    border: 2px solid #fff;
    border-radius: 50%;
    box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7);
    animation: pulse-purple 2s infinite;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    color: white; font-size: 12px; font-weight: bold; z-index: 5000;
  }
  .ai-marker-med {
      background: rgba(230, 126, 34, 0.9); /* æ©˜è‰² */
      box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7);
      animation: pulse-orange 2s infinite;
  }
  
  @keyframes pulse-purple {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
  }
  @keyframes pulse-orange {
    0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); }
    100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); }
  }

  /* AI Dashboard Styles */
  #aiDashboard { margin-top: 10px; display: none; animation: fadeIn 0.3s; }
  .ai-dash-filters { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
  .ai-filter-btn { 
      padding: 4px 8px; border-radius: 12px; border: 1px solid #ddd; background: #fff; 
      font-size: 11px; white-space: nowrap; cursor: pointer; color: #555;
  }
  .ai-filter-btn.active { background: #9b59b6; color: white; border-color: #9b59b6; }
  .ai-list-item { 
      padding: 8px; border-bottom: 1px dashed #eee; font-size: 12px; cursor: pointer; 
      display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;
  }
  .ai-list-item:hover { background: #fdf2fe; }
  .ai-score-badge { font-weight: bold; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
  .badge-high { background: #9b59b6; }
  .badge-med { background: #e67e22; }

  /* AI Popup æ¨£å¼å„ªåŒ– */
  .ai-report-header {
      background: linear-gradient(135deg, #8e44ad, #9b59b6);
      color: white; padding: 12px; font-weight: bold; font-size: 14px;
      display: flex; align-items: center; gap: 8px;
      border-radius: 8px 8px 0 0;
  }
  .ai-report-body { padding: 15px; font-size: 13px; color: #333; line-height: 1.6; }
  .ai-stat-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 5px 0; }
  .ai-stat-val { font-weight: bold; color: #8e44ad; }
  .ai-advice-box { 
      background: #fdf2fe; border-left: 4px solid #9b59b6; 
      padding: 10px; margin-top: 10px; font-size: 12px; color: #555; 
  }

  /* 0112V2 é¸å–®å„ªåŒ– (V3ç¾åŒ–ç‰ˆ) */
  .multi-select-popup .info-header {
      background: #004080; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px;
      display: flex; justify-content: space-between; align-items: center;
  }
  .multi-select-item {
      padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
  }
  .multi-select-item:hover { background: #f0f7ff; }
  .multi-select-item:last-child { border-bottom: none; }
  .multi-select-title { font-size: 13px; font-weight: bold; color: #004080; margin-bottom: 3px; }
  .multi-select-meta { font-size: 11px; color: #666; display: flex; gap: 8px; align-items: center; }
  .badge-type { background: #e0f7fa; color: #006064; padding: 1px 5px; border-radius: 3px; font-size: 10px; border: 1px solid #b2ebf2; display: inline-block; margin-left: 5px;}

  #floatingCoords { position:absolute; pointer-events:none; background:rgba(255,255,255,0.9); border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:11px; display:none; z-index:1300; bottom: 10px; right: 10px; }

  /* 0205V1 Photo Source Modal Animation */
  @keyframes popIn {
      0% { transform: scale(0.9); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
  }

  /* å¼·åˆ¶éš±è—æ©Ÿåˆ¶ */
  .view-desktop { display: block !important; }
  .view-mobile { display: none !important; }
  .info-details-block { display: block; } /* Desktop Default */
  
  @media (max-width: 768px) {
    #sidebar { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; top: auto; border-radius: 20px 20px 0 0; border-right: none; transform: translateY(100%); margin-left: 0; }
    body.sidebar-open #sidebar { transform: translateY(0); }
    #overlay-mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1400; }
    body.sidebar-open #overlay-mask { display: block; }
    #toggleSidebarBtn { left: 10px; top: 10px; }
    #bottomPanel { left: 0; height: 300px; z-index: 2100; }
    .map-floating-controls { top: 70px; right: 10px; }
    #clusterControlPanel { bottom: 200px; left: 15px; right: 15px; width: auto; }
    #map { width: 100% !important; }

    /* æ‰‹æ©Ÿç‰ˆå¼·åˆ¶åè½‰ */
    .view-desktop { display: none !important; }
    .view-mobile { display: block !important; }
    .info-details-block { display: none; } /* Mobile Default Hidden */
    .info-details-block.open { display: block; } /* Toggle */
    
    /* Mobile Photo Tabs - Specific Handling */
    .mobile-photo-tabs.view-mobile { display: flex !important; }
    
    /* Mobile Header Layout */
    .mobile-compact-header { order: 1; padding: 8px 12px; background: #fff; border-bottom: 1px dashed #eee; position: relative; }
    .m-row-1 { display: flex; flex-direction: column; align-items: flex-start; justify-content: center; margin-bottom: 6px; gap: 4px; }
    .m-row-1 .status-pill { margin: 0; font-size: 10px; padding: 2px 8px; }
    .m-row-1 .case-id { font-size: 15px; font-weight: bold; color: #333; margin: 0; text-align: left; width: 100%; word-break: break-all; }
    .m-row-2 { display: flex; align-items: baseline; gap: 8px; }
    .m-row-2 .price-val { font-size: 16px; font-weight: 900; color: #d35400; flex-shrink: 0; }
    .m-tags-line { flex: 1; display: flex; gap: 5px; overflow: hidden; font-size: 11px; color: #555; align-items: center; min-width: 0; }
  }
</style>
</head>
<body>

<div id="overlay-mask"></div>
<button id="toggleSidebarBtn" title="åˆ‡æ›é¸å–®"><i class="fas fa-bars"></i></button>

<div id="container">
  <div id="sidebar">
    <div class="sidebar-header">
      <h3>è‡ºå—å¸‚å±±ä¸Šå€<br>å…¬çœ¾é€šè¡Œé“è·¯åœ–è³‡åŠæ–½å·¥/ç¶­ä¿®æ¡ˆä»¶é€æ˜</h3>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('tab-layers')"><i class="fas fa-layer-group"></i> é€æ˜</button>
        <button class="tab-btn" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> æœå°‹</button>
        <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fas fa-tools"></i> å·¥å…·</button>
        <button class="tab-btn" onclick="switchTab('tab-dengue')"><i class="fas fa-shield-virus"></i> ç™»é©ç†±</button>
    </div>

    <div id="tab-layers" class="tab-content-container tab-pane active">
        <div class="card-section" style="border-left: 5px solid #ff9800;">
            <div class="card-title" style="color:#e65100;"><i class="fas fa-satellite-dish"></i> æ°‘çœ¾é€šå ±å³æ™‚çœ‹æ¿</div>
            <label class="toggle-switch">
                <input type="checkbox" id="realtimeToggle" onchange="toggleRealtimeLayer(this)"> é¡¯ç¤ºå³æ™‚é€šå ±æ¡ˆä»¶
            </label>
            <div class="small" style="color:#666; margin-top:5px; display:flex; gap:10px;">
                <span><span style="color:#ff9800;">â—</span> æ´¾å·¥ä¸­</span>
                <span><span style="color:#004080;">â—</span> å·²å®Œå·¥</span>
                <span><span style="color:#7f8c8d;">â—</span> å¾…è™•ç†</span>
            </div>
        </div>

        <div class="card-section">
            <div class="card-title"><i class="fas fa-road"></i> æ–½å·¥/ç¶­ä¿®æ¡ˆä»¶å…¬å‘Š</div>
            <div class="small" style="margin-bottom:8px; color:#666;">å‹¾é¸å¹´ä»½æ‰¹æ¬¡é¡¯ç¤ºä½ç½® (<span style="color:#004080">â—</span>è¿‘ / <span style="color:red">â—</span>é )</div>
            <div id="repairCheckboxes" style="max-height:400px; overflow-y:auto;"></div>
            <button class="secondary" id="clearRepairBtn"><i class="fas fa-eraser"></i> æ¸…é™¤æ‰€æœ‰é¡¯ç¤º</button>
        </div>

        <div class="card-section">
            <div class="card-title"><i class="fas fa-calculator"></i> é‡Œåˆ¥ç¶­ä¿®çµ±è¨ˆ</div>
            <div class="small" style="margin-bottom:5px; color:#666;">ç³»çµ±å°‡è‡ªå‹•æ’é™¤åŒæ¡ˆä»¶é‡è¤‡è¨ˆç®—</div>
            <select id="statsVillageSelect" style="margin-bottom:10px;">
                <option value="">(è®€å–ä¸­...)</option>
            </select>
            <div id="statsResult" style="display:none;">
                <div class="stats-columns">
                    <div class="stats-col col-general">
                        <div class="stats-header">ä¸€èˆ¬å·¥ç¨‹</div>
                        <div id="statsGenList"></div>
                    </div>
                    <div class="stats-col col-emergency">
                        <div class="stats-header">æ¶éšªæ¶ä¿®</div>
                        <div id="statsEmgList"></div>
                    </div>
                </div>
            </div>
            <button class="secondary" id="clearStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> æ¸…é™¤æ‰€æœ‰é¡¯ç¤º</button>
        </div>
    </div>

    <div id="tab-search" class="tab-content-container tab-pane">
        <div class="card-section">
            <div class="card-title"><i class="fas fa-route"></i> å…¬çœ¾é€šè¡Œé“è·¯åœ–è³‡æŸ¥è©¢</div>
            <select id="roadSelect"><option>è¼‰å…¥ä¸­...</option></select>
        </div>
        <div class="card-section">
            <div class="card-title"><i class="fas fa-search-plus"></i> æ¡ˆä»¶é€²éšæœå°‹</div>
            <div class="search-block-label"><i class="fas fa-map-marked-alt"></i> ä¾é‡Œåˆ¥å¿«ç¯©</div>
            <select id="villageSelect" style="margin-bottom:10px;">
                <option value="">-- è«‹é¸æ“‡è¡Œæ”¿å€ (è¼‰å…¥ä¸­...) --</option>
            </select>
            <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- æˆ– -</div>
            <div class="search-block-label"><i class="fas fa-filter"></i> ä¾å» å•†å¿«ç¯©</div>
            <select id="contractorSelect" style="margin-bottom:10px;"><option value="">(è®€å–ç³»çµ±è³‡æ–™ä¸­...)</option></select>
            <div id="contractorStatsResult" style="display:none; margin-top:10px;">
                <div class="stats-columns">
                    <div class="stats-col col-general">
                        <div class="stats-header">ä¸€èˆ¬å·¥ç¨‹</div>
                        <div id="contractorGenList"></div>
                    </div>
                    <div class="stats-col col-emergency">
                        <div class="stats-header">æ¶éšªæ¶ä¿®</div>
                        <div id="contractorEmgList"></div>
                    </div>
                </div>
                <button class="secondary" id="clearContractorStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> æ¸…é™¤æ‰€æœ‰é¡¯ç¤º</button>
            </div>
            <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- æˆ– -</div>
            
            <div class="search-block-label"><i class="fas fa-clock"></i> ä¾æ´¾å·¥æ™‚æ©Ÿå¿«ç¯©</div>
            <select id="timingSelect" style="margin-bottom:10px;">
                <option value="">(è®€å–ç³»çµ±è³‡æ–™ä¸­...)</option>
            </select>
            
            <div class="search-block-label"><i class="fas fa-tools"></i> ä¾ç¶­ä¿®é¡å‹å¿«ç¯© (å¤šé¸)</div>
            <div class="multiselect-group" id="typeFilterContainer">
                <div class="multiselect-header" onclick="toggleTypeFilter()">
                    <span id="typeFilterLabel">è«‹é¸æ“‡ç¶­ä¿®é¡å‹ (æœªé¸)</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="multiselect-content" id="typeFilterContent">
                    <div class="checkbox-item select-all-row">
                        <label><input type="checkbox" id="typeSelectAll" onchange="toggleAllTypes(this)"> å…¨é¸/å–æ¶ˆ</label>
                    </div>
                    <div id="typeCheckboxList"></div>
                </div>
            </div>

            <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- æˆ– -</div>
            
            <div class="search-block-label"><i class="fas fa-keyboard"></i> é—œéµå­—æœå°‹</div>
            <input type="text" id="keywordInput" placeholder="ä¾‹å¦‚ï¼šæ¡ˆä»¶ç·¨è™Ÿ(113001) æ¡ˆä»¶åç¨± å» å•†åç¨±">
            <button id="searchBtn" class="primary"><i class="fas fa-search"></i> é–‹å§‹æœå°‹</button>
            <button id="clearSearchBtn" class="secondary" style="display:none; background:#ffebee; border-color:#ffcdd2; color:#d32f2f;"><i class="fas fa-times"></i> æ¸…é™¤çµæœ</button>
            <div id="searchStatus" class="small" style="margin-top:8px; color:#004080; font-weight:bold;"></div>
        </div>
    </div>
    
    <div id="tab-tools" class="tab-content-container tab-pane">
        <div class="card-section">
            <div class="card-title"><i class="fas fa-map-marker-alt"></i> åº§æ¨™æŸ¥è©¢å·¥å…·</div>
            <div class="small" style="margin-bottom:5px;">è¼¸å…¥ TWD97 åº§æ¨™ (X,Y)ï¼Œæ¯è¡Œä¸€çµ„</div>
            <textarea id="coordsInput" rows="4" placeholder="ä¾‹å¦‚ï¼š181924,2555825"></textarea>
            <div style="display:flex; gap:5px; margin-top:5px;">
              <button id="plotBtn" class="primary" style="margin-top:0;">é¡¯ç¤ºé»ä½</button>
              <button id="clearBtn" class="secondary" style="margin-top:0;">æ¸…é™¤</button>
            </div>
        </div>
        
        <div class="card-section">
            <div class="card-title"><i class="fas fa-home"></i> é–€ç‰ŒæŸ¥è©¢</div>
            <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
                <i class="fas fa-map-marked-alt"></i> è‡ºå—å¸‚é–€ç‰Œé›»å­åœ°åœ–æŸ¥è©¢ç³»çµ±
            </a>
        </div>
        
        <div class="card-section">
            <div class="card-title"><i class="fas fa-chart-network"></i> ç©ºé–“ç¾¤èšåˆ†æ</div>
            <label class="toggle-switch"><input type="checkbox" id="clusterToggle"> å•Ÿå‹•ç†±å€åˆ†æ</label>
            <div class="analysis-control">
                <div style="font-size:12px; color:#666;">ç¾¤èšé–¾å€¼ (åŠå¾‘)ï¼š</div>
                <div class="slider-container">
                    <input type="range" id="clusterSlider" min="0" max="500" step="10" value="50">
                    <span id="clusterValue" class="slider-value">50m</span>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="card-title"><i class="fas fa-history"></i> é‡è¤‡æ€§æ¡ˆä»¶æª¢æ ¸</div>
            <label class="toggle-switch" style="margin-bottom:10px;">
                <input type="checkbox" id="autoDupCheckToggle"> å•Ÿå‹•è‡ªå‹•æª¢æ ¸é‡è¤‡æ€§æ¡ˆä»¶
            </label>
            <div class="small" style="margin-bottom:5px;">è¼¸å…¥ TWD97 åº§æ¨™ (X,Y)</div>
            <input type="text" id="dupCheckInput" placeholder="ä¾‹å¦‚ï¼š181924,2555825">
            <div style="display:flex; gap:5px; margin-top:5px;">
              <button id="dupCheckBtn" class="primary" style="background:#e65100; margin-top:0;"><i class="fas fa-search"></i> é–‹å§‹æª¢æ ¸</button>
              <button id="dupClearBtn" class="secondary" style="width:auto; margin-top:0; white-space:nowrap; flex-shrink:0;">æ¸…é™¤</button>
            </div>
            <div id="dupCheckResult" style="margin-top:10px; font-size:13px; color:#333;"></div>
        </div>

        <div class="card-section" style="border-left: 5px solid #9b59b6;">
            <div class="card-title" style="color:#8e44ad;"><i class="fas fa-brain"></i> AI é“è·¯å¥åº·é¢¨éšªé æ¸¬</div>
            <div class="small" style="margin-bottom:8px; color:#666;">
                é€éæ¼”ç®—æ³•åˆ†æç¶­ä¿®é »ç‡ã€çµæ§‹é¢¨éšªèˆ‡æ¤è¢«å½±éŸ¿ï¼Œé»æ“Šåˆ—è¡¨å¯å¿«é€Ÿå®šä½ã€‚
            </div>
            <label class="toggle-switch">
                <input type="checkbox" id="aiRiskToggle" onchange="toggleAiRiskLayer(this)"> é¡¯ç¤º AI é¢¨éšªé è­¦ç†±é»
            </label>
            <div id="aiLoading" style="display:none; color:#8e44ad; font-size:12px; margin-top:5px;">
                <i class="fas fa-circle-notch fa-spin"></i> é‹ç®—ä¸­...
            </div>
            
            <div id="aiDashboard">
                <div class="ai-dash-filters">
                    <div class="ai-filter-btn active" onclick="filterAiResults('all', this)">å…¨éƒ¨</div>
                    <div class="ai-filter-btn" onclick="filterAiResults('high', this)">æ¥µé«˜é¢¨éšª</div>
                    <div class="ai-filter-btn" onclick="filterAiResults('road', this)">åœŸæœ¨çµæ§‹</div>
                    <div class="ai-filter-btn" onclick="filterAiResults('tree', this)">ç’°å¢ƒæ¤è¢«</div>
                </div>
                <div id="aiResultList" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:6px; background:#fafafa;">
                </div>
            </div>
        </div>
    </div>
    
    <div id="tab-dengue" class="tab-content-container tab-pane">
        <div class="card-section">
            <div class="card-title"><i class="fas fa-map-pin"></i> åº§æ¨™è¼¸å…¥</div>
            <div class="small" style="margin-bottom:5px;">è¼¸å…¥ TWD97 åº§æ¨™ (X,Y)ï¼Œæ¯è¡Œä¸€çµ„</div>
            <textarea id="dengueCoordsInput" rows="4" placeholder="ä¾‹å¦‚ï¼š181924,2555825"></textarea>
            <div style="display:flex; gap:5px; margin-top:5px;">
              <button id="plotDengueBtn" class="primary" style="background:#7f8c8d; margin-top:0;">é¡¯ç¤ºé»ä½</button>
              <button id="clearDengueBtn" class="secondary" style="margin-top:0;">æ¸…é™¤</button>
            </div>
        </div>
        <div class="card-section">
            <div class="card-title"><i class="fas fa-home"></i> é–€ç‰ŒæŸ¥è©¢</div>
            <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
                <i class="fas fa-map-marked-alt"></i> è‡ºå—å¸‚é–€ç‰Œé›»å­åœ°åœ–æŸ¥è©¢ç³»çµ±
            </a>
        </div>
        <div class="card-section">
            <div class="card-title"><i class="fas fa-circle-notch"></i> é¸æ“‡æ–¹åœ“åŠå¾‘</div>
            <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
                <label class="dengue-option"><input type="radio" name="dengueRadius" value="50" onchange="updateDengueRadius()"> 50 å…¬å°º</label>
                <label class="dengue-option"><input type="radio" name="dengueRadius" value="150" onchange="updateDengueRadius()"> 150 å…¬å°º</label>
                <label class="dengue-option"><input type="radio" name="dengueRadius" value="200" onchange="updateDengueRadius()"> 200 å…¬å°º</label>
            </div>
        </div>
    </div>

    <div class="sidebar-footer">
        <div>æœ¬ç¶²é åœ–è³‡åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç‹€æ³æ‡‰ä»¥æ¬Šç®¡æ©Ÿé—œç¾å ´é‘‘ç•Œç‚ºæº–ã€‚</div>
        <div style="margin-top:2px;">è³‡æ–™ä¾†æºï¼šGoogle Maps, OSM, åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ, è‡ºå—å¸‚å±±ä¸Šå€å…¬æ‰€</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<div class="map-floating-controls">
    <button class="float-btn" id="toggleMapBtn" data-title="åˆ‡æ›è¡›æ˜Ÿ/åœ°åœ–"><i class="fas fa-layer-group"></i></button>
    <button class="float-btn" id="toggleCadastralBtn" data-title="åœ°ç±åœ–é–‹é—œ"><i class="fas fa-map"></i></button>
    <button class="float-btn" id="toggleClusterControlBtn" data-title="é»ä½èšåˆè¨­å®š"><i class="fas fa-circle-nodes"></i></button>
    <button class="float-btn" id="openReportBtn" data-title="æ¡ˆä»¶é€šå ±" style="color:#d32f2f;"><i class="fas fa-camera"></i></button>
</div>

<div id="reportOverlay">
    <div class="report-header">
        <div style="font-size:18px; font-weight:bold;"><i class="fas fa-camera"></i> æ¡ˆä»¶é€šå ±</div>
        <button onclick="closeReport()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="report-body">
        <div class="report-grid">
            <div class="report-col">
                <div class="report-item"><span class="report-label">æ¡ˆä»¶ç·¨è™Ÿï¼š</span><span id="reportCaseId" style="color:#666; font-style:italic;">(å¾…ç³»çµ±å–è™Ÿ)</span></div>
                <div class="report-item"><span class="report-label">é€šå ±æ™‚é–“ï¼š</span><span id="reportTime"></span></div>
            </div>
            <div class="report-col">
                <div class="report-item"><span class="report-label">TWD97ï¼š</span><span id="reportTwd97">å®šä½ä¸­...</span></div>
                <div class="report-item"><span class="report-label">WGS84ï¼š</span><span id="reportWgs84">å®šä½ä¸­...</span></div>
            </div>
            <div class="report-col">
                <div class="report-item"><span class="report-label">ç°¡è¿°æ¡ˆæƒ…ï¼š</span></div>
                <textarea id="reportDesc" class="report-textarea" placeholder="è«‹æè¿°æå£æƒ…å½¢ (ä¾‹å¦‚ï¼šè·¯é¢å‘æ´)"></textarea>
            </div>
        </div>

        <div id="nearbyHistorySection" style="margin-bottom:15px; border:1px solid #ffd700; background:#fffbe6; border-radius:6px; padding:10px; display:none;">
            <div style="font-weight:bold; color:#d35400; margin-bottom:5px; font-size:14px; display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-history"></i> å®šä½é»éå¾€3å¹´å…§å‘¨é­50å…¬å°ºçš„ç¶­ä¿®æ¡ˆä»¶</span>
                <span style="font-size:11px; color:#666; font-weight:normal;">(é»æ“ŠæŸ¥çœ‹è©³æƒ…)</span>
            </div>
            <div id="nearbyHistoryList" style="max-height:150px; overflow-y:auto; font-size:13px; background:#fff; border:1px solid #eee; border-radius:4px;"></div>
        </div>

        <div class="photo-upload-container">
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box-upload" id="photoBox1" onclick="triggerCamera(1)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview1">
                    <input type="file" id="fileInput1" accept="image/*" capture="camera" style="display:none;" onchange="previewImage(this, 1)">
                </div>
                <button class="delete-photo-btn" id="delBtn1" onclick="deletePhoto(1)">åˆªé™¤</button>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box-upload" id="photoBox2" onclick="triggerCamera(2)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview2">
                    <input type="file" id="fileInput2" accept="image/*" capture="camera" style="display:none;" onchange="previewImage(this, 2)">
                </div>
                <button class="delete-photo-btn" id="delBtn2" onclick="deletePhoto(2)">åˆªé™¤</button>
            </div>
        </div>
        <div style="margin-top:10px; font-size:12px; color:#666; text-align:center;">è«‹é»æ“Šã€Œ+ã€æ‹æ”å…©å¼µä¸åŒè§’åº¦çš„ç…§ç‰‡</div>
    </div>
    <div class="report-footer">
        <button class="btn-cancel" onclick="closeReport()">å–æ¶ˆ</button>
        <button class="btn-submit" id="btnSubmitReport" onclick="submitReport()">ä¸Šå‚³é€šå ±</button>
    </div>
</div>

<div id="reportDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
    <div style="position:relative; max-width:960px; width:95%; max-height:90vh; overflow-y:auto; background:transparent; display:flex; flex-direction:column;">
        <button onclick="closeReportDetailModal()" style="align-self:flex-end; margin-bottom:10px; color:white; font-size:16px; background:rgba(0,0,0,0.5); border:1px solid #fff; border-radius:20px; padding:5px 15px; cursor:pointer;"><i class="fas fa-times"></i> é—œé–‰è¦–çª—</button>
        <div class="custom-popup">
            <div class="leaflet-popup-content-wrapper">
                <div class="leaflet-popup-content" id="reportDetailContent">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxStreetView"><i class="fas fa-street-view"></i> Google è¡—æ™¯</div>
    <div class="ctx-item" id="ctxGoogleNav"><i class="fas fa-location-arrow"></i> Google å°èˆª</div>
    <div class="ctx-item" id="ctxCadastral"><i class="fas fa-map"></i> åœ°ç±åœ–/æŸ¥è©¢</div>
    <div class="ctx-item" id="ctxMeasure"><i class="fas fa-ruler-horizontal"></i> è·é›¢é‡æ¸¬</div>
    <div class="ctx-item" id="ctxClearMarker" style="color:#d32f2f;"><i class="fas fa-trash-alt" style="color:#d32f2f;"></i> ç§»é™¤æ¨™è¨˜</div>
</div>

<div id="clusterControlPanel">
    <div class="cluster-header">
        <div class="cluster-title"><i class="fas fa-circle-nodes"></i> é»ä½èšåˆè¨­å®š</div>
        <div style="display:flex; align-items:center;">
            <span id="clusterRadiusVal" class="cluster-value-badge" style="margin-right: 5px;">ç¯„åœ 50px</span>
            <button id="closeClusterControlBtn" class="control-btn" title="é—œé–‰" style="color:#000; font-size:12px; padding:0;"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div style="font-size:12px; color:#666; margin-bottom:5px;">èª¿æ•´èšåˆæ•æ„Ÿåº¦ (æ»‘ç«¿å¾€å³ = ç¯„åœå¤§/èšåˆå¼·)</div>
    <input type="range" id="clusterRadiusSlider" class="custom-range" min="20" max="150" step="10" value="50">
</div>

<div id="bottomPanel">
    <div id="bottomPanelHeader">
        <div class="header-left">
            <div id="panelTitle"><i class="fas fa-history"></i> è·¯ç·šç¶­ä¿®ç´€éŒ„</div>
            <div id="timelineStats"></div>
        </div>
        <div class="header-right">
            <button id="togglePanelSizeBtn" class="control-btn" title="ç¸®å°/å±•é–‹"><i class="fas fa-chevron-down"></i></button>
            <button id="closePanelBtn" class="control-btn" title="é—œé–‰"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div id="timelineFilterBar">
        <span class="filter-label"><i class="fas fa-filter"></i> ç¯©é¸ï¼š</span>
        </div>
    <div id="timelineContainer"><div style="padding:20px; color:#777;">è«‹é»é¸åœ°åœ–ä¸Šçš„è—è‰²è·¯ç·šä»¥æª¢è¦–ç´€éŒ„ã€‚</div></div>
</div>

<div id="map"></div>
<div id="floatingCoords"></div>

<div id="photoSourceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:12000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:280px; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.2); animation: popIn 0.2s;">
        <div style="background:var(--primary-color); color:#fff; padding:12px; text-align:center; font-weight:bold;">è«‹é¸æ“‡ç…§ç‰‡ä¾†æº</div>
        <div style="display:flex; flex-direction:column;">
            <button onclick="selectSource('camera')" style="padding:15px; border:none; background:#fff; border-bottom:1px solid #eee; font-size:16px; cursor:pointer; color:#004080;"><i class="fas fa-camera"></i> æ‹æ”ç…§ç‰‡</button>
            <button onclick="selectSource('gallery')" style="padding:15px; border:none; background:#fff; border-bottom:1px solid #eee; font-size:16px; cursor:pointer; color:#e65100;"><i class="fas fa-images"></i> å¾ç›¸ç°¿æŒ‘é¸</button>
            <button onclick="closeSourceModal()" style="padding:15px; border:none; background:#f8fafc; color:#666; font-size:14px; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwb88r-ifPxx9bBcD1sF0tLVxOIjw60RoLWWJZXk8T82TP3GhSV8bb3dTNEGcgggwr5/exec";

const map = L.map('map', { zoomControl:false, doubleClickZoom: false }).setView([23.1025,120.3538], 13);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: 'Â© Google Maps' });
let isSat = false; 

const lc = L.control.locate({
    position: 'topright', 
    strings: { title: "æˆ‘çš„ä½ç½® (é»æ“Šè¿½è¹¤)" },
    icon: 'fas fa-crosshairs', iconLoading: 'fas fa-spinner fa-spin',
    setView: 'untilPan', keepCurrentZoomLevel: true, flyTo: true, cacheLocation: true,
    showPopup: false, drawCircle: true, drawMarker: true,
    locateOptions: { enableHighAccuracy: true, watch: true }
}).addTo(map);
const floatingContainer = document.querySelector('.map-floating-controls');
const lcContainer = lc.getContainer();
lcContainer.classList.remove('leaflet-bar', 'leaflet-control');
floatingContainer.prepend(lcContainer);

let wakeLock = null;
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); console.log('Screen Wake Lock active'); } catch (err) {}
    }
}
map.on('locateactivate', requestWakeLock);

let REPAIR_CONFIG = []; 
let roadsLayer = null;  
let roadLayersArray = [];
let REPAIR_DATA_CACHE = {}; 
let ALL_CONTRACTORS = new Set(); 
let ALL_TIMINGS = new Set();
let ALL_TYPES = new Set();

let currentRouteAllMatches = []; 
let villageGeoJSON = null; 
let dupCheckLayer = L.layerGroup().addTo(map); 
let dupMarkersMap = {}; 
let CURRENT_DUPLICATE_GROUPS = []; 
let CURRENT_MAP_GROUPS = {}; 
let reportNearbyMatches = []; 

let isMeasuring = false;
let measureStartLatLng = null;
let measureLine = null;
let measureTooltip = null;
let markersClusterGroup = null; 
let activeRepairLayers = []; 
let selectedTimelineMarker = null;

// 0205V1 Added: ç›®å‰æ­£åœ¨æ“ä½œçš„ç…§ç‰‡æ¡†ID
let activePhotoId = 0;

// 0205V4 Added: å³æ™‚çœ‹æ¿åœ–å±¤
const realtimeLayer = L.layerGroup().addTo(map);

const DEEP_BLUE = '#004080'; 
const LIGHT_BLUE = '#0066cc'; 

proj4.defs("EPSG:3826","+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=WGS84 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

function twd97FromWgs84(lat,lng){ 
    const p = proj4('EPSG:4326','EPSG:3826',[lng,lat]); 
    return {x:Math.round(p[0]),y:Math.round(p[1])}; 
}

const dengueLayer = L.layerGroup().addTo(map);
const dengueRadiusLayer = L.layerGroup().addTo(map);
const cadastralLayer = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: 'Â© åœ‹åœŸæ¸¬ç¹ªä¸­å¿ƒ', opacity: 0.8, maxZoom: 20 });
let isCadastralVisible = false;
const boundaryLayer = L.layerGroup().addTo(map).setZIndex(100); 
const pointLayer = L.layerGroup().addTo(map).setZIndex(1000);   
const repairLayer = L.layerGroup().addTo(map); 
const routeMatchLayer = L.layerGroup().addTo(map).setZIndex(999); 
const searchResultLayer = L.featureGroup().addTo(map);
const clusterLayer = L.featureGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map).setZIndex(1001);

/* === V19 Added: åœ–ç‰‡é è¼‰ helper function === */
function preloadImages(urls) {
    if (!urls || !Array.isArray(urls)) return;
    urls.forEach(url => {
        if (url && url.trim() !== "") {
            const img = new Image();
            img.src = url.trim();
        }
    });
}

// 0206V3 Modified: å¼·åŠ›ä¿®å¾©ç‰ˆ - ç¶²å€è½‰æ›å™¨
function getDirectDriveUrl(url) {
    if (!url) return '';
    let cleanUrl = url.trim();
    
    // å˜—è©¦æŠ“å– ID
    let id = '';
    
    // Pattern 1: .../file/d/ID/...
    let match1 = cleanUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if (match1) id = match1[1];
    
    // Pattern 2: ...id=ID...
    if (!id) {
        let match2 = cleanUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
        if (match2) id = match2[1];
    }

    if (id) {
        // ä½¿ç”¨ lh3.googleusercontent.com ç›´é€£ (æœ€ç©©å®š)
        return `https://lh3.googleusercontent.com/d/${id}`;
    }
    
    return cleanUrl;
}

// 0205V7 Fix: è‡ªå‹•è½‰æ› Google Drive View Link ç‚º Direct Link
function getPhotosFromProps(props) {
    if(!props) return [];
    
    // åˆä½µå‰å¾Œç…§ç‰‡æ¬„ä½ï¼Œä¸¦æ”¯æ´åˆ†è™Ÿåˆ†éš”
    const rawPhotos = [];
    if(props['æ–½å·¥å‰ç…§ç‰‡']) rawPhotos.push(props['æ–½å·¥å‰ç…§ç‰‡']);
    if(props['æ–½å·¥å¾Œç…§ç‰‡']) rawPhotos.push(props['æ–½å·¥å¾Œç…§ç‰‡']);
    
    const combinedStr = rawPhotos.join(';');
    
    return combinedStr.split(/[;\n\r]+/).map(u => getDirectDriveUrl(u)).filter(u => u.length > 0);
}

/* === æ ¸å¿ƒåŠŸèƒ½ï¼šæ–°ç‰ˆæ³¡æ³¡çª—ç”Ÿæˆå‡½å¼ === */

window.switchMobilePhotoTab = function(el, type) {
    const card = el.closest('.popup-card');
    const tabs = card.querySelectorAll('.m-tab');
    tabs.forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    
    const beforeView = card.querySelector('.photo-col-before');
    const afterView = card.querySelector('.photo-col-after');
    
    if(type === 'before') {
        beforeView.classList.add('active-view');
        afterView.classList.remove('active-view');
    } else {
        beforeView.classList.remove('active-view');
        afterView.classList.add('active-view');
    }
};

window.toggleMobileDetails = function(el) {
    const card = el.closest('.popup-card');
    const details = card.querySelector('.info-details-block');
    
    if(details.classList.contains('open')) {
        details.classList.remove('open');
        el.innerHTML = 'â–¼ æŸ¥çœ‹è©³ç´°è³‡è¨Š (å» å•†ã€åº§æ¨™ã€æ—¥æœŸ)';
    } else {
        details.classList.add('open');
        el.innerHTML = 'â–² æ”¶èµ·è©³ç´°è³‡è¨Š';
    }
};

window.switchPhotoSet = function(el, index) {
    const card = el.closest('.popup-card');
    if(!card) return;
    const viewers = card.querySelectorAll('.photo-viewer');
    viewers.forEach(viewer => {
        const imgs = viewer.querySelectorAll('img');
        if(imgs.length > index) { 
            imgs.forEach(img => img.classList.remove('active'));
            imgs[index].classList.add('active');
        }
    });
    const allDotContainers = card.querySelectorAll('.carousel-dots');
    allDotContainers.forEach(container => {
        const dots = container.querySelectorAll('.dot');
        if(dots.length > index) {
            dots.forEach(dot => dot.classList.remove('active'));
            dots[index].classList.add('active');
        }
    });
};

function renderTypeTags(rawType, isMobile) {
    if (!rawType) return isMobile ? '' : '<span class="type-pill">ä¸€èˆ¬å·¥ç¨‹</span>';
    const types = rawType.split(/[,ï¼Œ]/).map(s => s.trim()).filter(s => s.length > 0);
    if (types.length === 0) return isMobile ? '' : '<span class="type-pill">ä¸€èˆ¬å·¥ç¨‹</span>';
    if (types.length <= 2) {
        return `<div class="type-tag-group">${types.map(t => `<span class="type-pill">${t}</span>`).join('')}</div>`;
    }
    const visible = types.slice(0, 2);
    const hidden = types.slice(2);
    const uid = Math.random().toString(36).substr(2, 9);
    const hiddenId = `hidden-${uid}`;
    const btnId = `btn-${uid}`;
    const expandScript = `document.getElementById('${hiddenId}').style.display='contents';document.getElementById('${btnId}').style.display='none';`;

    return `<div class="type-tag-group">
        ${visible.map(t => `<span class="type-pill">${t}</span>`).join('')}
        <span id="${hiddenId}" style="display:none;">${hidden.map(t => `<span class="type-pill">${t}</span>`).join('')}</span>
        <span id="${btnId}" class="type-pill-more" onclick="${expandScript}" title="é»æ“Šå±•é–‹: ${hidden.join(', ')}">+${hidden.length} æ›´å¤š</span>
    </div>`;
}

function createPopup(data) {
    const { fileName, props, lat, lng, dist } = data;
    const twd = twd97FromWgs84(lat, lng);
    const distText = isNaN(dist) ? 'N/A' : dist.toFixed(0) + 'm';
    
    // 0205V6 Fix: å¼·åˆ¶å°‡æ¡ˆä»¶ç·¨è™Ÿè½‰ç‚º Stringï¼Œé¿å…ç´”æ•¸å­—é€ æˆ split éŒ¯èª¤
    const caseIdRaw = String(props['æ¡ˆä»¶ç·¨è™Ÿ'] || 'ç„¡ç·¨è™Ÿ');
    const caseId = caseIdRaw;
    
    const status = props['æ¡ˆä»¶ç‹€æ…‹'] || 'å·²å®Œå·¥';
    const timing = props['æ´¾å·¥æ™‚æ©Ÿ'] || 'ä¸€èˆ¬';
    const typeRaw = props['æ¶ä¿®é¡å‹'] || 'ä¸€èˆ¬å·¥ç¨‹'; 
    const description = props['æ¡ˆæƒ…æè¿°'] || 'ç„¡æè¿°'; 
    const contractor = props['æ–½å·¥å» å•†'] || '-';
    const supervisor = props['ç›£é€ å» å•†'] || '-';
    const date = props['å®Œå·¥æ—¥æœŸ'] || '-';
    const procurementUrl = props['æ¡è³¼ç¶²å€'] ? props['æ¡è³¼ç¶²å€'].trim() : '';

    let price = '0å…ƒ';
    const rawPrice = props['æ±ºæ¨™é‡‘é¡'];
    if(rawPrice) {
        const num = parseInt(rawPrice.toString().replace(/,/g, ''));
        if(!isNaN(num)) {
            const formatPriceV15 = (n) => {
                if(n < 10000) return n.toLocaleString() + 'å…ƒ';
                const w = Math.floor(n / 10000);
                const r = n % 10000;
                let rStr = r.toString().padStart(4, '0');
                if(r >= 1000) {
                    rStr = rStr.substring(0, 1) + ',' + rStr.substring(1);
                }
                return `${w}è¬${rStr}å…ƒ`;
            };
            price = formatPriceV15(num);
        }
    }

    let pillClass = 'pill-done';
    if(status.includes('æ–½å·¥') || status.includes('æ´¾å·¥')) pillClass = 'pill-working';
    else if(status.includes('ç·Šæ€¥') || status.includes('æ¶ä¿®')) pillClass = 'pill-urgent';

    let formattedCaseId = caseId; 
    
    // 0205V6 Fix: ä½¿ç”¨å®‰å…¨çš„å­—ä¸²æ“ä½œ
    if (caseId.indexOf('-') > -1) {
        const idParts = caseId.split('-');
        if (idParts.length >= 2) {
            const suffix = idParts[idParts.length - 1]; 
            if (/^\d{1,4}$/.test(suffix)) {
                const num = parseInt(suffix, 10);
                if (!isNaN(num)) {
                    formattedCaseId = `${fileName}ç¬¬${num}æ¡ˆ`;
                }
            }
        }
    }
    
    const mobileCaseIdDisplay = formattedCaseId;
    let siblingNavHtml = '';
    let mobileSiblingNavHtml = '';
    let siblings = [];
    if (caseIdRaw !== 'ç„¡ç·¨è™Ÿ') {
        const candidates = [...activeRepairLayers, ...realtimeLayer.getLayers(), ...searchResultLayer.getLayers()]; 
        // V6 Fix: ç¢ºä¿æ¯”è¼ƒæ™‚éƒ½è½‰ç‚º String
        const rawSiblings = candidates.filter(m => String(m.customData?.props['æ¡ˆä»¶ç·¨è™Ÿ'] || '') === caseIdRaw);
        const uniqueMap = new Map();
        rawSiblings.forEach(m => {
            const ll = m.getLatLng();
            const key = ll.lat.toFixed(6) + ',' + ll.lng.toFixed(6);
            if(!uniqueMap.has(key)) uniqueMap.set(key, m);
        });
        siblings = Array.from(uniqueMap.values());
        siblings.sort((a, b) => {
            const la = a.getLatLng();
            const lb = b.getLatLng();
            if(Math.abs(la.lat - lb.lat) > 0.00001) return lb.lat - la.lat;
            return lb.lng - la.lng;
        });
    }

    if (siblings.length > 1) {
        let dots = '';
        siblings.forEach((sib, idx) => {
            const sLat = sib.getLatLng().lat;
            const sLng = sib.getLatLng().lng;
            const isCurrent = (Math.abs(sLat - lat) < 0.000001 && Math.abs(sLng - lng) < 0.000001);
            const activeClass = isCurrent ? 'active' : '';
            const clickEvent = isCurrent ? '' : `onclick="jumpToSpecificSibling('${caseIdRaw}', ${sLat}, ${sLng})"`;
            const titleText = isCurrent ? 'ç›®å‰ä½ç½®' : `å‰å¾€é—œè¯é»ä½ ${idx+1}`;
            dots += `<div class="sibling-dot ${activeClass}" ${clickEvent} title="${titleText}">${idx+1}</div>`;
        });
        siblingNavHtml = `<div class="sibling-nav-container">${dots}</div>`;
        mobileSiblingNavHtml = `<div class="sibling-nav-container mobile">${dots}</div>`;
    }

    // --- 0206V1 Fix: ç…§ç‰‡åˆ†æµé‚è¼¯ ---
    const processPhotoStr = (str) => {
        if (!str) return [];
        // V2 Fix: ä½¿ç”¨å…¨åŸŸè½‰æ›å™¨
        return str.split(/[;\n\r]+/).map(u => getDirectDriveUrl(u)).filter(u => u.length > 0);
    };

    let arrBefore = [];
    let arrAfter = [];

    // åˆ¤æ–·ï¼šè‹¥æœ‰ã€Œæ–½å·¥å¾Œç…§ç‰‡ã€æ¬„ä½ï¼ˆè³‡æ–™åº«æ¡ˆä»¶ï¼‰ï¼Œå‰‡å‰å¾Œåˆ†é›¢ï¼›å¦å‰‡ä½¿ç”¨è¼ªæ’­ï¼ˆæ°‘çœ¾é€šå ±/å³æ™‚ï¼‰
    if (props['æ–½å·¥å¾Œç…§ç‰‡'] && props['æ–½å·¥å¾Œç…§ç‰‡'].trim() !== '') {
        // ã€è³‡æ–™åº«æ¡ˆä»¶æ¨¡å¼ã€‘ï¼šå‰å¾Œåˆ†é›¢
        arrBefore = processPhotoStr(props['æ–½å·¥å‰ç…§ç‰‡']);
        arrAfter = processPhotoStr(props['æ–½å·¥å¾Œç…§ç‰‡']);
    } else {
        // ã€æ°‘çœ¾é€šå ±/å–®æ¬„ä½æ¨¡å¼ã€‘ï¼šä½¿ç”¨è¼ªæ’­ (å…¨éƒ¨æ”¾åœ¨å·¦å´)
        // ä¿®å¾©: å¼·åˆ¶æª¢æŸ¥ GAS å¸¸ç”¨çš„ photoUrl æ¬„ä½ä¸¦é€²è¡Œè½‰æ› (V2 Fix)
        arrBefore = [];
        if (props.photoUrl) arrBefore.push(getDirectDriveUrl(props.photoUrl));
        if (props.photoUrl2) arrBefore.push(getDirectDriveUrl(props.photoUrl2));
        // å¦‚æœéƒ½æ²’æœ‰ï¼Œæ‰å»æ‰¾å‚³çµ±çš„æ–½å·¥å‰ç…§ç‰‡
        if (arrBefore.length === 0) {
             arrBefore = getPhotosFromProps(props);
        }
        arrAfter = [];
    }
    // --- 0206V1 Fix End ---

    // --- 0206V3-Progress: é€²åº¦æ¢é‚è¼¯ ---
    // 1. å–å‡ºæ—¥æœŸ
    let d1 = props['é€šå ±æ™‚é–“'] || props['timestamp'] || '-';
    // è‹¥ GAS å›å‚³ ISO æ™‚é–“æ ¼å¼ (2025-02-06T...)ï¼Œè½‰æ›ç‚ºæ°‘åœ‹å¹´/æœˆ/æ—¥
    if(d1 !== '-' && d1.includes('T')) {
        try {
            let dateObj = new Date(d1);
            if(!isNaN(dateObj.getTime())) {
                let y = dateObj.getFullYear() - 1911;
                let m = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                let d = dateObj.getDate().toString().padStart(2, '0');
                d1 = `${y}/${m}/${d}`;
            }
        } catch(e) {}
    }

    let d2 = props['æ´¾å·¥æ—¥æœŸ'] || '-';
    let d3 = props['å®Œå·¥æ—¥æœŸ'] || '-';

    // æ ¼å¼åŒ–å‡½æ•¸ (å°‡ 1140206 è½‰ç‚º 114/02/06)
    const fmt = (s) => {
        if(!s || s === '-') return '-';
        s = String(s).trim();
        if(s.length === 7 && /^\d+$/.test(s)) {
            return `${s.substring(0,3)}/${s.substring(3,5)}/${s.substring(5,7)}`;
        }
        return s;
    };

    d2 = fmt(d2);
    d3 = fmt(d3);

    // 2. åˆ¤æ–·ç›®å‰é€²åº¦éšæ®µ (1~3)
    let progressStep = 1; // é è¨­è‡³å°‘åœ¨å¾…è™•ç†
    let fillPercent = 0;

    // é‚è¼¯: æœ‰å®Œå·¥æ—¥ -> éšæ®µ3; æ²’å®Œå·¥ä½†æœ‰æ´¾å·¥æ—¥ -> éšæ®µ2; å¦å‰‡ -> éšæ®µ1
    // ç‰¹æ®Šé‚è¼¯: å¦‚æœæ˜¯æ­·å²æ¡ˆä»¶(é€šå¸¸ status=å·²å®Œæˆ)ï¼Œå³ä½¿ d1 ç¼ºæ¼ï¼Œä¹Ÿè¦–ç‚ºå·²å®Œæˆ
    if ((d3 !== '-' && d3) || status === 'å·²å®Œæˆ') {
        progressStep = 3;
        fillPercent = 100;
    } else if (d2 !== '-' && d2) {
        progressStep = 2;
        fillPercent = 50;
    } else {
        progressStep = 1;
        fillPercent = 0;
    }

    // 3. ç”¢ç”Ÿé€²åº¦æ¢ HTML
    const progressBarHtml = `
        <div class="progress-container">
            <div class="progress-track"></div>
            <div class="progress-fill" style="width: ${fillPercent}%"></div>
            
            <div class="progress-step ${progressStep >= 1 ? 'active' : ''}">
                <div class="step-circle">${progressStep >= 1 ? 'âœ”' : '1'}</div>
                <div class="step-label">å¾…è™•ç†</div>
                <div class="step-date">${d1}</div>
            </div>
            
            <div class="progress-step ${progressStep >= 2 ? 'active' : ''}">
                <div class="step-circle">${progressStep >= 2 ? 'âœ”' : '2'}</div>
                <div class="step-label">æ´¾å·¥ä¸­</div>
                <div class="step-date">${d2}</div>
            </div>
            
            <div class="progress-step ${progressStep >= 3 ? 'active' : ''}">
                <div class="step-circle">${progressStep >= 3 ? 'âœ”' : '3'}</div>
                <div class="step-label">å·²å®Œå·¥</div>
                <div class="step-date">${d3}</div>
            </div>
        </div>
    `;
    // --- End Progress Bar Logic ---

    const generatePhotoSection = (title, urls, typeKey) => {
        const uid = Math.random().toString(36).substr(2, 9);
        const viewerId = `viewer-${typeKey}-${uid}`;
        let imgsHtml = '';
        let dotsHtml = '';

        if(urls.length > 0) {
            urls.forEach((url, i) => { 
                const activeClass = i === 0 ? 'active' : ''; 
                imgsHtml += `<img src="${url.trim()}" class="${activeClass}" oncontextmenu="return false;" draggable="false">`; 
            });
            if(urls.length > 1) {
                dotsHtml = `<div class="carousel-dots">`;
                urls.forEach((_, i) => { const activeClass = i === 0 ? 'active' : ''; dotsHtml += `<div class="dot ${activeClass}" onclick="switchPhotoSet(this, ${i})">${i+1}</div>`; });
                dotsHtml += `</div>`;
            }
        } else { imgsHtml = `<div class="no-photo"><i class="fas fa-image"></i><span>æš«ç„¡å½±åƒ</span></div>`; }

        return `
            <div class="photo-section-header">
                <div class="photo-title"><i class="fas fa-camera"></i> ${title}</div>
            </div>
            <div class="photo-viewer" id="${viewerId}">
                ${imgsHtml}
            </div>
            ${dotsHtml}
        `;
    };

    const tenderBtn = procurementUrl 
        ? `<a href="${procurementUrl}" target="_blank" class="popup-btn-new"><i class="fas fa-file-alt"></i><span>æ±ºæ¨™</span></a>` 
        : `<span class="popup-btn-new" style="opacity:0.5;cursor:not-allowed;"><i class="fas fa-file-alt"></i><span>ç„¡å…¬å‘Š</span></span>`;

    return `
    <div class="popup-card">
        <div class="popup-deco-strip"></div>
        <div class="popup-col-info">
            <div class="view-mobile" style="margin: 0 10px;">
                ${progressBarHtml}
            </div>
            
            <div class="mobile-compact-header view-mobile">
                <div class="m-row-1">
                    <div class="status-pill ${pillClass}">${status}</div>
                    <div class="case-id mobile-id-text">${mobileCaseIdDisplay}</div>
                </div>
                ${mobileSiblingNavHtml}
                <div class="m-row-2">
                    <div class="price-val">${price}</div>
                    <div class="m-tags-line"><span>${fileName}</span>${renderTypeTags(typeRaw, true)}</div>
                </div>
            </div>
            
            <div class="mobile-photo-tabs view-mobile">
                <div class="m-tab" onclick="switchMobilePhotoTab(this, 'before')">ç¾å ´ç…§ç‰‡</div>
                <div class="m-tab active" onclick="switchMobilePhotoTab(this, 'after')">æ–½å·¥å¾Œ</div>
            </div>
            
            <div class="popup-btns view-mobile">
                ${tenderBtn}
                <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="popup-btn-new"><i class="fas fa-map"></i><span>åœ°ç±</span></a>
                <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-camera"></i><span>è¡—æ™¯</span></a>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-location-arrow"></i><span>å°èˆª</span></a>
            </div>

            <div class="mobile-details-toggle view-mobile" onclick="toggleMobileDetails(this)">â–¼ æŸ¥çœ‹è©³ç´°è³‡è¨Š (å» å•†ã€åº§æ¨™ã€æ—¥æœŸ)</div>

            <div class="info-details-block">
                <div class="compact-list">
                    <div class="compact-item" style="border-bottom:1px dashed #eee; padding-bottom:5px; margin-bottom:5px;">
                        <span class="compact-label" style="color:#047857;background:#d1fae5;">æ¡ˆæƒ…æè¿°</span>
                        <div class="compact-val" style="font-weight:normal;">${description}</div>
                    </div>
                    <div class="compact-item"><span class="compact-label">æ–½å·¥å» å•†</span><div class="compact-val">${contractor}</div></div>
                    <div class="compact-row">
                        <div class="compact-item" style="flex:1"><span class="compact-label">ç›£é€ å» å•†</span><div class="compact-val">${supervisor}</div></div>
                        <div class="compact-item" style="flex:1"><span class="compact-label">WGS84</span><div class="compact-val">${lat.toFixed(6)}, ${lng.toFixed(6)}</div></div>
                    </div>
                    <div class="compact-row">
                        <div class="compact-item" style="flex:1"><span class="compact-label">å®Œå·¥æ—¥æœŸ</span><div class="compact-val">${date}</div></div>
                        <div class="compact-item" style="flex:1"><span class="compact-label">TWD97</span><div class="compact-val">${twd.x}, ${twd.y}</div></div>
                    </div>
                </div>
            </div>
            
            <div class="desktop-only view-desktop">
                ${progressBarHtml}
                
                <div class="case-id" style="display:flex; align-items:center; flex-wrap:wrap;">${formattedCaseId}</div>
                ${siblingNavHtml}
                <div class="case-meta"><span class="file-tag">${fileName}</span>${renderTypeTags(typeRaw, false)}</div>
                
                <div class="popup-tags">
                    <div class="tag-pill tag-dark"><i class="fas fa-clock"></i> ${timing}</div>
                    <div class="tag-pill tag-light"><i class="fas fa-map-marker-alt" style="color:#10b981;"></i> è·è·¯ç·š ${distText}</div>
                </div>
                <div class="price-block"><div class="price-label">æ±ºæ¨™é‡‘é¡</div><div class="price-val">${price}</div></div>
            </div>
            
            <div class="popup-btns view-desktop">
                ${tenderBtn}
                <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="popup-btn-new"><i class="fas fa-map"></i><span>åœ°ç±</span></a>
                <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-camera"></i><span>è¡—æ™¯</span></a>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-location-arrow"></i><span>å°èˆª</span></a>
            </div>
        </div>
        <div class="popup-col-photo photo-col-before active-view-desktop">${generatePhotoSection('ç¾å ´ç…§ç‰‡', arrBefore, 'before')}</div>
        <div class="popup-col-photo photo-col-after active-view-mobile">${generatePhotoSection('æ–½å·¥å¾Œ', arrAfter, 'after')}</div>
        
        <style>
            @media (max-width: 768px) {
                .photo-col-before { display: none !important; }
                .photo-col-before.active-view { display: flex !important; }
                .photo-col-after { display: flex !important; } /* Default Active on Mobile */
                .photo-col-after:not(.active-view) { display: none !important; }
            }
            @media (min-width: 769px) {
                .photo-col-before, .photo-col-after { display: flex !important; } /* Desktop always show both */
            }
        </style>
    </div>
    `;
}

// 0205V4 Added: å³æ™‚çœ‹æ¿åˆ‡æ›èˆ‡è³‡æ–™è®€å–
async function toggleRealtimeLayer(checkbox) {
    realtimeLayer.clearLayers();
    if(!checkbox.checked) return;

    document.body.style.cursor = 'wait';

    try {
        const res = await fetch(GOOGLE_SCRIPT_URL);
        const data = await res.json();

        if(data.features) {
            data.features.forEach(f => {
                const props = f.properties;
                const status = props['æ¡ˆä»¶ç‹€æ…‹'] || 'å¾…è™•ç†';
                let color = '#7f8c8d'; // é è¨­ç°è‰²
                let radius = 8;

                if(status === 'æ´¾å·¥ä¸­') { color = '#ff9800'; radius = 10; } // æ©˜è‰²
                else if(status === 'å·²å®Œå·¥') { color = '#004080'; } // æ·±è—è‰²

                const lat = f.geometry.coordinates[1];
                const lng = f.geometry.coordinates[0];
                const latlng = L.latLng(lat, lng);

                const marker = L.circleMarker(latlng, {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.9
                });

                marker.customData = {
                    configLabel: "æ°‘çœ¾é€šå ±-" + props['æ¡ˆä»¶ç·¨è™Ÿ'], 
                    props: props
                };

                // 0205V5 Fix: ä¿®æ­£å‚³éåƒæ•¸ï¼Œç¢ºä¿å‚³å…¥çš„æ˜¯ Marker Array
                marker.on('click', (e) => {
                    // 0205V6 Added: é»æ“Šäº‹ä»¶éŒ¯èª¤æ””æˆª
                    try {
                        const realTimeMarkers = realtimeLayer.getLayers();
                        handleNearbyMarkerClick(e, [...realTimeMarkers, ...activeRepairLayers]);
                    } catch (err) {
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼šç„¡æ³•é–‹å•Ÿè©³ç´°è³‡æ–™ã€‚\nåŸå› ï¼š" + err.message);
                        console.error(err);
                    }
                });

                marker.addTo(realtimeLayer);
            });
        }
    } catch(e) {
        console.error(e);
        alert("è®€å–å³æ™‚çœ‹æ¿å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚");
    } finally {
        document.body.style.cursor = 'default';
    }
}

const reportOverlay = document.getElementById('reportOverlay');
const openReportBtn = document.getElementById('openReportBtn');
openReportBtn.addEventListener('click', function() { reportOverlay.style.display = 'flex'; initReportData(); });
function closeReport() { 
    reportOverlay.style.display = 'none'; 
    // Double Insurance: é—œé–‰é¸å–®
    document.getElementById('photoSourceModal').style.display = 'none';
    resetReportForm(); 
}

function initReportData() {
    document.getElementById('reportCaseId').innerText = "(å¾…ç³»çµ±å–è™Ÿ)";
    document.getElementById('reportTime').innerText = new Date().toLocaleString();
    
    const historySection = document.getElementById('nearbyHistorySection');
    const historyList = document.getElementById('nearbyHistoryList');
    historySection.style.display = 'none';
    historyList.innerHTML = '';
    reportNearbyMatches = [];

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude, lng = pos.coords.longitude;
                const twd = twd97FromWgs84(lat, lng);
                document.getElementById('reportWgs84').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('reportTwd97').innerText = `${twd.x}, ${twd.y}`;
                checkNearbyHistory(lat, lng);
            },
            () => { document.getElementById('reportWgs84').innerText = "å®šä½å¤±æ•—"; document.getElementById('reportTwd97').innerText = "å®šä½å¤±æ•—"; },
            { enableHighAccuracy: true }
        );
    } else { document.getElementById('reportWgs84').innerText = "ä¸æ”¯æ´å®šä½"; }
}

function checkNearbyHistory(lat, lng) {
    const historySection = document.getElementById('nearbyHistorySection');
    const historyList = document.getElementById('nearbyHistoryList');
    const centerLatLng = L.latLng(lat, lng);
    
    const now = new Date();
    const threeYearsAgo = new Date();
    threeYearsAgo.setFullYear(now.getFullYear() - 3);

    reportNearbyMatches = [];

    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; 
        if(!data || !data.features) return;
        
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
            
            const dist = centerLatLng.distanceTo(pt);
            if(dist <= 50) {
                const rawDate = f.properties['å®Œå·¥æ—¥æœŸ'];
                const dateStr = rawDate ? String(rawDate).trim() : "";
                
                if(dateStr.length === 7) {
                    const y = parseInt(dateStr.substring(0,3)) + 1911;
                    const m = parseInt(dateStr.substring(3,5)) - 1;
                    const d = parseInt(dateStr.substring(5,7));
                    const finishDate = new Date(y, m, d);
                    
                    if(finishDate >= threeYearsAgo) {
                        const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
                        reportNearbyMatches.push({
                            label: conf.label,
                            props: f.properties,
                            lat: pt.lat,
                            lng: pt.lng,
                            dist: dist.toFixed(1),
                            isEmergency: isEmergency,
                            dateStr: dateStr,
                            jsDate: finishDate
                        });
                    }
                }
            }
        });
    });

    historyList.innerHTML = '';
    if(reportNearbyMatches.length > 0) {
        historySection.style.display = 'block';
        reportNearbyMatches.sort((a,b) => b.jsDate - a.jsDate);
        
        reportNearbyMatches.forEach((item, index) => {
            const tagClass = item.isEmergency ? 'tag-emg' : 'tag-gen';
            const tagName = item.isEmergency ? 'æ¶ä¿®' : 'ä¸€èˆ¬';
            
            const div = document.createElement('div');
            div.className = 'nearby-item';
            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#004080; margin-bottom:2px;">${item.label}</div>
                    <div style="font-size:12px; color:#666;">å®Œå·¥ï¼š${item.dateStr} | è·é›¢ï¼š${item.dist}m</div>
                </div>
                <div class="nearby-tag ${tagClass}">${tagName}</div>
            `;
            div.onclick = function() { showReportDetail(index); };
            historyList.appendChild(div);
        });
    } else {
        historySection.style.display = 'block';
        historyList.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">æ­¤ä½ç½® 50å…¬å°ºå…§ æœ€è¿‘ 3å¹´ç„¡ç¶­ä¿®ç´€éŒ„ã€‚</div>';
    }
}

function showReportDetail(index) {
    const item = reportNearbyMatches[index];
    if(!item) return;
    const content = createPopup({
        fileName: item.label,
        props: item.props,
        lat: item.lat,
        lng: item.lng,
        dist: parseFloat(item.dist) 
    });
    
    document.getElementById('reportDetailContent').innerHTML = content;
    document.getElementById('reportDetailModal').style.display = 'flex';
}

function closeReportDetailModal() {
    document.getElementById('reportDetailModal').style.display = 'none';
}

// 0205V1 Modified: ä¿®æ”¹ triggerCamera ç‚ºé–‹å•Ÿé¸å–®ï¼Œè€Œéç›´æ¥æ‹ç…§
function triggerCamera(id) {
    const img = document.getElementById(`imgPreview${id}`);
    // åªæœ‰ç•¶å°šæœªæœ‰ç…§ç‰‡æ™‚ï¼Œæ‰è§¸ç™¼é¸æ“‡é¸å–®
    if (!img.src || img.style.display === 'none' || img.src === window.location.href) {
        activePhotoId = id;
        document.getElementById('photoSourceModal').style.display = 'flex';
    }
}

// 0205V3 Modified: å¼·æ•ˆç‰ˆä¿®å¾© - é›™é‡ä¿éšª + å¼·åˆ¶é‡ç¹ª + å»¶é•·å»¶é²
function selectSource(type) {
    if(!activePhotoId) return;
    const input = document.getElementById(`fileInput${activePhotoId}`);
    const modal = document.getElementById('photoSourceModal');
    
    // å¦‚æœé¸æ‹ç…§ï¼ŒåŠ ä¸Š capture="environment" (å¾Œé¡é ­)
    if(type === 'camera') {
        input.setAttribute('capture', 'environment');
    } else {
        // å¦‚æœé¸ç›¸ç°¿ï¼Œç§»é™¤ capture å±¬æ€§
        input.removeAttribute('capture');
    }
    
    // 1. é—œé–‰é¸å–® (DOM æ“ä½œ)
    modal.style.display = 'none';
    
    // 2. å¼·åˆ¶é‡ç¹ª (Force Reflow) - é—œéµï¼
    // è®€å– offsetHeight æœƒå¼·è¿«ç€è¦½å™¨ç«‹åˆ»è¨ˆç®—ä½ˆå±€ï¼Œç¢ºä¿ display:none è¢«å¥—ç”¨
    modal.offsetHeight;

    // 3. å»¶é²è§¸ç™¼ (Extended Buffer)
    // å»¶é•·åˆ° 300msï¼Œç¢ºä¿ UI å·²ç¶“å®Œå…¨æ¶ˆå¤±å¾Œæ‰å«èµ·ç³»çµ±ç›¸æ©Ÿ
    setTimeout(() => {
        input.click();
    }, 300);
}

function closeSourceModal() {
    document.getElementById('photoSourceModal').style.display = 'none';
}

function previewImage(input, id) {
    // Double Insurance: ç¢ºä¿é¸å–®çœŸçš„é—œé–‰äº† (é˜²æ­¢ç›¸æ©Ÿè¿”å›å¾Œé¸å–®é‚„åœ¨)
    document.getElementById('photoSourceModal').style.display = 'none';

    if (input.files && input.files[0]) {
        compressImage(input.files[0], 800, 0.7, function(compressedDataUrl) {
            const img = document.getElementById(`imgPreview${id}`);
            const box = document.getElementById(`photoBox${id}`);
            const delBtn = document.getElementById(`delBtn${id}`);
            img.src = compressedDataUrl; img.style.display = 'block';
            box.querySelector('.add-photo-btn').style.display = 'none';
            box.classList.add('has-image');
            delBtn.style.display = 'block';
        });
    }
}
function compressImage(file, maxWidth, quality, callback) {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = function (event) {
        const img = new Image(); img.src = event.target.result;
        img.onload = function () {
            let width = img.width, height = img.height;
            if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
            const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', quality));
        };
    };
}
function deletePhoto(id) {
    const img = document.getElementById(`imgPreview${id}`);
    const box = document.getElementById(`photoBox${id}`);
    const input = document.getElementById(`fileInput${id}`);
    const delBtn = document.getElementById(`delBtn${id}`);
    img.src = ""; img.removeAttribute('src'); img.style.display = 'none';
    box.querySelector('.add-photo-btn').style.display = 'block';
    box.classList.remove('has-image'); input.value = ""; delBtn.style.display = 'none';
}
function resetReportForm() { deletePhoto(1); deletePhoto(2); document.getElementById('reportDesc').value = ""; document.getElementById('reportWgs84').innerText = "å®šä½ä¸­..."; document.getElementById('reportTwd97').innerText = "å®šä½ä¸­..."; }

function getUserID() {
    let uid = localStorage.getItem('site_user_uid');
    if (!uid) {
        uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('site_user_uid', uid);
    }
    return getUserID;
}

async function submitReport() {
    if (GOOGLE_SCRIPT_URL.includes("æ‚¨çš„SCRIPT_ID")) { alert("è«‹å…ˆè¨­å®š Google Apps Script URLï¼"); return; }
    const desc = document.getElementById('reportDesc').value;
    if (!desc.trim()) { alert("è«‹è¼¸å…¥æ¡ˆæƒ…æè¿°ï¼"); return; }
    if (!confirm("ç¢ºå®šè¦ä¸Šå‚³æ­¤æ¡ˆä»¶é€šå ±å—ï¼Ÿ")) return;
    const btn = document.getElementById('btnSubmitReport'); const originalText = btn.innerText; btn.disabled = true; btn.innerText = "è³‡æ–™ä¸Šå‚³ä¸­...";
    try {
        const img1 = document.getElementById('imgPreview1'), img2 = document.getElementById('imgPreview2');
        const payload = { 
            time: document.getElementById('reportTime').innerText, 
            wgs84: document.getElementById('reportWgs84').innerText, 
            twd97: document.getElementById('reportTwd97').innerText, 
            description: desc, 
            photo1: (img1.src && img1.src.startsWith('data:')) ? img1.src : "", 
            photo2: (img2.src && img2.src.startsWith('data:')) ? img2.src : "",
            appKey: "TainanMap2026_SecureKey_v1", 
            siteUrl: window.location.href,        
            uid: getUserID()                      
        };
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.result === "success") { alert(`âœ… æ¡ˆä»¶é€šå ±æˆåŠŸï¼\n\næ¡ˆä»¶ç·¨è™Ÿï¼š${result.caseId}\nè³‡æ–™å·²å¯«å…¥é›²ç«¯è©¦ç®—è¡¨ã€‚`); closeReport(); } else { alert("âŒ ä¸Šå‚³å¤±æ•—: " + (result.error || "æœªçŸ¥éŒ¯èª¤")); }
    } catch (error) { console.error(error); alert("âŒ é€£ç·šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚"); } finally { btn.disabled = false; btn.innerText = originalText; }
}

document.getElementById('dupClearBtn').addEventListener('click', function() {
    dupCheckLayer.clearLayers(); document.getElementById('dupCheckResult').innerHTML = ''; document.getElementById('dupCheckInput').value = ''; document.getElementById('autoDupCheckToggle').checked = false; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = [];
});
window.focusDupMarker = function(index) { const marker = dupMarkersMap[index]; if(marker) { map.flyTo(marker.getLatLng(), 18); marker.openPopup(); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); } };
window.showDupDetailPopup = function(groupIdx, caseIdx) {
    const group = CURRENT_DUPLICATE_GROUPS[groupIdx]; if(!group) return; const item = group[caseIdx];
    const distToLine = distToRoad(item.latlng, roadsLayer); 
    const content = createPopup({ fileName: item.name, props: item.props, lat: item.latlng.lat, lng: item.latlng.lng, dist: distToLine });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};
window.showMapDetailPopup = function(key, index) {
    const group = CURRENT_MAP_GROUPS[key]; if(!group || !group[index]) return; const item = group[index];
    const dist = distToRoad(item.latlng, roadsLayer);
    const content = createPopup({ fileName: item.configLabel, props: item.feature.properties, lat: item.latlng.lat, lng: item.latlng.lng, dist: dist });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};
document.getElementById('autoDupCheckToggle').addEventListener('change', function() {
    if(this.checked) { document.getElementById('dupCheckInput').value = ''; performAutoDuplicateCheck(); } else { dupCheckLayer.clearLayers(); document.getElementById('dupCheckResult').innerHTML = ''; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = []; }
});

function performAutoDuplicateCheck() {
    const resDiv = document.getElementById('dupCheckResult'); resDiv.innerHTML = '<div style="padding:10px; color:#666;">æƒæè³‡æ–™åº«ä¸­...</div>';
    let coordMap = {}; 
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if(!data || !data.features) return;
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const key = f.geometry.coordinates.join(',');
            if(!coordMap[key]) coordMap[key] = [];
            coordMap[key].push({ name: conf.label, props: f.properties, latlng: L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]) });
        });
    });
    let duplicates = []; Object.keys(coordMap).forEach(k => { if(coordMap[k].length > 1) duplicates.push(coordMap[k]); });
    CURRENT_DUPLICATE_GROUPS = duplicates;
    dupCheckLayer.clearLayers(); resDiv.innerHTML = ''; dupMarkersMap = {};
    if(duplicates.length === 0) { resDiv.innerHTML = '<div style="padding:10px; color:green;">æœªç™¼ç¾å®Œå…¨é‡ç–Šçš„æ¡ˆä»¶åº§æ¨™ã€‚</div>'; return; }
    let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">âš ï¸ ç™¼ç¾ ${duplicates.length} çµ„é‡è¤‡åº§æ¨™é»ä½ï¼š</div>`;
    duplicates.forEach((group, idx) => {
        const pt = group[0].latlng; const twd = twd97FromWgs84(pt.lat, pt.lng);
        const marker = L.circleMarker(pt, { radius: 10, color: '#d32f2f', fillColor: '#ffeb3b', fillOpacity: 0.9, weight:2 }).addTo(dupCheckLayer);
        let popupHTML = `<div class="info-header" style="padding:10px;background:#004080;color:white;font-weight:bold;">é‡è¤‡åº§æ¨™é»ä½è³‡è¨Š (${group.length}ç­†)</div><div class="info-body" style="padding:10px;max-height:250px; overflow-y:auto;"><div style="font-size:12px; color:#666; margin-bottom:5px;">é»æ“Šæ¡ˆä»¶åç¨±å¯æŸ¥çœ‹è©³ç´°è³‡æ–™</div>`;
        group.forEach((item, i) => {
            popupHTML += `<div style="border-bottom:1px dashed #ccc; padding:8px 0; cursor:pointer;" onclick="showDupDetailPopup(${idx}, ${i})"><b style="color:#004080; text-decoration:underline;">${i+1}. ${item.name}</b><br><span style="color:#333; font-size:12px;">æ¡ˆä»¶ç·¨è™Ÿ: ${item.props['æ¡ˆä»¶ç·¨è™Ÿ']||'ç„¡'}<br>å®Œå·¥æ—¥æœŸ: ${item.props['å®Œå·¥æ—¥æœŸ']||'ç„¡'}</span></div>`;
        });
        popupHTML += `</div>`;
        marker.bindPopup(popupHTML, { className: 'custom-popup', maxWidth: 300 });
        dupMarkersMap[idx] = marker;
        const dates = group.map(g => g.props['å®Œå·¥æ—¥æœŸ'] || '').sort();
        const dateRange = dates[0] ? `${dates[0]} ~ ${dates[dates.length-1]}` : 'æ—¥æœŸæœªçŸ¥';
        html += `<div class="dup-check-item" onclick="focusDupMarker(${idx})"><div class="dup-check-title">ğŸ“ åº§æ¨™é‡è¤‡ç¾¤çµ„ #${idx+1} <br><span style="font-size:11px; color:#555;">(TWD97: ${twd.x}, ${twd.y})</span></div><div class="dup-check-info" style="color:#d32f2f; font-weight:bold;">åŒ…å« ${group.length} ç­†æ¡ˆä»¶</div><div class="dup-check-info" style="font-size:11px; color:#666;">${dateRange}</div></div>`;
    });
    resDiv.innerHTML = html;
}

document.getElementById('dupCheckBtn').addEventListener('click', function() {
    const autoCheck = document.getElementById('autoDupCheckToggle'); if(autoCheck.checked) autoCheck.checked = false;
    const input = document.getElementById('dupCheckInput').value.trim();
    const resultDiv = document.getElementById('dupCheckResult'); dupCheckLayer.clearLayers(); resultDiv.innerHTML = ''; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = [];
    if (!input) { alert('è«‹è¼¸å…¥ TWD97 åº§æ¨™ï¼Œä¾‹å¦‚ 181924,2555825'); return; }
    const parts = input.split(/[, \t]+/); if (parts.length < 2) { alert('åº§æ¨™æ ¼å¼éŒ¯èª¤'); return; }
    const x = parseFloat(parts[0]), y = parseFloat(parts[1]); if (isNaN(x) || isNaN(y)) { alert('åº§æ¨™æ•¸å€¼éŒ¯èª¤'); return; }
    try {
        const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]); const centerLatLng = L.latLng(w[1], w[0]);
        map.setView(centerLatLng, 18);
        L.circle(centerLatLng, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 50 }).addTo(dupCheckLayer);
        L.marker(centerLatLng).addTo(dupCheckLayer).bindPopup(`æª¢æ ¸ä¸­å¿ƒé»<br>TWD97: ${x}, ${y}`).openPopup();
        const matches = []; const now = new Date(); const threeYearsAgo = new Date(); threeYearsAgo.setFullYear(now.getFullYear() - 3);
        REPAIR_CONFIG.forEach(conf => {
            const data = REPAIR_DATA_CACHE[conf.value]; if (!data) return;
            data.features.forEach(f => {
                if (f.geometry.type !== 'Point') return;
                const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
                const dist = centerLatLng.distanceTo(pt);
                if (dist <= 50) {
                    const dateStr = f.properties['å®Œå·¥æ—¥æœŸ'];
                    if (dateStr && dateStr.length === 7) {
                        const y = parseInt(dateStr.substring(0, 3)) + 1911, m = parseInt(dateStr.substring(3, 5)) - 1, d = parseInt(dateStr.substring(5, 7));
                        const finishDate = new Date(y, m, d);
                        if (finishDate >= threeYearsAgo) {
                            let diffMonths = (now.getFullYear() - finishDate.getFullYear()) * 12 + (now.getMonth() - finishDate.getMonth());
                            if (now.getDate() < finishDate.getDate()) diffMonths--;
                            const years = Math.floor(diffMonths / 12), months = diffMonths % 12;
                            const timeAgoStr = `${years} å¹´ ${months} å€‹æœˆ`;
                            const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
                            matches.push({ name: conf.label, props: f.properties, date: dateStr, timeAgo: timeAgoStr, dist: dist.toFixed(1), isEmergency: isEmergency, latlng: pt });
                        }
                    }
                }
            });
        });
        if (matches.length === 0) { resultDiv.innerHTML = '<div style="color:green; font-weight:bold;"><i class="fas fa-check-circle"></i> æ­¤ç¯„åœ 50m å…§è¿‘ 3 å¹´ç„¡ç›¸é—œç´€éŒ„</div>'; } else {
            matches.sort((a, b) => parseFloat(a.dist) - parseFloat(b.dist));
            let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">âš ï¸ ç™¼ç¾ ${matches.length} ç­†è¿‘ 3 å¹´ç´€éŒ„ï¼š</div>`;
            matches.forEach((m, index) => {
                const marker = L.circleMarker(m.latlng, { radius: 8, color: '#d32f2f', weight: 2, fillColor: '#ffeb3b', fillOpacity: 1 }).addTo(dupCheckLayer);
                const distToLine = distToRoad(m.latlng, roadsLayer); 
                marker.bindPopup(createPopup({ fileName: m.name, props: m.props, lat: m.latlng.lat, lng: m.latlng.lng, dist: distToLine }), { className: 'custom-popup', maxWidth:960 });
                dupMarkersMap[index] = marker;
                const tagClass = m.isEmergency ? 'tag-emg' : 'tag-gen'; const tagName = m.isEmergency ? 'æ¶ä¿®' : 'ä¸€èˆ¬';
                html += `<div class="dup-check-item" onclick="focusDupMarker(${index})"><div class="dup-check-title">${m.name}<span class="dup-tag ${tagClass}">${tagName}</span></div><div class="dup-check-info"><span>å®Œå·¥ï¼š${m.props['å®Œå·¥æ—¥æœŸ']} (è·ä»Š ${m.timeAgo})</span></div><div class="dup-check-info"><span>è·é›¢ï¼š${m.dist} å…¬å°º</span></div></div>`;
            });
            resultDiv.innerHTML = html;
        }
    } catch (e) { console.error(e); alert('åº§æ¨™è½‰æ›å¤±æ•—'); }
});

window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`); if(btn) btn.classList.add('active');
};
const toggleBtn = document.getElementById('toggleSidebarBtn'), overlayMask = document.getElementById('overlay-mask'), bottomPanel = document.getElementById('bottomPanel'), togglePanelSizeBtn = document.getElementById('togglePanelSizeBtn'), panelIcon = togglePanelSizeBtn.querySelector('i');
function toggleSidebar() { const isMobile = window.innerWidth <= 768; if (isMobile) document.body.classList.toggle('sidebar-open'); else document.body.classList.toggle('collapsed'); setTimeout(() => map.invalidateSize(), 300); }
toggleBtn.addEventListener('click', toggleSidebar); overlayMask.addEventListener('click', () => document.body.classList.remove('sidebar-open'));
document.getElementById('closePanelBtn').addEventListener('click', () => { bottomPanel.classList.remove('open'); routeMatchLayer.clearLayers(); });
togglePanelSizeBtn.addEventListener('click', () => { bottomPanel.classList.toggle('minimized'); if (bottomPanel.classList.contains('minimized')) panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up'); else panelIcon.classList.replace('fa-chevron-up', 'fa-chevron-down'); });

fetch('tainan_districts.geojson').then(r=>r.json()).then(data=>{
    L.geoJSON(data, { interactive: false, style: f => { const isTarget = (f.properties.TOWNNAME||f.properties.TOWN).includes('å±±ä¸Š'); return { color: '#d500f9', weight: isTarget ? 4 : 1, opacity: 1, dashArray: isTarget ? '15, 10' : '', fillOpacity: 0 }; } }).addTo(boundaryLayer);
}).catch(e=>console.warn(e));

const VILLAGE_COLORS = { "æ˜å’Œé‡Œ": "#E74C3C", "å±±ä¸Šé‡Œ": "#F39C12", "å—æ´²é‡Œ": "#F1C40F", "æ–°èŠé‡Œ": "#2ECC71", "å¹³é™½é‡Œ": "#1ABC9C", "è±å¾·é‡Œ": "#9B59B6", "ç‰å³¯é‡Œ": "#FF69B4", "ç‰å³°é‡Œ": "#FF69B4" };
fetch('t22.json').then(r => r.json()).then(topology => {
    villageGeoJSON = topojson.feature(topology, topology.objects.t22);
    const villageNames = villageGeoJSON.features.map(f => f.properties.VILLAGE || f.properties.VILLNAME).sort();
    const vSelSearch = document.getElementById('villageSelect'), vSelStats = document.getElementById('statsVillageSelect');
    vSelSearch.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡Œæ”¿å€ --</option>'; vSelStats.innerHTML = '<option value="">-- è«‹é¸æ“‡è¡Œæ”¿å€ --</option>';
    villageNames.forEach(v => {
        const opt1 = document.createElement('option'); opt1.value = v; opt1.textContent = v; vSelSearch.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = v; opt2.textContent = v; vSelStats.appendChild(opt2);
    });
    const villageLayer = L.geoJSON(villageGeoJSON, {
        style: function(feature) { const vName = feature.properties.VILLAGE || feature.properties.VILLNAME; const color = VILLAGE_COLORS[vName] || "#999"; return { fillColor: color, fillOpacity: 0.1, color: color, weight: 1, opacity: 0.4, dashArray: '5, 5' }; },
        onEachFeature: function(feature, layer) { layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.4, weight: 2, color: '#FFD700', dashArray: '' }); }); layer.on('mouseout', function() { villageLayer.resetStyle(this); }); }
    }).addTo(boundaryLayer);
    villageLayer.bringToBack();
}).catch(e => console.warn(e));

function getVillageName(lat, lng) {
    if (!villageGeoJSON) return "è®€å–è³‡æ–™ä¸­..."; const pt = turf.point([lng, lat]);
    for (const feature of villageGeoJSON.features) { if (turf.booleanPointInPolygon(pt, feature)) return `å±±ä¸Šå€ ${feature.properties.VILLAGE || feature.properties.VILLNAME || "æœªçŸ¥é‡Œ"}`; }
    return "éå±±ä¸Šå€ç¯„åœ";
}

document.getElementById('villageSelect').addEventListener('change', function() {
    const selectedVillage = this.value; const status = document.getElementById('searchStatus'), clearBtn = document.getElementById('clearSearchBtn');
    document.getElementById('keywordInput').value = ''; document.getElementById('contractorSelect').value = ''; 
    document.getElementById('timingSelect').value = ''; 
    searchResultLayer.clearLayers();
    if (!selectedVillage) { status.innerText = ''; clearBtn.style.display = 'none'; return; }
    const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage); if (!villageFeature) return;
    let count = 0;
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if (!data || !data.features) return;
        data.features.forEach(f => {
            try {
                if (f.geometry.type !== 'Point') return;
                if (turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
                    const [lng, lat] = f.geometry.coordinates; const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6, interactive: false }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.customData = { configLabel: conf.label, props: f.properties };
                    marker.on('click', (e) => handleNearbyMarkerClick(e, searchResultLayer.getLayers()));
                    count++;
                }
            } catch (e) {}
        });
    });
    if (count > 0) { const bounds = L.geoJSON(villageFeature).getBounds(); map.fitBounds(bounds); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); status.innerHTML = `${selectedVillage} ç¯„åœå…§æ‰¾åˆ° <b style="color:#d32f2f">${count}</b> ç­†`; clearBtn.style.display = 'block'; } 
    else { status.innerHTML = '<span style="color:red">æ­¤é‡Œç¯„åœå…§å°šç„¡æ¡ˆä»¶è³‡æ–™</span>'; map.fitBounds(L.geoJSON(villageFeature).getBounds()); }
    if(clusterToggle.checked) setTimeout(calculateClusters, 100);
});

document.getElementById('statsVillageSelect').addEventListener('change', function() {
    const selectedVillage = this.value; const statsResult = document.getElementById('statsResult'), statsGenList = document.getElementById('statsGenList'), statsEmgList = document.getElementById('statsEmgList');
    searchResultLayer.clearLayers(); statsGenList.innerHTML = ''; statsEmgList.innerHTML = '';
    if (!selectedVillage) { statsResult.style.display = 'none'; return; }
    const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage); if (!villageFeature) return;
    let globalYearTotals = {}, globalProcessedCases = new Set();
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if (!data || !data.features) return;
        const yearMatch = conf.label.match(/(\d{3})å¹´/); const year = yearMatch ? yearMatch[1] : 'å…¶ä»–'; const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
        if (!globalYearTotals[year]) globalYearTotals[year] = { gen: 0, emg: 0 };
        data.features.forEach(f => {
            try {
                const props = f.properties, caseNo = props['æ¡ˆä»¶ç·¨è™Ÿ'], amount = formatMoney(props['æ±ºæ¨™é‡‘é¡']);
                if (caseNo && caseNo.trim() !== "") { if (!globalProcessedCases.has(caseNo)) { globalProcessedCases.add(caseNo); if (isEmergency) globalYearTotals[year].emg += amount; else globalYearTotals[year].gen += amount; } } 
                else { if (isEmergency) globalYearTotals[year].emg += amount; else globalYearTotals[year].gen += amount; }
            } catch(e){}
        });
    });
    let villageYearStats = {}, villageProcessedCases = new Set();
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if (!data || !data.features) return;
        const yearMatch = conf.label.match(/(\d{3})å¹´/); const year = yearMatch ? yearMatch[1] : 'å…¶ä»–'; const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
        if (!villageYearStats[year]) villageYearStats[year] = { genCount: 0, genAmount: 0, emgCount: 0, emgAmount: 0 };
        data.features.forEach(f => {
            try {
                if (f.geometry.type !== 'Point') return;
                if (turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
                    const [lng, lat] = f.geometry.coordinates; const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.customData = { configLabel: conf.label, props: f.properties };
                    marker.on('click', (e) => handleNearbyMarkerClick(e, searchResultLayer.getLayers()));
                    const props = f.properties, caseNo = props['æ¡ˆä»¶ç·¨è™Ÿ'], amount = formatMoney(props['æ±ºæ¨™é‡‘é¡']);
                    let shouldAdd = false; if (caseNo && caseNo.trim() !== "") { if (!villageProcessedCases.has(caseNo)) { villageProcessedCases.add(caseNo); shouldAdd = true; } } else { shouldAdd = true; }
                    if (shouldAdd) { if (isEmergency) { villageYearStats[year].emgCount++; villageYearStats[year].emgAmount += amount; } else { villageYearStats[year].genCount++; villageYearStats[year].genAmount += amount; } }
                }
            } catch (e) {}
        });
    });
    const sortedYears = Object.keys(villageYearStats).sort().reverse();
    sortedYears.forEach(y => {
        const stats = villageYearStats[y], globalTotals = globalYearTotals[y] || { gen: 1, emg: 1 };
        if (stats.genCount > 0) {
            const pct = globalTotals.gen > 0 ? (stats.genAmount / globalTotals.gen * 100).toFixed(0) : 0;
            statsGenList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}å¹´åº¦</span><span class="stat-percent-text">ä½”å…¨å€ ${pct}%</span></div><div class="stat-data-row">${stats.genCount} ä»¶ / $ ${stats.genAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`;
        }
        if (stats.emgCount > 0) {
            const pct = globalTotals.emg > 0 ? (stats.emgAmount / globalTotals.emg * 100).toFixed(0) : 0;
            statsEmgList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}å¹´åº¦</span><span class="stat-percent-text">ä½”å…¨å€ ${pct}%</span></div><div class="stat-data-row">${stats.emgCount} ä»¶ / $ ${stats.emgAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`;
        }
    });
    if (statsGenList.innerHTML === '') statsGenList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">ç„¡è³‡æ–™</div>';
    if (statsEmgList.innerHTML === '') statsEmgList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">ç„¡è³‡æ–™</div>';
    const bounds = L.geoJSON(villageFeature).getBounds(); map.fitBounds(bounds); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); statsResult.style.display = 'block';
});
document.getElementById('clearStatsBtn').addEventListener('click', function() { searchResultLayer.clearLayers(); document.getElementById('statsVillageSelect').value = ""; document.getElementById('statsResult').style.display = 'none'; });

fetch('farmroads.geojson').then(r=>r.json()).then(data=>{
    roadsLayer = L.geoJSON(data, {
        style: { color: DEEP_BLUE, weight: 3, opacity: 0.9 }, 
        onEachFeature: (f, l) => {
            l.bindTooltip(f.properties?.name || "é“è·¯", { sticky: true, direction: 'top' });
            l.on('mouseover', () => { l.setStyle({ weight: 5, color: LIGHT_BLUE }); map.getContainer().style.cursor='pointer'; });
            l.on('mouseout', () => { l.setStyle({ weight: 3, color: DEEP_BLUE }); map.getContainer().style.cursor='default'; });
            l.on('click', (e) => { L.DomEvent.stopPropagation(e); handleMapClickSelection(roadLayersArray.indexOf(l), true); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); });
        }
    }).addTo(map);
    roadLayersArray = roadsLayer.getLayers();
    const sel = document.getElementById('roadSelect'); sel.innerHTML = '<option value="">-- è«‹é¸æ“‡è·¯ç·š --</option>';
    data.features.forEach((f, i) => { const o = document.createElement('option'); o.value = i; o.textContent = f.properties?.name || `è·¯ç·š ${i+1}`; sel.appendChild(o); });
}).catch(e=>{});

async function loadRepairSettings() {
    const box = document.getElementById('repairCheckboxes');
    try { const res = await fetch('repair_months.json'); REPAIR_CONFIG = await res.json(); } catch (e) { box.innerHTML = 'è®€å–å¤±æ•—'; return; }
    if(REPAIR_CONFIG.length === 0) { box.innerHTML = 'ç„¡è³‡æ–™'; return; }
    box.innerHTML = ''; const grouped = {};
    REPAIR_CONFIG.forEach(item => { const m = item.label.match(/(\d{3})å¹´/); const y = m ? m[1] : 'å…¶ä»–'; if(!grouped[y]) grouped[y] = []; grouped[y].push(item); });
    Object.keys(grouped).sort((a,b)=>b-a).forEach((y, idx) => {
        const gDiv = document.createElement('div'); gDiv.className = 'year-group'; if(idx===0) gDiv.classList.add('open');
        gDiv.innerHTML = `<div class="year-header" onclick="this.parentElement.classList.toggle('open')"><div><span class="toggle-icon">â–¶</span> ${y}å¹´åº¦</div><label class="year-select-all" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleYear(this)"> å…¨é¸</label></div><div class="year-content">${grouped[y].map(item => `<div class="checkbox-item"><input type="checkbox" value="${item.value}" class="repair-cb" onchange="updateRepairPoints()"><label>${item.label}</label></div>`).join('')}</div>`; box.appendChild(gDiv);
    });
    preloadAllDataForContractors();
}
loadRepairSettings();
window.toggleYear = function(source) { const cbs = source.closest('.year-group').querySelectorAll('.repair-cb'); cbs.forEach(cb => cb.checked = source.checked); updateRepairPoints(); }

function distToRoad(latlng, roadLayer) {
    if(!roadLayer || !turf) return NaN;
    try {
        let min = Infinity;
        roadLayer.eachLayer(l => {
            if(!l.feature.geometry) return;
            const geom = l.feature.geometry; const line = geom.type==='LineString' ? turf.lineString(geom.coordinates) : (geom.type==='MultiLineString' ? turf.multiLineString(geom.coordinates) : null);
            if(line) { const d = turf.pointToLineDistance(turf.point([latlng.lng, latlng.lat]), line, {units:'meters'}); if(d < min) min = d; }
        });
        return min===Infinity ? NaN : min;
    } catch(e) { return NaN; }
}

function updateRepairPoints() {
    if(markersClusterGroup) { markersClusterGroup.clearLayers(); map.removeLayer(markersClusterGroup); markersClusterGroup = null; }
    activeRepairLayers = []; CURRENT_MAP_GROUPS = {}; 
    const panel = document.getElementById('clusterControlPanel'), toggleBtn = document.getElementById('toggleClusterControlBtn'), checked = document.querySelectorAll('.repair-cb:checked');
    checked.forEach(cb => {
        const fileKey = cb.value;
        if(REPAIR_DATA_CACHE[fileKey]) {
            const data = REPAIR_DATA_CACHE[fileKey], config = REPAIR_CONFIG.find(c => c.value === fileKey);
            data.features.forEach(f => {
                if(f.geometry.type === 'Point') {
                    const key = f.geometry.coordinates.join(',');
                    if(!CURRENT_MAP_GROUPS[key]) CURRENT_MAP_GROUPS[key] = [];
                    CURRENT_MAP_GROUPS[key].push({ feature: f, configLabel: config.label, latlng: L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]) });
                }
            });
        }
    });
    Object.keys(CURRENT_MAP_GROUPS).forEach(key => {
        const group = CURRENT_MAP_GROUPS[key], firstItem = group[0], pt = firstItem.latlng;
        const dist = distToRoad(pt, roadsLayer), isFar = (!isNaN(dist) && dist > 30), color = isFar ? '#ef4444' : '#004080';
        const iconHtml = `<div style="width:14px; height:14px; background:${color}; border:2px solid #fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>`;
        const icon = L.divIcon({ html: iconHtml, className: 'custom-dot-marker', iconSize: [18, 18], iconAnchor: [9, 9] });
        const marker = L.marker(pt, { icon: icon });
        marker.customData = { group: group, configLabel: firstItem.configLabel, props: firstItem.feature.properties };
        marker.on('click', (e) => handleNearbyMarkerClick(e, activeRepairLayers));
        marker.feature = firstItem.feature; activeRepairLayers.push(marker);
    });
    if (activeRepairLayers.length === 0) { panel.style.display = 'none'; toggleBtn.classList.remove('active'); }
    renderClusterGroup(); calculateClusters(); 
}

window.handleNearbyMarkerClick = function(e, sourceLayers) {
    L.DomEvent.stopPropagation(e);
    const clickPoint = map.latLngToContainerPoint(e.latlng);
    const candidates = [];
    const BUFFER_PX = 30; 

    sourceLayers.forEach(layer => {
        if (!map.getBounds().contains(layer.getLatLng())) return;
        const layerPos = map.latLngToContainerPoint(layer.getLatLng());
        if (layerPos.distanceTo(clickPoint) <= BUFFER_PX) {
            if(layer.customData) {
                candidates.push(layer);
            }
        }
    });

    if (candidates.length > 1) {
        showMultiSelectPopup(e.latlng, candidates);
        if(selectedTimelineMarker) {
             selectedTimelineMarker.setStyle({ radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 });
             selectedTimelineMarker = null;
        }
    } else {
        const targetMarker = candidates.length > 0 ? candidates[0] : e.target;
        if(selectedTimelineMarker && selectedTimelineMarker !== targetMarker) {
             selectedTimelineMarker.setStyle({ radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 });
             selectedTimelineMarker = null;
        }
        openDetailPopupFromMarker(targetMarker);
    }
};

window.showMultiSelectPopup = function(latlng, markers) {
    markers.forEach(m => {
        const p = m.customData && m.customData.props;
        if(p) {
            const photoUrls = getPhotosFromProps(p);
            preloadImages(photoUrls);
        }
    });

    let html = `<div class="multi-select-popup">
        <div class="info-header">è«‹é¸æ“‡æ¡ˆä»¶ (${markers.length})</div>
        <div style="max-height:250px; overflow-y:auto;">`;
    
    markers.forEach((m, idx) => {
        const data = m.customData || {};
        const isGroup = data.group && data.group.length > 1;
        const title = data.configLabel || "æ¡ˆä»¶";
        const props = data.props || {};
        const caseNo = props['æ¡ˆä»¶ç·¨è™Ÿ'] || 'ç„¡ç·¨è™Ÿ';
        const date = props['å®Œå·¥æ—¥æœŸ'] || '';
        const repairType = props['æ¶ä¿®é¡å‹'] || '';
        const ll = m.getLatLng();
        const twd = twd97FromWgs84(ll.lat, ll.lng);
        const twdStr = `${twd.x}, ${twd.y}`;

        window[`_temp_marker_${idx}`] = m;
        html += `
        <div class="multi-select-item" onclick="window.triggerMarkerPopup(${idx})">
            <div class="multi-select-title">
                ${idx+1}. ${title} ${isGroup ? `<span style='font-size:10px;background:#d32f2f;color:fff;padding:1px 4px;border-radius:3px;'>é‡ç–Š${data.group.length}ç­†</span>` : ''}
            </div>
            <div class="multi-select-meta">
                <span><i class="fas fa-barcode"></i> ${caseNo}</span>
                <span><i class="fas fa-calendar-alt"></i> ${date}</span>
                ${repairType ? `<span class="badge-type">${repairType}</span>` : ''}
            </div>
            <div class="multi-select-meta" style="margin-top:2px; color:#555; font-size:10px;">
                <span><i class="fas fa-map-marker-alt"></i> TWD97: ${twdStr}</span>
            </div>
        </div>`;
    });
    html += `</div></div>`;
    L.popup({ className: 'custom-popup', maxWidth: 300 }).setLatLng(latlng).setContent(html).openOn(map);
};

window.triggerMarkerPopup = function(idx) {
    const m = window[`_temp_marker_${idx}`];
    if(m) {
        map.closePopup();
        openDetailPopupFromMarker(m);
    }
};

window.openDetailPopupFromMarker = function(marker) {
    const data = marker.customData;
    if(!data) return;

    if (data.group && data.group.length > 1) {
        let listHtml = `<div class="info-header" style="padding:10px;background:#004080;color:white;font-weight:bold;">é‡è¤‡åº§æ¨™é»ä½è³‡è¨Š (${data.group.length}ç­†)</div><div class="info-body" style="padding:10px;max-height:250px; overflow-y:auto;"><div style="font-size:12px; color:#666; margin-bottom:5px;">é»æ“Šæ¡ˆä»¶åç¨±å¯æŸ¥çœ‹è©³ç´°è³‡æ–™</div>`;
        data.group.forEach((item, index) => {
             window[`_temp_group_item_${index}`] = item;
             listHtml += `<div style="border-bottom:1px dashed #ccc; padding:8px 0; cursor:pointer;" onclick="openSingleGroupItem(${index})"><b style="color:#004080; text-decoration:underline;">${index+1}. ${item.configLabel}</b><br><span style="color:#333; font-size:12px;">æ¡ˆä»¶ç·¨è™Ÿ: ${item.feature.properties['æ¡ˆä»¶ç·¨è™Ÿ']||'ç„¡'}<br>å®Œå·¥æ—¥æœŸ: ${item.feature.properties['å®Œå·¥æ—¥æœŸ']||'ç„¡'}</span></div>`;
        });
        listHtml += `</div>`;
        L.popup({ className: 'custom-popup', maxWidth: 300 }).setLatLng(marker.getLatLng()).setContent(listHtml).openOn(map);
    } else {
        const dist = distToRoad(marker.getLatLng(), roadsLayer);
        const content = createPopup({
            fileName: data.configLabel,
            props: data.props,
            lat: marker.getLatLng().lat,
            lng: marker.getLatLng().lng,
            dist: dist
        });
        
        const latlng = marker.getLatLng();
        sessionStorage.setItem('savedPopup', JSON.stringify({
             lat: latlng.lat, lng: latlng.lng, content: content, zoom: map.getZoom()
        }));
        L.popup({className:'custom-popup', maxWidth:960}).setLatLng(marker.getLatLng()).setContent(content).openOn(map);
    }
};

window.openSingleGroupItem = function(index) {
    const item = window[`_temp_group_item_${index}`];
    if(item) {
        const dist = distToRoad(item.latlng, roadsLayer);
        const content = createPopup({ fileName: item.configLabel, props: item.feature.properties, lat: item.latlng.lat, lng: item.latlng.lng, dist: dist });
        L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
    }
};

function renderClusterGroup() {
    const sliderVal = parseInt(document.getElementById('clusterRadiusSlider').value);
    if (markersClusterGroup) map.removeLayer(markersClusterGroup);
    markersClusterGroup = L.markerClusterGroup({ maxClusterRadius: sliderVal, disableClusteringAtZoom: 18, spiderfyOnMaxZoom: true, showCoverageOnHover: false, zoomToBoundsOnClick: true });
    markersClusterGroup.addLayers(activeRepairLayers); map.addLayer(markersClusterGroup);
}
const clusterRadiusSlider = document.getElementById('clusterRadiusSlider');
clusterRadiusSlider.addEventListener('input', function() { document.getElementById('clusterRadiusVal').innerText = `ç¯„åœ ${this.value}px`; renderClusterGroup(); });
const toggleClusterControlBtn = document.getElementById('toggleClusterControlBtn'), clusterControlPanel = document.getElementById('clusterControlPanel'), closeClusterControlBtn = document.getElementById('closeClusterControlBtn');
toggleClusterControlBtn.addEventListener('click', function() { if (activeRepairLayers.length === 0) { alert("è«‹å…ˆè‡³ã€Œé€æ˜ã€åˆ†é å‹¾é¸æ¬²é¡¯ç¤ºçš„æ¡ˆä»¶è³‡æ–™ã€‚"); return; } const isVisible = clusterControlPanel.style.display === 'block'; clusterControlPanel.style.display = isVisible ? 'none' : 'block'; this.classList.toggle('active'); });
closeClusterControlBtn.addEventListener('click', function() { clusterControlPanel.style.display = 'none'; toggleClusterControlBtn.classList.remove('active'); });

function renderTypeCheckboxes() {
    const container = document.getElementById('typeCheckboxList');
    if(!container) return;
    container.innerHTML = '';
    const sortedType = Array.from(ALL_TYPES).sort();
    sortedType.forEach(type => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        div.innerHTML = `<label><input type="checkbox" value="${type}" class="type-filter-cb" onchange="updateTypeSelection()"> ${type}</label>`;
        container.appendChild(div);
    });
    updateTypeSelection();
}

function toggleTypeFilter() {
    const container = document.getElementById('typeFilterContainer');
    container.classList.toggle('open');
}

function toggleAllTypes(source) {
    const checkboxes = document.querySelectorAll('.type-filter-cb');
    checkboxes.forEach(cb => cb.checked = source.checked);
    updateTypeSelection();
}

function updateTypeSelection() {
    const checkedBoxes = document.querySelectorAll('.type-filter-cb:checked');
    const label = document.getElementById('typeFilterLabel');
    const total = document.querySelectorAll('.type-filter-cb').length;
    
    if(checkedBoxes.length === total) {
        label.innerText = `è«‹é¸æ“‡ç¶­ä¿®é¡å‹ (å…¨é¸)`;
    } else if (checkedBoxes.length === 0) {
        label.innerText = `è«‹é¸æ“‡ç¶­ä¿®é¡å‹ (æœªé¸)`;
    } else {
        label.innerText = `ç¶­ä¿®é¡å‹ (å·²é¸ ${checkedBoxes.length} é …)`;
    }
    
    const selectedSet = new Set();
    checkedBoxes.forEach(cb => selectedSet.add(cb.value));
    document.getElementById('keywordInput').value=''; 
    document.getElementById('villageSelect').value=''; 
    document.getElementById('contractorSelect').value=''; 
    document.getElementById('timingSelect').value=''; 
    
    performSearch(p => {
        const typeStr = p['æ¶ä¿®é¡å‹'] || '';
        const types = typeStr.split(/[,ï¼Œ]/).map(s => s.trim());
        if (selectedSet.size === 0) return false;
        return types.some(t => selectedSet.has(t));
    }, `ç¶­ä¿®é¡å‹ç¯©é¸`);
}

async function preloadAllDataForContractors() {
    const cSel = document.getElementById('contractorSelect');
    const tSel = document.getElementById('timingSelect');

    await Promise.all(REPAIR_CONFIG.map(async item => {
        if (!REPAIR_DATA_CACHE[item.value]) { 
            try { const res = await fetch(item.value + '.geojson'); if(res.ok) { const json = await res.json(); REPAIR_DATA_CACHE[item.value] = json; json.features?.forEach(f => { 
                const c = f.properties['æ–½å·¥å» å•†']?.trim(); if(c) ALL_CONTRACTORS.add(c);
                const t = f.properties['æ´¾å·¥æ™‚æ©Ÿ']?.trim(); if(t) ALL_TIMINGS.add(t);
                const typeRaw = f.properties['æ¶ä¿®é¡å‹']?.trim(); 
                if(typeRaw) {
                    const parts = typeRaw.split(/[,ï¼Œ]/).map(s => s.trim());
                    parts.forEach(p => { if(p) ALL_TYPES.add(p); });
                }
            }); } } catch(e){}
        }
    }));
    const sortedC = Array.from(ALL_CONTRACTORS).sort();
    cSel.innerHTML = '<option value="">-- è«‹é¸æ“‡å» å•† (' + sortedC.length + ') --</option>' + sortedC.map(c => `<option value="${c}">${c}</option>`).join('');
    cSel.addEventListener('change', function() { 
        if(this.value) { 
            document.getElementById('keywordInput').value=''; 
            document.getElementById('villageSelect').value=''; 
            document.getElementById('timingSelect').value=''; 
            resetTypeCheckboxesToNone();
            performSearch(p=>p['æ–½å·¥å» å•†']?.trim()===this.value, `å» å•†ï¼š${this.value}`); updateContractorStats(this.value); 
        } else { clearSearchResults(); } 
    });

    const sortedT = Array.from(ALL_TIMINGS).sort();
    tSel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ´¾å·¥æ™‚æ©Ÿ --</option>' + sortedT.map(t => `<option value="${t}">${t}</option>`).join('');
    tSel.addEventListener('change', function() {
        if(this.value) {
            document.getElementById('keywordInput').value=''; 
            document.getElementById('villageSelect').value=''; 
            document.getElementById('contractorSelect').value=''; 
            resetTypeCheckboxesToNone();
            performSearch(p=>p['æ´¾å·¥æ™‚æ©Ÿ']?.trim()===this.value, `æ´¾å·¥æ™‚æ©Ÿï¼š${this.value}`);
        } else { clearSearchResults(); } 
    });
    renderTypeCheckboxes();
}

function resetTypeCheckboxesToNone() {
    const allCb = document.getElementById('typeSelectAll');
    if(allCb) {
        allCb.checked = false;
        const checkboxes = document.querySelectorAll('.type-filter-cb');
        checkboxes.forEach(cb => cb.checked = false);
        const label = document.getElementById('typeFilterLabel');
        if(label) label.innerText = `è«‹é¸æ“‡ç¶­ä¿®é¡å‹ (æœªé¸)`;
    }
}

function updateContractorStats(contractorName) {
    const statsResult = document.getElementById('contractorStatsResult'), genList = document.getElementById('contractorGenList'), emgList = document.getElementById('contractorEmgList');
    genList.innerHTML = ''; emgList.innerHTML = '';
    if (!contractorName) { statsResult.style.display = 'none'; return; }
    let globalYearTotals = {}, globalProcessedCases = new Set();
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if (!data || !data.features) return;
        const yearMatch = conf.label.match(/(\d{3})å¹´/); const year = yearMatch ? yearMatch[1] : 'å…¶ä»–'; const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
        if (!globalYearTotals[year]) globalYearTotals[year] = { gen: 0, emg: 0 };
        data.features.forEach(f => {
            const props = f.properties, caseNo = props['æ¡ˆä»¶ç·¨è™Ÿ'], amount = formatMoney(props['æ±ºæ¨™é‡‘é¡']);
            if (caseNo && caseNo.trim() !== "") { if (!globalProcessedCases.has(caseNo)) { globalProcessedCases.add(caseNo); if (isEmergency) globalYearTotals[year].emg += amount; else globalYearTotals[year].gen += amount; } } else { if (isEmergency) globalYearTotals[year].emg += amount; else globalYearTotals[year].gen += amount; }
        });
    });
    let contractorYearStats = {}, contractorProcessedCases = new Set();
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if (!data || !data.features) return;
        const yearMatch = conf.label.match(/(\d{3})å¹´/); const year = yearMatch ? yearMatch[1] : 'å…¶ä»–'; const isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(conf.label);
        if (!contractorYearStats[year]) contractorYearStats[year] = { genCount: 0, genAmount: 0, emgCount: 0, emgAmount: 0 };
        data.features.forEach(f => {
            if (f.properties['æ–½å·¥å» å•†']?.trim() === contractorName) {
                const props = f.properties, caseNo = props['æ¡ˆä»¶ç·¨è™Ÿ'], amount = formatMoney(props['æ±ºæ¨™é‡‘é¡']);
                let shouldAdd = false; if (caseNo && caseNo.trim() !== "") { if (!contractorProcessedCases.has(caseNo)) { contractorProcessedCases.add(caseNo); shouldAdd = true; } } else { shouldAdd = true; }
                if (shouldAdd) { if (isEmergency) { contractorYearStats[year].emgCount++; contractorYearStats[year].emgAmount += amount; } else { contractorYearStats[year].genCount++; contractorYearStats[year].genAmount += amount; } }
            }
        });
    });
    const sortedYears = Object.keys(contractorYearStats).sort().reverse();
    sortedYears.forEach(y => {
        const stats = contractorYearStats[y], globalTotals = globalYearTotals[y] || { gen: 1, emg: 1 };
        if (stats.genCount > 0) { const pct = globalTotals.gen > 0 ? (stats.genAmount / globalTotals.gen * 100).toFixed(0) : 0; genList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}å¹´åº¦</span><span class="stat-percent-text">å¸‚ä½” ${pct}%</span></div><div class="stat-data-row">${stats.genCount} ä»¶ / $ ${stats.genAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`; }
        if (stats.emgCount > 0) { const pct = globalTotals.emg > 0 ? (stats.emgAmount / globalTotals.emg * 100).toFixed(0) : 0; emgList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}å¹´åº¦</span><span class="stat-percent-text">å¸‚ä½” ${pct}%</span></div><div class="stat-data-row">${stats.emgCount} ä»¶ / $ ${stats.emgAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`; }
    });
    if (genList.innerHTML === '') genList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">ç„¡è³‡æ–™</div>';
    if (emgList.innerHTML === '') emgList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">ç„¡è³‡æ–™</div>';
    statsResult.style.display = 'block';
}
document.getElementById('clearContractorStatsBtn').addEventListener('click', clearSearchResults);

async function performSearch(predicate, label) {
    const status = document.getElementById('searchStatus'), btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; status.innerText = 'æœå°‹ä¸­...'; searchResultLayer.clearLayers();
    let count = 0;
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if(!data || !data.features) return;
        data.features.forEach(f => {
            try {
                if(f.geometry.type !== 'Point') return;
                if(predicate(f.properties)) {
                    const [lng, lat] = f.geometry.coordinates; const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6, interactive: false }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.customData = { configLabel: conf.label, props: f.properties };
                    marker.on('click', (e) => handleNearbyMarkerClick(e, searchResultLayer.getLayers()));
                    marker.feature = f; 
                    count++;
                }
            } catch(e){}
        });
    });
    if(count > 0) { map.fitBounds(searchResultLayer.getBounds()); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); status.innerHTML = `æ‰¾åˆ° <b style="color:#d32f2f">${count}</b> ç­†`; document.getElementById('clearSearchBtn').style.display = 'block'; } 
    else status.innerHTML = '<span style="color:red">æŸ¥ç„¡è³‡æ–™</span>';
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-search"></i> é–‹å§‹æœå°‹';
    if(clusterToggle.checked) setTimeout(calculateClusters, 100);
}
document.getElementById('searchBtn').addEventListener('click', () => {
    const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
    if(!kw) return alert('è«‹è¼¸å…¥é—œéµå­—');
    document.getElementById('contractorSelect').value = ''; document.getElementById('villageSelect').value = ''; 
    document.getElementById('timingSelect').value = ''; 
    resetTypeCheckboxesToNone();
    document.getElementById('contractorStatsResult').style.display = 'none';
    performSearch(p => Object.values(p).join(' ').toLowerCase().includes(kw), kw);
});
document.getElementById('clearSearchBtn').addEventListener('click', clearSearchResults);
function clearSearchResults() { 
    searchResultLayer.clearLayers(); 
    document.getElementById('keywordInput').value = ''; 
    document.getElementById('contractorSelect').value = ''; 
    document.getElementById('villageSelect').value = ''; 
    document.getElementById('timingSelect').value = ''; 
    resetTypeCheckboxesToNone();
    document.getElementById('searchStatus').innerText = ''; 
    document.getElementById('clearSearchBtn').style.display = 'none'; 
    document.getElementById('contractorStatsResult').style.display = 'none'; 
}
document.getElementById('roadSelect').addEventListener('change', (e) => handleMapClickSelection(e.target.value, false));
function handleMapClickSelection(idx, isInteractive) {
    if(idx==="" || idx===null) return; if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
    const target = roadLayersArray[idx];
    if(target) {
        target.setStyle({ color: 'red', weight: 6 }); map.fitBounds(target.getBounds()); target.openPopup();
        if (isInteractive) { document.getElementById('panelTitle').innerHTML = `<i class="fas fa-history"></i> ${target.feature.properties.name}`; bottomPanel.classList.remove('minimized'); panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up'); bottomPanel.classList.add('open'); showTimeline(target); } 
        else { bottomPanel.classList.remove('open'); routeMatchLayer.clearLayers(); }
    }
}
map.on('click', (e) => {
    if(isMeasuring) { if(measureStartLatLng) finishMeasure(e.latlng); } 
    else { 
        document.getElementById('contextMenu').style.display='none'; 
        document.getElementById('roadSelect').value = ""; 
        if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({ color: DEEP_BLUE, weight: 3 })); 
        map.closePopup(); 
        bottomPanel.classList.remove('open'); 
        routeMatchLayer.clearLayers(); 
        selectedTimelineMarker = null; 
    }
});
const ctxMenu = document.getElementById('contextMenu'); let clickedLatLng = null;
map.on('contextmenu', (e) => {
    ctxMenu.style.display = 'none'; pointLayer.clearLayers(); measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring'); measureStartLatLng = null;
    const latlng = e.latlng; const twd = twd97FromWgs84(latlng.lat, latlng.lng); const villageName = getVillageName(latlng.lat, latlng.lng);
    const popupContent = `<div style="font-weight:bold; color:#004080; margin-bottom:5px;">ä½ç½®è³‡è¨Š</div><div style="font-size:13px;">TWD97: ${twd.x}, ${twd.y}</div><div style="font-size:13px;">WGS84: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</div><div style="font-size:13px;">è¡Œæ”¿å€: ${villageName}</div><div style="font-size:12px; color:#666; margin-top:5px;">(å†é»å³éµé–‹å•ŸåŠŸèƒ½é¸å–®;æ‰‹æ©Ÿä»‹é¢é•·æŒ‰å¯é–‹å•Ÿ)</div>`;
    const marker = L.marker(latlng, { draggable: true }).addTo(pointLayer); marker.bindPopup(popupContent).openPopup();
    marker.on('contextmenu', (ev) => { L.DomEvent.stopPropagation(ev); clickedLatLng = ev.latlng; openCtxMenu(ev.originalEvent); });
});
function openCtxMenu(nativeEvent) { ctxMenu.style.display = 'block'; ctxMenu.style.left = nativeEvent.clientX + 'px'; ctxMenu.style.top = nativeEvent.clientY + 'px'; }
document.getElementById('ctxStreetView').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxGoogleNav').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxCadastral').onclick = () => { if(clickedLatLng) window.open(`https://maps.nlsc.gov.tw/go/${clickedLatLng.lng}/${clickedLatLng.lat}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxClearMarker').onclick = () => { pointLayer.clearLayers(); measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring'); measureStartLatLng = null; ctxMenu.style.display='none'; }
document.getElementById('ctxMeasure').onclick = () => { ctxMenu.style.display = 'none'; startMeasure(clickedLatLng); };
function startMeasure(latlng) { isMeasuring = true; measureStartLatLng = latlng; document.body.classList.add('measuring'); L.circleMarker(latlng, {color: 'green', radius: 5, fillOpacity: 1}).addTo(measureLayer); }
function finishMeasure(endLatLng) {
    if(!isMeasuring || !measureStartLatLng) return; const dist = measureStartLatLng.distanceTo(endLatLng).toFixed(1); if(dist == 0) return;
    const line = L.polyline([measureStartLatLng, endLatLng], {color: 'red', weight: 3}).addTo(measureLayer);
    const centerLat = (measureStartLatLng.lat + endLatLng.lat) / 2; const centerLng = (measureStartLatLng.lng + endLatLng.lng) / 2;
    const icon = L.divIcon({ className: 'measure-label', html: `${dist} m <span class="measure-close-btn" onclick="clearMeasure()">X</span>`, iconSize: [100, 20], iconAnchor: [50, 10] });
    L.marker([centerLat, centerLng], {icon: icon}).addTo(measureLayer); isMeasuring = false; document.body.classList.remove('measuring');
    if(measureLine) map.removeLayer(measureLine); if(measureTooltip) map.removeLayer(measureTooltip); measureLine = null; measureTooltip = null; measureStartLatLng = null;
}
window.clearMeasure = function() { measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring'); }
map.on('mousemove', e => {
    if(window.innerWidth > 768) { const t = twd97FromWgs84(e.latlng.lat, e.latlng.lng); const el = document.getElementById('floatingCoords'); el.style.display = 'block'; el.innerHTML = `TWD97: ${t.x}, ${t.y}`; }
    if(isMeasuring && measureStartLatLng) {
        if(measureLine) measureLine.setLatLngs([measureStartLatLng, e.latlng]); else measureLine = L.polyline([measureStartLatLng, e.latlng], {color: 'red', dashArray: '5, 10'}).addTo(map);
        const dist = measureStartLatLng.distanceTo(e.latlng).toFixed(1);
        if(measureTooltip) measureTooltip.setLatLng(e.latlng).setContent(`${dist} m`); else measureTooltip = L.tooltip({permanent:true, direction:'right'}).setLatLng(e.latlng).setContent(`${dist} m`).addTo(map);
    }
});
document.getElementById('toggleMapBtn').onclick = function() { if(isSat) { map.removeLayer(sat); osm.addTo(map); this.classList.remove('active'); } else { map.removeLayer(osm); sat.addTo(map); this.classList.add('active'); } isSat = !isSat; };
document.getElementById('toggleCadastralBtn').onclick = function() { if(isCadastralVisible) { map.removeLayer(cadastralLayer); this.classList.remove('active'); } else { cadastralLayer.addTo(map); this.classList.add('active'); } isCadastralVisible = !isCadastralVisible; };
document.getElementById('plotBtn').onclick = () => {
    pointLayer.clearLayers(); const input = document.getElementById('coordsInput').value.trim(); if (!input) return;
    const lines = input.split(/\r?\n/).filter(line => line.trim() !== ''); const bounds = L.latLngBounds(); let markerCount = 0;
    lines.forEach(line => {
        const parts = line.trim().split(/[, \t]+/).filter(p => p !== '');
        if (parts.length >= 2) {
            const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
            if (!isNaN(x) && !isNaN(y)) {
                try {
                    const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]); const latlng = L.latLng(w[1], w[0]); const villageName = getVillageName(w[1], w[0]);
                    L.marker(latlng).addTo(pointLayer).bindPopup(`X:${x}, Y:${y}<br>è¡Œæ”¿å€: ${villageName}`); markerCount++; bounds.extend(latlng);
                } catch (e) { console.error("Coordinate conversion error:", e); }
            }
        }
    });
    if (markerCount > 0) { if (markerCount === 1) { map.setView(bounds.getCenter(), 16); pointLayer.getLayers()[0].openPopup(); } else { map.fitBounds(bounds, { padding: [50, 50] }); } } else { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ TWD97 åº§æ¨™ï¼Œæ ¼å¼ç‚º X,Y (æ¯è¡Œä¸€çµ„)'); }
};
document.getElementById('plotDengueBtn').onclick = () => {
    dengueLayer.clearLayers(); const val = document.getElementById('dengueCoordsInput').value.trim(); if(!val) return;
    const lines = val.split(/\r?\n/);
    lines.forEach(line => {
        const parts = line.split(/[, \t]+/);
        if(parts.length>=2) {
            const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
            if(!isNaN(x)&&!isNaN(y)) {
                const w = proj4('EPSG:3826','EPSG:4326',[x,y]);
                const icon = L.divIcon({ className: 'custom-div-icon', html: "<div class='gray-dot-marker'></div>", iconSize: [14, 14], iconAnchor: [7, 7] });
                L.marker([w[1],w[0]], {icon: icon}).addTo(dengueLayer).bindPopup(`ç¢ºè¨ºæˆ¶åº§æ¨™: ${x}, ${y}`); map.setView([w[1],w[0]], 16);
            }
        }
    });
};
document.getElementById('clearDengueBtn').onclick = () => { dengueLayer.clearLayers(); dengueRadiusLayer.clearLayers(); document.getElementById('dengueCoordsInput').value=''; document.querySelectorAll('input[name="dengueRadius"]').forEach(r => r.checked = false); };
document.getElementById('clearBtn').onclick = () => { pointLayer.clearLayers(); document.getElementById('coordsInput').value=''; };
document.getElementById('clearRepairBtn').addEventListener('click', () => {
    if(markersClusterGroup) { markersClusterGroup.clearLayers(); map.removeLayer(markersClusterGroup); markersClusterGroup = null; }
    activeRepairLayers = []; document.getElementById('clusterControlPanel').style.display = 'none'; document.getElementById('toggleClusterControlBtn').classList.remove('active');
    document.querySelectorAll('.repair-cb').forEach(cb => cb.checked = false); document.querySelectorAll('.year-select-all input').forEach(cb => cb.checked = false);
    searchResultLayer.clearLayers(); document.getElementById('keywordInput').value = ''; document.getElementById('contractorSelect').value = ''; document.getElementById('villageSelect').value = ''; document.getElementById('searchStatus').innerText = ''; document.getElementById('clearSearchBtn').style.display = 'none';
    pointLayer.clearLayers(); measureLayer.clearLayers(); document.getElementById('coordsInput').value = '';
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3})); document.getElementById('roadSelect').value = "";
    clusterLayer.clearLayers(); if(clusterToggle.checked) clusterToggle.checked = false;
    dengueLayer.clearLayers(); dengueRadiusLayer.clearLayers(); document.getElementById('dengueCoordsInput').value = ''; document.querySelectorAll('input[name="dengueRadius"]').forEach(r => r.checked = false);
    bottomPanel.classList.remove('open'); map.closePopup();
    
    // Clear AI layer if active
    if(document.getElementById('aiRiskToggle').checked) {
        document.getElementById('aiRiskToggle').checked = false;
        aiRiskLayer.clearLayers();
        document.getElementById('aiDashboard').style.display = 'none';
    }
});
const clusterToggle = document.getElementById('clusterToggle'), clusterSlider = document.getElementById('clusterSlider'), clusterValue = document.getElementById('clusterValue');
clusterToggle.addEventListener('change', () => { if(clusterToggle.checked) calculateClusters(); else clusterLayer.clearLayers(); });
clusterSlider.addEventListener('input', () => { clusterValue.innerText = `${clusterSlider.value}m`; if(clusterToggle.checked) { clearTimeout(window.clusterTimer); window.clusterTimer = setTimeout(calculateClusters, 100); } });
function calculateClusters() {
    clusterLayer.clearLayers(); if(!clusterToggle.checked) return; const radius = parseInt(clusterSlider.value); if(radius === 0) return; document.body.style.cursor = 'wait';
    setTimeout(() => {
        try {
            const points = [];
            activeRepairLayers.forEach(marker => { if(marker.feature && marker.feature.geometry.type === 'Point') points.push(marker.feature); });
            searchResultLayer.eachLayer(layer => { if(layer.feature && layer.feature.geometry.type === 'Point') points.push(layer.feature); });
            if(points.length === 0) { alert("âš ï¸ å°šæœªè¼‰å…¥ä»»ä½•æ¡ˆä»¶è³‡æ–™ï¼\n\nè«‹å…ˆè‡³ã€Œé€æ˜ã€åˆ†é å‹¾é¸å¹´åº¦ï¼Œ\næˆ–è‡³ã€Œæœå°‹ã€åˆ†é æŸ¥è©¢æ¡ˆä»¶å¾Œï¼Œ\nå†ä¾†åŸ·è¡Œç©ºé–“åˆ†æã€‚"); clusterToggle.checked = false; document.body.style.cursor = 'default'; return; }
            const fc = turf.featureCollection(points); const buffered = turf.buffer(fc, radius / 1000, {units: 'kilometers', steps: 10});
            let resultGeoJSON = null; try { if (buffered.features.length > 0) { let merged = buffered.features[0]; for (let i = 1; i < buffered.features.length; i++) merged = turf.union(merged, buffered.features[i]); resultGeoJSON = merged; } } catch (unionError) { resultGeoJSON = buffered; }
            if (resultGeoJSON) { const layer = L.geoJSON(resultGeoJSON, { style: { color: 'none', weight: 0, fillColor: '#d32f2f', fillOpacity: 0.3 }, interactive: false }).addTo(clusterLayer); layer.bringToBack(); }
        } catch (e) { console.error(e); } finally { document.body.style.cursor = 'default'; }
    }, 50);
}
document.getElementById('repairCheckboxes').addEventListener('change', () => { if(clusterToggle.checked) { clearTimeout(window.clusterTimer); window.clusterTimer = setTimeout(calculateClusters, 200); } });
function formatMoney(val) { if (!val) return 0; return parseInt(val.toString().replace(/,/g, '')) || 0; }
function getDateDiffDays(dateStr1, dateStr2) {
    if (!dateStr1 || dateStr1.length < 7 || !dateStr2 || dateStr2.length < 7) return 9999;
    const s1 = String(dateStr1), s2 = String(dateStr2); // å¼·åˆ¶è½‰å‹ï¼Œé¿å…æ•¸å­—æ ¼å¼å´©æ½°
    const d1 = new Date(parseInt(s1.substring(0,3))+1911, parseInt(s1.substring(3,5))-1, parseInt(s1.substring(5,7)));
    const d2 = new Date(parseInt(s2.substring(0,3))+1911, parseInt(s2.substring(3,5))-1, parseInt(s2.substring(5,7)));
    return Math.ceil(Math.abs(d1 - d2) / (1000 * 60 * 60 * 24)); 
}

function showTimeline(routeLayer) {
    const cont = document.getElementById('timelineContainer'), filterBar = document.getElementById('timelineFilterBar');
    cont.innerHTML = '<div style="padding:20px;">è®€å–ä¸­...</div>'; routeMatchLayer.clearLayers();
    
    const routeLine = routeLayer.toGeoJSON().geometry; 
    currentRouteAllMatches = [];
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if(!data) return;
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const pt = turf.point(f.geometry.coordinates); 
            const dist = turf.pointToLineDistance(pt, routeLine, {units:'meters'});
            if(dist <= 50) {
                 const pLatLng = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
                 const globalMinDist = distToRoad(pLatLng, roadsLayer);
                 if ((dist - globalMinDist) <= 1.0) {
                     currentRouteAllMatches.push({ label: conf.label, props: f.properties, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0], dist });
                 }
            }
        });
    });

    filterBar.innerHTML = '<span class="filter-label"><i class="fas fa-filter"></i> ç¯©é¸ï¼š</span>';

    const getUniqueValues = (data, key) => {
        const set = new Set();
        data.forEach(item => {
            let val = key === 'label' ? item.label : item.props[key];
            if(val) set.add(val.toString().trim());
        });
        return Array.from(set).sort().reverse();
    };

    const years = getUniqueValues(currentRouteAllMatches, 'label');
    const timings = getUniqueValues(currentRouteAllMatches, 'æ´¾å·¥æ™‚æ©Ÿ');
    const types = getUniqueValues(currentRouteAllMatches, 'æ¶ä¿®é¡å‹');

    const createSelect = (options, placeholder, onChange) => {
        const sel = document.createElement('select');
        sel.className = 'timeline-select-pill';
        const def = document.createElement('option');
        def.value = 'all'; def.textContent = placeholder;
        sel.appendChild(def);
        options.forEach(opt => {
            const o = document.createElement('option');
            o.value = opt; o.textContent = opt;
            sel.appendChild(o);
        });
        sel.addEventListener('change', onChange);
        return sel;
    };

    const selYear = createSelect(years, 'å¹´åº¦/æ¡ˆä»¶ä¾†æº (å…¨é¸)', filterData);
    const selTiming = createSelect(timings, 'æ´¾å·¥æ™‚æ©Ÿ (å…¨é¸)', filterData);
    const selType = createSelect(types, 'æ¶ä¿®é¡å‹ (å…¨é¸)', filterData);

    filterBar.appendChild(selYear);
    filterBar.appendChild(selTiming);
    filterBar.appendChild(selType);

    function filterData() {
        const vYear = selYear.value;
        const vTiming = selTiming.value;
        const vType = selType.value;

        const filtered = currentRouteAllMatches.filter(m => {
            const matchYear = (vYear === 'all') || (m.label === vYear);
            const matchTiming = (vTiming === 'all') || (m.props['æ´¾å·¥æ™‚æ©Ÿ'] === vTiming);
            const matchType = (vType === 'all') || (m.props['æ¶ä¿®é¡å‹'] === vType);
            return matchYear && matchTiming && matchType;
        });
        renderTimeline(filtered);
    }

    renderTimeline(currentRouteAllMatches);
}

function renderTimeline(matches) {
    const cont = document.getElementById('timelineContainer'), statsDiv = document.getElementById('timelineStats');
    
    cont.innerHTML = '';
    routeMatchLayer.clearLayers(); 
    selectedTimelineMarker = null; 

    if(matches.length === 0) { cont.innerHTML = '<div style="padding:20px;">ç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„ç´€éŒ„</div>'; statsDiv.innerHTML = 'ç¸½èŠ±è²»ï¼š<span>$0</span> | ç¶­ä¿®ï¼š<span>0 æ¬¡</span>'; return; }
    
    matches.sort((a,b) => String(b.props['å®Œå·¥æ—¥æœŸ']||'').localeCompare(String(a.props['å®Œå·¥æ—¥æœŸ']||'')));
    
    let totalCost = 0, genCost = 0, genCount = 0, emgCost = 0, emgCount = 0, processedCases = new Set();
    
    try {
        matches.forEach(m => {
            const caseNo = m.props['æ¡ˆä»¶ç·¨è™Ÿ'], money = formatMoney(m.props['æ±ºæ¨™é‡‘é¡']), labelName = String(m.label || ""), isEmergency = /æ¶ä¿®|ç½å®³|ç·Šæ€¥/.test(labelName);
            if(isEmergency) emgCount++; else genCount++;
            let shouldAdd = false; if (caseNo && !processedCases.has(caseNo)) { processedCases.add(caseNo); shouldAdd = true; } else if (!caseNo) { shouldAdd = true; }
            if (shouldAdd) { totalCost += money; if(isEmergency) emgCost += money; else genCost += money; }
        });
        const totalHtml = `<span style="color:#ffeb3b; font-weight:bold;">ç¸½è¨ˆ $${totalCost.toLocaleString()} (${matches.length}æ¬¡)</span>`;
        const genHtml = `<span style="color:#b3e5fc;">ä¸€èˆ¬ $${genCost.toLocaleString()} (${genCount}æ¬¡)</span>`;
        const emgHtml = `<span style="color:#ffcdd2;">æ¶ä¿® $${emgCost.toLocaleString()} (${emgCount}æ¬¡)</span>`;
        statsDiv.innerHTML = `${totalHtml} <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> ${genHtml} <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> ${emgHtml}`;

        const normalStyle = { radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 };
        const highlightStyle = { radius: 20, color:'#ffd700', weight:4, fillColor:'#d32f2f' };

        matches.forEach((m, i) => {
            const marker = L.circleMarker([m.lat, m.lng], normalStyle).addTo(routeMatchLayer);
            marker.customData = { configLabel: m.label, props: m.props };
            marker.on('click', (e) => handleNearbyMarkerClick(e, routeMatchLayer.getLayers()));
            
            const popupContent = createPopup({
                fileName: m.label,
                props: m.props,
                lat: m.lat,
                lng: m.lng,
                dist: m.dist
            });

            const labelName = String(m.label || ""); 
            const amount = formatMoney(m.props['æ±ºæ¨™é‡‘é¡']); 
            let sizeClass = 'dot-sm'; if (amount > 5000000) sizeClass = 'dot-lg'; else if (amount > 1000000) sizeClass = 'dot-md'; 
            
            let isFrequent = false; 
            if (i < matches.length - 1) { 
                const nextItem = matches[i+1]; 
                if(nextItem && nextItem.props) {
                    const days = getDateDiffDays(m.props['å®Œå·¥æ—¥æœŸ'], nextItem.props['å®Œå·¥æ—¥æœŸ']); 
                    if (days < 180) isFrequent = true; 
                }
            }
            const alertClass = isFrequent ? 'alert-right' : '';
            const item = document.createElement('div'); item.className = `h-item ${alertClass}`;
            item.innerHTML = `<div class="h-date">${m.props['å®Œå·¥æ—¥æœŸ']||'æœªçŸ¥'}</div><div class="h-line-container"><div class="h-dot ${sizeClass}"></div></div><div class="h-badge ${labelName.includes('æ¶ä¿®')||labelName.includes('ç½å®³')||labelName.includes('ç·Šæ€¥') ? 'badge-urgent' : 'badge-normal'}">${labelName.includes('æ¶ä¿®')||labelName.includes('ç½å®³')||labelName.includes('ç·Šæ€¥') ? 'æ¶ä¿®' : 'ä¸€èˆ¬'}</div>`;
            
            item.addEventListener('mouseenter', () => { 
                const photoUrls = getPhotosFromProps(m.props);
                preloadImages(photoUrls);

                if (selectedTimelineMarker === marker) return; 
                marker.setStyle(highlightStyle); 
                marker.bringToFront(); 
                
                if(!marker._tempPopup) {
                    marker._tempPopup = L.popup({ className: 'custom-popup', maxWidth: 960, offset: [0, -10], closeButton: false })
                        .setLatLng([m.lat, m.lng])
                        .setContent(popupContent);
                }
                marker._tempPopup.openOn(map);
            });
            
            item.addEventListener('mouseleave', () => { 
                if (selectedTimelineMarker === marker) return; 
                marker.setStyle(normalStyle); 
                if(marker._tempPopup) {
                    map.closePopup(marker._tempPopup);
                    marker._tempPopup = null;
                }
                if(selectedTimelineMarker && selectedTimelineMarker._lockedPopup) {
                    selectedTimelineMarker._lockedPopup.openOn(map);
                }
            });

            item.addEventListener('click', (e) => {
                e.stopPropagation(); 
                if (selectedTimelineMarker && selectedTimelineMarker !== marker) {
                     selectedTimelineMarker.setStyle(normalStyle);
                     if(selectedTimelineMarker._lockedPopup) map.closePopup(selectedTimelineMarker._lockedPopup);
                }
                selectedTimelineMarker = marker; 
                marker.setStyle(highlightStyle);
                marker.bringToFront();
                
                if(!marker._lockedPopup) {
                    marker._lockedPopup = L.popup({ className: 'custom-popup', maxWidth: 960, offset: [0, -10] })
                        .setLatLng([m.lat, m.lng])
                        .setContent(popupContent);
                }
                marker._lockedPopup.openOn(map);
                map.flyTo([m.lat, m.lng], 18);
            });
            cont.appendChild(item);
        });
    } catch(err) {
        console.error("Timeline render error:", err);
        cont.innerHTML = '<div style="padding:20px; color:red;">é¡¯ç¤ºå¤±æ•—ï¼šè³‡æ–™æ ¼å¼æœ‰èª¤</div>';
    }
}
function updateDengueRadius() {
    dengueRadiusLayer.clearLayers(); const radios = document.getElementsByName('dengueRadius'); let r = 0;
    for(let i=0; i<radios.length; i++){ if(radios[i].checked) r = parseInt(radios[i].value); }
    if(r === 0) return; dengueLayer.eachLayer(marker => { L.circle(marker.getLatLng(), { radius: r, color: 'none', fillColor: '#ff9800', fillOpacity: 0.3 }).addTo(dengueRadiusLayer); });
}

map.on('popupopen', function(e) {
    var content = e.popup.getContent();
    var latlng = e.popup.getLatLng();
    sessionStorage.setItem('savedPopup', JSON.stringify({
        lat: latlng.lat,
        lng: latlng.lng,
        content: content,
        zoom: map.getZoom()
    }));
});

map.on('popupclose', function(e) {
    sessionStorage.removeItem('savedPopup');
});

window.addEventListener('load', function() {
    setTimeout(function(){
        var saved = sessionStorage.getItem('savedPopup');
        if(saved) {
            try {
                var data = JSON.parse(saved);
                map.setView([data.lat, data.lng], data.zoom || 18);
                L.popup({className:'custom-popup', maxWidth:960})
                 .setLatLng([data.lat, data.lng])
                 .setContent(data.content)
                 .openOn(map);
            } catch(e) {
                console.error("Restore popup failed", e);
            }
        }
    }, 500); 
});

window.jumpToSpecificSibling = function(caseId, targetLat, targetLng) {
    const allLayers = [...activeRepairLayers, ...searchResultLayer.getLayers()];
    const target = allLayers.find(m => {
        const p = m.getLatLng();
        return Math.abs(p.lat - targetLat) < 0.000001 && 
               Math.abs(p.lng - targetLng) < 0.000001 && 
               m.customData && m.customData.props &&
               m.customData.props['æ¡ˆä»¶ç·¨è™Ÿ'] === caseId;
    });
    
    if(target) {
        map.flyTo(target.getLatLng(), 18, { duration: 1.5 });
        map.once('moveend', function() {
            openDetailPopupFromMarker(target);
        });
    }
};

/* ==========================================
   AI é“è·¯å¥åº·é¢¨éšªé æ¸¬æ¨¡çµ„ (Client-side JSç‰ˆ)
   Updated in v.Dash with Dashboard & New Visuals
   ========================================== */
const aiRiskLayer = L.layerGroup().addTo(map);
let aiRiskData = []; // Store results for dashboard

async function toggleAiRiskLayer(checkbox) {
    aiRiskLayer.clearLayers();
    aiRiskData = [];
    const loading = document.getElementById('aiLoading');
    const dashboard = document.getElementById('aiDashboard');
    
    if (!checkbox.checked) {
        loading.style.display = 'none';
        dashboard.style.display = 'none';
        return;
    }

    if (activeRepairLayers.length === 0) {
        alert("ç³»çµ±æç¤ºï¼š\nç›®å‰åœ°åœ–ä¸Šæ²’æœ‰è¼‰å…¥ä»»ä½•ç¶­ä¿®æ¡ˆä»¶ã€‚\n\nè«‹å…ˆè‡³ã€Œé€æ˜ã€åˆ†é å‹¾é¸å¹´ä»½ï¼Œæˆ–è¼‰å…¥è³‡æ–™å¾Œå†åŸ·è¡Œ AI é æ¸¬ã€‚");
        checkbox.checked = false;
        return;
    }

    loading.style.display = 'block';
    dashboard.style.display = 'none';
    
    setTimeout(() => {
        runAiRiskAnalysis();
        loading.style.display = 'none';
        dashboard.style.display = 'block';
        updateAiDashboard('all'); // Initialize dashboard
    }, 100);
}

function runAiRiskAnalysis() {
    const points = activeRepairLayers.map(layer => {
        if (layer.feature && layer.feature.geometry.type === 'Point') {
            return layer.feature;
        }
        return null;
    }).filter(p => p !== null);

    const ANALYSIS_RADIUS = 0.05; // 50 meters
    const processedCenters = []; 
    let riskCount = 0;

    points.forEach(point => {
        const center = turf.point(point.geometry.coordinates);
        
        const isOverlap = processedCenters.some(pc => turf.distance(center, pc) < 0.03); 
        if (isOverlap) return;

        const neighbors = points.filter(p => {
            const target = turf.point(p.geometry.coordinates);
            return turf.distance(center, target) <= ANALYSIS_RADIUS;
        });

        if (neighbors.length < 2) return;

        let riskScore = 0;
        let treeTrimCount = 0;
        let roadFixCount = 0;
        let recentCaseCount = 0;
        const now = new Date();

        // é—œéµå­—åº« (Road/Civil)
        const kwRoad = ['AC','PC','ç€é’','æ··å‡åœŸ','å‘æ´','ä¸‹é™·','æ²‰é™·','æç©º','è£‚ç¸«','ç ´è£‚','é‹ªè¨­','ä¿®è£œ','å¡«è£œ','è·¯ç·£','æ“‹åœŸç‰†'];
        // é—œéµå­—åº« (Tree/Veg)
        const kwTree = ['æ¨¹','ç«¹','è‰','æ','è‘‰','è•‰','é‹¸é™¤','æ¸…é‹','å€’ä¼','ä¿®å‰ª'];
        // é—œéµå­—åº« (Water)
        const kwWater = ['æ’æ°´','æ¸…æ·¤','æº','æ²™åŒ…','æŠ½æ°´','ç©æ°´','æ³¥æ¿˜','åœŸçŸ³'];

        neighbors.forEach(n => {
            const props = n.properties;
            const name = (props['å·¥ç¨‹åç¨±'] || '').toString();
            const type = (props['æ¶ä¿®é¡å‹'] || '').toString();
            const fullText = name + type;
            const dateStr = (props['å®Œå·¥æ—¥æœŸ'] || '').toString().trim();
            
            // Classification
            let isTree = kwTree.some(k => fullText.includes(k));
            let isRoad = kwRoad.some(k => fullText.includes(k));
            
            if (isTree) treeTrimCount++;
            else roadFixCount++; // Default to road if ambiguous but grouped

            // Risk Weights
            if (fullText.includes('å‘æ´') || fullText.includes('æ²‰é™·') || fullText.includes('æç©º') || fullText.includes('ä¸‹é™·')) {
                riskScore += 2;
            } else {
                riskScore += 1;
            }

            // Time Weight
            if (dateStr.length === 7) {
                const y = parseInt(dateStr.substring(0, 3)) + 1911;
                const m = parseInt(dateStr.substring(3, 5)) - 1;
                const d = parseInt(dateStr.substring(5, 7));
                const caseDate = new Date(y, m, d);
                const diffMonths = (now.getFullYear() - caseDate.getFullYear()) * 12 + (now.getMonth() - caseDate.getMonth());
                
                if (diffMonths <= 6) {
                    riskScore += 3; 
                    recentCaseCount++;
                } else if (diffMonths <= 12) {
                    riskScore += 1.5; 
                }
            }
        });

        if (riskScore >= 5 || (neighbors.length >= 3 && recentCaseCount > 0)) {
            const marker = createRiskMarker(center, neighbors.length, treeTrimCount, roadFixCount, recentCaseCount, riskScore);
            processedCenters.push(center);
            
            // Save data for dashboard
            aiRiskData.push({
                marker: marker,
                score: riskScore,
                total: neighbors.length,
                tree: treeTrimCount,
                road: roadFixCount,
                recent: recentCaseCount,
                lat: center.geometry.coordinates[1],
                lng: center.geometry.coordinates[0]
            });
            riskCount++;
        }
    });

    if (riskCount === 0) {
        alert("AI åˆ†æå®Œæˆï¼š\nç›®å‰ç¯„åœå…§ç„¡é¡¯è‘—çš„é«˜é¢¨éšªç¾¤èšç†±é»ã€‚");
    }
}

function createRiskMarker(centerPoint, totalCount, treeCount, roadCount, recentCount, score) {
    const lat = centerPoint.geometry.coordinates[1];
    const lng = centerPoint.geometry.coordinates[0];
    
    let level = "ä¸­åº¦é¢¨éšª";
    let cssClass = "ai-marker-med"; // Orange default
    if (score > 10) {
        level = "æ¥µé«˜é¢¨éšª";
        cssClass = "ai-pulse-marker"; // Purple high risk
    } else if (score > 7) {
        level = "é«˜åº¦é¢¨éšª";
        cssClass = "ai-pulse-marker";
    }

    const icon = L.divIcon({
        className: 'custom-div-icon',
        // ä½¿ç”¨ FontAwesome é›·é”åœ–æ¨™
        html: `<div class="${cssClass}" title="AI é¢¨éšªé è­¦"><i class="fas fa-radiation-alt"></i></div>`,
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });

    // Z-index offset ç¢ºä¿è“‹åœ¨æ™®é€šé»ä¸Šé¢
    const marker = L.marker([lat, lng], { icon: icon, zIndexOffset: 1000 }).addTo(aiRiskLayer);

    let advice = "";
    if (treeCount > roadCount) {
        advice = "æ­¤è™•æ¤è¢«ä¿®å‰ªé »ç¹ï¼Œå»ºè­°æª¢æŸ¥è·¯æ¨¹æ ¹ç³»æ˜¯å¦å½±éŸ¿è·¯åŸº/æ’æ°´ï¼Œæˆ–è©•ä¼°è¡Œé“æ¨¹çŸ®åŒ–/ç§»æ¤å¯è¡Œæ€§ã€‚";
    } else if (recentCount >= 2) {
        advice = "åŠå¹´å…§ç™¼ç”Ÿå¤šæ¬¡é‡è¤‡ç¶­ä¿®ï¼Œé¡¯ç¤ºè©²è™•è·¯åŸºæ¥µä¸ç©©å®šï¼å»ºè­°å®‰æ’é€åœ°é›·é”æª¢æ¸¬æˆ–é–‹æŒ–æª¢è¦–åœ°ä¸‹ç®¡ç·šã€‚";
    } else {
        advice = "æ­¤è™•ç‚ºç¶­ä¿®ç†±å€ï¼Œå»ºè­°ç´å…¥ä¸‹ä¸€å¹´åº¦å„ªå…ˆè·¯å¹³å°ˆæ¡ˆè·¯æ®µã€‚";
    }

    const popupHtml = `
        <div style="width:280px;">
            <div class="ai-report-header">
                <i class="fas fa-robot"></i> AI é“è·¯å¥åº·é¢¨éšªè©•ä¼°
            </div>
            <div class="ai-report-body">
                <div class="ai-stat-row">
                    <span>é¢¨éšªç­‰ç´š</span>
                    <span class="ai-stat-val">${level} (Score: ${score})</span>
                </div>
                <div class="ai-stat-row">
                    <span>ç¯„åœåŠå¾‘</span>
                    <span style="font-family:monospace;">50 å…¬å°ºå…§</span>
                </div>
                <div class="ai-stat-row">
                    <span>ç´¯è¨ˆç¶­ä¿®ç¸½æ•¸</span>
                    <span class="ai-stat-val">${totalCount} æ¬¡</span>
                </div>
                <div class="ai-stat-row">
                    <span>åœŸæœ¨çµæ§‹ä¿®è£œ</span>
                    <span>${roadCount} æ¬¡</span>
                </div>
                <div class="ai-stat-row">
                    <span>ç’°å¢ƒæ¤è¢«è™•ç†</span>
                    <span>${treeCount} æ¬¡</span>
                </div>
                <div class="ai-stat-row">
                    <span>è¿‘åŠå¹´å…§æ¡ˆä»¶</span>
                    <span style="color:${recentCount>0?'red':'#333'}">${recentCount} æ¬¡</span>
                </div>
                
                <div class="ai-advice-box">
                    <strong><i class="fas fa-clipboard-check"></i> é é˜²æ€§æ±ºç­–å»ºè­°ï¼š</strong><br>
                    ${advice}
                </div>
            </div>
        </div>
    `;

    marker.bindPopup(popupHtml, { className: 'custom-popup', maxWidth: 300 });
    return marker;
}

// Dashboard Functions
window.filterAiResults = function(type, btn) {
    // Update active button
    document.querySelectorAll('.ai-filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    updateAiDashboard(type);
};

function updateAiDashboard(filterType) {
    const list = document.getElementById('aiResultList');
    list.innerHTML = '';
    
    // Sort by score desc
    let sorted = [...aiRiskData].sort((a,b) => b.score - a.score);
    
    // Filter
    if (filterType === 'high') sorted = sorted.filter(d => d.score > 10);
    else if (filterType === 'road') sorted = sorted.filter(d => d.road > d.tree);
    else if (filterType === 'tree') sorted = sorted.filter(d => d.tree >= d.road);
    
    // Show on map
    aiRiskLayer.eachLayer(l => l.setOpacity(0)); // Hide all first
    
    sorted.forEach((d, i) => {
        d.marker.setOpacity(1); // Show filtered
        
        const badgeClass = d.score > 10 ? 'badge-high' : 'badge-med';
        const badgeText = d.score > 10 ? 'æ¥µé«˜' : 'ä¸­é«˜';
        const typeText = d.road > d.tree ? 'åœŸæœ¨' : 'æ¤è¢«';
        
        const div = document.createElement('div');
        div.className = 'ai-list-item';
        div.innerHTML = `
            <div>
                <span class="ai-score-badge ${badgeClass}">${badgeText}</span>
                <span style="font-weight:bold; color:#555;">ç†±é» #${i+1}</span>
            </div>
            <div style="text-align:right; color:#666;">
                ${typeText} | ${d.total}æ¬¡ç¶­ä¿®
            </div>
        `;
        div.onclick = () => {
            map.flyTo([d.lat, d.lng], 18);
            setTimeout(() => d.marker.openPopup(), 500);
            if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
        };
        list.appendChild(div);
    });
    
    if(sorted.length === 0) {
        list.innerHTML = '<div style="padding:10px; text-align:center; color:#999;">ç„¡ç¬¦åˆæ¢ä»¶çš„ç†±é»</div>';
    }
}
</script>
</body>
</html>
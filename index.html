<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>臺南市山上區公眾通行道路圖資 (板手圖示藍色版)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  /* === 1. 全局設定 === */
  :root {
    --primary-color: #004080; /* 深藍 */
    --accent-color: #ff9800;  /* 橘黃 */
    --bg-light: #f8faff;
    --text-dark: #333;
    --sidebar-width: 350px;
  }
  body { margin:0; font-family:"Microsoft JhengHei", "Heiti TC", sans-serif; display:flex; height:100vh; overflow:hidden; position: relative; background: var(--bg-light); }
   
  /* === 2. 懸浮漢堡按鈕 === */
  #toggleSidebarBtn {
    position: absolute; top: 10px; 
    left: 360px; 
    width: 40px; height: 40px;
    background: #fff; color: var(--text-dark);
    border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;
    cursor: pointer; z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: left 0.3s ease; 
  }
  #toggleSidebarBtn:hover { background: #f4f4f4; }
  #toggleSidebarBtn i { font-size: 20px; }
  body.collapsed #toggleSidebarBtn { left: 10px; }

  /* === 3. 側邊欄樣式 === */
  #sidebar {
    width: var(--sidebar-width); min-width: var(--sidebar-width);
    background: #fff; border-right: 1px solid #eee;
    display: flex; flex-direction: column;
    z-index: 1500; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    margin-left: 0; transition: margin-left 0.3s ease;
    position: relative;
  }
  body.collapsed #sidebar { margin-left: calc(var(--sidebar-width) * -1); }

  /* 標題與分頁 */
  .sidebar-header { padding: 15px; background: var(--primary-color); color: white; text-align: center; flex-shrink: 0; }
  .sidebar-header h3 { margin: 0; font-size: 16px; font-weight: bold; line-height: 1.4; }
  .tabs-nav { display: flex; background: #eef2f6; padding: 5px 5px 0 5px; flex-shrink: 0; }
  .tab-btn { flex: 1; padding: 10px 0; border: none; background: transparent; cursor: pointer; font-size: 14px; font-weight: bold; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; }
  .tab-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 -2px 5px rgba(0,0,0,0.05); position: relative; top: 1px; }
  .tab-content-container { flex: 1; overflow-y: auto; padding: 15px; background: #fff; position: relative; }
  .tab-pane { display: none; animation: fadeIn 0.3s; }
  .tab-pane.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* 卡片樣式 */
  .card-section { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
  .card-title { font-size: 14px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #f0f0f0; }
  select, textarea, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  
  /* 按鈕樣式 */
  button.primary { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: none; background: var(--primary-color); color: #fff; font-size: 14px; font-weight: bold; }
  button.primary:hover { background: #003366; }
  button.secondary { width: 100%; padding: 8px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #555; font-size: 13px; }
  button.secondary:hover { background: #f5f5f5; }

  /* === 4. 地圖區 === */
  #map { flex: 1; position: relative; z-index: 1; transition: width 0.3s ease; }

  .map-floating-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
  .float-btn { width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; color: #444; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
  .float-btn:hover { background: #f0f0f0; color: var(--primary-color); transform: scale(1.1); }
  .float-btn.active { background: var(--accent-color); color: #000; }
  .float-btn::after { content: attr(data-title); position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .float-btn:hover::after { opacity: 1; }

  /* === 5. 年度摺疊選單 === */
  .year-group { margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
  .year-header { background: #f8fafc; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #475569; user-select: none; }
  .year-header:hover { background: #e2e8f0; }
  .year-content { display: none; padding: 8px 12px; background: #fff; border-top: 1px solid #eee; }
  .year-group.open .year-content { display: block; }
  .year-group.open .toggle-icon { transform: rotate(90deg); }
  .toggle-icon { display:inline-block; transition: transform 0.2s; width:12px; margin-right:5px;}
  .year-select-all { font-size: 12px; color: var(--primary-color); cursor: pointer; }
  .checkbox-item { margin-bottom: 6px; display: flex; align-items: center; gap: 6px; font-size: 13px; }
  .checkbox-item input { margin: 0; accent-color: var(--primary-color); }

  /* === 6. 底部時間軸面板 (板手圖示修正) === */
  #bottomPanel {
      position: absolute; bottom: 0; left: var(--sidebar-width); right: 0; 
      height: 160px; 
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1); z-index: 1400; 
      display: flex; flex-direction: column;
      transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), left 0.3s ease;
      border-top: 1px solid #e0e0e0;
  }
  body.collapsed #bottomPanel { left: 0; } 
  #bottomPanel.open { transform: translateY(0); }
  #bottomPanelHeader { padding: 8px 20px; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  #timelineContainer { flex: 1; overflow-x: auto; padding: 15px 20px; display: flex; align-items: flex-start; gap: 0; }
  
  .h-item { width: 130px; text-align: center; cursor: pointer; position: relative; transition: transform 0.2s; }
  .h-item:hover { transform: translateY(-5px); }
  .h-date { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 8px; }
  
  .h-line-container { position: relative; height: 24px; display: flex; align-items: center; justify-content: center; }
  .h-line-container::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: #ddd; z-index: 0; }
  .h-dot { width: 16px; height: 16px; background: #fff; border: 4px solid var(--primary-color); border-radius: 50%; z-index: 1; position: relative; transition: all 0.2s; }
  .h-item:hover .h-dot { transform: scale(1.4); border-color: var(--accent-color); }
  
  /* === 圖示樣式修正 === */
  .h-icon { 
      margin-top: 8px; font-size: 24px; display: flex; justify-content: center; 
  }
  /* 搶修：使用藍色 (var(--primary-color)) */
  .icon-urgent { color: var(--primary-color); } 
  /* 一般：使用淺藍色 */
  .icon-normal { color: #1976d2; font-size: 18px; }

  /* === 7. 右鍵選單 === */
  #contextMenu { 
      display: none; position: absolute; z-index: 5000; 
      background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
      overflow: hidden; min-width: 160px; border: 1px solid #ddd; 
      top: 0; left: 0;
  }
  .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
  .ctx-item:hover { background: #f5faff; color: var(--primary-color); }

  /* === 8. 泡泡窗 (Popup) === */
  .custom-popup .leaflet-popup-content-wrapper { padding: 0; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
  .custom-popup .leaflet-popup-content { margin: 0; width: 300px !important; }
  .info-header { background: var(--primary-color); color: white; padding: 10px 12px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
  .info-body { padding: 12px; background: #fff; font-size: 14px; color: #333; }
  .info-row { margin-bottom: 6px; display: flex; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
  .info-row:last-of-type { border-bottom: none; }
  .info-label { width: 85px; font-weight: bold; color: #555; flex-shrink: 0; }
  .info-val { color: #222; word-break: break-all; flex: 1; }
  .btn-group-popup { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
  .popup-btn { display: flex; align-items: center; justify-content: center; gap: 5px; background: var(--accent-color); color: #000; padding: 8px; border-radius: 4px; text-decoration: none; font-size: 13px; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.15); transition: background 0.2s; }
  .popup-btn:hover { background: #e68a00; }

  #floatingCoords { position:absolute; pointer-events:none; background:rgba(255,255,255,0.9); border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:11px; display:none; z-index:1300; bottom: 10px; right: 10px; }

  @media (max-width: 768px) {
    #sidebar {
      position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; 
      top: auto; border-radius: 20px 20px 0 0; border-right: none;
      transform: translateY(100%); margin-left: 0; 
    }
    body.sidebar-open #sidebar { transform: translateY(0); }
    #overlay-mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1400; }
    body.sidebar-open #overlay-mask { display: block; }
    
    #toggleSidebarBtn { left: 10px; top: 10px; }
    #bottomPanel { left: 0; height: 180px; z-index: 2100; }
    .map-floating-controls { top: 70px; right: 10px; }
  }
</style>
</head>
<body>

<div id="overlay-mask"></div>
<button id="toggleSidebarBtn" title="切換選單"><i class="fas fa-bars"></i></button>

<div class="map-floating-controls">
    <button class="float-btn" id="locateBtn" data-title="我的位置"><i class="fas fa-crosshairs"></i></button>
    <button class="float-btn" id="toggleMapBtn" data-title="切換衛星/地圖"><i class="fas fa-layer-group"></i></button>
    <button class="float-btn" id="toggleCadastralBtn" data-title="地籍圖開關"><i class="fas fa-map"></i></button>
</div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxStreetView"><i class="fas fa-street-view"></i> Google 街景</div>
    <div class="ctx-item" id="ctxGoogleNav"><i class="fas fa-location-arrow"></i> Google 導航</div>
    <div class="ctx-item" id="ctxClearMarker" style="color:#d32f2f;"><i class="fas fa-trash-alt" style="color:#d32f2f;"></i> 移除標記</div>
</div>

<!-- 底部時間軸 -->
<div id="bottomPanel">
    <div id="bottomPanelHeader">
        <span id="panelTitle"><i class="fas fa-history"></i> 路線維修紀錄</span>
        <button id="closePanelBtn" style="background:none; border:none; color:#fff; font-size:18px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div id="timelineContainer">
        <div style="padding:20px; color:#777;">請點選地圖上的藍色路線以檢視紀錄。</div>
    </div>
</div>

<div id="sidebar">
  <div class="sidebar-header">
      <h3>臺南市山上區<br>公眾通行道路圖資及施工/維修案件透明</h3>
  </div>

  <div class="tabs-nav">
      <button class="tab-btn active" onclick="switchTab('tab-layers')"><i class="fas fa-layer-group"></i> 圖層</button>
      <button class="tab-btn" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> 搜尋</button>
      <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fas fa-tools"></i> 工具</button>
  </div>

  <div id="tab-layers" class="tab-content-container tab-pane active">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-road"></i> 施工/維修案件公告</div>
          <div class="small" style="margin-bottom:8px; color:#666;">勾選年份批次顯示位置 (<span style="color:#004080">●</span>近 / <span style="color:red">●</span>遠)</div>
          <div id="repairCheckboxes" style="max-height:400px; overflow-y:auto;"></div>
          <button class="secondary" id="clearRepairBtn"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>
  </div>

  <div id="tab-search" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-route"></i> 公眾通行道路圖資查詢</div>
          <select id="roadSelect"><option>載入中...</option></select>
      </div>

      <div class="card-section">
          <div class="card-title"><i class="fas fa-search-plus"></i> 案件進階搜尋</div>
          <div class="search-block-label"><i class="fas fa-filter"></i> 依廠商快篩</div>
          <select id="contractorSelect" style="margin-bottom:10px;">
              <option value="">(讀取系統資料中...)</option>
          </select>
          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          <div class="search-block-label"><i class="fas fa-keyboard"></i> 關鍵字搜尋</div>
          <input type="text" id="keywordInput" placeholder="例如：案件編號(113001) 案件名稱 廠商名稱">
          <button id="searchBtn" class="primary"><i class="fas fa-search"></i> 開始搜尋</button>
          <button id="clearSearchBtn" class="secondary" style="display:none; background:#ffebee; border-color:#ffcdd2; color:#d32f2f;"><i class="fas fa-times"></i> 清除結果</button>
          <div id="searchStatus" class="small" style="margin-top:8px; color:#004080; font-weight:bold;"></div>
      </div>
  </div>

  <div id="tab-tools" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-map-marker-alt"></i> 座標查詢工具</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
          <textarea id="coordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="plotBtn" class="primary" style="margin-top:0;">顯示點位</button>
            <button id="clearBtn" class="secondary" style="margin-top:0;">清除</button>
          </div>
      </div>
      <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">臺南市山上區公所</div>
  </div>
</div>

<div id="map"></div>
<div id="floatingCoords"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
/* === 變數定義 === */
let REPAIR_CONFIG = []; 
let roadsLayer = null;  
let roadLayersArray = [];
let REPAIR_DATA_CACHE = {}; 
let ALL_CONTRACTORS = new Set(); 

const DEEP_BLUE = '#004080'; 
const LIGHT_BLUE = '#0066cc'; 
const ROUTE_MATCH_THRESHOLD = 50; 
const NEAR_ROAD_THRESHOLD = 30; 
const POINT_RADIUS = 14; 

proj4.defs("EPSG:3826","+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=WGS84 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

function twd97FromWgs84(lat,lng){ 
    const p = proj4('EPSG:4326','EPSG:3826',[lng,lat]); 
    return {x:Math.round(p[0]),y:Math.round(p[1])}; 
}

/* === 分頁切換 === */
window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
    if(btn) btn.classList.add('active');
};

/* === 地圖初始化 === */
const map = L.map('map', { 
    zoomControl:false,
    doubleClickZoom: false 
}).setView([23.1025,120.3538], 13);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);
const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '© Google Maps' });
let isSat = false; 

const cadastralLayer = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: '© 國土測繪中心', opacity: 0.8, maxZoom: 20 });
let isCadastralVisible = false;

const boundaryLayer = L.layerGroup().addTo(map); 
const pointLayer = L.layerGroup().addTo(map);   
const repairLayer = L.layerGroup().addTo(map);  
const routeMatchLayer = L.layerGroup().addTo(map);
const searchResultLayer = L.featureGroup().addTo(map);

/* === 側邊欄控制 === */
const toggleBtn = document.getElementById('toggleSidebarBtn');
const overlayMask = document.getElementById('overlay-mask');
const bottomPanel = document.getElementById('bottomPanel');

function toggleSidebar() {
    const isMobile = window.innerWidth <= 768;
    if (isMobile) document.body.classList.toggle('sidebar-open');
    else document.body.classList.toggle('collapsed');
    setTimeout(() => map.invalidateSize(), 300);
}
toggleBtn.addEventListener('click', toggleSidebar);
overlayMask.addEventListener('click', () => document.body.classList.remove('sidebar-open'));

document.getElementById('closePanelBtn').addEventListener('click', () => {
    bottomPanel.classList.remove('open');
    routeMatchLayer.clearLayers();
});

/* === 資料載入 === */
fetch('tainan_districts.geojson').then(r=>r.json()).then(data=>{
    L.geoJSON(data, { interactive: false, style: f => ({ color: '#000', weight: (f.properties.TOWNNAME||f.properties.TOWN).includes('山上')?5:2, opacity: 0.8, fillOpacity: 0 }) }).addTo(boundaryLayer).bringToBack();
}).catch(e=>console.warn(e));

fetch('farmroads.geojson').then(r=>r.json()).then(data=>{
    roadsLayer = L.geoJSON(data, {
        style: { color: DEEP_BLUE, weight: 3, opacity: 0.9 }, 
        onEachFeature: (f, l) => {
            l.bindTooltip(f.properties?.name || "道路", { sticky: true, direction: 'top' });
            l.on('mouseover', () => { l.setStyle({ weight: 5, color: LIGHT_BLUE }); map.getContainer().style.cursor='pointer'; });
            l.on('mouseout', () => { l.setStyle({ weight: 3, color: DEEP_BLUE }); map.getContainer().style.cursor='default'; });
            l.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                handleMapClickSelection(roadLayersArray.indexOf(l), true);
                if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
            });
        }
    }).addTo(map);
    roadLayersArray = roadsLayer.getLayers();
    const sel = document.getElementById('roadSelect');
    sel.innerHTML = '<option value="">-- 請選擇路線 --</option>';
    data.features.forEach((f, i) => {
        const o = document.createElement('option');
        o.value = i; o.textContent = f.properties?.name || `路線 ${i+1}`;
        sel.appendChild(o);
    });
}).catch(e=>{});

async function loadRepairSettings() {
    const box = document.getElementById('repairCheckboxes');
    try {
        const res = await fetch('repair_months.json');
        REPAIR_CONFIG = await res.json(); 
    } catch (e) { box.innerHTML = '讀取失敗'; return; }
    
    if(REPAIR_CONFIG.length === 0) { box.innerHTML = '無資料'; return; }
    box.innerHTML = ''; 

    const grouped = {};
    REPAIR_CONFIG.forEach(item => {
        const m = item.label.match(/(\d{3})年/);
        const y = m ? m[1] : '其他';
        if(!grouped[y]) grouped[y] = [];
        grouped[y].push(item);
    });

    Object.keys(grouped).sort((a,b)=>b-a).forEach((y, idx) => {
        const gDiv = document.createElement('div');
        gDiv.className = 'year-group';
        if(idx===0) gDiv.classList.add('open');
        gDiv.innerHTML = `
            <div class="year-header" onclick="this.parentElement.classList.toggle('open')">
                <div><span class="toggle-icon">▶</span> ${y}年度</div>
                <label class="year-select-all" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleYear(this)"> 全選</label>
            </div>
            <div class="year-content">
                ${grouped[y].map(item => `<div class="checkbox-item"><input type="checkbox" value="${item.value}" class="repair-cb" onchange="updateRepairPoints()"><label>${item.label}</label></div>`).join('')}
            </div>
        `;
        box.appendChild(gDiv);
    });
    preloadAllDataForContractors();
}
loadRepairSettings();

window.toggleYear = function(source) {
    const cbs = source.closest('.year-group').querySelectorAll('.repair-cb');
    cbs.forEach(cb => cb.checked = source.checked);
    updateRepairPoints();
}

function distToRoad(latlng, roadLayer) {
    if(!roadLayer || !turf) return NaN;
    try {
        let min = Infinity;
        roadLayer.eachLayer(l => {
            if(!l.feature.geometry) return;
            const geom = l.feature.geometry;
            const line = geom.type==='LineString' ? turf.lineString(geom.coordinates) : (geom.type==='MultiLineString' ? turf.multiLineString(geom.coordinates) : null);
            if(line) {
                const d = turf.pointToLineDistance(turf.point([latlng.lng, latlng.lat]), line, {units:'meters'});
                if(d < min) min = d;
            }
        });
        return min===Infinity ? NaN : min;
    } catch(e) { return NaN; }
}

function createPopup(data) {
    const { fileName, props, lat, lng, dist } = data;
    const dText = isNaN(dist) ? 'N/A' : (dist<=30 ? `<span style="color:green">${dist.toFixed(1)}m</span>` : `<span style="color:red">${dist.toFixed(1)}m</span>`);
    const twd = twd97FromWgs84(lat, lng);
    const procurementUrl = props['採購網址'] ? props['採購網址'].trim() : '';
    const tenderBtn = procurementUrl ? `<a href="${procurementUrl}" target="_blank" class="popup-btn"><i class="fas fa-bullhorn"></i> 決標公告</a>` : `<span class="popup-btn" style="background:#eee;color:#999;cursor:not-allowed;"><i class="fas fa-bullhorn"></i> 無公告</span>`;

    return `
        <div class="info-card">
            <div class="info-header">檔案編號：${fileName}</div>
            <div class="info-body">
                <div class="info-row"><div class="info-label">案件編號</div><div class="info-val">${props['案件編號']||''}</div></div>
                <div class="info-row"><div class="info-label">決標金額</div><div class="info-val" style="font-weight:bold;color:#0056b3;">${props['決標金額']||''}</div></div>
                <div class="info-row"><div class="info-label">施工廠商</div><div class="info-val">${props['施工廠商']||''}</div></div>
                <div class="info-row"><div class="info-label">監造廠商</div><div class="info-val">${props['監造廠商']||''}</div></div>
                <div class="info-row"><div class="info-label">完工日期</div><div class="info-val">${props['完工日期']||''}</div></div>
                <div class="info-row"><div class="info-label">TWD97</div><div class="info-val">${props['X']||twd.x}, ${props['Y']||twd.y}</div></div>
                <div class="info-row"><div class="info-label">WGS84</div><div class="info-val">${lat.toFixed(6)}, ${lng.toFixed(6)}</div></div>
                <div class="info-row"><div class="info-label">距最近路線</div><div class="info-val">${dText}</div></div>
                
                <div class="btn-group-popup">
                    ${tenderBtn}
                    <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="popup-btn"><i class="fas fa-map"></i> 地籍查詢</a>
                    <a href="https://www.google.com/maps?q=&layer=c&cbll=${lat},${lng}" target="_blank" class="popup-btn"><i class="fas fa-street-view"></i> Google街景</a>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn"><i class="fas fa-location-arrow"></i> Google導航</a>
                </div>
            </div>
        </div>
    `;
}

function updateRepairPoints() {
    repairLayer.clearLayers();
    const checked = document.querySelectorAll('.repair-cb:checked');
    checked.forEach(cb => {
        const fileKey = cb.value;
        const data = REPAIR_DATA_CACHE[fileKey];
        if(!data) return;
        const config = REPAIR_CONFIG.find(c => c.value === fileKey);
        L.geoJSON(data, {
            pointToLayer: (f, ll) => L.circleMarker(ll, { radius: 14, fillColor: '#004080', color: '#fff', weight: 1, fillOpacity: 0.9 }),
            onEachFeature: (f, l) => {
                if(f.geometry.type !== 'Point') return;
                const ll = l.getLatLng();
                const dist = distToRoad(ll, roadsLayer);
                if(!isNaN(dist) && dist > 30) l.setStyle({ fillColor: 'red' });
                l.bindPopup(createPopup({ fileName: config.label, props: f.properties, lat: ll.lat, lng: ll.lng, dist }), { className: 'custom-popup' });
            }
        }).addTo(repairLayer);
    });
}

async function preloadAllDataForContractors() {
    const cSel = document.getElementById('contractorSelect');
    await Promise.all(REPAIR_CONFIG.map(async item => {
        try {
            const res = await fetch(item.value + '.geojson');
            if(res.ok) {
                const json = await res.json();
                REPAIR_DATA_CACHE[item.value] = json;
                json.features?.forEach(f => {
                    const c = f.properties['施工廠商']?.trim();
                    if(c) ALL_CONTRACTORS.add(c);
                });
            }
        } catch(e){}
    }));
    const sortedC = Array.from(ALL_CONTRACTORS).sort();
    cSel.innerHTML = '<option value="">-- 請選擇廠商 (' + sortedC.length + ') --</option>' + sortedC.map(c => `<option value="${c}">${c}</option>`).join('');
    cSel.addEventListener('change', function() {
        if(this.value) { document.getElementById('keywordInput').value=''; performSearch(p=>p['施工廠商']?.trim()===this.value, `廠商：${this.value}`); }
        else clearSearchResults();
    });
}

async function performSearch(predicate, label) {
    const status = document.getElementById('searchStatus');
    const btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    status.innerText = '搜尋中...';
    searchResultLayer.clearLayers();
    let count = 0;
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if(!data || !data.features) return;
        data.features.forEach(f => {
            try {
                if(f.geometry.type !== 'Point') return;
                if(predicate(f.properties)) {
                    const [lng, lat] = f.geometry.coordinates;
                    const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
                    L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer)
                        .bindPopup(createPopup({ fileName: conf.label, props: f.properties, lat, lng, dist: distToRoad(ll, roadsLayer) }), { className: 'custom-popup' });
                    count++;
                }
            } catch(e){}
        });
    });
    if(count > 0) {
        map.fitBounds(searchResultLayer.getBounds());
        if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
        status.innerHTML = `找到 <b style="color:#d32f2f">${count}</b> 筆`;
        document.getElementById('clearSearchBtn').style.display = 'block';
    } else status.innerHTML = '<span style="color:red">查無資料</span>';
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-search"></i> 搜尋';
}

document.getElementById('searchBtn').addEventListener('click', () => {
    const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
    if(!kw) return alert('請輸入關鍵字');
    document.getElementById('contractorSelect').value = '';
    performSearch(p => Object.values(p).join(' ').toLowerCase().includes(kw), kw);
});

document.getElementById('clearSearchBtn').addEventListener('click', clearSearchResults);
function clearSearchResults() {
    searchResultLayer.clearLayers();
    document.getElementById('keywordInput').value = '';
    document.getElementById('contractorSelect').value = '';
    document.getElementById('searchStatus').innerText = '';
    document.getElementById('clearSearchBtn').style.display = 'none';
}

document.getElementById('roadSelect').addEventListener('change', (e) => handleMapClickSelection(e.target.value, false));

function handleMapClickSelection(idx, isInteractive) {
    if(idx==="" || idx===null) return;
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
    
    const target = roadLayersArray[idx];
    if(target) {
        target.setStyle({ color: 'red', weight: 6 });
        map.fitBounds(target.getBounds());
        target.openPopup();
        
        if (isInteractive) {
            document.getElementById('panelTitle').innerHTML = `<i class="fas fa-history"></i> ${target.feature.properties.name}`;
            bottomPanel.classList.add('open');
            showTimeline(target);
        } else {
            bottomPanel.classList.remove('open');
            routeMatchLayer.clearLayers();
        }
    }
}

map.on('click', (e) => {
    document.getElementById('contextMenu').style.display='none';
    document.getElementById('roadSelect').value = "";
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({ color: DEEP_BLUE, weight: 3 }));
    map.closePopup();
    bottomPanel.classList.remove('open');
    routeMatchLayer.clearLayers();
});

map.on('contextmenu', (e) => {
    addUserMarker(e.latlng);
    L.DomEvent.preventDefault(e);
});

map.on('dblclick', (e) => {
    addUserMarker(e.latlng);
});

function showTimeline(routeLayer) {
    const cont = document.getElementById('timelineContainer');
    cont.innerHTML = '<div style="padding:20px;">讀取中...</div>';
    routeMatchLayer.clearLayers();
    const routeLine = routeLayer.toGeoJSON().geometry; 
    const matches = [];
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if(!data) return;
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const pt = turf.point(f.geometry.coordinates);
            const dist = turf.pointToLineDistance(pt, routeLine, {units:'meters'});
            if(dist <= 50) matches.push({ label: conf.label, props: f.properties, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0], dist });
        });
    });
    
    if(matches.length === 0) { cont.innerHTML = '<div style="padding:20px;">無維修紀錄</div>'; return; }
    matches.sort((a,b) => (b.props['完工日期']||'').localeCompare(a.props['完工日期']||''));
    cont.innerHTML = '';
    
    matches.forEach(m => {
        const marker = L.circleMarker([m.lat, m.lng], { radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }).addTo(routeMatchLayer);
        marker.bindPopup(createPopup({ fileName: m.label, props: m.props, lat: m.lat, lng: m.lng, dist: m.dist }), {className:'custom-popup'});
        
        const labelName = m.label.toString();
        // 修正：使用 fas fa-wrench
        let icon = '<i class="fas fa-circle icon-normal"></i>';
        let title = '一般';
        if(labelName.includes('搶修') || labelName.includes('災害') || labelName.includes('緊急')) {
            icon = '<i class="fas fa-wrench icon-urgent"></i>'; 
            title = '搶修';
        }
        
        const item = document.createElement('div');
        item.className = 'h-item';
        item.innerHTML = `
            <div class="h-date">${m.props['完工日期']||'未知'}</div>
            <div class="h-line-container"><div class="h-dot"></div></div>
            <div class="h-icon" title="${title}">${icon}</div>
        `;
        item.addEventListener('mouseenter', () => { marker.setStyle({ radius: 20, color:'#ffd700', weight:4, fillColor:'#d32f2f' }); marker.bringToFront(); marker.openPopup(); });
        item.addEventListener('mouseleave', () => { marker.setStyle({ radius: 14, color:'#fff', weight:1, fillColor:DEEP_BLUE }); marker.closePopup(); });
        item.addEventListener('click', () => map.flyTo([m.lat, m.lng], 18));
        cont.appendChild(item);
    });
}

const ctxMenu = document.getElementById('contextMenu');
let clickedLatLng = null;

function addUserMarker(latlng) {
    pointLayer.clearLayers();
    const marker = L.marker(latlng, { draggable: true }).addTo(pointLayer);
    const twd = twd97FromWgs84(latlng.lat, latlng.lng);
    marker.bindPopup(`
        <div style="text-align:center;">
            <b>已選取位置</b><br>
            WGS84: ${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}<br>
            TWD97: ${twd.x}, ${twd.y}
        </div>
    `).openPopup();
    marker.on('contextmenu', (e) => {
        L.DomEvent.stopPropagation(e);
        clickedLatLng = e.latlng;
        ctxMenu.style.display = 'block';
        ctxMenu.style.left = e.originalEvent.clientX + 'px';
        ctxMenu.style.top = e.originalEvent.clientY + 'px';
    });
    marker.on('click', (e) => {
        if(L.Browser.mobile) {
            clickedLatLng = e.latlng;
            ctxMenu.style.display = 'block';
            ctxMenu.style.left = e.originalEvent.clientX + 'px';
            ctxMenu.style.top = e.originalEvent.clientY + 'px';
        } else {
            marker.openPopup();
        }
    });
}

map.on('dragstart click', () => ctxMenu.style.display='none');

document.getElementById('ctxStreetView').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps?q=&layer=c&cbll=${clickedLatLng.lat},${clickedLatLng.lng}`); ctxMenu.style.display='none'; }
document.getElementById('ctxGoogleNav').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${clickedLatLng.lat},${clickedLatLng.lng}`); ctxMenu.style.display='none'; }
document.getElementById('ctxClearMarker').onclick = () => { pointLayer.clearLayers(); ctxMenu.style.display='none'; }

document.getElementById('locateBtn').onclick = () => map.locate({setView:true, maxZoom:16});
map.on('locationfound', e => L.circleMarker(e.latlng, {color:'blue', radius:8}).addTo(map).bindPopup('我的位置').openPopup());

document.getElementById('toggleMapBtn').onclick = function() {
    if(isSat) { map.removeLayer(sat); osm.addTo(map); this.classList.remove('active'); }
    else { map.removeLayer(osm); sat.addTo(map); this.classList.add('active'); }
    isSat = !isSat;
};
document.getElementById('toggleCadastralBtn').onclick = function() {
    if(isCadastralVisible) { map.removeLayer(cadastralLayer); this.classList.remove('active'); }
    else { cadastralLayer.addTo(map); this.classList.add('active'); }
    isCadastralVisible = !isCadastralVisible;
};

document.getElementById('plotBtn').onclick = () => {
    pointLayer.clearLayers();
    const parts = document.getElementById('coordsInput').value.split(/[, \t]+/);
    if(parts.length>=2) {
        const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
        if(!isNaN(x)&&!isNaN(y)) {
            const w = proj4('EPSG:3826','EPSG:4326',[x,y]);
            L.marker([w[1],w[0]]).addTo(pointLayer).bindPopup(`X:${x}, Y:${y}`).openPopup();
            map.setView([w[1],w[0]], 16);
        }
    }
};
document.getElementById('clearBtn').onclick = () => { pointLayer.clearLayers(); document.getElementById('coordsInput').value=''; };

map.on('mousemove', e => {
    if(window.innerWidth > 768) {
        const t = twd97FromWgs84(e.latlng.lat, e.latlng.lng);
        const el = document.getElementById('floatingCoords');
        el.style.display = 'block'; el.innerHTML = `TWD97: ${t.x}, ${t.y}`;
    }
});

document.getElementById('clearRepairBtn').addEventListener('click', () => {
    repairLayer.clearLayers();
    document.querySelectorAll('.repair-cb').forEach(cb => cb.checked = false);
    document.querySelectorAll('.year-select-all input').forEach(cb => cb.checked = false);

    searchResultLayer.clearLayers();
    document.getElementById('keywordInput').value = '';
    document.getElementById('contractorSelect').value = '';
    document.getElementById('searchStatus').innerText = '';
    document.getElementById('clearSearchBtn').style.display = 'none';

    pointLayer.clearLayers();
    document.getElementById('coordsInput').value = '';

    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
    document.getElementById('roadSelect').value = "";

    bottomPanel.classList.remove('open');
    map.closePopup();
});
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>臺南市山上區公眾通行道路圖資 (登革熱防治整合版)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<!-- 定位套件 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<style>
  /* === 1. 全局設定 === */
  :root {
    --primary-color: #004080; /* 深藍 */
    --accent-color: #ff9800;  /* 橘黃 */
    --bg-light: #f8faff;
    --text-dark: #333;
    --sidebar-width: 350px;
    --panel-height-open: 200px;
    --panel-height-min: 50px;
  }
  
  body { 
      margin:0; 
      font-family:"Microsoft JhengHei", "Heiti TC", sans-serif; 
      display:flex; 
      height: 100vh; 
      height: 100dvh; 
      overflow:hidden; 
      position: relative; 
      background: var(--bg-light); 
  }
   
  /* === 2. 懸浮漢堡按鈕 === */
  #toggleSidebarBtn {
    position: absolute; top: 10px; left: 360px; width: 40px; height: 40px;
    background: #fff; color: var(--text-dark); border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;
    cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: left 0.3s ease; 
  }
  #toggleSidebarBtn:hover { background: #f4f4f4; }
  body.collapsed #toggleSidebarBtn { left: 10px; }

  /* === 3. 側邊欄樣式 === */
  #sidebar {
    width: var(--sidebar-width); min-width: var(--sidebar-width); background: #fff; border-right: 1px solid #eee;
    display: flex; flex-direction: column; z-index: 1500; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    margin-left: 0; transition: margin-left 0.3s ease; position: relative;
  }
  body.collapsed #sidebar { margin-left: calc(var(--sidebar-width) * -1); }

  .sidebar-header { padding: 15px; background: var(--primary-color); color: white; text-align: center; flex-shrink: 0; }
  .sidebar-header h3 { margin: 0; font-size: 16px; font-weight: bold; line-height: 1.4; }
  
  /* 分頁籤樣式 */
  .tabs-nav { display: flex; background: #eef2f6; padding: 5px 5px 0 5px; flex-shrink: 0; overflow-x: auto; }
  .tab-btn { flex: 1; padding: 10px 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: bold; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; white-space: nowrap; }
  .tab-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 -2px 5px rgba(0,0,0,0.05); position: relative; top: 1px; }
  
  .tab-content-container { flex: 1; overflow-y: auto; padding: 15px; background: #fff; position: relative; }
  .tab-pane { display: none; animation: fadeIn 0.3s; }
  .tab-pane.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* 卡片區塊樣式 */
  .card-section { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
  .card-title { font-size: 14px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #f0f0f0; }
  
  /* 年度摺疊選單 */
  .year-group { margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
  .year-header { background: #f8fafc; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #475569; user-select: none; }
  .year-header:hover { background: #e2e8f0; }
  .year-content { display: none; padding: 8px 12px; background: #fff; border-top: 1px solid #eee; }
  .year-group.open .year-content { display: block; }
  .year-group.open .toggle-icon { transform: rotate(90deg); }
  .toggle-icon { display:inline-block; transition: transform 0.2s; width:12px; margin-right:5px;}
  .year-select-all { font-size: 12px; color: var(--primary-color); cursor: pointer; }
  .checkbox-item { margin-bottom: 6px; display: flex; align-items: center; gap: 6px; font-size: 13px; }
  .checkbox-item input { margin: 0; accent-color: var(--primary-color); }

  select, textarea, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  
  button.primary { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: none; background: var(--primary-color); color: #fff; font-size: 14px; font-weight: bold; }
  button.primary:hover { background: #003366; }
  button.secondary { width: 100%; padding: 8px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #555; font-size: 13px; }
  button.secondary:hover { background: #f5f5f5; }

  /* === 登革熱專用樣式 === */
  .dengue-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: #555; }
  .dengue-option input { width: auto; margin: 0; transform: scale(1.2); }
  
  /* 灰色圓點樣式 */
  .gray-dot-marker {
      width: 14px; height: 14px;
      background: #7f8c8d; /* 灰色 */
      border: 2px solid #fff;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.4);
  }

  /* === 4. 地圖區 === */
  #map { flex: 1; position: relative; z-index: 1; transition: width 0.3s ease; }
  body.measuring, body.measuring #map { cursor: crosshair !important; }

  .map-floating-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
  .float-btn { width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; color: #444; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
  .float-btn:hover { background: #f0f0f0; color: var(--primary-color); transform: scale(1.1); }
  .float-btn.active { background: var(--accent-color); color: #000; }
  .float-btn::after { content: attr(data-title); position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .float-btn:hover::after { opacity: 1; }

  /* 定位套件樣式覆寫 */
  .leaflet-control-locate { border: none !important; box-shadow: none !important; margin: 0 !important; }
  .leaflet-control-locate a { width: 40px !important; height: 40px !important; border-radius: 50% !important; background: #fff !important; color: #444 !important; font-size: 16px !important; line-height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important; cursor: pointer !important; }
  .leaflet-control-locate a:hover { background: #f0f0f0 !important; color: #004080 !important; transform: scale(1.1); }
  .leaflet-control-locate.active a { color: #2074b6 !important; background: #fff !important; }
  .leaflet-control-locate.following a { color: #e65100 !important; border: 2px solid #e65100 !important; }
  .leaflet-control-locate a .leaflet-control-locate-location-arrow { display: none; }

  /* 聚合圖標 */
  .marker-cluster-custom { background-color: rgba(46, 204, 113, 0.6); border-radius: 50%; }
  .marker-cluster-custom div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 50%; color: white; font-weight: bold; background-color: rgba(39, 174, 96, 0.9); line-height: 30px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* 聚合控制面板 */
  #clusterControlPanel {
    position: absolute; bottom: 220px; left: 360px; z-index: 1000;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
    padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    width: 220px; border: 1px solid rgba(255,255,255,0.2);
    display: none; 
    transition: left 0.3s ease;
  }
  body.collapsed #clusterControlPanel { left: 20px; } 

  .cluster-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .cluster-title { font-size:14px; font-weight:bold; color:var(--primary-color); display:flex; align-items:center; gap:6px; }
  .cluster-value-badge { background: var(--accent-color); color:#fff; padding:2px 6px; border-radius:4px; font-size:12px; }
  input[type=range].custom-range { -webkit-appearance: none; width: 100%; background: transparent; }
  input[type=range].custom-range::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  input[type=range].custom-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }

  /* === 6. 底部時間軸面板 === */
  #bottomPanel { 
      position: absolute; 
      bottom: 0; 
      left: var(--sidebar-width); 
      right: 0; 
      height: 200px; 
      background: rgba(255, 255, 255, 0.98); 
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1); 
      z-index: 1400; 
      display: flex; 
      flex-direction: column; 
      transform: translateY(100%); 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease; 
      border-top: 1px solid #e0e0e0; 
      overflow: hidden; 
  }
  body.collapsed #bottomPanel { left: 0; } 
  #bottomPanel.open { transform: translateY(0); }
  
  /* 縮小狀態：高度自動適應標題 (藍色框切齊) */
  #bottomPanel.minimized { 
      height: auto !important; 
      transform: translateY(0) !important; 
  }
  /* 縮小時隱藏內容，確保藍色框包覆完整 */
  #bottomPanel.minimized #timelineFilterBar,
  #bottomPanel.minimized #timelineContainer {
      display: none !important;
  }

  /* 底部面板標題列 - 自動高度 */
  #bottomPanelHeader { 
      padding: 8px 20px; 
      min-height: 50px; 
      height: auto; 
      background: var(--primary-color); 
      color: white; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-shrink: 0; 
  }
  
  .header-left { display: flex; flex-direction: column; gap: 2px; justify-content: center; overflow: hidden; }
  #panelTitle { font-size: 15px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  
  /* 統計文字預設樣式 (電腦版) */
  #timelineStats { 
      font-size: 13px; 
      color: #ffeb3b; 
      font-weight: normal; 
      opacity: 1; 
      white-space: normal; /* 允許換行 */
      line-height: 1.5;
      margin-top: 2px;
  }
  
  /* === 修正重點：手機版強制垂直三行顯示 === */
  @media (max-width: 768px) {
      #timelineStats {
          display: flex;
          flex-direction: column; /* 強制垂直排列 */
          align-items: flex-start; /* 靠左對齊 */
          line-height: 1.6;        /* 增加行距提升易讀性 */
      }
      /* 手機版隱藏分隔線符號 */
      .stat-divider {
          display: none;
      }
  }

  .header-right { display: flex; gap: 15px; align-items: center; flex-shrink: 0;}
  .control-btn { background:none; border:none; color:#fff; font-size:16px; cursor:pointer; padding: 5px; transition: color 0.2s; }
  .control-btn:hover { color: #ffeb3b; }

  /* Timeline 篩選列 */
  #timelineFilterBar { background: #f1f5f9; padding: 6px 20px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 10px; align-items: center; flex-shrink: 0; height: 48px; box-sizing: border-box; }
  .filter-label { font-size: 13px; color: #333; font-weight: bold; white-space: nowrap; }
  
  /* Timeline 下拉選單樣式 */
  .timeline-select {
      flex: 1;
      max-width: 400px;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 13px;
      color: #333;
      background: #fff;
      margin: 0;
      cursor: pointer;
  }
  .timeline-select:focus { outline: none; border-color: var(--primary-color); }

  #timelineContainer { flex: 1; overflow-x: auto; padding: 15px 20px; display: flex; align-items: flex-start; gap: 0; }
  
  /* === 修正重點：增加時間軸項目寬度，解決日期重疊 === */
  .h-item { width: 160px; text-align: center; cursor: pointer; position: relative; transition: transform 0.2s; }
  
  .h-item:hover { transform: translateY(-5px); }
  .h-date { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 8px; }
  .h-line-container { position: relative; height: 24px; display: flex; align-items: center; justify-content: center; }
  .h-line-container::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: #ddd; z-index: 0; }
  .h-item.alert-right .h-line-container::after { content: ''; position: absolute; left: 50%; right: -50%; top: 50%; height: 4px; background: repeating-linear-gradient(45deg, #d32f2f, #d32f2f 5px, #ffcdd2 5px, #ffcdd2 10px); z-index: 0; animation: alertPulse 1.5s infinite; }
  @keyframes alertPulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  
  /* 時間軸圓點 - 實心美化版 */
  .h-dot { 
      background: var(--primary-color); /* 深藍實心 */
      border: 2px solid #fff;           /* 白色光暈邊框 */
      border-radius: 50%; 
      z-index: 1; 
      position: relative; 
      transition: all 0.2s; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* 立體陰影 */
  }
  .h-item:hover .h-dot { 
      transform: scale(1.3); 
      background: var(--accent-color); /* 懸停變橘黃 */
      border-color: #fff;
  }
  .dot-sm { width: 12px; height: 12px; }
  .dot-md { width: 16px; height: 16px; }
  .dot-lg { width: 22px; height: 22px; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.3); /* 大額案件加外光暈 */ }
  
  /* 新增：文字標籤樣式 (取代圖示) */
  .h-badge {
      margin-top: 8px;
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px; /* 膠囊圓角 */
      font-size: 12px;
      font-weight: bold;
      color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: nowrap;
      position: relative;
      z-index: 2;
  }
  .badge-normal {
      background-color: var(--primary-color); /* 藍底 */
      border: 1px solid #fff;
  }
  .badge-urgent {
      background-color: #d32f2f; /* 紅底 */
      border: 1px solid #fff;
  }

  /* === 7. 右鍵選單 === */
  #contextMenu { display: none; position: fixed; z-index: 5000; background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; min-width: 160px; border: 1px solid #ddd; top: 0; left: 0; }
  .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
  .ctx-item:hover { background: #f5faff; color: var(--primary-color); }
  .ctx-item i { width: 20px; text-align: center; }

  /* Popup */
  .custom-popup .leaflet-popup-content-wrapper { padding: 0; border-radius: 8px; overflow: hidden; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
  .custom-popup .leaflet-popup-content { margin: 0; width: 300px !important; }
  .info-header { background: var(--primary-color); color: white; padding: 10px 12px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; }
  .info-body { padding: 12px; background: #fff; font-size: 14px; color: #333; }
  .info-row { margin-bottom: 6px; display: flex; border-bottom: 1px dashed #eee; padding-bottom: 4px; }
  .info-row:last-of-type { border-bottom: none; }
  .info-label { width: 85px; font-weight: bold; color: #555; flex-shrink: 0; }
  .info-val { color: #222; word-break: break-all; flex: 1; }
  .btn-group-popup { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
  
  /* Popup 按鈕：黃底黑字 */
  .popup-btn { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      gap: 5px; 
      background: #ffc107; /* 琥珀黃/工程黃 */
      color: #000;         /* 純黑字 */
      padding: 8px; 
      border-radius: 4px; 
      text-decoration: none; 
      font-size: 14px; 
      font-weight: bold; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.15); 
      transition: background 0.2s; 
  }
  .popup-btn:hover { background: #e0a800; /* 深橘黃 */ }
  
  .analysis-control { margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
  .slider-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
  .slider-container input { flex: 1; cursor: pointer; }
  .slider-value { font-weight: bold; color: #d32f2f; min-width: 50px; text-align: right; }
  .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: #e65100; }
  .toggle-switch input { width: auto; margin: 0; }

  .measure-label { background: rgba(255,255,255,0.9); border: 1px solid #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
  .measure-close-btn { color: red; cursor: pointer; font-weight: bold; padding: 0 4px; }

  /* 統計區塊雙欄與列表樣式 */
  .stats-columns { display: flex; gap: 8px; margin-top: 5px; }
  .stats-col { flex: 1; padding: 8px; border-radius: 6px; overflow: hidden; }
  .col-general { background: #e3f2fd; border: 1px solid #bbdefb; } /* 淡藍 */
  .col-emergency { background: #ffebee; border: 1px solid #ffcdd2; } /* 淡紅 */
  
  .stats-header { 
      font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 8px; 
      padding-bottom: 5px; border-bottom: 2px solid rgba(0,0,0,0.1); 
  }
  .col-general .stats-header { color: #004080; }
  .col-emergency .stats-header { color: #d32f2f; }

  .stat-year-row { margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 6px; }
  .stat-year-row:last-child { border-bottom: none; }
  
  .stat-year-title { 
      font-size: 13px; font-weight: bold; color: #444; 
      display: flex; justify-content: space-between; align-items: center;
  }
  .stat-percent-text { font-size: 11px; color: #777; background: rgba(255,255,255,0.6); padding: 1px 4px; border-radius: 3px; }
  
  .stat-data-row { font-size: 13px; margin-top: 3px; color: #222; font-weight: bold; }
  
  /* 微型進度條 */
  .stat-bar-bg { background: rgba(0,0,0,0.1); height: 5px; border-radius: 3px; width: 100%; margin-top: 5px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .col-general .stat-bar-fill { background-color: var(--primary-color); }
  .col-emergency .stat-bar-fill { background-color: #d32f2f; }
  
  /* === 8. 案件通報全螢幕視窗 (預設隱藏) === */
  #reportOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #f8faff; z-index: 9999; 
    display: none; /* 預設隱藏 */
    flex-direction: column; font-family: "Microsoft JhengHei", sans-serif;
  }
  .report-header { background: var(--primary-color); color: white; padding: 15px; display:flex; justify-content:space-between; align-items:center; }
  .report-body { flex: 1; padding: 15px; overflow-y: auto; }
  
  /* 三欄式資訊佈局 */
  .report-grid { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .report-col { flex: 1; display: flex; flex-direction: column; gap: 8px; justify-content: flex-start; }
  .report-item { font-size: 14px; color: #333; }
  .report-label { font-weight: bold; color: #555; margin-right: 5px; }
  .report-textarea { width: 100%; height: 100%; min-height: 60px; resize: none; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; box-sizing: border-box; }
  
  /* 手機響應式：變為垂直堆疊 */
  @media (max-width: 768px) {
      .report-grid { flex-direction: column; gap: 15px; }
      .report-textarea { height: 80px; }
  }
  
  .photo-upload-container { display: flex; gap: 10px; margin-top: 15px; height: 200px; }
  .photo-box { 
    flex: 1; border: 2px dashed #ccc; border-radius: 8px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    background: #fff; position: relative; overflow: hidden;
  }
  .photo-box.has-image { border-style: solid; border-color: #666; }
  .photo-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
  .add-photo-btn { font-size: 40px; color: #ccc; cursor: pointer; }
  .delete-photo-btn {
    width: 100%; background: #d32f2f; color: white; border: none; padding: 8px;
    font-weight: bold; cursor: pointer; margin-top: 5px; border-radius: 4px;
    display: none; 
  }
  
  .report-footer { padding: 15px; display: flex; justify-content: space-between; gap: 15px; background: #fff; border-top: 1px solid #eee; }
  .btn-cancel { flex: 1; padding: 12px; background: #7f8c8d; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; }
  .btn-submit { flex: 1; padding: 12px; background: var(--accent-color); color: black; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; }

  /* 檢核結果列表樣式 (新增功能用) */
  .dup-check-item {
      padding: 8px;
      border-bottom: 1px solid #eee;
      font-size: 13px;
      cursor: pointer; /* 讓滑鼠變成手型 */
      transition: background-color 0.2s;
  }
  .dup-check-item:hover {
      background-color: #f0f7ff; /* 滑鼠移入變色 */
  }
  .dup-check-item:last-child { border-bottom: none; }
  .dup-check-title { font-weight: bold; color: #333; margin-bottom: 2px; }
  .dup-check-info { color: #666; display:flex; justify-content:space-between; }
  .dup-tag { font-size: 11px; padding: 1px 4px; border-radius: 3px; color: #fff; margin-left: 5px; }
  .tag-gen { background: var(--primary-color); }
  .tag-emg { background: #d32f2f; }

  #floatingCoords { position:absolute; pointer-events:none; background:rgba(255,255,255,0.9); border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:11px; display:none; z-index:1300; bottom: 10px; right: 10px; }

  @media (max-width: 768px) {
    #sidebar { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; top: auto; border-radius: 20px 20px 0 0; border-right: none; transform: translateY(100%); margin-left: 0; }
    body.sidebar-open #sidebar { transform: translateY(0); }
    #overlay-mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1400; }
    body.sidebar-open #overlay-mask { display: block; }
    #toggleSidebarBtn { left: 10px; top: 10px; }
    #bottomPanel { left: 0; height: 220px; z-index: 2100; }
    .map-floating-controls { top: 70px; right: 10px; }
    #clusterControlPanel { bottom: 200px; left: 15px; right: 15px; width: auto; }
  }
</style>
</head>
<body>

<div id="overlay-mask"></div>
<button id="toggleSidebarBtn" title="切換選單"><i class="fas fa-bars"></i></button>

<div class="map-floating-controls">
    <!-- 原本的靜態定位按鈕已移除，改由 JS 動態插入「完美版」定位按鈕 -->
    <button class="float-btn" id="toggleMapBtn" data-title="切換衛星/地圖"><i class="fas fa-layer-group"></i></button>
    <button class="float-btn" id="toggleCadastralBtn" data-title="地籍圖開關"><i class="fas fa-map"></i></button>
    <button class="float-btn" id="toggleClusterControlBtn" data-title="點位聚合設定"><i class="fas fa-circle-nodes"></i></button>
    <!-- 案件通報按鈕 -->
    <button class="float-btn" id="openReportBtn" data-title="案件通報" style="color:#d32f2f;"><i class="fas fa-camera"></i></button>
</div>

<!-- 案件通報全螢幕視窗 (預設隱藏) -->
<div id="reportOverlay">
    <div class="report-header">
        <div style="font-size:18px; font-weight:bold;"><i class="fas fa-camera"></i> 案件通報</div>
        <button onclick="closeReport()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="report-body">
        
        <!-- 三欄式資訊佈局 -->
        <div class="report-grid">
            <!-- 左欄：基本資訊 -->
            <div class="report-col">
                <div class="report-item"><span class="report-label">案件編號：</span><span id="reportCaseId">載入中...</span></div>
                <div class="report-item"><span class="report-label">通報時間：</span><span id="reportTime"></span></div>
            </div>
            <!-- 中欄：座標資訊 -->
            <div class="report-col">
                <div class="report-item"><span class="report-label">TWD97：</span><span id="reportTwd97">定位中...</span></div>
                <div class="report-item"><span class="report-label">WGS84：</span><span id="reportWgs84">定位中...</span></div>
            </div>
            <!-- 右欄：案情描述 -->
            <div class="report-col">
                <div class="report-item"><span class="report-label">簡述案情：</span></div>
                <textarea id="reportDesc" class="report-textarea" placeholder="請描述損壞情形 (例如：路面坑洞、路燈不亮)"></textarea>
            </div>
        </div>
        
        <div class="photo-upload-container">
            <!-- 左視窗 -->
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box" id="photoBox1" onclick="triggerCamera(1)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview1">
                    <input type="file" id="fileInput1" accept="image/*" capture="camera" style="display:none;" onchange="previewImage(this, 1)">
                </div>
                <button class="delete-photo-btn" id="delBtn1" onclick="deletePhoto(1)">刪除</button>
            </div>
            
            <!-- 右視窗 -->
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box" id="photoBox2" onclick="triggerCamera(2)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview2">
                    <input type="file" id="fileInput2" accept="image/*" capture="camera" style="display:none;" onchange="previewImage(this, 2)">
                </div>
                <button class="delete-photo-btn" id="delBtn2" onclick="deletePhoto(2)">刪除</button>
            </div>
        </div>
        <div style="margin-top:10px; font-size:12px; color:#666; text-align:center;">
            請點擊「+」拍攝兩張不同角度的照片
        </div>
    </div>
    <div class="report-footer">
        <button class="btn-cancel" onclick="closeReport()">取消</button>
        <button class="btn-submit" onclick="submitReport()">上傳通報</button>
    </div>
</div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxStreetView"><i class="fas fa-street-view"></i> Google 街景</div>
    <div class="ctx-item" id="ctxGoogleNav"><i class="fas fa-location-arrow"></i> Google 導航</div>
    <div class="ctx-item" id="ctxCadastral"><i class="fas fa-map"></i> 地籍圖/查詢</div>
    <div class="ctx-item" id="ctxMeasure"><i class="fas fa-ruler-horizontal"></i> 距離量測</div>
    <div class="ctx-item" id="ctxClearMarker" style="color:#d32f2f;"><i class="fas fa-trash-alt" style="color:#d32f2f;"></i> 移除標記</div>
</div>

<div id="clusterControlPanel">
    <div class="cluster-header">
        <div class="cluster-title"><i class="fas fa-circle-nodes"></i> 點位聚合設定</div>
        <div style="display:flex; align-items:center;">
            <span id="clusterRadiusVal" class="cluster-value-badge" style="margin-right: 5px;">範圍 50px</span>
            <button id="closeClusterControlBtn" class="control-btn" title="關閉" style="color:#000; font-size:12px; padding:0;"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div style="font-size:12px; color:#666; margin-bottom:5px;">調整聚合敏感度 (滑竿往右 = 範圍大/聚合強)</div>
    <input type="range" id="clusterRadiusSlider" class="custom-range" min="20" max="150" step="10" value="50">
</div>

<div id="bottomPanel">
    <div id="bottomPanelHeader">
        <div class="header-left">
            <div id="panelTitle"><i class="fas fa-history"></i> 路線維修紀錄</div>
            <div id="timelineStats"></div>
        </div>
        <div class="header-right">
            <button id="togglePanelSizeBtn" class="control-btn" title="縮小/展開"><i class="fas fa-chevron-down"></i></button>
            <button id="closePanelBtn" class="control-btn" title="關閉"><i class="fas fa-times"></i></button>
        </div>
    </div>
    
    <div id="timelineFilterBar"><span class="filter-label"><i class="fas fa-filter"></i> 篩選案件：</span></div>
    <div id="timelineContainer"><div style="padding:20px; color:#777;">請點選地圖上的藍色路線以檢視紀錄。</div></div>
</div>

<div id="sidebar">
  <div class="sidebar-header">
      <h3>臺南市山上區<br>公眾通行道路圖資及施工/維修案件透明</h3>
  </div>

  <div class="tabs-nav">
      <button class="tab-btn active" onclick="switchTab('tab-layers')"><i class="fas fa-layer-group"></i> 透明</button>
      <button class="tab-btn" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> 搜尋</button>
      <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fas fa-tools"></i> 工具</button>
      <button class="tab-btn" onclick="switchTab('tab-dengue')"><i class="fas fa-shield-virus"></i> 登革熱</button>
  </div>

  <div id="tab-layers" class="tab-content-container tab-pane active">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-road"></i> 施工/維修案件公告</div>
          <div class="small" style="margin-bottom:8px; color:#666;">勾選年份批次顯示位置 (<span style="color:#004080">●</span>近 / <span style="color:red">●</span>遠)</div>
          <div id="repairCheckboxes" style="max-height:400px; overflow-y:auto;"></div>
          <button class="secondary" id="clearRepairBtn"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>

      <!-- 里別維修統計 (升級版：分年度 + 佔比) -->
      <div class="card-section">
          <div class="card-title"><i class="fas fa-calculator"></i> 里別維修統計</div>
          <div class="small" style="margin-bottom:5px; color:#666;">系統將自動排除同案件重複計算</div>
          <select id="statsVillageSelect" style="margin-bottom:10px;">
              <option value="">(讀取中...)</option>
          </select>
          
          <div id="statsResult" style="display:none;">
              <div class="stats-columns">
                  <!-- 左欄：一般工程 (List) -->
                  <div class="stats-col col-general">
                      <div class="stats-header">一般工程</div>
                      <div id="statsGenList"></div>
                  </div>
                  <!-- 右欄：搶險搶修 (List) -->
                  <div class="stats-col col-emergency">
                      <div class="stats-header">搶險搶修</div>
                      <div id="statsEmgList"></div>
                  </div>
              </div>
          </div>
          <!-- 新增：清除按鈕 -->
          <button class="secondary" id="clearStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>
  </div>

  <div id="tab-search" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-route"></i> 公眾通行道路圖資查詢</div>
          <select id="roadSelect"><option>載入中...</option></select>
      </div>
      <div class="card-section">
          <div class="card-title"><i class="fas fa-search-plus"></i> 案件進階搜尋</div>
          
          <!-- 新增：依里別快篩 -->
          <div class="search-block-label"><i class="fas fa-map-marked-alt"></i> 依里別快篩</div>
          <select id="villageSelect" style="margin-bottom:10px;">
              <option value="">-- 請選擇行政區 (載入中...) --</option>
          </select>
          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          
          <div class="search-block-label"><i class="fas fa-filter"></i> 依廠商快篩</div>
          <select id="contractorSelect" style="margin-bottom:10px;"><option value="">(讀取系統資料中...)</option></select>
          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          <div class="search-block-label"><i class="fas fa-keyboard"></i> 關鍵字搜尋</div>
          <input type="text" id="keywordInput" placeholder="例如：案件編號(113001) 案件名稱 廠商名稱">
          <button id="searchBtn" class="primary"><i class="fas fa-search"></i> 開始搜尋</button>
          <button id="clearSearchBtn" class="secondary" style="display:none; background:#ffebee; border-color:#ffcdd2; color:#d32f2f;"><i class="fas fa-times"></i> 清除結果</button>
          <div id="searchStatus" class="small" style="margin-top:8px; color:#004080; font-weight:bold;"></div>
      </div>
  </div>
  
  <div id="tab-tools" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-map-marker-alt"></i> 座標查詢工具</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
          <textarea id="coordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="plotBtn" class="primary" style="margin-top:0;">顯示點位</button>
            <button id="clearBtn" class="secondary" style="margin-top:0;">清除</button>
          </div>
      </div>
      
      <div class="card-section">
          <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
          <!-- 修正：移除 (內政部版) 文字 -->
          <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
              <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
          </a>
      </div>
      
      <div class="card-section">
          <!-- 修正：移除 (戰情模式) 文字 -->
          <div class="card-title"><i class="fas fa-chart-network"></i> 空間群聚分析</div>
          <label class="toggle-switch"><input type="checkbox" id="clusterToggle"> 啟動熱區分析</label>
          <div class="analysis-control">
              <div style="font-size:12px; color:#666;">群聚閾值 (半徑)：</div>
              <div class="slider-container">
                  <input type="range" id="clusterSlider" min="0" max="500" step="10" value="50">
                  <span id="clusterValue" class="slider-value">50m</span>
              </div>
          </div>
      </div>

      <!-- 新增功能：重複性案件檢核 (含清除按鈕與結果點擊) -->
      <div class="card-section">
          <div class="card-title"><i class="fas fa-history"></i> 重複性案件檢核</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)</div>
          <input type="text" id="dupCheckInput" placeholder="例如：181924,2555825">
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="dupCheckBtn" class="primary" style="background:#e65100; margin-top:0;"><i class="fas fa-search"></i> 開始檢核</button>
            <!-- 修正：清除按鈕不換行 -->
            <button id="dupClearBtn" class="secondary" style="width:auto; margin-top:0; white-space:nowrap; flex-shrink:0;">清除</button>
          </div>
          <div id="dupCheckResult" style="margin-top:10px; font-size:13px; color:#333;"></div>
      </div>

      <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">臺南市山上區公所</div>
  </div>
  
  <div id="tab-dengue" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-map-pin"></i> 座標輸入</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
          <textarea id="dengueCoordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="plotDengueBtn" class="primary" style="background:#7f8c8d; margin-top:0;">顯示點位</button>
            <button id="clearDengueBtn" class="secondary" style="margin-top:0;">清除</button>
          </div>
      </div>

      <div class="card-section">
          <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
          <!-- 修正：移除 (內政部版) 文字 -->
          <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
              <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
          </a>
      </div>

      <div class="card-section">
          <div class="card-title"><i class="fas fa-circle-notch"></i> 選擇方圓半徑</div>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
              <label class="dengue-option">
                  <input type="radio" name="dengueRadius" value="50" onchange="updateDengueRadius()"> 50 公尺
              </label>
              <label class="dengue-option">
                  <input type="radio" name="dengueRadius" value="150" onchange="updateDengueRadius()"> 150 公尺
              </label>
              <label class="dengue-option">
                  <input type="radio" name="dengueRadius" value="200" onchange="updateDengueRadius()"> 200 公尺
              </label>
          </div>
      </div>
      <div style="text-align:center; color:#999; font-size:12px; margin-top:20px;">臺南市山上區公所</div>
  </div>
</div>

<div id="map"></div>
<div id="floatingCoords"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<!-- 引入 TopoJSON 支援 -->
<script src="https://unpkg.com/topojson-client@3"></script>
<!-- 新增：定位套件 JS -->
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
/* === 1. 初始化 Map (必須放在所有圖層變數之前) === */
const map = L.map('map', { zoomControl:false, doubleClickZoom: false }).setView([23.1025,120.3538], 13);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '© Google Maps' });
let isSat = false; 

/* === 升級：完美定位導航功能整合 (Leaflet.LocateControl) === */
// 初始化定位控制項 (設定參數以符合 Google Maps 體驗)
const lc = L.control.locate({
    position: 'topright', // 先放在預設位置，稍後用 JS 移動到自訂區塊
    strings: {
        title: "我的位置 (點擊追蹤)"
    },
    icon: 'fas fa-crosshairs', // 使用 FontAwesome 圖示
    iconLoading: 'fas fa-spinner fa-spin',
    setView: 'untilPan', // 鎖定視角，直到使用者手動拖曳地圖為止
    keepCurrentZoomLevel: true, // 保持當前縮放層級
    flyTo: true, // 平滑飛行效果
    cacheLocation: true,
    showPopup: false, // 不顯示預設的 "You are within x meters" 視窗
    drawCircle: true, // 繪製準確度圓圈
    drawMarker: true, // 繪製藍點
    locateOptions: {
        enableHighAccuracy: true,
        watch: true // 關鍵：持續監聽位置變動
    }
}).addTo(map);

// === 關鍵修改：將定位按鈕搬移到 .map-floating-controls 並保持原有樣式 ===
const floatingContainer = document.querySelector('.map-floating-controls');
const lcContainer = lc.getContainer(); // 取得套件生成的 DOM

// 移除套件預設的 Leaflet Control 樣式類別，避免外觀衝突
lcContainer.classList.remove('leaflet-bar', 'leaflet-control');

// 將按鈕插入到自訂懸浮區塊的最上方 (prepend)
floatingContainer.prepend(lcContainer);

// 防止手機休眠 (Wake Lock) 邏輯
let wakeLock = null;
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Screen Wake Lock active');
        } catch (err) {
            console.error(`${err.name}, ${err.message}`);
        }
    }
}
// 當開始定位時，申請螢幕恆亮
map.on('locateactivate', requestWakeLock);

/* === 全域變數宣告 === */
let REPAIR_CONFIG = []; 
let roadsLayer = null;  
let roadLayersArray = [];
let REPAIR_DATA_CACHE = {}; 
let ALL_CONTRACTORS = new Set(); 
let currentRouteAllMatches = []; 
let villageGeoJSON = null; // 儲存里界資料
let dupCheckLayer = L.layerGroup().addTo(map); // 重複性檢核圖層
let dupMarkersMap = {}; // 儲存重複檢核的標記參照，以便點擊列表時縮放

let isMeasuring = false;
let measureStartLatLng = null;
let measureLine = null;
let measureTooltip = null;
let markersClusterGroup = null; 
let activeRepairLayers = []; 
let reportCaseNumber = 1; // 通報案件流水號模擬

const DEEP_BLUE = '#004080'; 
const LIGHT_BLUE = '#0066cc'; 
const ROUTE_MATCH_THRESHOLD = 50; 
const NEAR_ROAD_THRESHOLD = 30; 
const POINT_RADIUS = 14; 

proj4.defs("EPSG:3826","+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=WGS84 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

function twd97FromWgs84(lat,lng){ 
    const p = proj4('EPSG:4326','EPSG:3826',[lng,lat]); 
    return {x:Math.round(p[0]),y:Math.round(p[1])}; 
}

/* === 2. 初始化其他圖層 === */
const dengueLayer = L.layerGroup().addTo(map);
const dengueRadiusLayer = L.layerGroup().addTo(map);

const cadastralLayer = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: '© 國土測繪中心', opacity: 0.8, maxZoom: 20 });
let isCadastralVisible = false;

const boundaryLayer = L.layerGroup().addTo(map).setZIndex(100); 
const pointLayer = L.layerGroup().addTo(map).setZIndex(1000);   
const repairLayer = L.layerGroup().addTo(map); 
const routeMatchLayer = L.layerGroup().addTo(map).setZIndex(999); // 確保在最上層
const searchResultLayer = L.featureGroup().addTo(map);
const clusterLayer = L.featureGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map).setZIndex(1001);

/* === 案件通報相關邏輯 === */
const reportOverlay = document.getElementById('reportOverlay');
const openReportBtn = document.getElementById('openReportBtn');

openReportBtn.addEventListener('click', function() {
    reportOverlay.style.display = 'flex';
    initReportData();
});

function closeReport() {
    reportOverlay.style.display = 'none';
    resetReportForm();
}

function initReportData() {
    // 1. 生成案件編號：YYYMMDDNN
    const now = new Date();
    const year = now.getFullYear() - 1911;
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const num = String(reportCaseNumber).padStart(2, '0');
    document.getElementById('reportCaseId').innerText = `${year}${month}${day}${num}`;
    
    // 2. 時間
    document.getElementById('reportTime').innerText = now.toLocaleString();
    
    // 3. 座標定位
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const twd = twd97FromWgs84(lat, lng);
                document.getElementById('reportWgs84').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('reportTwd97').innerText = `${twd.x}, ${twd.y}`;
            },
            (err) => {
                document.getElementById('reportWgs84').innerText = "定位失敗";
                document.getElementById('reportTwd97').innerText = "定位失敗";
            },
            { enableHighAccuracy: true }
        );
    } else {
        document.getElementById('reportWgs84').innerText = "不支援定位";
    }
}

function triggerCamera(id) {
    const fileInput = document.getElementById(`fileInput${id}`);
    if (!document.getElementById(`imgPreview${id}`).src) {
         fileInput.click();
    }
}

function previewImage(input, id) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.getElementById(`imgPreview${id}`);
            const box = document.getElementById(`photoBox${id}`);
            const delBtn = document.getElementById(`delBtn${id}`);
            
            img.src = e.target.result;
            img.style.display = 'block';
            box.querySelector('.add-photo-btn').style.display = 'none';
            box.classList.add('has-image');
            delBtn.style.display = 'block';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function deletePhoto(id) {
    const img = document.getElementById(`imgPreview${id}`);
    const box = document.getElementById(`photoBox${id}`);
    const input = document.getElementById(`fileInput${id}`);
    const delBtn = document.getElementById(`delBtn${id}`);
    
    img.src = "";
    img.style.display = 'none';
    box.querySelector('.add-photo-btn').style.display = 'block';
    box.classList.remove('has-image');
    input.value = ""; // 清空 input
    delBtn.style.display = 'none';
}

function resetReportForm() {
    deletePhoto(1);
    deletePhoto(2);
    document.getElementById('reportDesc').value = ""; // 清空描述
    document.getElementById('reportWgs84').innerText = "定位中...";
    document.getElementById('reportTwd97').innerText = "定位中...";
}

function submitReport() {
    if (confirm("確定要上傳此案件通報嗎？")) {
        // 模擬上傳資料打包
        const data = {
            caseId: document.getElementById('reportCaseId').innerText,
            time: document.getElementById('reportTime').innerText,
            wgs84: document.getElementById('reportWgs84').innerText,
            twd97: document.getElementById('reportTwd97').innerText,
            description: document.getElementById('reportDesc').value, // 新增：案情描述
            photo1: document.getElementById('imgPreview1').src ? "有照片" : "無",
            photo2: document.getElementById('imgPreview2').src ? "有照片" : "無"
        };
        
        console.log("上傳資料:", data);
        
        alert("案件通報成功！\n\n(此為前端模擬，資料已記錄於 Console)");
        reportCaseNumber++; // 模擬編號增加
        closeReport();
    }
}

/* === 重複性案件檢核功能 (新) === */
// 清除按鈕功能
document.getElementById('dupClearBtn').addEventListener('click', function() {
    dupCheckLayer.clearLayers();
    document.getElementById('dupCheckResult').innerHTML = '';
    document.getElementById('dupCheckInput').value = '';
    dupMarkersMap = {};
});

// 全域函式：供檢核列表點擊呼叫
window.focusDupMarker = function(index) {
    const marker = dupMarkersMap[index];
    if(marker) {
        map.flyTo(marker.getLatLng(), 18);
        marker.openPopup();
        // 手機版自動收合側邊欄
        if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
    }
};

document.getElementById('dupCheckBtn').addEventListener('click', function() {
    const input = document.getElementById('dupCheckInput').value.trim();
    const resultDiv = document.getElementById('dupCheckResult');
    dupCheckLayer.clearLayers();
    resultDiv.innerHTML = '';
    dupMarkersMap = {}; // 重置
    
    if (!input) {
        alert('請輸入 TWD97 座標，例如 181924,2555825');
        return;
    }
    
    const parts = input.split(/[, \t]+/);
    if (parts.length < 2) {
        alert('座標格式錯誤');
        return;
    }
    
    const x = parseFloat(parts[0]);
    const y = parseFloat(parts[1]);
    
    if (isNaN(x) || isNaN(y)) {
        alert('座標數值錯誤');
        return;
    }
    
    // 轉換為 WGS84
    try {
        const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]);
        const centerLatLng = L.latLng(w[1], w[0]);
        
        // 1. 地圖飛到該點 & 畫紅圈 (50m)
        map.setView(centerLatLng, 18);
        L.circle(centerLatLng, {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.2,
            radius: 50 // 50公尺半徑
        }).addTo(dupCheckLayer);
        
        L.marker(centerLatLng).addTo(dupCheckLayer).bindPopup(`檢核中心點<br>TWD97: ${x}, ${y}`).openPopup();
        
        // 2. 搜尋 50m 內且 3年內的案件
        const matches = [];
        const now = new Date();
        const threeYearsAgo = new Date();
        threeYearsAgo.setFullYear(now.getFullYear() - 3); // 3年前
        
        REPAIR_CONFIG.forEach(conf => {
            const data = REPAIR_DATA_CACHE[conf.value];
            if (!data) return;
            
            data.features.forEach(f => {
                if (f.geometry.type !== 'Point') return;
                
                const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
                const dist = centerLatLng.distanceTo(pt);
                
                if (dist <= 50) {
                    // 檢查時間
                    const dateStr = f.properties['完工日期']; // e.g. "1130520"
                    if (dateStr && dateStr.length === 7) {
                        const y = parseInt(dateStr.substring(0, 3)) + 1911;
                        const m = parseInt(dateStr.substring(3, 5)) - 1;
                        const d = parseInt(dateStr.substring(5, 7));
                        const finishDate = new Date(y, m, d);
                        
                        if (finishDate >= threeYearsAgo) {
                            // 計算距今多久 (更精確的 年+月)
                            let diffMonths = (now.getFullYear() - finishDate.getFullYear()) * 12 + (now.getMonth() - finishDate.getMonth());
                            if (now.getDate() < finishDate.getDate()) {
                                diffMonths--;
                            }
                            const years = Math.floor(diffMonths / 12);
                            const months = diffMonths % 12;
                            const timeAgoStr = `${years} 年 ${months} 個月`;
                            
                            const isEmergency = /搶修|災害|緊急/.test(conf.label);
                            
                            matches.push({
                                name: conf.label,
                                props: f.properties,
                                date: dateStr,
                                timeAgo: timeAgoStr,
                                dist: dist.toFixed(1),
                                isEmergency: isEmergency,
                                latlng: pt
                            });
                        }
                    }
                }
            });
        });
        
        // 3. 顯示結果
        if (matches.length === 0) {
            resultDiv.innerHTML = '<div style="color:green; font-weight:bold;"><i class="fas fa-check-circle"></i> 此範圍 50m 內近 3 年無相關紀錄</div>';
        } else {
            // 排序 (距離近優先)
            matches.sort((a, b) => parseFloat(a.dist) - parseFloat(b.dist));
            
            let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">⚠️ 發現 ${matches.length} 筆近 3 年紀錄：</div>`;
            
            matches.forEach((m, index) => {
                // 標示出舊案件位置 (黃色圓點，可點擊)
                const marker = L.circleMarker(m.latlng, { radius: 8, color: '#d32f2f', weight: 2, fillColor: '#ffeb3b', fillOpacity: 1 }).addTo(dupCheckLayer);
                
                // 綁定 Popup (共用之前的 createPopup 邏輯)
                const distToLine = distToRoad(m.latlng, roadsLayer); // 計算距路徑距離以保持一致性
                marker.bindPopup(createPopup({ 
                    fileName: m.name, 
                    props: m.props, 
                    lat: m.latlng.lat, 
                    lng: m.latlng.lng, 
                    dist: distToLine 
                }), { className: 'custom-popup' });
                
                // 儲存參照
                dupMarkersMap[index] = marker;

                const tagClass = m.isEmergency ? 'tag-emg' : 'tag-gen';
                const tagName = m.isEmergency ? '搶修' : '一般';
                
                // 格式：點擊呼叫 focusDupMarker
                html += `
                    <div class="dup-check-item" onclick="focusDupMarker(${index})">
                        <div class="dup-check-title">${m.name}<span class="dup-tag ${tagClass}">${tagName}</span></div>
                        <div class="dup-check-info">
                            <span>完工：${m.props['完工日期']} (距今 ${m.timeAgo})</span>
                        </div>
                        <div class="dup-check-info">
                            <span>距離：${m.dist} 公尺</span>
                        </div>
                    </div>
                `;
            });
            resultDiv.innerHTML = html;
        }
        
    } catch (e) {
        console.error(e);
        alert('座標轉換失敗');
    }
});


/* === UI 控制與事件 === */
window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`);
    if(btn) btn.classList.add('active');
};

const toggleBtn = document.getElementById('toggleSidebarBtn');
const overlayMask = document.getElementById('overlay-mask');
const bottomPanel = document.getElementById('bottomPanel');
const togglePanelSizeBtn = document.getElementById('togglePanelSizeBtn');
const panelIcon = togglePanelSizeBtn.querySelector('i');

function toggleSidebar() {
    const isMobile = window.innerWidth <= 768;
    if (isMobile) document.body.classList.toggle('sidebar-open');
    else document.body.classList.toggle('collapsed');
    setTimeout(() => map.invalidateSize(), 300);
}
toggleBtn.addEventListener('click', toggleSidebar);
overlayMask.addEventListener('click', () => document.body.classList.remove('sidebar-open'));

document.getElementById('closePanelBtn').addEventListener('click', () => {
    bottomPanel.classList.remove('open');
    routeMatchLayer.clearLayers();
});

togglePanelSizeBtn.addEventListener('click', () => {
    bottomPanel.classList.toggle('minimized');
    if (bottomPanel.classList.contains('minimized')) {
        panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
    } else {
        panelIcon.classList.replace('fa-chevron-up', 'fa-chevron-down');
    }
});

/* === 資料載入 === */
fetch('tainan_districts.geojson').then(r=>r.json()).then(data=>{
    // Layer 1: Solid Neon Purple Line (Tech Style) - 紫色粗虛線
    L.geoJSON(data, {
        interactive: false,
        style: f => {
            const isTarget = (f.properties.TOWNNAME||f.properties.TOWN).includes('山上');
            return {
                color: '#d500f9', // Neon Purple
                weight: isTarget ? 4 : 1, 
                opacity: 1,
                dashArray: isTarget ? '15, 10' : '', // Dashed pattern
                fillOpacity: 0
            };
        }
    }).addTo(boundaryLayer);
}).catch(e=>console.warn(e));

/* 新增：載入 t22.json (TopoJSON 里界) 並設定七色分區 */
const VILLAGE_COLORS = {
    "明和里": "#E74C3C", // 柔和紅
    "山上里": "#F39C12", // 亮橘色
    "南洲里": "#F1C40F", // 金黃色
    "新莊里": "#2ECC71", // 翡翠綠
    "平陽里": "#1ABC9C", // 青綠色
    "豐德里": "#9B59B6", // 紫羅蘭
    "玉峯里": "#FF69B4", // 粉紅色
    "玉峰里": "#FF69B4"  // 相容字
};

fetch('t22.json').then(r => r.json()).then(topology => {
    villageGeoJSON = topojson.feature(topology, topology.objects.t22);
    
    // 取得里名列表 (用於搜尋 & 統計)
    const villageNames = villageGeoJSON.features.map(f => f.properties.VILLAGE || f.properties.VILLNAME).sort();
    
    // 1. 填入「搜尋分頁-依里別快篩」下拉選單
    const vSelSearch = document.getElementById('villageSelect');
    vSelSearch.innerHTML = '<option value="">-- 請選擇行政區 --</option>';
    
    // 2. 填入「透明分頁-里別維修統計」下拉選單
    const vSelStats = document.getElementById('statsVillageSelect');
    vSelStats.innerHTML = '<option value="">-- 請選擇行政區 --</option>';

    villageNames.forEach(v => {
        // 搜尋選單
        const opt1 = document.createElement('option');
        opt1.value = v; opt1.textContent = v;
        vSelSearch.appendChild(opt1);
        
        // 統計選單
        const opt2 = document.createElement('option');
        opt2.value = v; opt2.textContent = v;
        vSelStats.appendChild(opt2);
    });

    // 顯示里界線 (色塊 + 細虛線)
    const villageLayer = L.geoJSON(villageGeoJSON, {
        style: function(feature) {
            const vName = feature.properties.VILLAGE || feature.properties.VILLNAME;
            const color = VILLAGE_COLORS[vName] || "#999";
            return {
                fillColor: color,
                fillOpacity: 0.1, // 極低透明度，不擋底圖
                color: color,     // 邊框同色
                weight: 1,        // 細線
                opacity: 0.4,
                dashArray: '5, 5' // 虛線風格
            };
        },
        onEachFeature: function(feature, layer) {
            // 滑鼠移入：加深顏色 + 金黃邊框
            layer.on('mouseover', function() {
                this.setStyle({
                    fillOpacity: 0.4,
                    weight: 2,
                    color: '#FFD700', // 金黃色 highlight
                    dashArray: ''     // 實線
                });
            });
            // 滑鼠移出：恢復原狀
            layer.on('mouseout', function() {
                villageLayer.resetStyle(this);
            });
        }
    }).addTo(boundaryLayer);
    
    // 確保在最底層，不遮擋道路
    villageLayer.bringToBack();
    
}).catch(e => console.warn("無法載入里界資料 t22.json", e));

/* 輔助函式：取得里別名稱 */
function getVillageName(lat, lng) {
    if (!villageGeoJSON) return "讀取資料中...";
    const pt = turf.point([lng, lat]);
    for (const feature of villageGeoJSON.features) {
        if (turf.booleanPointInPolygon(pt, feature)) {
            // 嘗試取得里名，根據 GeoJSON 屬性欄位可能不同
            const vName = feature.properties.VILLAGE || feature.properties.VILLNAME || "未知里";
            return `山上區 ${vName}`;
        }
    }
    return "非山上區範圍";
}

/* 監聽：依里別快篩 (搜尋分頁) */
document.getElementById('villageSelect').addEventListener('change', function() {
    const selectedVillage = this.value;
    const status = document.getElementById('searchStatus');
    const clearBtn = document.getElementById('clearSearchBtn');
    
    // 清除其他搜尋欄位
    document.getElementById('keywordInput').value = '';
    document.getElementById('contractorSelect').value = '';
    searchResultLayer.clearLayers();

    if (!selectedVillage) {
        status.innerText = '';
        clearBtn.style.display = 'none';
        return;
    }

    const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage);
    if (!villageFeature) return;

    let count = 0;
    
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if (!data || !data.features) return;
        
        data.features.forEach(f => {
            try {
                if (f.geometry.type !== 'Point') return;
                if (turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
                    const [lng, lat] = f.geometry.coordinates;
                    const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.feature = f;
                    marker.bindPopup(createPopup({ fileName: conf.label, props: f.properties, lat, lng, dist: distToRoad(ll, roadsLayer) }), { className: 'custom-popup' });
                    count++;
                }
            } catch (e) {}
        });
    });

    if (count > 0) {
        const bounds = L.geoJSON(villageFeature).getBounds();
        map.fitBounds(bounds);
        if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
        status.innerHTML = `${selectedVillage} 範圍內找到 <b style="color:#d32f2f">${count}</b> 筆`;
        clearBtn.style.display = 'block';
    } else {
        status.innerHTML = '<span style="color:red">此里範圍內尚無案件資料</span>';
        map.fitBounds(L.geoJSON(villageFeature).getBounds());
    }
    if(clusterToggle.checked) setTimeout(calculateClusters, 100);
});

/* 新增監聽：里別維修統計 (透明分頁) - 升級版：分年度統計 */
document.getElementById('statsVillageSelect').addEventListener('change', function() {
    const selectedVillage = this.value;
    const statsResult = document.getElementById('statsResult');
    const statsGenList = document.getElementById('statsGenList');
    const statsEmgList = document.getElementById('statsEmgList');
    
    // 清除舊資料 & 地圖點位
    searchResultLayer.clearLayers();
    statsGenList.innerHTML = '';
    statsEmgList.innerHTML = '';

    if (!selectedVillage) {
        statsResult.style.display = 'none';
        return;
    }

    const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage);
    if (!villageFeature) return;

    // --- 步驟 1: 計算「全區」各年度總金額 (分母) ---
    // 結構: globalYearTotals = { '114': { gen: 0, emg: 0 }, '113': ... }
    let globalYearTotals = {};
    let globalProcessedCases = new Set(); // 全區去重

    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if (!data || !data.features) return;
        
        // 取得年份 (從檔名 '搶險搶修114年' 提取 '114')
        const yearMatch = conf.label.match(/(\d{3})年/);
        const year = yearMatch ? yearMatch[1] : '其他';
        const isEmergency = /搶修|災害|緊急/.test(conf.label);

        if (!globalYearTotals[year]) globalYearTotals[year] = { gen: 0, emg: 0 };

        data.features.forEach(f => {
            try {
                const props = f.properties;
                const caseNo = props['案件編號'];
                const amount = formatMoney(props['決標金額']);
                
                // 全區金額計算 (含去重)
                if (caseNo && caseNo.trim() !== "") {
                    if (!globalProcessedCases.has(caseNo)) {
                        globalProcessedCases.add(caseNo);
                        if (isEmergency) globalYearTotals[year].emg += amount;
                        else globalYearTotals[year].gen += amount;
                    }
                } else {
                    if (isEmergency) globalYearTotals[year].emg += amount;
                    else globalYearTotals[year].gen += amount;
                }
            } catch(e){}
        });
    });

    // --- 步驟 2: 計算「該里」各年度數據 (分子) & 繪製地圖 ---
    // 結構: villageYearStats = { '114': { genCount: 0, genAmount: 0, ... } }
    let villageYearStats = {};
    let villageProcessedCases = new Set(); // 里內去重

    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if (!data || !data.features) return;

        const yearMatch = conf.label.match(/(\d{3})年/);
        const year = yearMatch ? yearMatch[1] : '其他';
        const isEmergency = /搶修|災害|緊急/.test(conf.label);
        
        if (!villageYearStats[year]) {
            villageYearStats[year] = { genCount: 0, genAmount: 0, emgCount: 0, emgAmount: 0 };
        }

        data.features.forEach(f => {
            try {
                if (f.geometry.type !== 'Point') return;
                
                // 空間判斷
                if (turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
                    
                    // 繪製地圖點位
                    const [lng, lat] = f.geometry.coordinates;
                    const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.feature = f;
                    marker.bindPopup(createPopup({ fileName: conf.label, props: f.properties, lat, lng, dist: distToRoad(ll, roadsLayer) }), { className: 'custom-popup' });

                    // 統計計算
                    const props = f.properties;
                    const caseNo = props['案件編號'];
                    const amount = formatMoney(props['決標金額']);
                    
                    let shouldAdd = false;
                    if (caseNo && caseNo.trim() !== "") {
                        if (!villageProcessedCases.has(caseNo)) {
                            villageProcessedCases.add(caseNo);
                            shouldAdd = true;
                        }
                    } else {
                        shouldAdd = true;
                    }

                    if (shouldAdd) {
                        if (isEmergency) {
                            villageYearStats[year].emgCount++;
                            villageYearStats[year].emgAmount += amount;
                        } else {
                            villageYearStats[year].genCount++;
                            villageYearStats[year].genAmount += amount;
                        }
                    }
                }
            } catch (e) {}
        });
    });

    // --- 步驟 3: 產生 HTML 列表 (按年份倒序) ---
    const sortedYears = Object.keys(villageYearStats).sort().reverse();
    
    sortedYears.forEach(y => {
        const stats = villageYearStats[y];
        const globalTotals = globalYearTotals[y] || { gen: 1, emg: 1 }; // 避免除以0
        
        // 一般工程 HTML
        if (stats.genCount > 0) {
            const pct = globalTotals.gen > 0 ? (stats.genAmount / globalTotals.gen * 100).toFixed(0) : 0;
            const html = `
                <div class="stat-year-row">
                    <div class="stat-year-title">
                        <span>${y}年度</span>
                        <span class="stat-percent-text">佔全區 ${pct}%</span>
                    </div>
                    <div class="stat-data-row">${stats.genCount} 件 / $ ${stats.genAmount.toLocaleString()}</div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            statsGenList.innerHTML += html;
        }

        // 搶險搶修 HTML
        if (stats.emgCount > 0) {
            const pct = globalTotals.emg > 0 ? (stats.emgAmount / globalTotals.emg * 100).toFixed(0) : 0;
            const html = `
                <div class="stat-year-row">
                    <div class="stat-year-title">
                        <span>${y}年度</span>
                        <span class="stat-percent-text">佔全區 ${pct}%</span>
                    </div>
                    <div class="stat-data-row">${stats.emgCount} 件 / $ ${stats.emgAmount.toLocaleString()}</div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div>
                </div>`;
            statsEmgList.innerHTML += html;
        }
    });

    // 若無資料顯示提示
    if (statsGenList.innerHTML === '') statsGenList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';
    if (statsEmgList.innerHTML === '') statsEmgList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';

    // 地圖縮放
    const bounds = L.geoJSON(villageFeature).getBounds();
    map.fitBounds(bounds);
    if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');

    statsResult.style.display = 'block';
});

// 新增監聽：清除所有顯示按鈕 (透明分頁下)
document.getElementById('clearStatsBtn').addEventListener('click', function() {
    // 1. 清空地圖點位
    searchResultLayer.clearLayers();
    // 2. 重置下拉選單
    document.getElementById('statsVillageSelect').value = "";
    // 3. 隱藏統計儀表板
    document.getElementById('statsResult').style.display = 'none';
});

fetch('farmroads.geojson').then(r=>r.json()).then(data=>{
    roadsLayer = L.geoJSON(data, {
        style: { color: DEEP_BLUE, weight: 3, opacity: 0.9 }, 
        onEachFeature: (f, l) => {
            l.bindTooltip(f.properties?.name || "道路", { sticky: true, direction: 'top' });
            l.on('mouseover', () => { l.setStyle({ weight: 5, color: LIGHT_BLUE }); map.getContainer().style.cursor='pointer'; });
            l.on('mouseout', () => { l.setStyle({ weight: 3, color: DEEP_BLUE }); map.getContainer().style.cursor='default'; });
            l.on('click', (e) => {
                L.DomEvent.stopPropagation(e);
                handleMapClickSelection(roadLayersArray.indexOf(l), true);
                if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
            });
        }
    }).addTo(map);
    roadLayersArray = roadsLayer.getLayers();
    const sel = document.getElementById('roadSelect');
    sel.innerHTML = '<option value="">-- 請選擇路線 --</option>';
    data.features.forEach((f, i) => {
        const o = document.createElement('option');
        o.value = i; o.textContent = f.properties?.name || `路線 ${i+1}`;
        sel.appendChild(o);
    });
}).catch(e=>{});

async function loadRepairSettings() {
    const box = document.getElementById('repairCheckboxes');
    try {
        const res = await fetch('repair_months.json');
        REPAIR_CONFIG = await res.json(); 
    } catch (e) { box.innerHTML = '讀取失敗'; return; }
    
    if(REPAIR_CONFIG.length === 0) { box.innerHTML = '無資料'; return; }
    box.innerHTML = ''; 
    const grouped = {};
    REPAIR_CONFIG.forEach(item => {
        const m = item.label.match(/(\d{3})年/);
        const y = m ? m[1] : '其他';
        if(!grouped[y]) grouped[y] = [];
        grouped[y].push(item);
    });
    Object.keys(grouped).sort((a,b)=>b-a).forEach((y, idx) => {
        const gDiv = document.createElement('div');
        gDiv.className = 'year-group';
        if(idx===0) gDiv.classList.add('open');
        gDiv.innerHTML = `
            <div class="year-header" onclick="this.parentElement.classList.toggle('open')">
                <div><span class="toggle-icon">▶</span> ${y}年度</div>
                <label class="year-select-all" onclick="event.stopPropagation()"><input type="checkbox" onchange="toggleYear(this)"> 全選</label>
            </div>
            <div class="year-content">
                ${grouped[y].map(item => `<div class="checkbox-item"><input type="checkbox" value="${item.value}" class="repair-cb" onchange="updateRepairPoints()"><label>${item.label}</label></div>`).join('')}
            </div>
        `;
        box.appendChild(gDiv);
    });
    // 立即預載所有資料，確保時間軸和搜尋能正常運作
    preloadAllDataForContractors();
}
loadRepairSettings();

window.toggleYear = function(source) {
    const cbs = source.closest('.year-group').querySelectorAll('.repair-cb');
    cbs.forEach(cb => cb.checked = source.checked);
    updateRepairPoints();
}

function distToRoad(latlng, roadLayer) {
    if(!roadLayer || !turf) return NaN;
    try {
        let min = Infinity;
        roadLayer.eachLayer(l => {
            if(!l.feature.geometry) return;
            const geom = l.feature.geometry;
            const line = geom.type==='LineString' ? turf.lineString(geom.coordinates) : (geom.type==='MultiLineString' ? turf.multiLineString(geom.coordinates) : null);
            if(line) {
                const d = turf.pointToLineDistance(turf.point([latlng.lng, latlng.lat]), line, {units:'meters'});
                if(d < min) min = d;
            }
        });
        return min===Infinity ? NaN : min;
    } catch(e) { return NaN; }
}

function createPopup(data) {
    const { fileName, props, lat, lng, dist } = data;
    const dText = isNaN(dist) ? 'N/A' : (dist<=30 ? `<span style="color:green">${dist.toFixed(1)}m</span>` : `<span style="color:red">${dist.toFixed(1)}m</span>`);
    const twd = twd97FromWgs84(lat, lng);
    const procurementUrl = props['採購網址'] ? props['採購網址'].trim() : '';
    const tenderBtn = procurementUrl ? `<a href="${procurementUrl}" target="_blank" class="popup-btn"><i class="fas fa-bullhorn"></i> 決標公告</a>` : `<span class="popup-btn" style="background:#eee;color:#999;cursor:not-allowed;"><i class="fas fa-bullhorn"></i> 無公告</span>`;
    
    return `
        <div class="info-card">
            <div class="info-header">檔案編號：${fileName}</div>
            <div class="info-body">
                <div class="info-row"><div class="info-label">案件編號</div><div class="info-val">${props['案件編號']||''}</div></div>
                <div class="info-row"><div class="info-label">決標金額</div><div class="info-val" style="font-weight:bold;color:#0056b3;">${props['決標金額']||''}</div></div>
                <div class="info-row"><div class="info-label">施工廠商</div><div class="info-val">${props['施工廠商']||''}</div></div>
                <div class="info-row"><div class="info-label">監造廠商</div><div class="info-val">${props['監造廠商']||''}</div></div>
                <div class="info-row"><div class="info-label">完工日期</div><div class="info-val">${props['完工日期']||''}</div></div>
                <div class="info-row"><div class="info-label">TWD97</div><div class="info-val">${props['X']||twd.x}, ${props['Y']||twd.y}</div></div>
                <div class="info-row"><div class="info-label">WGS84</div><div class="info-val">${lat.toFixed(6)}, ${lng.toFixed(6)}</div></div>
                <div class="info-row"><div class="info-label">距最近路線</div><div class="info-val">${dText}</div></div>
                
                <div class="btn-group-popup">
                    ${tenderBtn}
                    <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="popup-btn"><i class="fas fa-map"></i> 地籍查詢</a>
                    <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="popup-btn"><i class="fas fa-street-view"></i> Google街景</a>
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn"><i class="fas fa-location-arrow"></i> Google導航</a>
                </div>
            </div>
        </div>
    `;
}

function updateRepairPoints() {
    if(markersClusterGroup) {
        markersClusterGroup.clearLayers();
        map.removeLayer(markersClusterGroup);
    }
    
    const checked = document.querySelectorAll('.repair-cb:checked');
    activeRepairLayers = []; 
    const panel = document.getElementById('clusterControlPanel');
    const toggleBtn = document.getElementById('toggleClusterControlBtn'); // 取得按鈕

    checked.forEach(cb => {
        const fileKey = cb.value;
        if(REPAIR_DATA_CACHE[fileKey]) {
            const data = REPAIR_DATA_CACHE[fileKey];
            const config = REPAIR_CONFIG.find(c => c.value === fileKey);
            
            L.geoJSON(data, {
                pointToLayer: (f, ll) => {
                    const dist = distToRoad(ll, roadsLayer);
                    const isFar = (!isNaN(dist) && dist > 30);
                    const color = isFar ? '#ef4444' : '#004080';
                    const iconHtml = `<div style="width:14px; height:14px; background:${color}; border:2px solid #fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>`;
                    const icon = L.divIcon({ html: iconHtml, className: 'custom-dot-marker', iconSize: [18, 18], iconAnchor: [9, 9] });
                    const marker = L.marker(ll, { icon: icon });
                    marker.bindPopup(createPopup({ fileName: config.label, props: f.properties, lat: ll.lat, lng: ll.lng, dist }), { className: 'custom-popup' });
                    // 重要：確保 feature 被保留在 marker 上，供熱區分析使用
                    marker.feature = f; 
                    activeRepairLayers.push(marker);
                    return marker;
                }
            });
        }
    });

    // 修正邏輯：不再自動顯示面板，只在點位數為 0 時強制隱藏
    if (activeRepairLayers.length === 0) {
        panel.style.display = 'none';
        toggleBtn.classList.remove('active');
    }
    // 如果點位數 > 0，則面板狀態由使用者點擊按鈕決定
    
    renderClusterGroup();
    calculateClusters(); 
}

function renderClusterGroup() {
    const sliderVal = parseInt(document.getElementById('clusterRadiusSlider').value);
    if (markersClusterGroup) map.removeLayer(markersClusterGroup);
    markersClusterGroup = L.markerClusterGroup({
        maxClusterRadius: sliderVal,
        disableClusteringAtZoom: 18, 
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true
    });
    markersClusterGroup.addLayers(activeRepairLayers);
    map.addLayer(markersClusterGroup);
}

const clusterRadiusSlider = document.getElementById('clusterRadiusSlider');
const clusterRadiusVal = document.getElementById('clusterRadiusVal');
clusterRadiusSlider.addEventListener('input', function() {
    clusterRadiusVal.innerText = `範圍 ${this.value}px`;
    renderClusterGroup();
});

// 修正項目：新增切換聚合設定面板的事件監聽器
const toggleClusterControlBtn = document.getElementById('toggleClusterControlBtn');
const clusterControlPanel = document.getElementById('clusterControlPanel');
const closeClusterControlBtn = document.getElementById('closeClusterControlBtn');

toggleClusterControlBtn.addEventListener('click', function() {
    // 檢查是否有 activeRepairLayers，沒有則不開啟，並給予提示 (可選)
    if (activeRepairLayers.length === 0) {
        alert("請先至「透明」分頁勾選欲顯示的案件資料。");
        return;
    }
    const isVisible = clusterControlPanel.style.display === 'block';
    clusterControlPanel.style.display = isVisible ? 'none' : 'block';
    this.classList.toggle('active');
});

closeClusterControlBtn.addEventListener('click', function() {
    clusterControlPanel.style.display = 'none';
    toggleClusterControlBtn.classList.remove('active');
});

async function preloadAllDataForContractors() {
    const cSel = document.getElementById('contractorSelect');
    await Promise.all(REPAIR_CONFIG.map(async item => {
        if (!REPAIR_DATA_CACHE[item.value]) { // 避免重複載入
            try {
                const res = await fetch(item.value + '.geojson');
                if(res.ok) {
                    const json = await res.json();
                    REPAIR_DATA_CACHE[item.value] = json;
                    json.features?.forEach(f => {
                        const c = f.properties['施工廠商']?.trim();
                        if(c) ALL_CONTRACTORS.add(c);
                    });
                }
            } catch(e){}
        }
    }));
    const sortedC = Array.from(ALL_CONTRACTORS).sort();
    cSel.innerHTML = '<option value="">-- 請選擇廠商 (' + sortedC.length + ') --</option>' + sortedC.map(c => `<option value="${c}">${c}</option>`).join('');
    cSel.addEventListener('change', function() {
        if(this.value) { document.getElementById('keywordInput').value=''; document.getElementById('villageSelect').value=''; performSearch(p=>p['施工廠商']?.trim()===this.value, `廠商：${this.value}`); }
        else clearSearchResults();
    });
}

async function performSearch(predicate, label) {
    const status = document.getElementById('searchStatus');
    const btn = document.getElementById('searchBtn');
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    status.innerText = '搜尋中...';
    searchResultLayer.clearLayers();
    let count = 0;
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if(!data || !data.features) return;
        data.features.forEach(f => {
            try {
                if(f.geometry.type !== 'Point') return;
                if(predicate(f.properties)) {
                    const [lng, lat] = f.geometry.coordinates;
                    const ll = L.latLng(lat, lng);
                    L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
                    const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
                    marker.feature = f; 
                    marker.bindPopup(createPopup({ fileName: conf.label, props: f.properties, lat, lng, dist: distToRoad(ll, roadsLayer) }), { className: 'custom-popup' });
                    count++;
                }
            } catch(e){}
        });
    });
    if(count > 0) {
        map.fitBounds(searchResultLayer.getBounds());
        if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open');
        status.innerHTML = `找到 <b style="color:#d32f2f">${count}</b> 筆`;
        document.getElementById('clearSearchBtn').style.display = 'block';
    } else status.innerHTML = '<span style="color:red">查無資料</span>';
    btn.disabled = false; btn.innerHTML = '<i class="fas fa-search"></i> 開始搜尋';
    if(clusterToggle.checked) setTimeout(calculateClusters, 100);
}

document.getElementById('searchBtn').addEventListener('click', () => {
    const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
    if(!kw) return alert('請輸入關鍵字');
    document.getElementById('contractorSelect').value = '';
    document.getElementById('villageSelect').value = '';
    performSearch(p => Object.values(p).join(' ').toLowerCase().includes(kw), kw);
});

document.getElementById('clearSearchBtn').addEventListener('click', clearSearchResults);
function clearSearchResults() {
    searchResultLayer.clearLayers();
    document.getElementById('keywordInput').value = '';
    document.getElementById('contractorSelect').value = '';
    document.getElementById('villageSelect').value = '';
    document.getElementById('searchStatus').innerText = '';
    document.getElementById('clearSearchBtn').style.display = 'none';
}

document.getElementById('roadSelect').addEventListener('change', (e) => handleMapClickSelection(e.target.value, false));

function handleMapClickSelection(idx, isInteractive) {
    if(idx==="" || idx===null) return;
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
    const target = roadLayersArray[idx];
    if(target) {
        target.setStyle({ color: 'red', weight: 6 });
        map.fitBounds(target.getBounds());
        target.openPopup();
        if (isInteractive) {
            document.getElementById('panelTitle').innerHTML = `<i class="fas fa-history"></i> ${target.feature.properties.name}`;
            bottomPanel.classList.remove('minimized');
            panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            bottomPanel.classList.add('open');
            showTimeline(target);
        } else {
            bottomPanel.classList.remove('open');
            routeMatchLayer.clearLayers();
        }
    }
}

map.on('click', (e) => {
    if(isMeasuring) {
        if(measureStartLatLng) finishMeasure(e.latlng);
    } else {
        document.getElementById('contextMenu').style.display='none';
        document.getElementById('roadSelect').value = "";
        if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({ color: DEEP_BLUE, weight: 3 }));
        map.closePopup();
        bottomPanel.classList.remove('open');
        routeMatchLayer.clearLayers();
    }
});

/* === 修正：右鍵選單邏輯 (單一標記與選單定位 + 顯示里別) === */
const ctxMenu = document.getElementById('contextMenu');
let clickedLatLng = null;

// 1. 地圖右鍵：新增標記並顯示座標 (先清除舊標記)
map.on('contextmenu', (e) => {
    // 關閉選單，避免重疊
    ctxMenu.style.display = 'none';

    // **修正：每次點右鍵先清除 pointLayer 的舊標記**
    pointLayer.clearLayers();
    measureLayer.clearLayers(); // 清除量測結果
    isMeasuring = false;
    document.body.classList.remove('measuring');
    measureStartLatLng = null;

    // 建立新標記
    const latlng = e.latlng;
    const twd = twd97FromWgs84(latlng.lat, latlng.lng);
    // 取得里別
    const villageName = getVillageName(latlng.lat, latlng.lng);
    
    // Popup 內容：顯示座標與里別 (修正：文字顏色樣式與上方統一)
    const popupContent = `
        <div style="font-weight:bold; color:#004080; margin-bottom:5px;">位置資訊</div>
        <div style="font-size:13px;">TWD97: ${twd.x}, ${twd.y}</div>
        <div style="font-size:13px;">WGS84: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</div>
        <div style="font-size:13px;">行政區: ${villageName}</div>
        <div style="font-size:12px; color:#666; margin-top:5px;">(再點右鍵開啟功能選單;手機介面長按可開啟)</div>
    `;

    // 加到 pointLayer
    const marker = L.marker(latlng, { draggable: true }).addTo(pointLayer);
    marker.bindPopup(popupContent).openPopup();

    // 2. 標記右鍵：開啟功能選單 (固定在滑鼠旁)
    marker.on('contextmenu', (ev) => {
        L.DomEvent.stopPropagation(ev); // 停止冒泡，不觸發地圖的右鍵事件
        clickedLatLng = ev.latlng;      // 記錄此標記的座標供選單使用
        openCtxMenu(ev.originalEvent);  // 開啟選單
    });
});

// 開啟選單函式 (使用 clientX/Y 定位)
function openCtxMenu(nativeEvent) {
    ctxMenu.style.display = 'block';
    ctxMenu.style.left = nativeEvent.clientX + 'px';
    ctxMenu.style.top = nativeEvent.clientY + 'px';
}

// === 右鍵選單點擊事件修正與新增地籍查詢 ===
document.getElementById('ctxStreetView').onclick = () => { 
    if(clickedLatLng) window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); 
    ctxMenu.style.display='none'; 
}
document.getElementById('ctxGoogleNav').onclick = () => { 
    if(clickedLatLng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); 
    ctxMenu.style.display='none'; 
}
document.getElementById('ctxCadastral').onclick = () => { 
    if(clickedLatLng) window.open(`https://maps.nlsc.gov.tw/go/${clickedLatLng.lng}/${clickedLatLng.lat}`, '_blank'); 
    ctxMenu.style.display='none'; 
}
document.getElementById('ctxClearMarker').onclick = () => { 
    pointLayer.clearLayers(); 
    measureLayer.clearLayers(); 
    isMeasuring = false; 
    document.body.classList.remove('measuring'); 
    measureStartLatLng = null;
    ctxMenu.style.display='none'; 
}
document.getElementById('ctxMeasure').onclick = () => { ctxMenu.style.display = 'none'; startMeasure(clickedLatLng); };

function startMeasure(latlng) {
    isMeasuring = true;
    measureStartLatLng = latlng;
    document.body.classList.add('measuring');
    L.circleMarker(latlng, {color: 'green', radius: 5, fillOpacity: 1}).addTo(measureLayer);
}
function finishMeasure(endLatLng) {
    if(!isMeasuring || !measureStartLatLng) return;
    const dist = measureStartLatLng.distanceTo(endLatLng).toFixed(1);
    if(dist == 0) return;
    const line = L.polyline([measureStartLatLng, endLatLng], {color: 'red', weight: 3}).addTo(measureLayer);
    const centerLat = (measureStartLatLng.lat + endLatLng.lat) / 2;
    const centerLng = (measureStartLatLng.lng + endLatLng.lng) / 2;
    const icon = L.divIcon({
        className: 'measure-label',
        html: `${dist} m <span class="measure-close-btn" onclick="clearMeasure()">X</span>`,
        iconSize: [100, 20],
        iconAnchor: [50, 10]
    });
    L.marker([centerLat, centerLng], {icon: icon}).addTo(measureLayer);
    isMeasuring = false;
    document.body.classList.remove('measuring');
    if(measureLine) map.removeLayer(measureLine);
    if(measureTooltip) map.removeLayer(measureTooltip);
    measureLine = null; measureTooltip = null;
    measureStartLatLng = null;
}
window.clearMeasure = function() { measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring'); }

map.on('mousemove', e => {
    if(window.innerWidth > 768) {
        const t = twd97FromWgs84(e.latlng.lat, e.latlng.lng);
        const el = document.getElementById('floatingCoords');
        el.style.display = 'block'; el.innerHTML = `TWD97: ${t.x}, ${t.y}`;
    }
    if(isMeasuring && measureStartLatLng) {
        if(measureLine) measureLine.setLatLngs([measureStartLatLng, e.latlng]);
        else measureLine = L.polyline([measureStartLatLng, e.latlng], {color: 'red', dashArray: '5, 10'}).addTo(map);
        const dist = measureStartLatLng.distanceTo(e.latlng).toFixed(1);
        if(measureTooltip) measureTooltip.setLatLng(e.latlng).setContent(`${dist} m`);
        else measureTooltip = L.tooltip({permanent:true, direction:'right'}).setLatLng(e.latlng).setContent(`${dist} m`).addTo(map);
    }
});

document.getElementById('toggleMapBtn').onclick = function() {
    if(isSat) { map.removeLayer(sat); osm.addTo(map); this.classList.remove('active'); }
    else { map.removeLayer(osm); sat.addTo(map); this.classList.add('active'); }
    isSat = !isSat;
};
document.getElementById('toggleCadastralBtn').onclick = function() {
    if(isCadastralVisible) { map.removeLayer(cadastralLayer); this.classList.remove('active'); }
    else { cadastralLayer.addTo(map); this.classList.add('active'); }
    isCadastralVisible = !isCadastralVisible;
};

/* === 修正：支援多點座標輸入與顯示，並顯示里別 === */
document.getElementById('plotBtn').onclick = () => {
    pointLayer.clearLayers();
    const input = document.getElementById('coordsInput').value.trim();
    if (!input) return;

    // 將輸入內容按行分割，並過濾空行
    const lines = input.split(/\r?\n/).filter(line => line.trim() !== '');
    const bounds = L.latLngBounds();
    let markerCount = 0;

    lines.forEach(line => {
        // 使用更寬鬆的分隔符號 (逗號、空格或 tab)
        const parts = line.trim().split(/[, \t]+/).filter(p => p !== '');
        if (parts.length >= 2) {
            const x = parseFloat(parts[0]);
            const y = parseFloat(parts[1]);

            if (!isNaN(x) && !isNaN(y)) {
                try {
                    // TWD97 (EPSG:3826) 轉 WGS84 (EPSG:4326)
                    const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]);
                    const latlng = L.latLng(w[1], w[0]);
                    
                    // 取得里別
                    const villageName = getVillageName(w[1], w[0]);

                    const marker = L.marker(latlng).addTo(pointLayer);
                    // 修正：座標輸入工具的 Popup 樣式也移除紅色粗體
                    marker.bindPopup(`X:${x}, Y:${y}<br>行政區: ${villageName}`);
                    markerCount++;
                    bounds.extend(latlng);
                } catch (e) {
                    console.error("Coordinate conversion error:", e);
                }
            }
        }
    });

    if (markerCount > 0) {
        // 如果只有一個點，使用 setView；如果多於一個點，使用 fitBounds
        if (markerCount === 1) {
            map.setView(bounds.getCenter(), 16);
            // 打開唯一標記的 popup
            pointLayer.getLayers()[0].openPopup(); 
        } else {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
    } else {
         alert('請輸入有效的 TWD97 座標，格式為 X,Y (每行一組)');
    }
};

document.getElementById('plotDengueBtn').onclick = () => {
    dengueLayer.clearLayers();
    const val = document.getElementById('dengueCoordsInput').value.trim();
    if(!val) return;
    const lines = val.split(/\r?\n/);
    lines.forEach(line => {
        const parts = line.split(/[, \t]+/);
        if(parts.length>=2) {
            const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
            if(!isNaN(x)&&!isNaN(y)) {
                const w = proj4('EPSG:3826','EPSG:4326',[x,y]);
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: "<div class='gray-dot-marker'></div>",
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                L.marker([w[1],w[0]], {icon: icon}).addTo(dengueLayer).bindPopup(`確診戶座標: ${x}, ${y}`);
                map.setView([w[1],w[0]], 16);
            }
        }
    });
};
document.getElementById('clearDengueBtn').onclick = () => { 
    dengueLayer.clearLayers(); 
    dengueRadiusLayer.clearLayers();
    document.getElementById('dengueCoordsInput').value=''; 
    document.querySelectorAll('input[name="dengueRadius"]').forEach(r => r.checked = false);
};
document.getElementById('clearBtn').onclick = () => { pointLayer.clearLayers(); document.getElementById('coordsInput').value=''; };

document.getElementById('clearRepairBtn').addEventListener('click', () => {
    if(markersClusterGroup) { markersClusterGroup.clearLayers(); map.removeLayer(markersClusterGroup); markersClusterGroup = null; }
    activeRepairLayers = [];
    document.getElementById('clusterControlPanel').style.display = 'none'; // 清除所有點位時隱藏面板
    document.getElementById('toggleClusterControlBtn').classList.remove('active'); // 移除按鈕 active 狀態
    document.querySelectorAll('.repair-cb').forEach(cb => cb.checked = false);
    document.querySelectorAll('.year-select-all input').forEach(cb => cb.checked = false);
    searchResultLayer.clearLayers();
    document.getElementById('keywordInput').value = '';
    document.getElementById('contractorSelect').value = '';
    document.getElementById('villageSelect').value = '';
    document.getElementById('searchStatus').innerText = '';
    document.getElementById('clearSearchBtn').style.display = 'none';
    pointLayer.clearLayers();
    measureLayer.clearLayers();
    document.getElementById('coordsInput').value = '';
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
    document.getElementById('roadSelect').value = "";
    clusterLayer.clearLayers();
    if(clusterToggle.checked) clusterToggle.checked = false;
    dengueLayer.clearLayers();
    dengueRadiusLayer.clearLayers();
    document.getElementById('dengueCoordsInput').value = '';
    document.querySelectorAll('input[name="dengueRadius"]').forEach(r => r.checked = false);
    bottomPanel.classList.remove('open');
    map.closePopup();
});

const clusterToggle = document.getElementById('clusterToggle');
const clusterSlider = document.getElementById('clusterSlider');
const clusterValue = document.getElementById('clusterValue');
clusterToggle.addEventListener('change', () => { if(clusterToggle.checked) calculateClusters(); else clusterLayer.clearLayers(); });
clusterSlider.addEventListener('input', () => {
    clusterValue.innerText = `${clusterSlider.value}m`;
    if(clusterToggle.checked) { clearTimeout(window.clusterTimer); window.clusterTimer = setTimeout(calculateClusters, 100); }
});

/* === 核心修正：熱區分析 (確保抓取 透明/搜尋 點位) === */
function calculateClusters() {
    clusterLayer.clearLayers();
    if(!clusterToggle.checked) return;
    const radius = parseInt(clusterSlider.value);
    if(radius === 0) return;
    document.body.style.cursor = 'wait';
    setTimeout(() => {
        try {
            const points = [];
            activeRepairLayers.forEach(marker => {
                if(marker.feature && marker.feature.geometry.type === 'Point') {
                    points.push(marker.feature);
                }
            });
            searchResultLayer.eachLayer(layer => { 
                if(layer.feature && layer.feature.geometry.type === 'Point') {
                    points.push(layer.feature); 
                }
            });

            if(points.length === 0) {
                alert("⚠️ 尚未載入任何案件資料！\n\n請先至「透明」分頁勾選年度，\n或至「搜尋」分頁查詢案件後，\n再來執行空間分析。");
                clusterToggle.checked = false; document.body.style.cursor = 'default'; return;
            }
            const fc = turf.featureCollection(points);
            const buffered = turf.buffer(fc, radius / 1000, {units: 'kilometers', steps: 10});
            let resultGeoJSON = null;
            try {
                if (buffered.features.length > 0) {
                    let merged = buffered.features[0];
                    for (let i = 1; i < buffered.features.length; i++) merged = turf.union(merged, buffered.features[i]);
                    resultGeoJSON = merged;
                }
            } catch (unionError) { resultGeoJSON = buffered; }
            if (resultGeoJSON) {
                const layer = L.geoJSON(resultGeoJSON, { style: { color: 'none', weight: 0, fillColor: '#d32f2f', fillOpacity: 0.3 }, interactive: false }).addTo(clusterLayer);
                layer.bringToBack();
            }
        } catch (e) { console.error(e); } finally { document.body.style.cursor = 'default'; }
    }, 50);
}
document.getElementById('repairCheckboxes').addEventListener('change', () => {
    if(clusterToggle.checked) { clearTimeout(window.clusterTimer); window.clusterTimer = setTimeout(calculateClusters, 200); }
});

function formatMoney(val) {
    if (!val) return 0;
    return parseInt(val.toString().replace(/,/g, '')) || 0;
}

function getDateDiffDays(dateStr1, dateStr2) {
    if (!dateStr1 || dateStr1.length < 7 || !dateStr2 || dateStr2.length < 7) return 9999;
    const d1 = new Date(parseInt(dateStr1.substring(0,3))+1911, parseInt(dateStr1.substring(3,5))-1, parseInt(dateStr1.substring(5,7)));
    const d2 = new Date(parseInt(dateStr2.substring(0,3))+1911, parseInt(dateStr2.substring(3,5))-1, parseInt(dateStr2.substring(5,7)));
    return Math.ceil(Math.abs(d1 - d2) / (1000 * 60 * 60 * 24)); 
}

/* === 修改：歷史維修軸顯示 (使用下拉式選單篩選) === */
function showTimeline(routeLayer) {
    const cont = document.getElementById('timelineContainer');
    const filterBar = document.getElementById('timelineFilterBar');
    
    // 清除舊資料並顯示讀取中
    cont.innerHTML = '<div style="padding:20px;">讀取中...</div>';
    routeMatchLayer.clearLayers();
    
    // 計算匹配資料
    const routeLine = routeLayer.toGeoJSON().geometry; 
    currentRouteAllMatches = [];

    // 從已載入的 REPAIR_CONFIG 與 REPAIR_DATA_CACHE 中搜尋附近的點
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value];
        if(!data) return;
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const pt = turf.point(f.geometry.coordinates);
            const dist = turf.pointToLineDistance(pt, routeLine, {units:'meters'});
            if(dist <= 50) {
                currentRouteAllMatches.push({ label: conf.label, props: f.properties, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0], dist });
            }
        });
    });

    // 取得所有不重複的專案名稱 (用於建立下拉選單)
    const uniqueLabels = [...new Set(currentRouteAllMatches.map(m => m.label))].sort().reverse();

    // === 重建 Filter Bar 為 Select ===
    filterBar.innerHTML = '<span class="filter-label"><i class="fas fa-filter"></i> 篩選案件：</span>';
    
    // 建立 Select 元素
    const select = document.createElement('select');
    select.className = 'timeline-select';
    
    // 加入「全選」選項
    const allOption = document.createElement('option');
    allOption.value = 'all';
    allOption.textContent = `(全選) 顯示全部 (${currentRouteAllMatches.length} 筆)`;
    select.appendChild(allOption);

    // 加入各個專案選項
    uniqueLabels.forEach(label => {
        const count = currentRouteAllMatches.filter(m => m.label === label).length;
        const opt = document.createElement('option');
        opt.value = label;
        opt.textContent = `${label} (${count} 筆)`;
        select.appendChild(opt);
    });

    // 監聽變更事件
    select.addEventListener('change', function() {
        const val = this.value;
        if (val === 'all') {
            renderTimeline(currentRouteAllMatches);
        } else {
            const filtered = currentRouteAllMatches.filter(m => m.label === val);
            renderTimeline(filtered);
        }
    });

    filterBar.appendChild(select);

    // 初始渲染全部
    renderTimeline(currentRouteAllMatches);
}

/* === 修正：時間軸統計與顯示邏輯 (含一般/搶修分類) === */
function renderTimeline(matches) {
    const cont = document.getElementById('timelineContainer');
    const statsDiv = document.getElementById('timelineStats');
    routeMatchLayer.clearLayers(); 
    
    if(matches.length === 0) { 
        cont.innerHTML = '<div style="padding:20px;">無符合篩選條件的紀錄</div>'; 
        statsDiv.innerHTML = '總花費：<span>$0</span> | 維修：<span>0 次</span>';
        return; 
    }
    
    matches.sort((a,b) => (b.props['完工日期']||'').localeCompare(a.props['完工日期']||''));
    
    // --- 統計邏輯更新 ---
    let totalCost = 0;
    let genCost = 0, genCount = 0;
    let emgCost = 0, emgCount = 0;
    let processedCases = new Set();
    
    matches.forEach(m => {
        const caseNo = m.props['案件編號'];
        const money = formatMoney(m.props['決標金額']);
        const labelName = m.label || "";
        const isEmergency = /搶修|災害|緊急/.test(labelName);
        
        // 計數邏輯 (以點位/維修次數為主)
        if(isEmergency) emgCount++;
        else genCount++;
        
        // 金額邏輯 (需針對案件編號去重)
        let shouldAdd = false;
        if (caseNo && !processedCases.has(caseNo)) {
            processedCases.add(caseNo);
            shouldAdd = true;
        } else if (!caseNo) {
            shouldAdd = true;
        }
        
        if (shouldAdd) {
            totalCost += money;
            if(isEmergency) emgCost += money;
            else genCost += money;
        }
    });
    
    // --- 顯示統計 HTML (加入 .stat-divider 讓手機隱藏) ---
    const totalHtml = `<span style="color:#ffeb3b; font-weight:bold;">總計 $${totalCost.toLocaleString()} (${matches.length}次)</span>`;
    const genHtml = `<span style="color:#b3e5fc;">一般 $${genCost.toLocaleString()} (${genCount}次)</span>`;
    const emgHtml = `<span style="color:#ffcdd2;">搶修 $${emgCost.toLocaleString()} (${emgCount}次)</span>`;
    
    statsDiv.innerHTML = `${totalHtml} <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> ${genHtml} <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> ${emgHtml}`;
    
    cont.innerHTML = '';
    matches.forEach((m, i) => {
        const marker = L.circleMarker([m.lat, m.lng], { radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }).addTo(routeMatchLayer);
        marker.bindPopup(createPopup({ fileName: m.label, props: m.props, lat: m.lat, lng: m.lng, dist: m.dist }), {className:'custom-popup'});
        
        const labelName = m.label.toString();
        let iconClass = 'icon-normal';
        let title = '一般';
        if(labelName.includes('搶修') || labelName.includes('災害') || labelName.includes('緊急')) {
            iconClass = 'icon-urgent'; title = '搶修';
        }
        const amount = formatMoney(m.props['決標金額']);
        let sizeClass = 'dot-sm'; 
        if (amount > 5000000) sizeClass = 'dot-lg';      
        else if (amount > 1000000) sizeClass = 'dot-md'; 
        let isFrequent = false;
        if (i < matches.length - 1) {
            const nextItem = matches[i+1]; 
            const days = getDateDiffDays(m.props['完工日期'], nextItem.props['完工日期']);
            if (days < 180) isFrequent = true; 
        }
        const alertClass = isFrequent ? 'alert-right' : '';
        const item = document.createElement('div');
        item.className = `h-item ${alertClass}`;
        item.innerHTML = `
            <div class="h-date">${m.props['完工日期']||'未知'}</div>
            <div class="h-line-container"><div class="h-dot ${sizeClass}"></div></div>
            <!-- 修改為文字標籤 (Badge) -->
            <div class="h-badge ${labelName.includes('搶修')||labelName.includes('災害')||labelName.includes('緊急') ? 'badge-urgent' : 'badge-normal'}">
                ${labelName.includes('搶修')||labelName.includes('災害')||labelName.includes('緊急') ? '搶修' : '一般'}
            </div>
        `;
        item.addEventListener('mouseenter', () => { marker.setStyle({ radius: 20, color:'#ffd700', weight:4, fillColor:'#d32f2f' }); marker.bringToFront(); marker.openPopup(); });
        item.addEventListener('mouseleave', () => { marker.setStyle({ radius: 14, color:'#fff', weight:1, fillColor:DEEP_BLUE }); marker.closePopup(); });
        item.addEventListener('click', () => map.flyTo([m.lat, m.lng], 18));
        cont.appendChild(item);
    });
}

// 登革熱半徑更新
function updateDengueRadius() {
    dengueRadiusLayer.clearLayers();
    const radios = document.getElementsByName('dengueRadius');
    let r = 0;
    for(let i=0; i<radios.length; i++){ if(radios[i].checked) r = parseInt(radios[i].value); }
    if(r === 0) return;

    dengueLayer.eachLayer(marker => {
        L.circle(marker.getLatLng(), {
            radius: r,
            color: 'none',
            fillColor: '#ff9800',
            fillOpacity: 0.3 
        }).addTo(dengueRadiusLayer);
    });
}
</script>
</body>
</html>
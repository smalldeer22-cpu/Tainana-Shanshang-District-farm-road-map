<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>臺南市山上區公眾通行道路圖資 (v.1150129-V4-MobileLayout)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<style>
  /* === 1. 全局設定 === */
  :root {
    --primary-color: #004080; /* 深藍 */
    --accent-color: #ff9800;  /* 橘黃 */
    --bg-light: #f8faff;
    --text-dark: #333;
    --sidebar-width: 350px;
    
    /* 新版泡泡窗配色 (Emerald Theme) */
    --popup-bg: #f2fcf5;
    --popup-border: #d1fae5;
    --popup-text-main: #064e3b; /* emerald-900 */
    --popup-text-sub: #059669;  /* emerald-600 */
    --popup-accent: #10b981;    /* emerald-500 */
  }
  
  body { 
      margin:0; 
      font-family:"Microsoft JhengHei", "Heiti TC", sans-serif; 
      display:flex; 
      height: 100vh; 
      height: 100dvh; 
      overflow:hidden; 
      position: relative; 
      background: var(--bg-light); 
  }
   
  /* === 2. 懸浮漢堡按鈕 === */
  #toggleSidebarBtn {
    position: absolute; top: 10px; left: 360px; width: 40px; height: 40px;
    background: #fff; color: var(--text-dark); border: 2px solid rgba(0,0,0,0.1); border-radius: 8px;
    cursor: pointer; z-index: 2000; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: left 0.3s ease; 
  }
  #toggleSidebarBtn:hover { background: #f4f4f4; }
  body.collapsed #toggleSidebarBtn { left: 10px; }

  /* === 3. 側邊欄樣式 === */
  #sidebar {
    width: var(--sidebar-width); min-width: var(--sidebar-width); background: #fff; border-right: 1px solid #eee;
    display: flex; flex-direction: column; z-index: 1500; box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    margin-left: 0; transition: margin-left 0.3s ease; position: relative;
  }
  body.collapsed #sidebar { margin-left: calc(var(--sidebar-width) * -1); }

  .sidebar-header { padding: 15px; background: var(--primary-color); color: white; text-align: center; flex-shrink: 0; }
  .sidebar-header h3 { margin: 0; font-size: 16px; font-weight: bold; line-height: 1.4; }
  
  /* 分頁籤樣式 */
  .tabs-nav { display: flex; background: #eef2f6; padding: 5px 5px 0 5px; flex-shrink: 0; overflow-x: auto; }
  .tab-btn { flex: 1; padding: 10px 5px; border: none; background: transparent; cursor: pointer; font-size: 13px; font-weight: bold; color: #666; border-radius: 8px 8px 0 0; transition: all 0.2s; white-space: nowrap; }
  .tab-btn.active { background: #fff; color: var(--primary-color); box-shadow: 0 -2px 5px rgba(0,0,0,0.05); position: relative; top: 1px; }
  
  /* 0203V1 Update: 調整 flex 讓內容可滾動，並保留空間給底部聲明 */
  .tab-content-container { flex: 1; overflow-y: auto; padding: 15px; background: #fff; position: relative; }
  .tab-pane { display: none; animation: fadeIn 0.3s; }
  .tab-pane.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* 0203V3 Update: 側邊欄底部版權聲明區塊 (簡化版 + 手機安全區優化) */
  .sidebar-footer {
      flex-shrink: 0; 
      padding: 10px 15px;
      padding-bottom: calc(10px + env(safe-area-inset-bottom));
      background: #f8fafc;
      border-top: 1px solid #e2e8f0;
      font-size: 11px;
      color: #64748b;
      line-height: 1.6; 
      text-align: center;
      white-space: normal; 
  }

  /* 卡片區塊樣式 */
  .card-section { background: #fff; border-radius: 12px; padding: 12px; margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #f0f0f0; }
  .card-title { font-size: 14px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #f0f0f0; }
  
  /* 年度摺疊選單 */
  .year-group { margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
  .year-header { background: #f8fafc; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #475569; user-select: none; }
  .year-header:hover { background: #e2e8f0; }
  .year-content { display: none; padding: 8px 12px; background: #fff; border-top: 1px solid #eee; }
  .year-group.open .year-content { display: block; }
  .year-group.open .toggle-icon { transform: rotate(90deg); }
  .toggle-icon { display:inline-block; transition: transform 0.2s; width:12px; margin-right:5px;}
  .year-select-all { font-size: 12px; color: var(--primary-color); cursor: pointer; }
  .checkbox-item { margin-bottom: 6px; display: flex; align-items: center; gap: 6px; font-size: 13px; }
  .checkbox-item input { margin: 0; accent-color: var(--primary-color); }

  /* V3 Added: 多選摺疊樣式 */
  .multiselect-group { border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; background: #fff; }
  .multiselect-header { 
      padding: 10px; cursor: pointer; background: #fff; color: #555; font-size: 14px; 
      display: flex; justify-content: space-between; align-items: center; border-radius: 6px;
      transition: background 0.2s;
  }
  .multiselect-header:hover { background: #f5f5f5; }
  .multiselect-header i { transition: transform 0.2s; font-size: 12px; color: #999; }
  .multiselect-group.open .multiselect-header { background: #f0f7ff; border-radius: 6px 6px 0 0; color: var(--primary-color); font-weight: bold; border-bottom: 1px solid #e0e0e0; }
  .multiselect-group.open .multiselect-header i { transform: rotate(180deg); color: var(--primary-color); }
  .multiselect-content { display: none; padding: 10px; max-height: 250px; overflow-y: auto; background: #fafafa; border-radius: 0 0 6px 6px; }
  .multiselect-group.open .multiselect-content { display: block; }
  .select-all-row { border-bottom: 1px dashed #ddd; padding-bottom: 5px; margin-bottom: 5px; font-weight: bold; color: #004080; }

  select, textarea, input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; font-size: 14px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
  
  button.primary { width: 100%; padding: 10px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: none; background: var(--primary-color); color: #fff; font-size: 14px; font-weight: bold; }
  button.primary:hover { background: #003366; }
  button.secondary { width: 100%; padding: 8px; margin-top: 8px; cursor: pointer; border-radius: 6px; border: 1px solid #ddd; background: #fff; color: #555; font-size: 13px; }
  button.secondary:hover { background: #f5f5f5; }
  button:disabled { background: #ccc !important; cursor: not-allowed; color: #666 !important; }

  /* === 登革熱專用樣式 === */
  .dengue-option { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; cursor: pointer; font-weight: bold; color: #555; }
  .dengue-option input { width: auto; margin: 0; transform: scale(1.2); }
  .gray-dot-marker { width: 14px; height: 14px; background: #7f8c8d; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.4); }

  /* === 4. 地圖區 === */
  #map { flex: 1; position: relative; z-index: 1; transition: width 0.3s ease; }
  body.measuring, body.measuring #map { cursor: crosshair !important; }

  .map-floating-controls { position: absolute; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
  .float-btn { width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; color: #444; box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative; }
  .float-btn:hover { background: #f0f0f0; color: var(--primary-color); transform: scale(1.1); }
  .float-btn.active { background: var(--accent-color); color: #000; }
  .float-btn::after { content: attr(data-title); position: absolute; right: 50px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
  .float-btn:hover::after { opacity: 1; }

  /* 定位套件樣式覆寫 */
  .leaflet-control-locate { border: none !important; box-shadow: none !important; margin: 0 !important; }
  .leaflet-control-locate a { width: 40px !important; height: 40px !important; border-radius: 50% !important; background: #fff !important; color: #444 !important; font-size: 16px !important; line-height: 40px !important; display: flex !important; align-items: center !important; justify-content: center !important; box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important; cursor: pointer !important; }
  .leaflet-control-locate a:hover { background: #f0f0f0 !important; color: #004080 !important; transform: scale(1.1); }
  .leaflet-control-locate.active a { color: #2074b6 !important; background: #fff !important; }
  .leaflet-control-locate.following a { color: #e65100 !important; border: 2px solid #e65100 !important; }
  .leaflet-control-locate a .leaflet-control-locate-location-arrow { display: none; }

  /* 聚合圖標 */
  .marker-cluster-custom { background-color: rgba(46, 204, 113, 0.6); border-radius: 50%; }
  .marker-cluster-custom div { width: 30px; height: 30px; margin-left: 5px; margin-top: 5px; text-align: center; border-radius: 50%; color: white; font-weight: bold; background-color: rgba(39, 174, 96, 0.9); line-height: 30px; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

  /* 聚合控制面板 */
  #clusterControlPanel {
    position: absolute; bottom: 220px; left: 360px; z-index: 1000;
    background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px);
    padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    width: 220px; border: 1px solid rgba(255,255,255,0.2);
    display: none; transition: left 0.3s ease;
  }
  body.collapsed #clusterControlPanel { left: 20px; } 

  .cluster-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
  .cluster-title { font-size:14px; font-weight:bold; color:var(--primary-color); display:flex; align-items:center; gap:6px; }
  .cluster-value-badge { background: var(--accent-color); color:#fff; padding:2px 6px; border-radius:4px; font-size:12px; }
  input[type=range].custom-range { -webkit-appearance: none; width: 100%; background: transparent; }
  input[type=range].custom-range::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: var(--primary-color); cursor: pointer; margin-top: -6px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
  input[type=range].custom-range::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }

  /* === 6. 底部時間軸面板 === */
  #bottomPanel { 
      position: absolute; bottom: 0; left: var(--sidebar-width); right: 0; 
      height: 280px; background: rgba(255, 255, 255, 0.98); 
      box-shadow: 0 -4px 16px rgba(0,0,0,0.1); z-index: 1400; 
      display: flex; flex-direction: column; transform: translateY(100%); 
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease; 
      border-top: 1px solid #e0e0e0; overflow: hidden; 
  }
  body.collapsed #bottomPanel { left: 0; } 
  #bottomPanel.open { transform: translateY(0); }
  #bottomPanel.minimized { height: auto !important; transform: translateY(0) !important; }
  #bottomPanel.minimized #timelineFilterBar, #bottomPanel.minimized #timelineContainer { display: none !important; }

  #bottomPanelHeader { padding: 8px 20px; min-height: 50px; height: auto; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .header-left { display: flex; flex-direction: column; gap: 2px; justify-content: center; overflow: hidden; }
  #panelTitle { font-size: 15px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #timelineStats { font-size: 13px; color: #ffeb3b; font-weight: normal; opacity: 1; white-space: normal; line-height: 1.5; margin-top: 2px; }
  @media (max-width: 768px) { #timelineStats { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.6; } .stat-divider { display: none; } }
  .header-right { display: flex; gap: 15px; align-items: center; flex-shrink: 0;}
  .control-btn { background:none; border:none; color:#fff; font-size:16px; cursor:pointer; padding: 5px; transition: color 0.2s; }
  .control-btn:hover { color: #ffeb3b; }

  #timelineFilterBar { 
      background: #f1f5f9; padding: 8px 10px; 
      border-bottom: 1px solid #e0e0e0; 
      display: flex; gap: 6px; 
      align-items: center; flex-shrink: 0; 
      height: auto; min-height: 50px; box-sizing: border-box; 
      flex-wrap: nowrap; 
      overflow-x: auto; 
  }
  #timelineFilterBar::-webkit-scrollbar { height: 0px; background: transparent; }
  
  .filter-label { font-size: 12px; color: #333; font-weight: bold; white-space: nowrap; display: flex; align-items: center; gap: 4px; margin-right: 2px; flex-shrink: 0; }
  
  .timeline-select-pill {
      padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 20px; background-color: #fff;
      font-size: 12px; font-weight: bold; color: #334155; cursor: pointer; outline: none; transition: all 0.2s;
      min-width: auto; max-width: 180px; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      background-image: linear-gradient(to bottom, #fff, #f8fafc);
  }
  .timeline-select-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
  .timeline-select-pill:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); }
  
  #timelineContainer { flex: 1; overflow-x: auto; padding: 15px 20px; display: flex; align-items: flex-start; gap: 0; }
  .h-item { width: 160px; text-align: center; cursor: pointer; position: relative; transition: transform 0.2s; }
  .h-item:hover { transform: translateY(-5px); }
  .h-date { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 8px; }
  .h-line-container { position: relative; height: 24px; display: flex; align-items: center; justify-content: center; }
  .h-line-container::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: #ddd; z-index: 0; }
  .h-item.alert-right .h-line-container::after { content: ''; position: absolute; left: 50%; right: -50%; top: 50%; height: 4px; background: repeating-linear-gradient(45deg, #d32f2f, #d32f2f 5px, #ffcdd2 5px, #ffcdd2 10px); z-index: 0; animation: alertPulse 1.5s infinite; }
  @keyframes alertPulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
  .h-dot { background: var(--primary-color); border: 2px solid #fff; border-radius: 50%; z-index: 1; position: relative; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .h-item:hover .h-dot { transform: scale(1.3); background: var(--accent-color); border-color: #fff; }
  .dot-sm { width: 12px; height: 12px; }
  .dot-md { width: 16px; height: 16px; }
  .dot-lg { width: 22px; height: 22px; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.3); }
  .h-badge { margin-top: 8px; display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; position: relative; z-index: 2; }
  .badge-normal { background-color: var(--primary-color); border: 1px solid #fff; }
  .badge-urgent { background-color: #d32f2f; border: 1px solid #fff; }

  /* === 7. 右鍵選單 === */
  #contextMenu { display: none; position: fixed; z-index: 5000; background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; min-width: 160px; border: 1px solid #ddd; top: 0; left: 0; }
  .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
  .ctx-item:hover { background: #f5faff; color: var(--primary-color); }
  .ctx-item i { width: 20px; text-align: center; }

  /* === 關鍵修改：3欄式 Popup CSS (v.0109-3Column) + 手機版優化 === */
  .custom-popup .leaflet-popup-content-wrapper { padding: 0 !important; border-radius: 20px !important; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; border: 2px solid var(--popup-border) !important; background: rgba(242, 252, 245, 0.95) !important; backdrop-filter: blur(5px); }
  .custom-popup .leaflet-popup-content { margin: 0 !important; width: 960px !important; max-width: 90vw !important; }
  .custom-popup .leaflet-popup-tip { background: var(--popup-border) !important; }

  .popup-card { display: flex; flex-direction: row; min-height: 320px; }
  .popup-deco-strip { width: 8px; background: var(--popup-text-sub); flex-shrink: 0; }
  
  /* 左欄：資訊區 */
  .popup-col-info { width: 280px; padding: 20px; display: flex; flex-direction: column; justify-content: space-between; border-right: 1px solid #e0e0e0; flex-shrink: 0; background: rgba(255,255,255,0.6); }
  
  /* 照片區 */
  .popup-col-photo { flex: 1; padding: 15px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid #e0e0e0; background: #fff; min-width: 0; }
  .popup-col-photo:last-child { border-right: none; }

  /* 資訊元件 */
  .status-pill { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 900; letter-spacing: 0.5px; color: #fff; align-self: flex-start; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  .pill-working { background: #10b981; } .pill-done { background: #64748b; } .pill-urgent { background: #f59e0b; }  
  .case-id { font-size: 24px; font-weight: 900; color: #1e293b; line-height: 1.1; letter-spacing: -0.5px; margin-bottom: 4px; }
  .case-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #3d5a80; margin-bottom: 10px; }
  .file-tag { background: #ecfdf5; padding: 2px 6px; border-radius: 4px; font-family: monospace; letter-spacing: -0.5px; opacity: 0.8; }
  
  /* V0129 新增：多類型標籤樣式 */
  .type-tag-group { display: inline-flex; gap: 4px; align-items: center; flex-wrap: wrap; }
  .type-pill { background: rgba(16, 185, 129, 0.1); color: var(--popup-text-sub); padding: 2px 6px; border-radius: 4px; font-size: 11px; white-space: nowrap; }
  .type-pill-more { background: #e0f2fe; color: #0284c7; cursor: pointer; font-weight: bold; border-radius: 4px; padding: 2px 6px; font-size: 11px; transition: all 0.2s; }
  .type-pill-more:hover { background: #bae6fd; transform: scale(1.05); }

  .price-block { margin: 10px 0; border-bottom: 1px dashed #ccc; padding-bottom: 10px; }
  .price-label { font-size: 9px; color: var(--popup-text-sub); font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
  .price-val { font-size: 22px; font-weight: 900; color: #064e3b; font-style: italic; letter-spacing: -0.5px; line-height: 1.2; }

  .compact-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
  .compact-item { font-size: 11px; line-height: 1.4; color: #334155; }
  .compact-label { font-weight: 900; color: var(--popup-accent); font-size: 10px; text-transform: uppercase; display: block; margin-bottom: 1px; }
  .compact-val { font-weight: bold; word-break: break-word; }
  .compact-row { display: flex; gap: 10px; }
  .popup-tags { display: flex; gap: 6px; margin-bottom: 15px; flex-wrap: wrap; }
  .tag-pill { padding: 3px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; gap: 4px; }
  .tag-dark { background: var(--popup-text-sub); color: white; }
  .tag-light { background: white; border: 1px solid var(--popup-border); color: var(--popup-text-main); }

  /* Buttons */
  .popup-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .popup-btn-new { background: white; color: var(--popup-text-main); border: 1px solid var(--popup-border); padding: 8px 0; border-radius: 8px; font-size: 10px; font-weight: 900; display: flex; align-items: center; justify-content: center; gap: 6px; text-decoration: none; transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
  .popup-btn-new:hover { background: var(--popup-text-main); color: white; border-color: var(--popup-text-main); }
  .btn-full { grid-column: span 2; background: #ecfdf5; }

  /* 0116V2 Added: Sibling Dot Navigation Style */
  .sibling-nav-container { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; align-items: center; }
  .sibling-nav-container.mobile { justify-content: center; margin-bottom: 5px; margin-top: -2px; }
  .sibling-dot {
      width: 20px; height: 20px; border-radius: 50%;
      background: #fff; border: 1px solid #6f42c1;
      color: #6f42c1; font-size: 10px; font-weight: bold;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s; user-select: none;
  }
  .sibling-dot:hover { background: #f3e5f5; transform: scale(1.1); }
  .sibling-dot.active {
      background: #6f42c1; color: white;
      box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.3);
      cursor: default; transform: scale(1.05);
  }

  /* 照片輪播 */
  .photo-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
  .photo-title { font-size: 11px; font-weight: 900; color: var(--popup-text-main); display: flex; align-items: center; gap: 5px; }
  .photo-viewer { flex: 1; position: relative; border-radius: 8px; border: 1px solid var(--popup-border); background: #f1f5f9; overflow: hidden; display: flex; align-items: center; justify-content: center; }
  .photo-viewer img { 
      width: 100%; height: 100%; object-fit: cover; display: none;
      /* V13V5 Added: 照片防下載保護 */
      -webkit-user-drag: none;
      user-select: none;
      -webkit-touch-callout: none;
  }
  .photo-viewer img.active { display: block; }
  .photo-viewer .no-photo { color: #666; font-size: 24px; display: flex; flex-direction: column; align-items: center; gap:5px; background: #f0fdf4; width:100%; height:100%; justify-content:center; }
  .photo-viewer .no-photo span { font-size: 10px; font-weight: bold; }
  .carousel-dots { display: flex; justify-content: center; gap: 8px; margin-top: 10px; height: 22px; }
  .dot { width: 22px; height: 22px; border-radius: 50%; background: #e2e8f0; color: #64748b; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 900; border: 1px solid #cbd5e1; user-select: none; }
  .dot:hover { background: #cbd5e1; }
  .dot.active { background: var(--accent-color); color: #fff; border-color: var(--accent-color); transform: scale(1.1); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

  /* === Mobile Style (針對手機版優化 V12+V15) === */
  .mobile-compact-header, .mobile-photo-tabs, .mobile-details-toggle { display: none; } 
  .desktop-only { display: block; }

  @media (max-width: 768px) {
      .custom-popup .leaflet-popup-content { width: 300px !important; }
      .desktop-only { display: none !important; }
      
      /* 重設佈局：使用 Flex column 與 order 屬性重排 */
      .popup-card { flex-direction: column; min-height: auto; }
      .popup-deco-strip { width: 100%; height: 6px; border-radius: 20px 20px 0 0; background: #a7f3d0; order: 0; }
      .popup-col-info { display: contents; } /* 讓子元素能參與 order 排列 */
      
      /* Row 1 & 2: 極致緊湊標頭 */
      .mobile-compact-header { 
          order: 1; display: block; 
          padding: 8px 12px;
          padding-right: 40px; /* V12: 增加右側 Padding 避開 X 按鈕 */
          background: #fff; border-bottom: 1px dashed #eee;
          position: relative;
      }
      
      /* V12: 修改排版邏輯為絕對置中 -> V0129V4: 改為垂直堆疊 (方案一) */
      .m-row-1 { 
          display: flex; 
          flex-direction: column; /* 垂直排列 */
          align-items: flex-start; /* 靠左對齊 */
          justify-content: center;
          margin-bottom: 6px;
          position: relative;
          min-height: auto;
          gap: 4px; /* 行距 */
      }
      .m-row-1 .status-pill { 
          position: static; /* 取消絕對定位 */
          transform: none;
          margin: 0; 
          font-size: 10px; 
          padding: 2px 8px; 
          align-self: flex-start;
      }
      .m-row-1 .case-id { 
          font-size: 15px; /* 稍微加大字體提升辨識度 */
          font-weight: bold;
          color: #333;
          margin: 0; 
          text-align: left; /* 改為靠左 */
          line-height: 1.4; /* 增加行高 */
          width: 100%;
          word-break: break-all; /* 確保長字串換行 */
      }
      
      .m-row-2 { display: flex; align-items: baseline; gap: 8px; }
      .m-row-2 .price-val { font-size: 16px; font-weight: 900; color: #d35400; white-space: nowrap; flex-shrink: 0; }
      .m-tags-line { 
          flex: 1; display: flex; gap: 5px; overflow: hidden; white-space: nowrap; 
          font-size: 11px; color: #555; align-items: center; min-width: 0;
      }
      
      /* Row 3: 照片 Tabs + Photo */
      .mobile-photo-tabs { order: 2; display: flex; background: #f8fafc; padding: 2px; gap: 2px; justify-content: center; border-bottom: 1px solid #f1f5f9; }
      .m-tab { flex: 1; padding: 6px; text-align: center; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; color: #94a3b8; transition:all 0.2s; }
      .m-tab.active { background: #fff; color: var(--primary-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
      
      .popup-col-photo { order: 3; height: 220px; border: none; padding: 5px; display: none; margin: 0; } /* 更緊湊的高度 */
      .popup-col-photo.active-view { display: block; animation: fadeIn 0.3s; }
      .photo-section-header { display: none; }
      
      /* Row 4: 圖示按鈕 */
      .popup-btns { order: 4; display: flex; gap: 8px; padding: 8px; background: #fff; border-top: 1px solid #f1f5f9; }
      .popup-btn-new { flex: 1; border-radius: 8px; height: 36px; font-size: 16px; padding: 0; color: #555; background: #f8fafc; border: 1px solid #e2e8f0; }
      .popup-btn-new span { display: none; } /* 隱藏文字，只留 Icon */
      .popup-btn-new:hover { background: var(--primary-color); color: #fff; }
      
      /* Row 5: 折疊詳情 */
      .mobile-details-toggle { order: 5; display: block; text-align: center; padding: 8px; background: #f0f9ff; color: var(--primary-color); font-weight: bold; font-size: 11px; cursor: pointer; border-top: 1px solid #e0f2fe; }
      .info-details-block { order: 6; display: none; padding: 10px; background: #fff; animation: slideDown 0.3s; }
      .info-details-block.open { display: block; }
  }
  @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }

  /* === 其他原有樣式 === */
  .analysis-control { margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
  .slider-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
  .slider-container input { flex: 1; cursor: pointer; }
  .slider-value { font-weight: bold; color: #d32f2f; min-width: 50px; text-align: right; }
  .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: #e65100; }
  .toggle-switch input { width: auto; margin: 0; }
  .measure-label { background: rgba(255,255,255,0.9); border: 1px solid #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
  .measure-close-btn { color: red; cursor: pointer; font-weight: bold; padding: 0 4px; }
  
  /* 統計區塊 */
  .stats-columns { display: flex; gap: 8px; margin-top: 5px; }
  .stats-col { flex: 1; padding: 8px; border-radius: 6px; overflow: hidden; }
  .col-general { background: #e3f2fd; border: 1px solid #bbdefb; } 
  .col-emergency { background: #ffebee; border: 1px solid #ffcdd2; } 
  .stats-header { font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid rgba(0,0,0,0.1); }
  .col-general .stats-header { color: #004080; }
  .col-emergency .stats-header { color: #d32f2f; }
  .stat-year-row { margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 6px; }
  .stat-year-row:last-child { border-bottom: none; }
  .stat-year-title { font-size: 13px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; }
  .stat-percent-text { font-size: 11px; color: #777; background: rgba(255,255,255,0.6); padding: 1px 4px; border-radius: 3px; }
  .stat-data-row { font-size: 13px; margin-top: 3px; color: #222; font-weight: bold; }
  .stat-bar-bg { background: rgba(0,0,0,0.1); height: 5px; border-radius: 3px; width: 100%; margin-top: 5px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .col-general .stat-bar-fill { background-color: var(--primary-color); }
  .col-emergency .stat-bar-fill { background-color: #d32f2f; }
  
  /* 案件通報 */
  #reportOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8faff; z-index: 9999; display: none; flex-direction: column; font-family: "Microsoft JhengHei", sans-serif; }
  .report-header { background: var(--primary-color); color: white; padding: 15px; display:flex; justify-content:space-between; align-items:center; }
  .report-body { flex: 1; padding: 15px; overflow-y: auto; }
  .report-grid { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .report-col { flex: 1; display: flex; flex-direction: column; gap: 8px; justify-content: flex-start; }
  .report-item { font-size: 14px; color: #333; }
  .report-label { font-weight: bold; color: #555; margin-right: 5px; }
  .report-textarea { width: 100%; height: 100%; min-height: 60px; resize: none; border: 1px solid #ccc; border-radius: 4px; padding: 8px; font-size: 14px; box-sizing: border-box; }
  @media (max-width: 768px) { .report-grid { flex-direction: column; gap: 15px; } .report-textarea { height: 80px; } }
  .photo-upload-container { display: flex; gap: 10px; margin-top: 15px; height: 200px; }
  .photo-box-upload { flex: 1; border: 2px dashed #ccc; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; position: relative; overflow: hidden; }
  .photo-box-upload.has-image { border-style: solid; border-color: #666; }
  .photo-box-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
  .add-photo-btn { font-size: 40px; color: #ccc; cursor: pointer; }
  .delete-photo-btn { width: 100%; background: #d32f2f; color: white; border: none; padding: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; border-radius: 4px; display: none; }
  .report-footer { padding: 15px; display: flex; justify-content: space-between; gap: 15px; background: #fff; border-top: 1px solid #eee; }
  .btn-cancel { flex: 1; padding: 12px; background: #7f8c8d; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; }
  .btn-submit { flex: 1; padding: 12px; background: var(--accent-color); color: black; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; }

  /* 0111V6 新增：歷史案件列表樣式 */
  .nearby-item { padding:8px 6px; border-bottom:1px dashed #ccc; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s; }
  .nearby-item:last-child { border-bottom:none; }
  .nearby-item:hover { background: #fff; border-radius:4px; }
  .nearby-tag { font-size:11px; padding:2px 6px; border-radius:4px; color:white; white-space:nowrap; }

  /* 0111V6 新增：懸浮視窗樣式 (Reuse Popup Styles) */
  #reportDetailModal .custom-popup .leaflet-popup-content-wrapper { box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important; width:100%; border-radius: 12px !important; }
  #reportDetailModal .custom-popup .leaflet-popup-content { width: 100% !important; margin: 0 !important; max-width: none !important; }
  #reportDetailModal .popup-card { min-height: 400px; }
  @media (max-width: 768px) { #reportDetailModal .popup-card { flex-direction:column; } }

  /* 重複檢核 */
  .dup-check-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; transition: background-color 0.2s; }
  .dup-check-item:hover { background-color: #f0f7ff; }
  .dup-check-item:last-child { border-bottom: none; }
  .dup-check-title { font-weight: bold; color: #333; margin-bottom: 2px; }
  .dup-check-info { color: #666; display:flex; justify-content:space-between; }
  .dup-tag { font-size: 11px; padding: 1px 4px; border-radius: 3px; color: #fff; margin-left: 5px; }
  .tag-gen { background: var(--primary-color); }
  .tag-emg { background: #d32f2f; }

  /* 0112V2 新增：多選清單列表樣式 (Multi-select) */
  .multi-select-popup .info-header {
      background: #004080; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px;
      display: flex; justify-content: space-between; align-items: center;
  }
  .multi-select-item {
      padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;
  }
  .multi-select-item:hover { background: #f0f7ff; }
  .multi-select-item:last-child { border-bottom: none; }
  .multi-select-title { font-size: 13px; font-weight: bold; color: #004080; margin-bottom: 3px; }
  .multi-select-meta { font-size: 11px; color: #666; display: flex; gap: 8px; align-items: center; }

  /* 0203V5 新增: 選擇上傳來源選單樣式 */
  #sourceSelectModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; align-items: center; justify-content: center; }
  .source-select-content { background: white; width: 80%; max-width: 300px; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
  .source-btn { display: block; width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
  .btn-camera { background: #e0f2fe; color: #004080; border-color: #b3e5fc; }
  .btn-album { background: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
  .btn-cancel-source { background: #f1f5f9; color: #64748b; margin-bottom: 0; }

  #floatingCoords { position:absolute; pointer-events:none; background:rgba(255,255,255,0.9); border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:11px; display:none; z-index:1300; bottom: 10px; right: 10px; }

  @media (max-width: 768px) {
    #sidebar { position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; top: auto; border-radius: 20px 20px 0 0; border-right: none; transform: translateY(100%); margin-left: 0; }
    body.sidebar-open #sidebar { transform: translateY(0); }
    #overlay-mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1400; }
    body.sidebar-open #overlay-mask { display: block; }
    #toggleSidebarBtn { left: 10px; top: 10px; }
    #bottomPanel { left: 0; height: 300px; z-index: 2100; }
    .map-floating-controls { top: 70px; right: 10px; }
    #clusterControlPanel { bottom: 200px; left: 15px; right: 15px; width: auto; }
  }
</style>
</head>
<body>

<div id="overlay-mask"></div>
<button id="toggleSidebarBtn" title="切換選單"><i class="fas fa-bars"></i></button>

<div class="map-floating-controls">
    <button class="float-btn" id="toggleMapBtn" data-title="切換衛星/地圖"><i class="fas fa-layer-group"></i></button>
    <button class="float-btn" id="toggleCadastralBtn" data-title="地籍圖開關"><i class="fas fa-map"></i></button>
    <button class="float-btn" id="toggleClusterControlBtn" data-title="點位聚合設定"><i class="fas fa-circle-nodes"></i></button>
    <button class="float-btn" id="openReportBtn" data-title="案件通報" style="color:#d32f2f;"><i class="fas fa-camera"></i></button>
</div>

<div id="sourceSelectModal">
    <div class="source-select-content">
        <div style="font-size:16px; font-weight:bold; margin-bottom:15px; color:#333;">請選擇上傳方式</div>
        <button class="source-btn btn-camera" onclick="selectSource('camera')"><i class="fas fa-camera"></i> 立即拍照</button>
        <button class="source-btn btn-album" onclick="selectSource('album')"><i class="fas fa-images"></i> 從相簿選擇</button>
        <button class="source-btn btn-cancel-source" onclick="closeSourceModal()">取消</button>
    </div>
</div>

<div id="reportOverlay">
    <div class="report-header">
        <div style="font-size:18px; font-weight:bold;"><i class="fas fa-camera"></i> 案件通報</div>
        <button onclick="closeReport()" style="background:none; border:none; color:white; font-size:20px;"><i class="fas fa-times"></i></button>
    </div>
    <div class="report-body">
        <div class="report-grid">
            <div class="report-col">
                <div class="report-item"><span class="report-label">案件編號：</span><span id="reportCaseId" style="color:#666; font-style:italic;">(待系統取號)</span></div>
                <div class="report-item"><span class="report-label">通報時間：</span><span id="reportTime"></span></div>
            </div>
            <div class="report-col">
                <div class="report-item"><span class="report-label">TWD97：</span><span id="reportTwd97">定位中...</span></div>
                <div class="report-item"><span class="report-label">WGS84：</span><span id="reportWgs84">定位中...</span></div>
            </div>
            <div class="report-col">
                <div class="report-item"><span class="report-label">簡述案情：</span></div>
                <textarea id="reportDesc" class="report-textarea" placeholder="請描述損壞情形 (例如：路面坑洞、路燈不亮)"></textarea>
            </div>
        </div>

        <div id="nearbyHistorySection" style="margin-bottom:15px; border:1px solid #ffd700; background:#fffbe6; border-radius:6px; padding:10px; display:none;">
            <div style="font-weight:bold; color:#d35400; margin-bottom:5px; font-size:14px; display:flex; justify-content:space-between; align-items:center;">
                <span><i class="fas fa-history"></i> 定位點過往3年內周遭50公尺的維修案件</span>
                <span style="font-size:11px; color:#666; font-weight:normal;">(點擊查看詳情)</span>
            </div>
            <div id="nearbyHistoryList" style="max-height:150px; overflow-y:auto; font-size:13px; background:#fff; border:1px solid #eee; border-radius:4px;"></div>
        </div>

        <div class="photo-upload-container">
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box-upload" id="photoBox1" onclick="triggerCamera(1)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview1">
                    <input type="file" id="fileInput1" accept="image/*" style="display:none;" onchange="previewImage(this, 1)">
                </div>
                <button class="delete-photo-btn" id="delBtn1" onclick="deletePhoto(1)">刪除</button>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="photo-box-upload" id="photoBox2" onclick="triggerCamera(2)">
                    <div class="add-photo-btn">+</div>
                    <img id="imgPreview2">
                    <input type="file" id="fileInput2" accept="image/*" style="display:none;" onchange="previewImage(this, 2)">
                </div>
                <button class="delete-photo-btn" id="delBtn2" onclick="deletePhoto(2)">刪除</button>
            </div>
        </div>
        <div style="margin-top:10px; font-size:12px; color:#666; text-align:center;">請點擊「+」拍攝兩張不同角度的照片</div>
    </div>
    <div class="report-footer">
        <button class="btn-cancel" onclick="closeReport()">取消</button>
        <button class="btn-submit" id="btnSubmitReport" onclick="submitReport()">上傳通報</button>
    </div>
</div>

<div id="reportDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
    <div style="position:relative; max-width:960px; width:95%; max-height:90vh; overflow-y:auto; background:transparent; display:flex; flex-direction:column;">
        <button onclick="closeReportDetailModal()" style="align-self:flex-end; margin-bottom:10px; color:white; font-size:16px; background:rgba(0,0,0,0.5); border:1px solid #fff; border-radius:20px; padding:5px 15px; cursor:pointer;"><i class="fas fa-times"></i> 關閉視窗</button>
        <div class="custom-popup">
            <div class="leaflet-popup-content-wrapper">
                <div class="leaflet-popup-content" id="reportDetailContent">
                    </div>
            </div>
        </div>
    </div>
</div>

<div id="contextMenu">
    <div class="ctx-item" id="ctxStreetView"><i class="fas fa-street-view"></i> Google 街景</div>
    <div class="ctx-item" id="ctxGoogleNav"><i class="fas fa-location-arrow"></i> Google 導航</div>
    <div class="ctx-item" id="ctxCadastral"><i class="fas fa-map"></i> 地籍圖/查詢</div>
    <div class="ctx-item" id="ctxMeasure"><i class="fas fa-ruler-horizontal"></i> 距離量測</div>
    <div class="ctx-item" id="ctxClearMarker" style="color:#d32f2f;"><i class="fas fa-trash-alt" style="color:#d32f2f;"></i> 移除標記</div>
</div>

<div id="clusterControlPanel">
    <div class="cluster-header">
        <div class="cluster-title"><i class="fas fa-circle-nodes"></i> 點位聚合設定</div>
        <div style="display:flex; align-items:center;">
            <span id="clusterRadiusVal" class="cluster-value-badge" style="margin-right: 5px;">範圍 50px</span>
            <button id="closeClusterControlBtn" class="control-btn" title="關閉" style="color:#000; font-size:12px; padding:0;"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div style="font-size:12px; color:#666; margin-bottom:5px;">調整聚合敏感度 (滑竿往右 = 範圍大/聚合強)</div>
    <input type="range" id="clusterRadiusSlider" class="custom-range" min="20" max="150" step="10" value="50">
</div>

<div id="bottomPanel">
    <div id="bottomPanelHeader">
        <div class="header-left">
            <div id="panelTitle"><i class="fas fa-history"></i> 路線維修紀錄</div>
            <div id="timelineStats"></div>
        </div>
        <div class="header-right">
            <button id="togglePanelSizeBtn" class="control-btn" title="縮小/展開"><i class="fas fa-chevron-down"></i></button>
            <button id="closePanelBtn" class="control-btn" title="關閉"><i class="fas fa-times"></i></button>
        </div>
    </div>
    <div id="timelineFilterBar">
        <span class="filter-label"><i class="fas fa-filter"></i> 篩選：</span>
        </div>
    <div id="timelineContainer"><div style="padding:20px; color:#777;">請點選地圖上的藍色路線以檢視紀錄。</div></div>
</div>

<div id="sidebar">
  <div class="sidebar-header">
      <h3>臺南市山上區<br>公眾通行道路圖資及施工/維修案件透明</h3>
  </div>

  <div class="tabs-nav">
      <button class="tab-btn active" onclick="switchTab('tab-layers')"><i class="fas fa-layer-group"></i> 透明</button>
      <button class="tab-btn" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> 搜尋</button>
      <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fas fa-tools"></i> 工具</button>
      <button class="tab-btn" onclick="switchTab('tab-dengue')"><i class="fas fa-shield-virus"></i> 登革熱</button>
  </div>

  <div id="tab-layers" class="tab-content-container tab-pane active">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-road"></i> 施工/維修案件公告</div>
          <div class="small" style="margin-bottom:8px; color:#666;">勾選年份批次顯示位置 (<span style="color:#004080">●</span>近 / <span style="color:red">●</span>遠)</div>
          <div id="repairCheckboxes" style="max-height:400px; overflow-y:auto;"></div>
          <button class="secondary" id="clearRepairBtn"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>

      <div class="card-section">
          <div class="card-title"><i class="fas fa-calculator"></i> 里別維修統計</div>
          <div class="small" style="margin-bottom:5px; color:#666;">系統將自動排除同案件重複計算</div>
          <select id="statsVillageSelect" style="margin-bottom:10px;">
              <option value="">(讀取中...)</option>
          </select>
          <div id="statsResult" style="display:none;">
              <div class="stats-columns">
                  <div class="stats-col col-general">
                      <div class="stats-header">一般工程</div>
                      <div id="statsGenList"></div>
                  </div>
                  <div class="stats-col col-emergency">
                      <div class="stats-header">搶險搶修</div>
                      <div id="statsEmgList"></div>
                  </div>
              </div>
          </div>
          <button class="secondary" id="clearStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>
  </div>

  <div id="tab-search" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-route"></i> 公眾通行道路圖資查詢</div>
          <select id="roadSelect"><option>載入中...</option></select>
      </div>
      <div class="card-section">
          <div class="card-title"><i class="fas fa-search-plus"></i> 案件進階搜尋</div>
          <div class="search-block-label"><i class="fas fa-map-marked-alt"></i> 依里別快篩</div>
          <select id="villageSelect" style="margin-bottom:10px;">
              <option value="">-- 請選擇行政區 (載入中...) --</option>
          </select>
          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          <div class="search-block-label"><i class="fas fa-filter"></i> 依廠商快篩</div>
          <select id="contractorSelect" style="margin-bottom:10px;"><option value="">(讀取系統資料中...)</option></select>
          <div id="contractorStatsResult" style="display:none; margin-top:10px;">
              <div class="stats-columns">
                  <div class="stats-col col-general">
                      <div class="stats-header">一般工程</div>
                      <div id="contractorGenList"></div>
                  </div>
                  <div class="stats-col col-emergency">
                      <div class="stats-header">搶險搶修</div>
                      <div id="contractorEmgList"></div>
                  </div>
              </div>
              <button class="secondary" id="clearContractorStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> 清除所有顯示</button>
          </div>
          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          
          <div class="search-block-label"><i class="fas fa-clock"></i> 依派工時機快篩</div>
          <select id="timingSelect" style="margin-bottom:10px;">
              <option value="">(讀取系統資料中...)</option>
          </select>
          
          <div class="search-block-label"><i class="fas fa-tools"></i> 依維修類型快篩 (多選)</div>
          <div class="multiselect-group" id="typeFilterContainer">
              <div class="multiselect-header" onclick="toggleTypeFilter()">
                  <span id="typeFilterLabel">請選擇維修類型 (未選)</span>
                  <i class="fas fa-chevron-down"></i>
              </div>
              <div class="multiselect-content" id="typeFilterContent">
                  <div class="checkbox-item select-all-row">
                      <label><input type="checkbox" id="typeSelectAll" onchange="toggleAllTypes(this)"> 全選/取消</label>
                  </div>
                  <div id="typeCheckboxList"></div>
              </div>
          </div>

          <div style="text-align:center; font-size:12px; color:#999; margin:5px 0;">- 或 -</div>
          
          <div class="search-block-label"><i class="fas fa-keyboard"></i> 關鍵字搜尋</div>
          <input type="text" id="keywordInput" placeholder="例如：案件編號(113001) 案件名稱 廠商名稱">
          <button id="searchBtn" class="primary"><i class="fas fa-search"></i> 開始搜尋</button>
          <button id="clearSearchBtn" class="secondary" style="display:none; background:#ffebee; border-color:#ffcdd2; color:#d32f2f;"><i class="fas fa-times"></i> 清除結果</button>
          <div id="searchStatus" class="small" style="margin-top:8px; color:#004080; font-weight:bold;"></div>
      </div>
  </div>
  
  <div id="tab-tools" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-map-marker-alt"></i> 座標查詢工具</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
          <textarea id="coordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="plotBtn" class="primary" style="margin-top:0;">顯示點位</button>
            <button id="clearBtn" class="secondary" style="margin-top:0;">清除</button>
          </div>
      </div>
      
      <div class="card-section">
          <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
          <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
              <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
          </a>
      </div>
      
      <div class="card-section">
          <div class="card-title"><i class="fas fa-chart-network"></i> 空間群聚分析</div>
          <label class="toggle-switch"><input type="checkbox" id="clusterToggle"> 啟動熱區分析</label>
          <div class="analysis-control">
              <div style="font-size:12px; color:#666;">群聚閾值 (半徑)：</div>
              <div class="slider-container">
                  <input type="range" id="clusterSlider" min="0" max="500" step="10" value="50">
                  <span id="clusterValue" class="slider-value">50m</span>
              </div>
          </div>
      </div>

      <div class="card-section">
          <div class="card-title"><i class="fas fa-history"></i> 重複性案件檢核</div>
          <label class="toggle-switch" style="margin-bottom:10px;">
              <input type="checkbox" id="autoDupCheckToggle"> 啟動自動檢核重複性案件
          </label>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)</div>
          <input type="text" id="dupCheckInput" placeholder="例如：181924,2555825">
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="dupCheckBtn" class="primary" style="background:#e65100; margin-top:0;"><i class="fas fa-search"></i> 開始檢核</button>
            <button id="dupClearBtn" class="secondary" style="width:auto; margin-top:0; white-space:nowrap; flex-shrink:0;">清除</button>
          </div>
          <div id="dupCheckResult" style="margin-top:10px; font-size:13px; color:#333;"></div>
      </div>
  </div>
  
  <div id="tab-dengue" class="tab-content-container tab-pane">
      <div class="card-section">
          <div class="card-title"><i class="fas fa-map-pin"></i> 座標輸入</div>
          <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
          <textarea id="dengueCoordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
          <div style="display:flex; gap:5px; margin-top:5px;">
            <button id="plotDengueBtn" class="primary" style="background:#7f8c8d; margin-top:0;">顯示點位</button>
            <button id="clearDengueBtn" class="secondary" style="margin-top:0;">清除</button>
          </div>
      </div>
      <div class="card-section">
          <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
          <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px;">
              <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
          </a>
      </div>
      <div class="card-section">
          <div class="card-title"><i class="fas fa-circle-notch"></i> 選擇方圓半徑</div>
          <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
              <label class="dengue-option"><input type="radio" name="dengueRadius" value="50" onchange="updateDengueRadius()"> 50 公尺</label>
              <label class="dengue-option"><input type="radio" name="dengueRadius" value="150" onchange="updateDengueRadius()"> 150 公尺</label>
              <label class="dengue-option"><input type="radio" name="dengueRadius" value="200" onchange="updateDengueRadius()"> 200 公尺</label>
          </div>
      </div>
  </div>

  <div class="sidebar-footer">
      <div>本網頁圖資僅供參考，實際狀況應以權管機關現場鑑界為準。</div>
      <div style="margin-top:2px;">資料來源：Google Maps, OSM, 國土測繪中心, 臺南市山上區公所</div>
  </div>
</div>

<div id="map"></div>
<div id="floatingCoords"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwb88r-ifPxx9bBcD1sF0tLVxOIjw60RoLWWJZXk8T82TP3GhSV8bb3dTNEGcgggwr5/exec";

const map = L.map('map', { zoomControl:false, doubleClickZoom: false }).setView([23.1025,120.3538], 13);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { attribution: '© Google Maps' });
let isSat = false; 

const lc = L.control.locate({
    position: 'topright', 
    strings: { title: "我的位置 (點擊追蹤)" },
    icon: 'fas fa-crosshairs', iconLoading: 'fas fa-spinner fa-spin',
    setView: 'untilPan', keepCurrentZoomLevel: true, flyTo: true, cacheLocation: true,
    showPopup: false, drawCircle: true, drawMarker: true,
    locateOptions: { enableHighAccuracy: true, watch: true }
}).addTo(map);
const floatingContainer = document.querySelector('.map-floating-controls');
const lcContainer = lc.getContainer();
lcContainer.classList.remove('leaflet-bar', 'leaflet-control');
floatingContainer.prepend(lcContainer);

let wakeLock = null;
async function requestWakeLock() {
    if ('wakeLock' in navigator) {
        try { wakeLock = await navigator.wakeLock.request('screen'); console.log('Screen Wake Lock active'); } catch (err) {}
    }
}
map.on('locateactivate', requestWakeLock);

let REPAIR_CONFIG = []; 
let roadsLayer = null;  
let roadLayersArray = [];
let REPAIR_DATA_CACHE = {}; 
let ALL_CONTRACTORS = new Set(); 
// V14 新增：全域 Set 儲存唯一值
let ALL_TIMINGS = new Set();
let ALL_TYPES = new Set();

let currentRouteAllMatches = []; 
let villageGeoJSON = null; 
let dupCheckLayer = L.layerGroup().addTo(map); 
let dupMarkersMap = {}; 
let CURRENT_DUPLICATE_GROUPS = []; 
let CURRENT_MAP_GROUPS = {}; 
let reportNearbyMatches = []; 

let isMeasuring = false;
let measureStartLatLng = null;
let measureLine = null;
let measureTooltip = null;
let markersClusterGroup = null; 
let activeRepairLayers = []; 
let selectedTimelineMarker = null;

const DEEP_BLUE = '#004080'; 
const LIGHT_BLUE = '#0066cc'; 

proj4.defs("EPSG:3826","+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=WGS84 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

function twd97FromWgs84(lat,lng){ 
    const p = proj4('EPSG:4326','EPSG:3826',[lng,lat]); 
    return {x:Math.round(p[0]),y:Math.round(p[1])}; 
}

const dengueLayer = L.layerGroup().addTo(map);
const dengueRadiusLayer = L.layerGroup().addTo(map);
const cadastralLayer = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', { attribution: '© 國土測繪中心', opacity: 0.8, maxZoom: 20 });
let isCadastralVisible = false;
const boundaryLayer = L.layerGroup().addTo(map).setZIndex(100); 
const pointLayer = L.layerGroup().addTo(map).setZIndex(1000);   
const repairLayer = L.layerGroup().addTo(map); 
const routeMatchLayer = L.layerGroup().addTo(map).setZIndex(999); 
const searchResultLayer = L.featureGroup().addTo(map);
const clusterLayer = L.featureGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map).setZIndex(1001);

/* === V19 Added: 圖片預載 helper function === */
function preloadImages(urls) {
    if (!urls || !Array.isArray(urls)) return;
    urls.forEach(url => {
        if (url && url.trim() !== "") {
            const img = new Image();
            img.src = url.trim();
        }
    });
}

function getPhotosFromProps(props) {
    if(!props) return [];
    const arr1 = props['施工前照片'] ? props['施工前照片'].split(/[;\n\r]+/) : [];
    const arr2 = props['施工後照片'] ? props['施工後照片'].split(/[;\n\r]+/) : [];
    return [...arr1, ...arr2];
}

/* === 核心功能：新版泡泡窗生成函式 (3-Column + Sync + Wan + Mobile Opt V13) === */

// 手機版切換照片 Tab 的函數
window.switchMobilePhotoTab = function(el, type) {
    const card = el.closest('.popup-card');
    const tabs = card.querySelectorAll('.m-tab');
    tabs.forEach(t => t.classList.remove('active'));
    el.classList.add('active');
    
    const beforeView = card.querySelector('.photo-col-before');
    const afterView = card.querySelector('.photo-col-after');
    
    if(type === 'before') {
        beforeView.classList.add('active-view');
        afterView.classList.remove('active-view');
    } else {
        beforeView.classList.remove('active-view');
        afterView.classList.add('active-view');
    }
};

// 手機版切換詳細資訊折疊的函數
window.toggleMobileDetails = function(el) {
    const card = el.closest('.popup-card');
    const details = card.querySelector('.info-details-block');
    
    if(details.classList.contains('open')) {
        details.classList.remove('open');
        el.innerHTML = '▼ 查看詳細資訊 (廠商、座標、日期)';
    } else {
        details.classList.add('open');
        el.innerHTML = '▲ 收起詳細資訊';
    }
};

// 全域函數：切換照片
window.switchPhotoSet = function(el, index) {
    const card = el.closest('.popup-card');
    if(!card) return;

    const viewers = card.querySelectorAll('.photo-viewer');
    viewers.forEach(viewer => {
        const imgs = viewer.querySelectorAll('img');
        if(imgs.length > index) { 
            imgs.forEach(img => img.classList.remove('active'));
            imgs[index].classList.add('active');
        }
    });

    const allDotContainers = card.querySelectorAll('.carousel-dots');
    allDotContainers.forEach(container => {
        const dots = container.querySelectorAll('.dot');
        if(dots.length > index) {
            dots.forEach(dot => dot.classList.remove('active'));
            dots[index].classList.add('active');
        }
    });
};

// 輔助函式：產生搶修類型標籤 HTML (修復按鈕失效問題)
function renderTypeTags(rawType, isMobile) {
    if (!rawType) return isMobile ? '' : '<span class="type-pill">一般工程</span>';
    
    // 支援半形逗號與全形逗號切割，並過濾空字串
    const types = rawType.split(/[,，]/).map(s => s.trim()).filter(s => s.length > 0);
    if (types.length === 0) return isMobile ? '' : '<span class="type-pill">一般工程</span>';

    // 如果數量 <= 2，直接顯示全部
    if (types.length <= 2) {
        return `<div class="type-tag-group">
            ${types.map(t => `<span class="type-pill">${t}</span>`).join('')}
        </div>`;
    }

    // 如果數量 > 2，顯示前兩個 + "更多"按鈕 (使用預先隱藏法)
    const visible = types.slice(0, 2);
    const hidden = types.slice(2);
    const uid = Math.random().toString(36).substr(2, 9);
    const hiddenId = `hidden-${uid}`;
    const btnId = `btn-${uid}`;
    
    // 安全的 DOM 操作腳本，避免字串引號衝突
    const expandScript = `document.getElementById('${hiddenId}').style.display='contents';document.getElementById('${btnId}').style.display='none';`;

    return `<div class="type-tag-group">
        ${visible.map(t => `<span class="type-pill">${t}</span>`).join('')}
        <span id="${hiddenId}" style="display:none;">
            ${hidden.map(t => `<span class="type-pill">${t}</span>`).join('')}
        </span>
        <span id="${btnId}" class="type-pill-more" onclick="${expandScript}" title="點擊展開: ${hidden.join(', ')}">
            +${hidden.length} 更多
        </span>
    </div>`;
}

function createPopup(data) {
    const { fileName, props, lat, lng, dist } = data;
    const twd = twd97FromWgs84(lat, lng);
    const distText = isNaN(dist) ? 'N/A' : dist.toFixed(0) + 'm';
    
    const caseIdRaw = props['案件編號'];
    const caseId = caseIdRaw || '無編號';
    const status = props['案件狀態'] || '已完工';
    const timing = props['派工時機'] || '一般';
    const typeRaw = props['搶修類型'] || '一般工程'; // 取得原始資料
    const contractor = props['施工廠商'] || '-';
    const supervisor = props['監造廠商'] || '-';
    const date = props['完工日期'] || '-';
    const procurementUrl = props['採購網址'] ? props['採購網址'].trim() : '';

    // V15: 金額格式優化
    let price = '0元';
    const rawPrice = props['決標金額'];
    if(rawPrice) {
        const num = parseInt(rawPrice.toString().replace(/,/g, ''));
        if(!isNaN(num)) {
            // V15 Formatter: X萬0000元 with comma
            const formatPriceV15 = (n) => {
                if(n < 10000) return n.toLocaleString() + '元';
                const w = Math.floor(n / 10000);
                const r = n % 10000;
                let rStr = r.toString().padStart(4, '0');
                // 若後4位大於等於1000，加上千分位逗號
                if(r >= 1000) {
                    rStr = rStr.substring(0, 1) + ',' + rStr.substring(1);
                }
                return `${w}萬${rStr}元`;
            };
            price = formatPriceV15(num);
        }
    }

    let pillClass = 'pill-done';
    if(status.includes('施工') || status.includes('派工')) pillClass = 'pill-working';
    else if(status.includes('緊急') || status.includes('搶修')) pillClass = 'pill-urgent';

    // V13 & V0129-V2: 智慧型案件編號顯示 (修正長名稱被截斷問題)
    let formattedCaseId = caseId; 
    const idParts = caseId.split('-');
    
    // 邏輯修正：只有當後綴是純數字且短於5位數時，才進行「第X案」的格式化
    if (idParts.length >= 2) {
        const suffix = idParts[idParts.length - 1]; 
        // 檢查後綴是否為純數字且長度在 1~4 之間 (例如 001, 155)
        if (/^\d{1,4}$/.test(suffix)) {
            const num = parseInt(suffix, 10);
            if (!isNaN(num)) {
                formattedCaseId = `${fileName}第${num}案`;
            }
        }
    }
    
    // V15: 手機版標題簡化 (直接顯示文字，不加前綴)
    const mobileCaseIdDisplay = formattedCaseId;

    // === 0116V2 Added: Sibling Dot Navigation Logic ===
    let siblingNavHtml = '';
    let mobileSiblingNavHtml = '';
    
    // 檢查是否有其他兄弟節點 (同編號但不同座標)
    let siblings = [];
    if (caseIdRaw) {
        // 合併搜尋來源
        const candidates = [...activeRepairLayers, ...searchResultLayer.getLayers()];
        // 過濾同案號
        const rawSiblings = candidates.filter(m => m.customData?.props['案件編號'] === caseIdRaw);
        
        // 智慧去重 (透過 lat,lng key) 並保持標記參考
        const uniqueMap = new Map();
        rawSiblings.forEach(m => {
            const ll = m.getLatLng();
            const key = ll.lat.toFixed(6) + ',' + ll.lng.toFixed(6);
            if(!uniqueMap.has(key)) uniqueMap.set(key, m);
        });
        siblings = Array.from(uniqueMap.values());

        // 固定排序 (由北至南，由東至西)，確保數字順序永遠一致
        siblings.sort((a, b) => {
            const la = a.getLatLng();
            const lb = b.getLatLng();
            // 先比緯度 (大到小)
            if(Math.abs(la.lat - lb.lat) > 0.00001) return lb.lat - la.lat;
            // 再比經度 (大到小)
            return lb.lng - la.lng;
        });
    }

    if (siblings.length > 1) {
        let dots = '';
        siblings.forEach((sib, idx) => {
            const sLat = sib.getLatLng().lat;
            const sLng = sib.getLatLng().lng;
            // 判斷是否為當前座標
            const isCurrent = (Math.abs(sLat - lat) < 0.000001 && Math.abs(sLng - lng) < 0.000001);
            const activeClass = isCurrent ? 'active' : '';
            const clickEvent = isCurrent ? '' : `onclick="jumpToSpecificSibling('${caseIdRaw}', ${sLat}, ${sLng})"`;
            const titleText = isCurrent ? '目前位置' : `前往關聯點位 ${idx+1}`;
            
            dots += `<div class="sibling-dot ${activeClass}" ${clickEvent} title="${titleText}">${idx+1}</div>`;
        });
        
        siblingNavHtml = `<div class="sibling-nav-container">${dots}</div>`;
        mobileSiblingNavHtml = `<div class="sibling-nav-container mobile">${dots}</div>`;
    }
    // ============================================

    const getPhotoArray = (str) => {
        if(!str) return [];
        return str.split(/[;\n\r]+/).map(u => u.trim()).filter(u => u.length > 0);
    };
    const arrBefore = getPhotoArray(props['施工前照片']);
    const arrAfter = getPhotoArray(props['施工後照片']);

    const generatePhotoSection = (title, urls, typeKey) => {
        const uid = Math.random().toString(36).substr(2, 9);
        const viewerId = `viewer-${typeKey}-${uid}`;
        let imgsHtml = '';
        let dotsHtml = '';

        if(urls.length > 0) {
            // V13V5 Updated: 加入 oncontextmenu 與 draggable 屬性
            urls.forEach((url, i) => { 
                const activeClass = i === 0 ? 'active' : ''; 
                imgsHtml += `<img src="${url.trim()}" class="${activeClass}" oncontextmenu="return false;" draggable="false">`; 
            });
            if(urls.length > 1) {
                dotsHtml = `<div class="carousel-dots">`;
                urls.forEach((_, i) => { const activeClass = i === 0 ? 'active' : ''; dotsHtml += `<div class="dot ${activeClass}" onclick="switchPhotoSet(this, ${i})">${i+1}</div>`; });
                dotsHtml += `</div>`;
            }
        } else { imgsHtml = `<div class="no-photo"><i class="fas fa-image"></i><span>暫無影像</span></div>`; }

        return `
            <div class="photo-section-header">
                <div class="photo-title"><i class="fas fa-camera"></i> ${title}</div>
            </div>
            <div class="photo-viewer" id="${viewerId}">
                ${imgsHtml}
            </div>
            ${dotsHtml}
        `;
    };

    const tenderBtn = procurementUrl 
        ? `<a href="${procurementUrl}" target="_blank" class="popup-btn-new"><i class="fas fa-file-alt"></i><span>決標</span></a>` 
        : `<span class="popup-btn-new" style="opacity:0.5;cursor:not-allowed;"><i class="fas fa-file-alt"></i><span>無公告</span></span>`;

    return `
    <div class="popup-card">
        <div class="popup-deco-strip"></div>
        <div class="popup-col-info">
            
            <div class="mobile-compact-header">
                <div class="m-row-1">
                    <div class="status-pill ${pillClass}">${status}</div>
                    <div class="case-id mobile-id-text">
                        ${mobileCaseIdDisplay}
                    </div>
                </div>
                ${mobileSiblingNavHtml}
                <div class="m-row-2">
                    <div class="price-val">${price}</div>
                    <div class="m-tags-line">
                        <span>${fileName}</span>
                        ${renderTypeTags(typeRaw, true)}
                    </div>
                </div>
            </div>

            <div class="desktop-only">
                <div class="status-pill ${pillClass}">進度：${status}</div>
                <div class="case-id" style="display:flex; align-items:center; flex-wrap:wrap;">
                    ${formattedCaseId}
                </div>
                ${siblingNavHtml}

                <div class="case-meta">
                    <span class="file-tag">${fileName}</span>
                    ${renderTypeTags(typeRaw, false)}
                </div>
                <div class="popup-tags">
                    <div class="tag-pill tag-dark"><i class="fas fa-clock"></i> ${timing}</div>
                    <div class="tag-pill tag-light"><i class="fas fa-map-marker-alt" style="color:#10b981;"></i> 距路線 ${distText}</div>
                </div>
                <div class="price-block">
                    <div class="price-label">決標金額</div>
                    <div class="price-val">${price}</div>
                </div>
            </div>

            <div class="mobile-photo-tabs">
                <div class="m-tab" onclick="switchMobilePhotoTab(this, 'before')">施工前</div>
                <div class="m-tab active" onclick="switchMobilePhotoTab(this, 'after')">● 施工後</div>
            </div>

            <div class="info-details-block">
                <div class="compact-list">
                    <div class="compact-item">
                        <span class="compact-label">施工廠商</span>
                        <div class="compact-val">${contractor}</div>
                    </div>
                    <div class="compact-row">
                        <div class="compact-item" style="flex:1">
                            <span class="compact-label">監造廠商</span>
                            <div class="compact-val">${supervisor}</div>
                        </div>
                        <div class="compact-item" style="flex:1">
                            <span class="compact-label">WGS84</span>
                            <div class="compact-val">${lat.toFixed(6)}, ${lng.toFixed(6)}</div>
                        </div>
                    </div>
                    <div class="compact-row">
                        <div class="compact-item" style="flex:1">
                            <span class="compact-label">完工日期</span>
                            <div class="compact-val">${date}</div>
                        </div>
                        <div class="compact-item" style="flex:1">
                            <span class="compact-label">TWD97</span>
                            <div class="compact-val">${twd.x}, ${twd.y}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="popup-btns">
                ${tenderBtn}
                <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="popup-btn-new"><i class="fas fa-map"></i><span>地籍</span></a>
                <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-camera"></i><span>街景</span></a>
                <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="popup-btn-new"><i class="fas fa-location-arrow"></i><span>導航</span></a>
            </div>

            <div class="mobile-details-toggle" onclick="toggleMobileDetails(this)">▼ 查看詳細資訊 (廠商、座標、日期)</div>

        </div>

        <div class="popup-col-photo photo-col-before">
            ${generatePhotoSection('施工前', arrBefore, 'before')}
        </div>
        <div class="popup-col-photo photo-col-after active-view">
            ${generatePhotoSection('施工後', arrAfter, 'after')}
        </div>
    </div>
    `;
}

/* === 其他 JS 邏輯保持 0109 版本原樣 === */
const reportOverlay = document.getElementById('reportOverlay');
const openReportBtn = document.getElementById('openReportBtn');
openReportBtn.addEventListener('click', function() { reportOverlay.style.display = 'flex'; initReportData(); });
function closeReport() { reportOverlay.style.display = 'none'; resetReportForm(); }

function initReportData() {
    document.getElementById('reportCaseId').innerText = "(待系統取號)";
    document.getElementById('reportTime').innerText = new Date().toLocaleString();
    
    const historySection = document.getElementById('nearbyHistorySection');
    const historyList = document.getElementById('nearbyHistoryList');
    historySection.style.display = 'none';
    historyList.innerHTML = '';
    reportNearbyMatches = [];

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude, lng = pos.coords.longitude;
                const twd = twd97FromWgs84(lat, lng);
                document.getElementById('reportWgs84').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                document.getElementById('reportTwd97').innerText = `${twd.x}, ${twd.y}`;
                checkNearbyHistory(lat, lng);
            },
            () => { document.getElementById('reportWgs84').innerText = "定位失敗"; document.getElementById('reportTwd97').innerText = "定位失敗"; },
            { enableHighAccuracy: true }
        );
    } else { document.getElementById('reportWgs84').innerText = "不支援定位"; }
}

function checkNearbyHistory(lat, lng) {
    const historySection = document.getElementById('nearbyHistorySection');
    const historyList = document.getElementById('nearbyHistoryList');
    const centerLatLng = L.latLng(lat, lng);
    
    const now = new Date();
    const threeYearsAgo = new Date();
    threeYearsAgo.setFullYear(now.getFullYear() - 3);

    reportNearbyMatches = [];

    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; 
        if(!data || !data.features) return;
        
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
            
            // V16: 修正搜尋半徑為 50m
            const dist = centerLatLng.distanceTo(pt);
            if(dist <= 50) {
                // V16: 修正日期格式判斷 (加入 String() 轉型)
                const rawDate = f.properties['完工日期'];
                const dateStr = rawDate ? String(rawDate).trim() : "";
                
                if(dateStr.length === 7) {
                    const y = parseInt(dateStr.substring(0,3)) + 1911;
                    const m = parseInt(dateStr.substring(3,5)) - 1;
                    const d = parseInt(dateStr.substring(5,7));
                    const finishDate = new Date(y, m, d);
                    
                    if(finishDate >= threeYearsAgo) {
                        const isEmergency = /搶修|災害|緊急/.test(conf.label);
                        reportNearbyMatches.push({
                            label: conf.label,
                            props: f.properties,
                            lat: pt.lat,
                            lng: pt.lng,
                            dist: dist.toFixed(1),
                            isEmergency: isEmergency,
                            dateStr: dateStr,
                            jsDate: finishDate
                        });
                    }
                }
            }
        });
    });

    historyList.innerHTML = '';
    if(reportNearbyMatches.length > 0) {
        historySection.style.display = 'block';
        reportNearbyMatches.sort((a,b) => b.jsDate - a.jsDate);
        
        reportNearbyMatches.forEach((item, index) => {
            const tagClass = item.isEmergency ? 'tag-emg' : 'tag-gen';
            const tagName = item.isEmergency ? '搶修' : '一般';
            
            const div = document.createElement('div');
            div.className = 'nearby-item';
            div.innerHTML = `
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#004080; margin-bottom:2px;">${item.label}</div>
                    <div style="font-size:12px; color:#666;">完工：${item.dateStr} | 距離：${item.dist}m</div>
                </div>
                <div class="nearby-tag ${tagClass}">${tagName}</div>
            `;
            div.onclick = function() { showReportDetail(index); };
            historyList.appendChild(div);
        });
    } else {
        historySection.style.display = 'block';
        // V16: 更新提示文字為 50公尺
        historyList.innerHTML = '<div style="padding:10px; color:#999; text-align:center;">此位置 50公尺內 最近 3年無維修紀錄。</div>';
    }
}

function showReportDetail(index) {
    const item = reportNearbyMatches[index];
    if(!item) return;
    const content = createPopup({
        fileName: item.label,
        props: item.props,
        lat: item.lat,
        lng: item.lng,
        dist: parseFloat(item.dist) 
    });
    
    document.getElementById('reportDetailContent').innerHTML = content;
    document.getElementById('reportDetailModal').style.display = 'flex';
}

function closeReportDetailModal() {
    document.getElementById('reportDetailModal').style.display = 'none';
}

// === 0203V5 Update: 觸發相機的邏輯改為開啟選擇對話框 ===
var currentPhotoTargetId = 1;

function triggerCamera(id) {
    currentPhotoTargetId = id;
    // 檢查目前是否有照片，若有則不動作（需先刪除）
    if (!document.getElementById(`imgPreview${id}`).src) {
        document.getElementById('sourceSelectModal').style.display = 'flex';
    }
}

function closeSourceModal() {
    document.getElementById('sourceSelectModal').style.display = 'none';
}

function selectSource(type) {
    var input = document.getElementById(`fileInput${currentPhotoTargetId}`);
    
    if (type === 'camera') {
        // 設定強制使用相機
        input.setAttribute('capture', 'environment');
    } else {
        // 移除 capture 屬性，讓手機開啟相簿/檔案總管
        input.removeAttribute('capture');
    }
    
    closeSourceModal();
    
    // 延遲一點點觸發點擊，避免 UI 還沒消失造成的干擾
    setTimeout(function() {
        input.click();
    }, 100);
}

function previewImage(input, id) {
    if (input.files && input.files[0]) {
        compressImage(input.files[0], 800, 0.7, function(compressedDataUrl) {
            const img = document.getElementById(`imgPreview${id}`);
            const box = document.getElementById(`photoBox${id}`);
            const delBtn = document.getElementById(`delBtn${id}`);
            img.src = compressedDataUrl; img.style.display = 'block';
            box.querySelector('.add-photo-btn').style.display = 'none';
            box.classList.add('has-image');
            delBtn.style.display = 'block';
        });
    }
}
function compressImage(file, maxWidth, quality, callback) {
    const reader = new FileReader(); reader.readAsDataURL(file);
    reader.onload = function (event) {
        const img = new Image(); img.src = event.target.result;
        img.onload = function () {
            let width = img.width, height = img.height;
            if (width > maxWidth) { height = Math.round(height * (maxWidth / width)); width = maxWidth; }
            const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', quality));
        };
    };
}
function deletePhoto(id) {
    const img = document.getElementById(`imgPreview${id}`);
    const box = document.getElementById(`photoBox${id}`);
    const input = document.getElementById(`fileInput${id}`);
    const delBtn = document.getElementById(`delBtn${id}`);
    img.src = ""; img.removeAttribute('src'); img.style.display = 'none';
    box.querySelector('.add-photo-btn').style.display = 'block';
    box.classList.remove('has-image'); input.value = ""; delBtn.style.display = 'none';
}
function resetReportForm() { deletePhoto(1); deletePhoto(2); document.getElementById('reportDesc').value = ""; document.getElementById('reportWgs84').innerText = "定位中..."; document.getElementById('reportTwd97').innerText = "定位中..."; }

// === 資安優化：產生或讀取使用者唯一識別碼 ===
function getUserID() {
    let uid = localStorage.getItem('site_user_uid');
    if (!uid) {
        // 簡單產生一個隨機 ID
        uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('site_user_uid', uid);
    }
    return uid;
}

async function submitReport() {
    if (GOOGLE_SCRIPT_URL.includes("您的SCRIPT_ID")) { alert("請先設定 Google Apps Script URL！"); return; }
    const desc = document.getElementById('reportDesc').value;
    if (!desc.trim()) { alert("請輸入案情描述！"); return; }
    if (!confirm("確定要上傳此案件通報嗎？")) return;
    const btn = document.getElementById('btnSubmitReport'); const originalText = btn.innerText; btn.disabled = true; btn.innerText = "資料上傳中...";
    try {
        const img1 = document.getElementById('imgPreview1'), img2 = document.getElementById('imgPreview2');
        const payload = { 
            time: document.getElementById('reportTime').innerText, 
            wgs84: document.getElementById('reportWgs84').innerText, 
            twd97: document.getElementById('reportTwd97').innerText, 
            description: desc, 
            photo1: (img1.src && img1.src.startsWith('data:')) ? img1.src : "", 
            photo2: (img2.src && img2.src.startsWith('data:')) ? img2.src : "",
            
            // === 新增資安驗證欄位 ===
            appKey: "TainanMap2026_SecureKey_v1", // 必須與 GAS 後端設定一致
            siteUrl: window.location.href,        // 來源網址檢查
            uid: getUserID()                      // 使用者識別碼 (頻率限制用)
        };
        const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
        const result = await response.json();
        if (result.result === "success") { alert(`✅ 案件通報成功！\n\n案件編號：${result.caseId}\n資料已寫入雲端試算表。`); closeReport(); } else { alert("❌ 上傳失敗: " + (result.error || "未知錯誤")); }
    } catch (error) { console.error(error); alert("❌ 連線錯誤，請檢查網路或稍後再試。"); } finally { btn.disabled = false; btn.innerText = originalText; }
}

document.getElementById('dupClearBtn').addEventListener('click', function() {
    dupCheckLayer.clearLayers(); document.getElementById('dupCheckResult').innerHTML = ''; document.getElementById('dupCheckInput').value = ''; document.getElementById('autoDupCheckToggle').checked = false; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = [];
});
window.focusDupMarker = function(index) { const marker = dupMarkersMap[index]; if(marker) { map.flyTo(marker.getLatLng(), 18); marker.openPopup(); if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); } };
window.showDupDetailPopup = function(groupIdx, caseIdx) {
    const group = CURRENT_DUPLICATE_GROUPS[groupIdx]; if(!group) return; const item = group[caseIdx];
    const distToLine = distToRoad(item.latlng, roadsLayer); 
    const content = createPopup({ fileName: item.name, props: item.props, lat: item.latlng.lat, lng: item.latlng.lng, dist: distToLine });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};
window.showMapDetailPopup = function(key, index) {
    const group = CURRENT_MAP_GROUPS[key]; if(!group || !group[index]) return; const item = group[index];
    const dist = distToRoad(item.latlng, roadsLayer);
    const content = createPopup({ fileName: item.configLabel, props: item.feature.properties, lat: item.latlng.lat, lng: item.latlng.lng, dist: dist });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};
document.getElementById('autoDupCheckToggle').addEventListener('change', function() {
    if(this.checked) { document.getElementById('dupCheckInput').value = ''; performAutoDuplicateCheck(); } else { dupCheckLayer.clearLayers(); document.getElementById('dupCheckResult').innerHTML = ''; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = []; }
});

function performAutoDuplicateCheck() {
    const resDiv = document.getElementById('dupCheckResult'); resDiv.innerHTML = '<div style="padding:10px; color:#666;">掃描資料庫中...</div>';
    let coordMap = {}; 
    REPAIR_CONFIG.forEach(conf => {
        const data = REPAIR_DATA_CACHE[conf.value]; if(!data || !data.features) return;
        data.features.forEach(f => {
            if(f.geometry.type !== 'Point') return;
            const key = f.geometry.coordinates.join(',');
            if(!coordMap[key]) coordMap[key] = [];
            coordMap[key].push({ name: conf.label, props: f.properties, latlng: L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]) });
        });
    });
    let duplicates = []; Object.keys(coordMap).forEach(k => { if(coordMap[k].length > 1) duplicates.push(coordMap[k]); });
    CURRENT_DUPLICATE_GROUPS = duplicates;
    dupCheckLayer.clearLayers(); resDiv.innerHTML = ''; dupMarkersMap = {};
    if(duplicates.length === 0) { resDiv.innerHTML = '<div style="padding:10px; color:green;">未發現完全重疊的案件座標。</div>'; return; }
    let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">⚠️ 發現 ${duplicates.length} 組重複座標點位：</div>`;
    duplicates.forEach((group, idx) => {
        const pt = group[0].latlng; const twd = twd97FromWgs84(pt.lat, pt.lng);
        const marker = L.circleMarker(pt, { radius: 10, color: '#d32f2f', fillColor: '#ffeb3b', fillOpacity: 0.9, weight:2 }).addTo(dupCheckLayer);
        let popupHTML = `<div class="info-header" style="padding:10px;background:#004080;color:white;font-weight:bold;">重複座標點位資訊 (${group.length}筆)</div><div class="info-body" style="padding:10px;max-height:250px; overflow-y:auto;"><div style="font-size:12px; color:#666; margin-bottom:5px;">點擊案件名稱可查看詳細資料</div>`;
        group.forEach((item, i) => {
            popupHTML += `<div style="border-bottom:1px dashed #ccc; padding:8px 0; cursor:pointer;" onclick="showDupDetailPopup(${idx}, ${i})"><b style="color:#004080; text-decoration:underline;">${i+1}. ${item.name}</b><br><span style="color:#333; font-size:12px;">案件編號: ${item.props['案件編號']||'無'}<br>完工日期: ${item.props['完工日期']||'無'}</span></div>`;
        });
        popupHTML += `</div>`;
        marker.bindPopup(popupHTML, { className: 'custom-popup', maxWidth: 300 });
        dupMarkersMap[idx] = marker;
        const dates = group.map(g => g.props['完工日期'] || '').sort();
        const dateRange = dates[0] ? `${dates[0]} ~ ${dates[dates.length-1]}` : '日期未知';
        html += `<div class="dup-check-item" onclick="focusDupMarker(${idx})"><div class="dup-check-title">📍 座標重複群組 #${idx+1} <br><span style="font-size:11px; color:#555;">(TWD97: ${twd.x}, ${twd.y})</span></div><div class="dup-check-info" style="color:#d32f2f; font-weight:bold;">包含 ${group.length} 筆案件</div><div class="dup-check-info" style="font-size:11px; color:#666;">${dateRange}</div></div>`;
    });
    resDiv.innerHTML = html;
}

document.getElementById('dupCheckBtn').addEventListener('click', function() {
    const autoCheck = document.getElementById('autoDupCheckToggle'); if(autoCheck.checked) autoCheck.checked = false;
    const input = document.getElementById('dupCheckInput').value.trim();
    const resultDiv = document.getElementById('dupCheckResult'); dupCheckLayer.clearLayers(); resultDiv.innerHTML = ''; dupMarkersMap = {}; CURRENT_DUPLICATE_GROUPS = [];
    if (!input) { alert('請輸入 TWD97 座標，例如 181924,2555825'); return; }
    const parts = input.split(/[, \t]+/); if (parts.length < 2) { alert('座標格式錯誤'); return; }
    const x = parseFloat(parts[0]), y = parseFloat(parts[1]); if (isNaN(x) || isNaN(y)) { alert('座標數值錯誤'); return; }
    try {
        const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]); const centerLatLng = L.latLng(w[1], w[0]);
        map.setView(centerLatLng, 18);
        L.circle(centerLatLng, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 50 }).addTo(dupCheckLayer);
        L.marker(centerLatLng).addTo(dupCheckLayer).bindPopup(`檢核中心點<br>TWD97: ${x}, ${y}`).openPopup();
        const matches = []; const now = new Date(); const threeYearsAgo = new Date(); threeYearsAgo.setFullYear(now.getFullYear() - 3);
        REPAIR_CONFIG.forEach(conf => {
            const data = REPAIR_DATA_CACHE[conf.value]; if (!data) return;
            data.features.forEach(f => {
                if (f.geometry.type !== 'Point') return;
                const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
                const dist = centerLatLng.distanceTo(pt);
                if (dist <= 50) {
                    const dateStr = f.properties['完工日期'];
                    if (dateStr && dateStr.length === 7) {
                        const y = parseInt(dateStr.substring(0, 3)) + 1911, m = parseInt(dateStr.substring(3, 5)) - 1, d = parseInt(dateStr.substring(5, 7));
                        const finishDate = new Date(y, m, d);
                        if (finishDate >= threeYearsAgo) {
                            let diffMonths = (now.getFullYear() - finishDate.getFullYear()) * 12 + (now.getMonth() - finishDate.getMonth());
                            if (now.getDate() < finishDate.getDate()) diffMonths--;
                            const years = Math.floor(diffMonths / 12), months = diffMonths % 12;
                            const timeAgoStr = `${years} 年 ${months} 個月`;
                            const isEmergency = /搶修|災害|緊急/.test(conf.label);
                            matches.push({ name: conf.label, props: f.properties, date: dateStr, timeAgo: timeAgoStr, dist: dist.toFixed(1), isEmergency: isEmergency, latlng: pt });
                        }
                    }
                }
            });
        });
        if (matches.length === 0) { resultDiv.innerHTML = '<div style="color:green; font-weight:bold;"><i class="fas fa-check-circle"></i> 此範圍 50m 內近 3 年無相關紀錄</div>'; } else {
            matches.sort((a, b) => parseFloat(a.dist) - parseFloat(b.dist));
            let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">⚠️ 發現 ${matches.length} 筆近 3 年紀錄：</div>`;
            matches.forEach((m, index) => {
                const marker = L.circleMarker(m.latlng, { radius: 8, color: '#d32f2f', weight: 2, fillColor: '#ffeb3b', fillOpacity: 1 }).addTo(dupCheckLayer);
                const distToLine = distToRoad(m.latlng, roadsLayer); 
                marker.bindPopup(createPopup({ fileName: m.name, props: m.props, lat: m.latlng.lat, lng: m.latlng.lng, dist: distToLine }), { className: 'custom-popup', maxWidth:960 });
                dupMarkersMap[index] = marker;
                const tagClass = m.isEmergency ? 'tag-emg' : 'tag-gen'; const tagName = m.isEmergency ? '搶修' : '一般';
                html += `<div class="dup-check-item" onclick="focusDupMarker(${index})"><div class="dup-check-title">${m.name}<span class="dup-tag ${tagClass}">${tagName}</span></div><div class="dup-check-info"><span>完工：${m.props['完工日期']} (距今 ${m.timeAgo})</span></div><div class="dup-check-info"><span>距離：${m.dist} 公尺</span></div></div>`;
            });
            resultDiv.innerHTML = html;
        }
    } catch (e) { console.error(e); alert('座標轉換失敗'); }
});

window.switchTab = function(tabId) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`); if(btn) btn.classList.add('active');
};
const toggleBtn = document.getElementById('toggleSidebarBtn'), overlayMask = document.getElementById('overlay-mask'), bottomPanel = document.getElementById('bottomPanel'), togglePanelSizeBtn = document.getElementById('togglePanelSizeBtn'), panelIcon = togglePanelSizeBtn.querySelector('i');
function toggleSidebar() { const isMobile = window.innerWidth <= 768; if (isMobile) document.body.classList.toggle('sidebar-open'); else document.body.classList.toggle('collapsed'); setTimeout(() => map.invalidateSize(), 300); }
toggleBtn.addEventListener('click', toggleSidebar); overlayMask.addEventListener('click', () => document.body.classList.remove('sidebar-open'));
document.getElementById('closePanelBtn').addEventListener('click', () => { bottomPanel.classList.remove('open'); routeMatchLayer.clearLayers(); });
togglePanelSizeBtn.addEventListener('click', () => { bottomPanel.classList.toggle('minimized'); if (bottomPanel.classList.contains('minimized')) panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up'); else panelIcon.classList.replace('fa-chevron-up', 'fa-chevron-down'); });

fetch('tainan_districts.geojson').then(r=>r.json()).then(data=>{
    L.geoJSON(data, { interactive: false, style: f => { const isTarget = (f.properties.TOWNNAME||f.properties.TOWN).includes('山上'); return { color: '#d500f9', weight: isTarget ? 4 : 1, opacity: 1, dashArray: isTarget ? '15, 10' : '', fillOpacity: 0 }; } }).addTo(boundaryLayer);
}).catch(e=>console.warn(e));

const VILLAGE_COLORS = { "明和里": "#E74C3C", "山上里": "#F39C12", "南洲里": "#F1C40F", "新莊里": "#2ECC71", "平陽里": "#1ABC9C", "豐德里": "#9B59B6", "玉峯里": "#FF69B4", "玉峰里": "#FF69B4" };
fetch('t22.json').then(r => r.json()).then(topology => {
    villageGeoJSON = topojson.feature(topology, topology.objects.t22);
    const villageNames = villageGeoJSON.features.map(f => f.properties.VILLAGE || f.properties.VILLNAME).sort();
    const vSelSearch = document.getElementById('villageSelect'), vSelStats = document.getElementById('statsVillageSelect');
    vSelSearch.innerHTML = '<option value="">-- 請選擇行政區 --</option>'; vSelStats.innerHTML = '<option value="">-- 請選擇行政區 --</option>';
    villageNames.forEach(v => {
        const opt1 = document.createElement('option'); opt1.value = v; opt1.textContent = v; vSelSearch.appendChild(opt1);
        const opt2 = document.createElement('option'); opt2.value = v; opt2.textContent = v; vSelStats.appendChild(opt2);
    });
    const villageLayer = L.geoJSON(villageGeoJSON, {
        style: function(feature) { const vName = feature.properties.VILLAGE || feature.properties.VILLNAME; const color = VILLAGE_COLORS[vName] || "#999"; return { fillColor: color, fillOpacity: 0.1, color: color, weight: 1, opacity: 0.4, dashArray: '5, 5' }; },
        onEachFeature: function(feature, layer) { layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.4, weight: 2, color: '#FFD700', dashArray: '' }); }); layer.on('mouseout', function() { villageLayer.resetStyle(this); }); }
    }).addTo(boundaryLayer);
    villageLayer.bringToBack();
}).catch(e => console.warn(e));

function getVillageName(lat, lng) {
    if (!villageGeoJSON) return "讀取資料中..."; const pt = turf.point([lng, lat]);
    for (const feature of villageGeoJSON.features) { if (turf.booleanPointInPolygon(pt, feature)) return `山上區 ${feature.properties.VILLAGE || feature.properties.VILLNAME || "未知里"}`; }
    return "非山上區範圍";
}

/* === 0116V2 Added: Function to navigate to specific sibling marker === */
window.jumpToSpecificSibling = function(caseId, targetLat, targetLng) {
    // 1. 搜尋所有圖層中的匹配項目 (Active + Search)
    const allLayers = [...activeRepairLayers, ...searchResultLayer.getLayers()];
    
    // 找到目標標記 (需同時符合 CaseId 與 座標)
    const target = allLayers.find(m => {
        const p = m.getLatLng();
        return Math.abs(p.lat - targetLat) < 0.000001 && 
               Math.abs(p.lng - targetLng) < 0.000001 && 
               m.customData && m.customData.props &&
               m.customData.props['案件編號'] === caseId;
    });
    
    if(target) {
        // 2. 執行飛行動畫並開啟泡泡窗
        map.flyTo(target.getLatLng(), 18, { duration: 1.5 });
        
        // 使用 once('moveend') 確保移動結束後才開啟 Popup
        map.once('moveend', function() {
            openDetailPopupFromMarker(target);
        });
    }
};
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>臺南市山上區公眾通行道路圖資 (v.0220_V8)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>

<style>
  /* === 1. 全局設定 === */
  :root {
    --primary-color: #004080; /* 深藍 */
    --accent-color: #ff9800;  /* 橘黃 */
    --purple-theme: #6f42c1;  /* 紫色主題 */
    --bg-light: #f8faff;
    --text-dark: #333;
    --sidebar-width: 350px;
    
    /* 新版泡泡窗配色 */
    --popup-bg: #f2fcf5;
    --popup-border: #d1fae5;
    --popup-text-main: #064e3b; 
    --popup-text-sub: #059669;  
    --popup-accent: #10b981;    
  }
  
  body { 
    margin: 0; 
    font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; 
    display: flex; 
    height: 100vh; 
    height: 100dvh; 
    overflow: hidden; 
    position: relative; 
    background: var(--bg-light); 
  }

  /* === 入口模式選擇視窗 === */
  #entryModal {
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    z-index: 99999;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: flex; 
    align-items: center; 
    justify-content: center;
    animation: fadeIn 0.3s;
  }
  .entry-card {
    background: #fff; 
    width: 90%; 
    max-width: 400px;
    border-radius: 20px; 
    padding: 30px 20px;
    text-align: center;
    box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    animation: popIn 0.4s;
  }
  .entry-header h2 { 
    margin: 0 0 10px 0; 
    color: var(--primary-color); 
    font-size: 22px; 
  }
  .entry-header p { 
    color: #666; 
    margin: 0 0 25px 0; 
    font-size: 14px; 
  }
  .entry-actions { 
    display: flex; 
    flex-direction: column; 
    gap: 15px; 
  }
  .entry-btn {
    padding: 15px; 
    border: none; 
    border-radius: 12px;
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 15px;
    transition: transform 0.2s, box-shadow 0.2s;
    text-align: left;
  }
  .entry-btn:hover { 
    transform: translateY(-3px); 
    box-shadow: 0 5px 15px rgba(0,0,0,0.15); 
  }
  .entry-btn i { 
    font-size: 24px; 
    width: 30px; 
    text-align: center; 
  }
  .entry-btn span { 
    font-size: 18px; 
    font-weight: bold; 
    line-height: 1.2; 
    display: flex; 
    flex-direction: column; 
  }
  .entry-btn small { 
    font-size: 12px; 
    font-weight: normal; 
    opacity: 0.8; 
  }
  
  .entry-btn.lite { 
    background: linear-gradient(135deg, #ff9800, #f57c00); 
    color: white; 
  }
  .entry-btn.full { 
    background: linear-gradient(135deg, #004080, #003366); 
    color: white; 
  }

  /* === 輕量版模式樣式覆寫 === */
  body.lite-mode #sidebar,
  body.lite-mode #toggleSidebarBtn,
  body.lite-mode #bottomPanel,
  body.lite-mode .map-floating-controls {
    display: none !important;
  }
  body.lite-mode #switchModeBtn {
    display: flex !important;
  }
  body.lite-mode #reportOverlay {
    display: flex !important;
    background: var(--bg-light);
  }
  body.lite-mode #reportCloseBtn {
    display: none !important; 
  }
  #switchModeBtn {
    display: none; 
    position: absolute; 
    top: 10px; 
    left: 10px;
    width: 40px; 
    height: 40px;
    background: rgba(255,255,255,0.9); 
    border: 2px solid var(--primary-color);
    color: var(--primary-color); 
    border-radius: 8px;
    z-index: 20000;
    align-items: center; 
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
   
  /* === 2. 懸浮漢堡按鈕 === */
  #toggleSidebarBtn {
    position: absolute; 
    top: 10px; 
    left: 360px; 
    width: 40px; 
    height: 40px;
    background: #fff; 
    color: var(--text-dark); 
    border: 2px solid rgba(0,0,0,0.1); 
    border-radius: 8px;
    cursor: pointer; 
    z-index: 2000; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
    transition: left 0.3s ease; 
  }
  #toggleSidebarBtn:hover { 
    background: #f4f4f4; 
  }
  body.collapsed #toggleSidebarBtn { 
    left: 10px; 
  }

  /* === 3. 側邊欄樣式 === */
  #sidebar {
    width: var(--sidebar-width); 
    min-width: var(--sidebar-width); 
    background: #fff; 
    border-right: 1px solid #eee;
    display: flex; 
    flex-direction: column; 
    z-index: 1500; 
    box-shadow: 2px 0 10px rgba(0,0,0,0.05);
    margin-left: 0; 
    transition: margin-left 0.3s ease; 
    position: relative;
  }
  body.collapsed #sidebar { 
    margin-left: calc(var(--sidebar-width) * -1); 
  }

  .sidebar-header { 
    padding: 15px; 
    background: var(--primary-color); 
    color: white; 
    text-align: center; 
    flex-shrink: 0; 
  }
  .sidebar-header h3 { 
    margin: 0; 
    font-size: 16px; 
    font-weight: bold; 
    line-height: 1.4; 
  }
  
  .tabs-nav { 
    display: flex; 
    background: #eef2f6; 
    padding: 5px 5px 0 5px; 
    flex-shrink: 0; 
    overflow-x: auto; 
  }
  .tab-btn { 
    flex: 1; 
    padding: 10px 5px; 
    border: none; 
    background: transparent; 
    cursor: pointer; 
    font-size: 13px; 
    font-weight: bold; 
    color: #666; 
    border-radius: 8px 8px 0 0; 
    transition: all 0.2s; 
    white-space: nowrap; 
  }
  .tab-btn.active { 
    background: #fff; 
    color: var(--primary-color); 
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05); 
    position: relative; 
    top: 1px; 
  }
  
  .tab-content-container { 
    flex: 1; 
    overflow-y: auto; 
    padding: 15px; 
    background: #fff; 
    position: relative; 
  }
  .tab-pane { 
    display: none; 
    animation: fadeIn 0.3s; 
  }
  .tab-pane.active { 
    display: block; 
  }
  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(5px); } 
    to { opacity: 1; transform: translateY(0); } 
  }

  .sidebar-footer {
    flex-shrink: 0; 
    padding: 10px 15px; 
    padding-bottom: calc(10px + env(safe-area-inset-bottom));
    background: #f8fafc; 
    border-top: 1px solid #e2e8f0; 
    font-size: 11px;
    color: #64748b; 
    line-height: 1.6; 
    text-align: center; 
    white-space: normal; 
  }

  .card-section { 
    background: #fff; 
    border-radius: 12px; 
    padding: 12px; 
    margin-bottom: 15px; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
    border: 1px solid #f0f0f0; 
  }
  .card-title { 
    font-size: 14px; 
    font-weight: bold; 
    color: var(--primary-color); 
    margin-bottom: 10px; 
    padding-bottom: 6px; 
    border-bottom: 2px solid #f0f0f0; 
  }
  
  .search-card {
    background: #fff; 
    border-radius: 16px; 
    padding: 15px; 
    margin-bottom: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
    border: 1px solid #eef2f6;
  }
  .search-card .card-title { 
    border-bottom: none; 
    margin-bottom: 15px; 
    color: var(--primary-color); 
    font-size: 15px; 
    display: flex; 
    align-items: center; 
    gap: 8px; 
  }
  
  .search-block-label { 
    font-size: 14px; 
    color: #333; 
    font-weight: bold; 
    margin-bottom: 8px; 
    display: flex; 
    align-items: center; 
    gap: 6px; 
  }
  .search-block-label i { 
    color: #555; 
    width: 16px; 
    text-align: center; 
  }

  .search-card select, 
  .search-card input[type="text"], 
  #statsVillageSelect,
  textarea#coordsInput, 
  textarea#dengueCoordsInput, 
  input#dupCheckInput {
    width: 100%; 
    padding: 10px 12px; 
    border: 1px solid #cbd5e1; 
    border-radius: 8px;
    background-color: #fff; 
    font-size: 14px; 
    color: #333; 
    outline: none; 
    box-sizing: border-box;
    transition: all 0.2s; 
    font-family: inherit;
  }
  .search-card select, 
  #statsVillageSelect {
    appearance: none; 
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23333%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
    background-repeat: no-repeat; 
    background-position: right 12px top 50%; 
    background-size: 10px auto;
  }
  .search-card input[type="text"], 
  textarea#coordsInput, 
  textarea#dengueCoordsInput, 
  input#dupCheckInput { 
    background-image: none; 
  }
  .search-card select:focus, 
  .search-card input:focus, 
  #statsVillageSelect:focus, 
  textarea#coordsInput:focus, 
  textarea#dengueCoordsInput:focus, 
  input#dupCheckInput:focus { 
    border-color: var(--primary-color); 
    box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.1); 
  }
  textarea#coordsInput, 
  textarea#dengueCoordsInput { 
    resize: vertical; 
    min-height: 80px; 
  }
  
  .search-divider { 
    text-align: center; 
    font-size: 12px; 
    color: #aaa; 
    margin: 12px 0; 
    position: relative; 
  }
  .search-divider::before, 
  .search-divider::after { 
    content: ""; 
    position: absolute; 
    top: 50%; 
    width: 40%; 
    height: 1px; 
    background: #eee; 
  }
  .search-divider::before { left: 0; } 
  .search-divider::after { right: 0; }

  #searchBtn { 
    width: 100%; 
    background: #0056b3; 
    color: #fff; 
    border: none; 
    border-radius: 8px; 
    padding: 12px; 
    font-size: 16px; 
    font-weight: bold; 
    margin-top: 15px; 
    box-shadow: 0 4px 6px rgba(0,64,128,0.2); 
    cursor: pointer; 
    transition: background 0.2s; 
  }
  #searchBtn:hover { 
    background: #004494; 
  }
  
  .year-group { 
    margin-bottom: 8px; 
    border: 1px solid #eee; 
    border-radius: 6px; 
    overflow: hidden; 
  }
  .year-header { 
    background: #f8fafc; 
    padding: 10px; 
    cursor: pointer; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    font-weight: bold; 
    font-size: 13px; 
    color: #475569; 
    user-select: none; 
  }
  .year-header:hover { 
    background: #e2e8f0; 
  }
  .year-content { 
    display: none; 
    padding: 8px 12px; 
    background: #fff; 
    border-top: 1px solid #eee; 
  }
  .year-group.open .year-content { 
    display: block; 
  }
  .year-group.open .toggle-icon { 
    transform: rotate(90deg); 
  }
  .toggle-icon { 
    display: inline-block; 
    transition: transform 0.2s; 
    width: 12px; 
    margin-right: 5px;
  }
  .year-select-all { 
    font-size: 12px; 
    color: var(--primary-color); 
    cursor: pointer; 
  }
  .checkbox-item { 
    margin-bottom: 6px; 
    display: flex; 
    align-items: center; 
    gap: 6px; 
    font-size: 13px; 
  }
  .checkbox-item input { 
    margin: 0; 
    accent-color: var(--primary-color); 
  }

  .multiselect-group { 
    border: 1px solid #cbd5e1; 
    border-radius: 8px; 
    margin-bottom: 10px; 
    background: #fff; 
  }
  .multiselect-header { 
    padding: 10px 12px; 
    cursor: pointer; 
    background: #fff; 
    color: #555; 
    font-size: 14px; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    border-radius: 8px; 
    transition: background 0.2s; 
  }
  .multiselect-header:hover { 
    background: #f5f5f5; 
  }
  .multiselect-header i { 
    transition: transform 0.2s; 
    font-size: 12px; 
    color: #999; 
  }
  .multiselect-group.open .multiselect-header { 
    background: #f0f7ff; 
    border-radius: 8px 8px 0 0; 
    color: var(--primary-color); 
    font-weight: bold; 
    border-bottom: 1px solid #e0e0e0; 
  }
  .multiselect-group.open .multiselect-header i { 
    transform: rotate(180deg); 
    color: var(--primary-color); 
  }
  .multiselect-content { 
    display: none; 
    padding: 10px; 
    max-height: 250px; 
    overflow-y: auto; 
    background: #fafafa; 
    border-radius: 0 0 8px 8px; 
  }
  .multiselect-group.open .multiselect-content { 
    display: block; 
  }
  .select-all-row { 
    border-bottom: 1px dashed #ddd; 
    padding-bottom: 5px; 
    margin-bottom: 5px; 
    font-weight: bold; 
    color: #004080; 
  }
/* === 新增：公告區 CSS === */
  .news-card { 
    background: #fff; 
    border-left: 4px solid var(--accent-color); 
    padding: 12px; 
    margin-bottom: 10px; 
    border-radius: 6px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
  }
  .news-date { 
    font-size: 11px; 
    color: #888; 
    margin-bottom: 4px; 
  }
  .news-title { 
    font-size: 14px; 
    font-weight: bold; 
    color: var(--primary-color); 
    margin-bottom: 6px; 
  }
  .news-content { 
    font-size: 13px; 
    color: #444; 
    line-height: 1.5; 
    margin-bottom: 8px; 
  }
  .news-attach-btn { 
    display: inline-block; 
    background: #eef2f6; 
    color: #0056b3; 
    padding: 4px 8px; 
    border-radius: 4px; 
    font-size: 11px; 
    text-decoration: none; 
    font-weight: bold; 
  }
  .news-attach-btn:hover { 
    background: #d0e1f9; 
  }

  .input-with-voice { 
    position: relative; 
    width: 100%; 
    display: flex; 
    align-items: center; 
  }
  .input-with-voice input, 
  .input-with-voice textarea { 
    width: 100%; 
    padding-right: 35px; 
    box-sizing: border-box; 
  }
  .voice-btn { 
    position: absolute; 
    right: 5px; 
    top: 50%; 
    transform: translateY(-50%); 
    background: none; 
    border: none; 
    cursor: pointer; 
    color: #999; 
    font-size: 16px; 
    width: 30px; 
    height: 30px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    border-radius: 50%; 
    transition: all 0.2s; 
    z-index: 10; 
  }
  .voice-btn:hover { 
    background: #f0f0f0; 
    color: #555; 
  }
  .voice-btn.listening { 
    color: #d32f2f; 
    animation: pulse-red 1.5s infinite; 
    background: #ffebee; 
  }
  textarea + .voice-btn { 
    top: 15px; 
    transform: none; 
  } 
  @keyframes pulse-red { 
    0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 
    70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 
    100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } 
  }

  #voiceOverlay { 
    display: none; 
    position: fixed; 
    top: 0; left: 0; width: 100%; height: 100%; 
    background: rgba(0,0,0,0.6); 
    z-index: 99999; 
    justify-content: center; 
    align-items: center; 
    flex-direction: column; 
    backdrop-filter: blur(2px); 
    animation: fadeIn 0.3s; 
  }
  .voice-box { 
    background: white; 
    padding: 25px 40px; 
    border-radius: 20px; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    gap: 15px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.3); 
    transform: scale(1); 
    animation: popIn 0.3s; 
  }
  .voice-icon-large { 
    font-size: 40px; 
    color: #d32f2f; 
    animation: pulse-red 1.5s infinite; 
  }
  .voice-text { 
    font-size: 16px; 
    font-weight: bold; 
    color: #333; 
  }

  button.primary { 
    width: 100%; 
    padding: 10px; 
    margin-top: 8px; 
    cursor: pointer; 
    border-radius: 6px; 
    border: none; 
    background: var(--primary-color); 
    color: #fff; 
    font-size: 14px; 
    font-weight: bold; 
  }
  button.primary:hover { background: #003366; }
  button.secondary { 
    width: 100%; 
    padding: 8px; 
    margin-top: 8px; 
    cursor: pointer; 
    border-radius: 6px; 
    border: 1px solid #ddd; 
    background: #fff; 
    color: #555; 
    font-size: 13px; 
  }
  button.secondary:hover { background: #f5f5f5; }
  button:disabled { background: #ccc !important; cursor: not-allowed; color: #666 !important; }

  .dengue-option { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 8px; 
    cursor: pointer; 
    font-weight: bold; 
    color: #555; 
  }
  .dengue-option input { 
    width: auto; 
    margin: 0; 
    transform: scale(1.2); 
  }
  .gray-dot-marker { 
    width: 14px; 
    height: 14px; 
    background: #7f8c8d; 
    border: 2px solid #fff; 
    border-radius: 50%; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.4); 
  }

  /* === 4. 地圖區 === */
  #map { 
    flex: 1; 
    position: relative; 
    z-index: 1; 
    transition: width 0.3s ease; 
  }
  body.measuring, 
  body.measuring #map { 
    cursor: crosshair !important; 
  }

  .map-floating-controls { 
    position: absolute; 
    top: 20px; 
    right: 20px; 
    z-index: 1000; 
    display: flex; 
    flex-direction: column; 
    gap: 10px; 
  }
  .float-btn { 
    width: 40px; 
    height: 40px; 
    border-radius: 50%; 
    background: #fff; 
    border: none; 
    color: #444; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    font-size: 16px; 
    position: relative; 
  }
  .float-btn:hover { 
    background: #f0f0f0; 
    color: var(--primary-color); 
    transform: scale(1.1); 
  }
  .float-btn.active { 
    background: var(--accent-color); 
    color: #000; 
  }
  .float-btn::after { 
    content: attr(data-title); 
    position: absolute; 
    right: 50px; 
    top: 50%; 
    transform: translateY(-50%); 
    background: rgba(0,0,0,0.7); 
    color: #fff; 
    padding: 4px 8px; 
    border-radius: 4px; 
    font-size: 12px; 
    white-space: nowrap; 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.2s; 
  }
  .float-btn:hover::after { opacity: 1; }

  .leaflet-control-locate { 
    border: none !important; 
    box-shadow: none !important; 
    margin: 0 !important; 
    background: transparent !important; 
  }
  .leaflet-control-locate a { 
    width: 40px !important; 
    height: 40px !important; 
    border-radius: 50% !important; 
    background: #fff !important; 
    color: #444 !important; 
    font-size: 16px !important; 
    line-height: 40px !important; 
    display: flex !important; 
    align-items: center !important; 
    justify-content: center !important; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.2) !important; 
    cursor: pointer !important; 
  }
  .leaflet-control-locate a:hover { 
    background: #f0f0f0 !important; 
    color: #004080 !important; 
    transform: scale(1.1); 
  }
  .leaflet-control-locate.active a { 
    color: #2074b6 !important; 
    background: #fff !important; 
  }
  .leaflet-control-locate.following a { 
    color: #e65100 !important; 
    border: 2px solid #e65100 !important; 
  }
  .leaflet-control-locate a .leaflet-control-locate-location-arrow { display: none; }

  #clusterControlPanel { 
    position: absolute; 
    bottom: 220px; 
    left: 360px; 
    z-index: 1000; 
    background: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(5px); 
    padding: 15px; 
    border-radius: 12px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.2); 
    width: 220px; 
    border: 1px solid rgba(255,255,255,0.2); 
    display: none; 
    transition: left 0.3s ease; 
  }
  body.collapsed #clusterControlPanel { left: 20px; } 
  .cluster-header { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 10px; 
  }
  .cluster-title { 
    font-size: 14px; 
    font-weight: bold; 
    color: var(--primary-color); 
    display: flex; 
    align-items: center; 
    gap: 6px; 
  }
  .cluster-value-badge { 
    background: var(--accent-color); 
    color: #fff; 
    padding: 2px 6px; 
    border-radius: 4px; 
    font-size: 12px; 
  }
  input[type=range].custom-range { 
    -webkit-appearance: none; 
    width: 100%; 
    background: transparent; 
  }
  input[type=range].custom-range::-webkit-slider-thumb { 
    -webkit-appearance: none; 
    height: 16px; 
    width: 16px; 
    border-radius: 50%; 
    background: var(--primary-color); 
    cursor: pointer; 
    margin-top: -6px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.3); 
  }
  input[type=range].custom-range::-webkit-slider-runnable-track { 
    width: 100%; 
    height: 4px; 
    cursor: pointer; 
    background: #ddd; 
    border-radius: 2px; 
  }

  /* === 6. 底部時間軸面板 === */
  #bottomPanel { 
    position: absolute; 
    bottom: 0; 
    left: var(--sidebar-width); 
    right: 0; 
    height: 280px; 
    background: rgba(255, 255, 255, 0.98); 
    box-shadow: 0 -4px 16px rgba(0,0,0,0.1); 
    z-index: 1400; 
    display: flex; 
    flex-direction: column; 
    transform: translateY(100%); 
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), height 0.3s ease; 
    border-top: 1px solid #e0e0e0; 
    overflow: hidden; 
  }
  body.collapsed #bottomPanel { left: 0; } 
  #bottomPanel.open { transform: translateY(0); }
  #bottomPanel.minimized { height: auto !important; transform: translateY(0) !important; }
  #bottomPanel.minimized #timelineFilterBar, 
  #bottomPanel.minimized #timelineContainer { display: none !important; }

  #bottomPanelHeader { 
    padding: 8px 20px; 
    min-height: 50px; 
    height: auto; 
    background: var(--primary-color); 
    color: white; 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    flex-shrink: 0; 
  }
  .header-left { display: flex; flex-direction: column; gap: 2px; justify-content: center; overflow: hidden; }
  #panelTitle { font-size: 15px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #timelineStats { font-size: 13px; color: #ffeb3b; font-weight: normal; opacity: 1; white-space: normal; line-height: 1.5; margin-top: 2px; }
  @media (max-width: 768px) { #timelineStats { display: flex; flex-direction: column; align-items: flex-start; line-height: 1.6; } .stat-divider { display: none; } }
  .header-right { display: flex; gap: 15px; align-items: center; flex-shrink: 0;}
  .control-btn { background: none; border: none; color: #fff; font-size: 16px; cursor: pointer; padding: 5px; transition: color 0.2s; }
  .control-btn:hover { color: #ffeb3b; }

  #timelineFilterBar { 
    background: #f1f5f9; padding: 8px 10px; border-bottom: 1px solid #e0e0e0; 
    display: flex; gap: 6px; align-items: center; flex-shrink: 0; 
    height: auto; min-height: 50px; box-sizing: border-box; 
    flex-wrap: nowrap; overflow-x: auto; 
  }
  #timelineFilterBar::-webkit-scrollbar { height: 0px; background: transparent; }
  .filter-label { font-size: 12px; color: #333; font-weight: bold; white-space: nowrap; display: flex; align-items: center; gap: 4px; margin-right: 2px; flex-shrink: 0; }
  .timeline-select-pill { 
    padding: 4px 8px; border: 1px solid #cbd5e1; border-radius: 20px; 
    background-color: #fff; font-size: 12px; font-weight: bold; color: #334155; 
    cursor: pointer; outline: none; transition: all 0.2s; min-width: auto; 
    max-width: 180px; flex-shrink: 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
    background-image: linear-gradient(to bottom, #fff, #f8fafc); 
  }
  .timeline-select-pill:hover { border-color: var(--primary-color); color: var(--primary-color); }
  
  #timelineContainer { flex: 1; overflow-x: auto; padding: 15px 20px; display: flex; align-items: flex-start; gap: 0; }
  .h-item { width: 160px; text-align: center; cursor: pointer; position: relative; transition: transform 0.2s; }
  .h-item:hover { transform: translateY(-5px); }
  .h-date { font-size: 13px; font-weight: bold; color: #333; margin-bottom: 8px; }
  .h-line-container { position: relative; height: 24px; display: flex; align-items: center; justify-content: center; }
  .h-line-container::before { content: ''; position: absolute; left: 0; right: 0; top: 50%; height: 3px; background: #ddd; z-index: 0; }
  .h-item.alert-right .h-line-container::after { content: ''; position: absolute; left: 50%; right: -50%; top: 50%; height: 4px; background: repeating-linear-gradient(45deg, #d32f2f, #d32f2f 5px, #ffcdd2 5px, #ffcdd2 10px); z-index: 0; animation: alertPulse 1.5s infinite; }
  .h-dot { background: var(--primary-color); border: 2px solid #fff; border-radius: 50%; z-index: 1; position: relative; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
  .h-item:hover .h-dot { transform: scale(1.3); background: var(--accent-color); border-color: #fff; }
  .dot-sm { width: 12px; height: 12px; }
  .dot-md { width: 16px; height: 16px; }
  .dot-lg { width: 22px; height: 22px; box-shadow: 0 0 0 3px rgba(0, 64, 128, 0.3); }
  .h-badge { margin-top: 8px; display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.2); white-space: nowrap; position: relative; z-index: 2; }
  .badge-normal { background-color: var(--primary-color); border: 1px solid #fff; }
  .badge-urgent { background-color: #d32f2f; border: 1px solid #fff; }

  /* === 7. 右鍵選單 === */
  #contextMenu { display: none; position: fixed; z-index: 5000; background: #fff; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); overflow: hidden; min-width: 160px; border: 1px solid #ddd; top: 0; left: 0; }
  .ctx-item { padding: 10px 15px; cursor: pointer; font-size: 14px; color: #333; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f0f0f0; }
  .ctx-item:hover { background: #f5faff; color: var(--primary-color); }
  .ctx-item i { width: 20px; text-align: center; }

  /* === 新版泡泡窗 CSS === */
  .custom-popup .leaflet-popup-content-wrapper { padding: 0 !important; border-radius: 12px !important; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important; border: 2px solid var(--popup-border) !important; background: rgba(250, 253, 255, 0.98) !important; backdrop-filter: blur(5px); }
  .custom-popup .leaflet-popup-content { margin: 0 !important; width: 600px !important; max-width: 90vw !important; }
  .custom-popup .leaflet-popup-tip { background: var(--popup-border) !important; }

  .popup-card { display: flex; flex-direction: column; width: 100%; box-sizing: border-box; }
  .popup-header { display: flex; flex-direction: column; padding: 12px 15px; border-bottom: 1px dashed #e0e0e0; background: #fff; }
  
  .case-id-row { margin-bottom: 8px; background: #10b981; color: white; padding: 10px; border-radius: 8px; display: inline-block; width: 100%; box-sizing: border-box; }
  .case-id { font-size: 20px; font-weight: 900; color: white; letter-spacing: -0.5px; line-height: 1.3; }

  .case-pagination { display: flex; gap: 8px; justify-content: flex-start; margin-top: 5px; margin-bottom: 5px; flex-wrap: wrap; }
  .page-dot { width: 24px; height: 24px; border-radius: 50%; background: #fff; border: 1px solid var(--purple-theme); color: var(--purple-theme); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
  .page-dot:hover { background: #f3e5f5; }
  .page-dot.active { background: var(--purple-theme); color: #fff; border-color: var(--purple-theme); transform: scale(1.1); box-shadow: 0 2px 5px rgba(111, 66, 193, 0.3); }

  .popup-tags-row { display: flex; flex-wrap: wrap; gap: 6px; align-items: center; }
  .info-pill { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 4px; white-space: nowrap; }
  .pill-status { background: #64748b; }
  .pill-working { background: #10b981; }
  .pill-urgent { background: #f59e0b; }
  
  .pill-rating { background: #fff; border:1px solid #f39c12; color: #333; cursor: pointer; transition: transform 0.2s; font-size:12px; font-weight:normal; }
  .pill-rating:hover { transform: scale(1.05); background:#fffdeb; }
  .pill-rating .fa-star { color: #f39c12; margin-right: 2px; }
  .pill-rating .rating-score { color: #e65100; font-weight: 900; font-size: 13px; margin-right:2px; }
  .pill-rating .rating-count { color: #7f8c8d; font-size: 11px; }

  .pill-timing { background: #3498db; }
  .pill-type { background: #9b59b6; cursor: pointer; }
  .pill-dist { background: #27ae60; }
  .pill-source { background: #17a2b8; }

  .progress-container { display: flex; justify-content: space-between; position: relative; margin: 15px 20px 5px 20px; padding: 0; }
  .progress-container::before { content: ''; position: absolute; top: 12px; left: 15px; right: 15px; height: 3px; background: #e2e8f0; z-index: 0; }
  .progress-step { position: relative; z-index: 1; text-align: center; display: flex; flex-direction: column; align-items: center; width: 33%; }
  .step-circle { width: 24px; height: 24px; background: #e2e8f0; border: 2px solid #cbd5e1; border-radius: 50%; transition: all 0.3s; box-sizing: border-box; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px; font-weight: bold; }
  .progress-step.active .step-circle { border-color: #f1c40f; background: #f1c40f; box-shadow: 0 0 0 3px rgba(241, 196, 15, 0.3); }
  .progress-step.active .step-circle::after { content: '✓'; color: #fff; }
  .step-date { font-size: 10px; color: #94a3b8; margin-top: 4px; white-space: nowrap; font-family: monospace; }
  .step-label { font-size: 11px; font-weight: bold; color: #94a3b8; margin-bottom: 2px; }
  .progress-step.active .step-label { color: var(--popup-text-main); }
  .progress-step.active .step-date { color: #333; font-weight: bold; }

  .icon-btn-row { display: flex; gap: 10px; padding: 10px 15px; background: #fff; justify-content: center; }
  .icon-only-btn { flex: 1; height: 36px; border-radius: 8px; background: #f0f9ff; border: 1px solid #bae6fd; color: #0284c7; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; transition: all 0.2s; text-decoration: none; max-width: 80px; }
  .icon-only-btn:hover { background: #0284c7; color: white; transform: translateY(-2px); border-color: #0284c7; }

  .desktop-photo-row { display: flex; gap: 5px; height: 200px; padding: 0 15px; margin-bottom: 10px; }
  .photo-half { flex: 1; position: relative; border-radius: 6px; overflow: hidden; border: 1px solid #e2e8f0; background: #f1f5f9; }
  .photo-half img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; cursor: default; pointer-events: auto; user-select: none; -webkit-user-drag: none; }
  .photo-half img:hover { transform: scale(1.05); }
  .photo-label { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 3px; text-align: center; font-weight: bold; }
  
  .mobile-photo-tabs { display: none; padding: 0 15px; gap: 5px; margin-bottom: 5px; }
  .m-photo-tab { flex: 1; padding: 6px; text-align: center; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
  .m-photo-tab.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }
  .mobile-photo-area { display: none; height: 220px; padding: 0 15px; margin-bottom: 10px; }
  .mobile-photo-view { width: 100%; height: 100%; border-radius: 6px; overflow: hidden; border: 1px solid #e2e8f0; position: relative; display: none; }
  .mobile-photo-view.active { display: block; }
  .mobile-photo-view img { width: 100%; height: 100%; object-fit: cover; pointer-events: auto; user-select: none; -webkit-user-drag: none; }

  .details-toggle { padding: 8px; text-align: center; font-size: 11px; font-weight: bold; color: #666; cursor: pointer; border-top: 1px solid #eee; background: #fafafa; transition: all 0.2s; }
  .details-toggle:hover { background: #f0f0f0; color: var(--primary-color); }
  .details-content { display: none; padding: 15px; background: #fff; border-top: 1px dashed #eee; font-size: 12px; line-height: 1.6; color: #333; }
  .details-content.open { display: block; animation: slideDown 0.3s; }
  .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 15px; }
  .grid-item { border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; display: flex; flex-direction: column; }
  .grid-item-full { grid-column: 1 / -1; }
  .grid-label { color: #888; font-weight: bold; font-size: 11px; margin-bottom: 2px; }
  .grid-val { color: #333; font-weight: bold; font-size: 13px; word-break: break-all; }
  .desc-box { background: #f9f9f9; padding: 8px; border-radius: 4px; border: 1px solid #eee; margin-top: 2px; }

  /* 側邊欄 UX 大改版 (手機版) */
  @media (max-width: 768px) {
      .custom-popup .leaflet-popup-content { width: 320px !important; }
      .desktop-photo-row { display: none; }
      .mobile-photo-tabs { display: flex; }
      .mobile-photo-area { display: block; }
      .popup-card { gap: 5px; }
      .icon-btn-row { order: 3; padding: 5px 15px; }
      .progress-container { order: 2; margin-bottom: 5px; }
      .popup-header { order: 1; }
      .mobile-photo-tabs { order: 4; }
      .mobile-photo-area { order: 5; }
      .details-toggle { order: 6; }
      .details-content { order: 7; }
      .details-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
      
      #sidebar { 
          position: fixed; top: 0; left: 0; width: 85%; max-width: 320px; height: 100%; border-right: 1px solid #ddd; 
          border-radius: 0 16px 16px 0; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 3000; margin-left: 0; 
      }
      body.sidebar-open #sidebar { transform: translateX(0); }
      #toggleSidebarBtn { left: 10px; top: 10px; z-index: 3100; }
      #overlay-mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2900; }
      body.sidebar-open #overlay-mask { display: block; }
      .map-floating-controls { top: 60px; right: 10px; }
      #clusterControlPanel { bottom: 200px; left: 15px; right: 15px; width: auto; }
      #bottomPanel { left: 0; height: 300px; z-index: 2800; }
  }
  
  #commentModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; }
  .comment-box { background: #fff; width: 90%; max-width: 450px; height: 80vh; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: popIn 0.3s; display: flex; flex-direction: column; }
  .comment-header { padding: 15px; background: var(--primary-color); color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; flex-shrink: 0; }
  .comment-body { padding: 15px; overflow-y: auto; flex: 1; background: #eef2f6; display: flex; flex-direction: column; gap: 10px; }
  
  .comment-policy-notice { font-size: 11px; color: #666; background: #fff3cd; border-bottom: 1px solid #ffeeba; padding: 8px 15px; line-height: 1.4; text-align: center; flex-shrink: 0; }
  .comment-hidden-text { color: #999; font-style: italic; font-size: 12px; }

  .chat-bubble { display: flex; gap: 10px; align-items: flex-start; animation: fadeIn 0.2s; }
  .chat-bubble.official { flex-direction: row-reverse; } 
  .chat-avatar { width: 36px; height: 36px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; font-size: 14px; flex-shrink: 0; border: 2px solid #fff; }
  .chat-bubble.official .chat-avatar { background: #004080; color: #fff; border-color: #004080; } 
  .chat-content { max-width: 80%; display: flex; flex-direction: column; }
  .chat-bubble.official .chat-content { align-items: flex-end; } 
  .chat-meta { font-size: 11px; color: #666; margin-bottom: 2px; display: flex; align-items: center; gap: 5px; }
  .chat-box { background: #fff; padding: 8px 12px; border-radius: 0 12px 12px 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 13px; line-height: 1.4; color: #333; position: relative; }
  .chat-bubble.official .chat-box { background: #fff3cd; border: 1px solid #ffeeba; border-radius: 12px 0 12px 12px; }
  .chat-star { color: #f39c12; font-size: 11px; margin-top: 4px; display: block; }
  .chat-time { font-size: 10px; color: #999; margin-top: 4px; text-align: right; }
  
  .chat-input-area { background: #fff; padding: 10px; border-top: 1px solid #ddd; flex-shrink: 0; display: flex; flex-direction: column; gap: 10px; }
  .chat-nickname-row { display: flex; gap: 8px; align-items: center; justify-content: space-between; }
  .input-group-inner { position: relative; flex: 1; display: flex; align-items: center; }
  .input-group-inner input { width: 100%; padding: 8px 12px; padding-right: 38px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; background: #f9f9f9; outline: none; }
  .input-group-inner input:focus { border-color: var(--primary-color); background: #fff; }
  .input-group-inner .voice-btn { position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 30px; height: 30px; margin: 0; }
  .chat-star-select { color: #ccc; cursor: pointer; font-size: 18px; margin-left: 5px; white-space: nowrap; }
  .chat-star-select i.active { color: #f39c12; }
  .chat-msg-row { display: flex; gap: 8px; align-items: center; }
  .chat-send-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-color); color: #fff; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; flex-shrink: 0; }
  .chat-send-btn:active { transform: scale(0.9); }
  @keyframes slideDown { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
  @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

  .analysis-control { margin-top: 10px; padding: 10px; background: #fff3e0; border-radius: 8px; border: 1px solid #ffe0b2; }
  .slider-container { margin-top: 10px; display: flex; align-items: center; gap: 10px; }
  .slider-container input { flex: 1; cursor: pointer; }
  .slider-value { font-weight: bold; color: #d32f2f; min-width: 50px; text-align: right; }
  .toggle-switch { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: bold; color: #e65100; }
  .toggle-switch input { width: auto; margin: 0; }
  .measure-label { background: rgba(255,255,255,0.9); border: 1px solid #333; padding: 2px 6px; border-radius: 4px; font-weight: bold; font-size: 12px; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
  .measure-close-btn { color: red; cursor: pointer; font-weight: bold; padding: 0 4px; }
  
  .stats-columns { display: flex; gap: 8px; margin-top: 5px; }
  .stats-col { flex: 1; padding: 8px; border-radius: 6px; overflow: hidden; }
  .col-general { background: #e3f2fd; border: 1px solid #bbdefb; } 
  .col-emergency { background: #ffebee; border: 1px solid #ffcdd2; } 
  .stats-header { font-size: 14px; font-weight: bold; text-align: center; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid rgba(0,0,0,0.1); }
  .col-general .stats-header { color: #004080; }
  .col-emergency .stats-header { color: #d32f2f; }
  .stat-year-row { margin-bottom: 8px; border-bottom: 1px dashed rgba(0,0,0,0.1); padding-bottom: 6px; }
  .stat-year-row:last-child { border-bottom: none; }
  .stat-year-title { font-size: 13px; font-weight: bold; color: #444; display: flex; justify-content: space-between; align-items: center; }
  .stat-percent-text { font-size: 11px; color: #777; background: rgba(255,255,255,0.6); padding: 1px 4px; border-radius: 3px; }
  .stat-data-row { font-size: 13px; margin-top: 3px; color: #222; font-weight: bold; }
  .stat-bar-bg { background: rgba(0,0,0,0.1); height: 5px; border-radius: 3px; width: 100%; margin-top: 5px; overflow: hidden; }
  .stat-bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
  .col-general .stat-bar-fill { background-color: var(--primary-color); }
  .col-emergency .stat-bar-fill { background-color: #d32f2f; }
  
  /* === 案件通報三步驟介面 (手機版溢出修正) === */
  #reportOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; height: 100dvh; background: rgba(0,0,0,0.6); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .report-wizard-card { background: #fff; width: 100%; max-width: 500px; height: 95vh; height: 95dvh; max-height: 800px; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
  @media (max-width: 768px) { 
      .report-wizard-card { height: 100%; height: 100dvh; max-height: 100dvh; border-radius: 0; } 
      .wizard-body { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
      .wizard-step { padding-bottom: 10px; }
  }

  .report-header { background: var(--primary-color); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
  .history-link-btn { color: #fff; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 13px; text-decoration: none; display: flex; align-items: center; gap: 6px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
  .history-link-btn:hover { background: rgba(255,255,255,0.4); }

  .wizard-tabs { display: flex; background: #eef2f6; position: relative; flex-shrink: 0; }
  .wizard-tab { flex: 1; text-align: center; font-weight: bold; color: #999; padding: 12px 0; font-size: 14px; position: relative; transition: 0.3s; }
  .wizard-tab.active { color: var(--primary-color); }
  .wizard-progress { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #ddd; }
  .wizard-progress-bar { height: 100%; background: var(--primary-color); width: 33.33%; transition: width 0.4s ease; }
  
  .wizard-body { flex: 1; overflow-y: auto; padding: 20px; background: #fdfdfd; position: relative; }
  .wizard-step { display: none; flex-direction: column; height: 100%; animation: fadeIn 0.3s; }
  .wizard-step.active { display: flex; }

  .wizard-nav-btn { background: var(--accent-color); color: #000; border: none; padding: 16px; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: auto; box-shadow: 0 4px 10px rgba(255,152,0,0.3); transition: transform 0.2s; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px;}
  .wizard-nav-btn:active { transform: scale(0.98); }
  .wizard-nav-btn.secondary { background: #e2e8f0; color: #333; box-shadow: none; margin-top: 10px; }

  /* 步驟 1：照片 */
  .photo-upload-grid { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
  .photo-box-upload { height: 180px; border: 3px dashed #cbd5e1; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f8fafc; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer; }
  .photo-box-upload:hover { background: #f1f5f9; border-color: #94a3b8; }
  .photo-box-upload.has-image { border-style: solid; border-color: var(--primary-color); padding: 0; }
  .photo-box-upload img { width: 100%; height: 100%; object-fit: cover; display: none; }
  .add-photo-icon { font-size: 40px; color: #94a3b8; margin-bottom: 10px; }
  .add-photo-text { font-size: 16px; font-weight: bold; color: #64748b; }
  .delete-photo-btn { position: absolute; top: 10px; right: 10px; background: rgba(211, 47, 47, 0.9); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; font-size: 16px; cursor: pointer; display: none; z-index: 10; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
  @keyframes bounce-border { 0%, 100% { border-color: #cbd5e1; transform: scale(1); } 50% { border-color: var(--primary-color); transform: scale(1.02); } }
  .bounce-hint { animation: bounce-border 1.5s infinite; background: #fffde7; }
/* 步驟 2：描述 */
  .report-textarea { width: 100%; height: 120px; resize: none; border: 2px solid #cbd5e1; border-radius: 12px; padding: 15px; font-size: 16px; box-sizing: border-box; font-family: inherit; transition: border-color 0.2s; }
  .report-textarea:focus { border-color: var(--primary-color); outline: none; }
  .huge-mic-wrapper { text-align: center; margin: 30px 0; }
  .huge-mic-btn { width: 100px; height: 100px; border-radius: 50%; background: #fff; border: 4px solid #cbd5e1; color: #64748b; font-size: 40px; display: flex; align-items: center; justify-content: center; margin: 0 auto; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }
  .huge-mic-btn.listening { border-color: #d32f2f; color: #d32f2f; background: #ffebee; animation: mic-pulse 1.5s infinite; }
  .recording-hint { font-size: 16px; font-weight: bold; color: #d32f2f; margin-top: 15px; opacity: 0; transition: opacity 0.2s; }
  .recording-hint.show { opacity: 1; }
  @keyframes mic-pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }

  /* 步驟 3：確認與上傳 */
  .confirm-data-box { background: #f1f5f9; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
  .confirm-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px dashed #cbd5e1; padding-bottom: 8px; }
  .confirm-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
  .confirm-label { color: #64748b; font-weight: bold; }
  .confirm-val { color: #0f172a; font-weight: bold; text-align: right; }
  
  .collision-warning { background: #fff3cd; border: 2px solid #ffeeba; border-radius: 12px; padding: 15px; margin-bottom: 15px; display: none; }
  .collision-title { color: #856404; font-weight: bold; font-size: 15px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .collision-list { max-height: 120px; overflow-y: auto; background: #fff; border-radius: 8px; border: 1px solid #ffeeba; }

  /* 隱私與其他共用 */
  .privacy-warning { color: #d32f2f; font-weight: bold; font-size: 13px; text-align: center; background: #ffebee; padding: 10px; border-radius: 8px; margin-bottom: 15px; }
  .nearby-item { padding:8px 10px; border-bottom:1px dashed #ccc; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:background 0.2s; font-size: 13px; }
  .nearby-item:last-child { border-bottom:none; }
  .nearby-item:hover { background: #f8faff; }
  .nearby-tag { font-size:11px; padding:2px 6px; border-radius:4px; color:white; white-space:nowrap; }

  #reportDetailModal .custom-popup .leaflet-popup-content-wrapper { box-shadow: 0 10px 25px rgba(0,0,0,0.5) !important; width:100%; border-radius: 12px !important; }
  #reportDetailModal .custom-popup .leaflet-popup-content { width: 100% !important; margin: 0 !important; max-width: none !important; }
  #reportDetailModal .popup-card { min-height: 400px; }
  @media (max-width: 768px) { #reportDetailModal .popup-card { flex-direction:column; } }

  .dup-check-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; cursor: pointer; transition: background-color 0.2s; }
  .dup-check-item:hover { background-color: #f0f7ff; }
  .dup-check-item:last-child { border-bottom: none; }
  .dup-check-title { font-weight: bold; color: #333; margin-bottom: 2px; }
  .dup-check-info { color: #666; display:flex; justify-content:space-between; }
  .dup-tag { font-size: 11px; padding: 1px 4px; border-radius: 3px; color: #fff; margin-left: 5px; }
  .tag-gen { background: var(--primary-color); }
  .tag-emg { background: #d32f2f; }

  .multi-select-popup .info-header { background: #004080; color: white; padding: 8px 12px; font-weight: bold; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
  .multi-select-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
  .multi-select-item:hover { background: #f0f7ff; }
  .multi-select-item:last-child { border-bottom: none; }
  .multi-select-title { font-size: 13px; font-weight: bold; color: #004080; margin-bottom: 3px; }
  .multi-select-meta { font-size: 11px; color: #666; display: flex; gap: 8px; align-items: center; }
  .badge-type { background: #e0f7fa; color: #006064; padding: 1px 5px; border-radius: 3px; font-size: 10px; border: 1px solid #b2ebf2; }

  #floatingCoords { position:absolute; pointer-events:none; background:rgba(255,255,255,0.9); border:1px solid #ccc; border-radius:4px; padding:4px 8px; font-size:11px; display:none; z-index:1300; bottom: 10px; right: 10px; }

  .ai-pulse-marker { width: 24px; height: 24px; background: rgba(155, 89, 182, 0.9); border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); animation: pulse-purple 2s infinite; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; font-weight: bold; z-index: 5000; }
  .ai-marker-med { background: rgba(230, 126, 34, 0.9); box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); animation: pulse-orange 2s infinite; }
  @keyframes pulse-purple { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(155, 89, 182, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); } }
  @keyframes pulse-orange { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(230, 126, 34, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(230, 126, 34, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(230, 126, 34, 0); } }
  
  #aiDashboard { margin-top: 10px; display: none; animation: fadeIn 0.3s; }
  .ai-dash-filters { display: flex; gap: 5px; overflow-x: auto; margin-bottom: 10px; padding-bottom: 5px; }
  .ai-filter-btn { padding: 4px 8px; border-radius: 12px; border: 1px solid #ddd; background: #fff; font-size: 11px; white-space: nowrap; cursor: pointer; color: #555; }
  .ai-filter-btn.active { background: #9b59b6; color: white; border-color: #9b59b6; }
  .ai-list-item { padding: 8px; border-bottom: 1px dashed #eee; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
  .ai-list-item:hover { background: #fdf2fe; }
  .ai-score-badge { font-weight: bold; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
  .badge-high { background: #9b59b6; }
  .badge-med { background: #e67e22; }
  .ai-report-header { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: white; padding: 12px; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 8px; border-radius: 8px 8px 0 0; }
  .ai-report-body { padding: 15px; font-size: 13px; color: #333; line-height: 1.6; }
  .ai-stat-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 5px 0; }
  .ai-stat-val { font-weight: bold; color: #8e44ad; }
  .ai-advice-box { background: #fdf2fe; border-left: 4px solid #9b59b6; padding: 10px; margin-top: 10px; font-size: 12px; color: #555; }

  /* === AI 隱私編輯器樣式 === */
  #privacyEditorModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99999; flex-direction: column; }
  .pe-header { height: 50px; background: #111; color: white; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; font-weight: bold; }
  .pe-canvas-container { flex: 1; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #222; }
  #peCanvas { max-width: 100%; max-height: 100%; touch-action: none; }
  .pe-tools { height: 70px; background: #111; display: flex; justify-content: space-around; align-items: center; }
  .pe-btn { background: none; border: none; color: #888; font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
  .pe-btn.active { color: #ff9800; }
  .pe-btn i { font-size: 20px; margin-bottom: 2px; }
  .pe-loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #ff9800; font-weight: bold; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 8px; display: none; pointer-events: none; }

  /* 歷史紀錄搜尋彈出窗 */
  #quickSearchModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 20000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
  .quick-search-box { background: #fff; width: 90%; max-width: 400px; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s; }
  .quick-search-header { background: var(--primary-color); color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
  .quick-search-body { padding: 20px; }
  .quick-search-input-group { display: flex; gap: 10px; margin-bottom: 20px; }
  .quick-search-input-group input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; outline: none; }
  .quick-search-input-group input:focus { border-color: var(--primary-color); }
  .quick-search-input-group button { background: var(--primary-color); color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; }
  .history-list-title { font-size: 13px; color: #666; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  .history-list-items { max-height: 200px; overflow-y: auto; }
  .h-list-item { padding: 10px; border-bottom: 1px dashed #eee; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; }
  .h-list-item:hover { background: #f0f7ff; color: var(--primary-color); font-weight: bold; }

  /* === 資料庫讀取 Loading 動畫 === */
  #searchLoadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 35000; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s; }
  .loading-card { background: white; padding: 30px 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; }
  .loading-spinner-large { font-size: 50px; color: #ff9800; animation: spin 1.5s linear infinite; }
  @keyframes spin { 100% { transform: rotate(360deg); } }

  /* === 新增：公告區 CSS === */
  .news-card { 
    background: #fff; 
    border-left: 4px solid var(--accent-color); 
    padding: 12px; 
    margin-bottom: 10px; 
    border-radius: 6px; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
  }
  .news-date { 
    font-size: 11px; 
    color: #888; 
    margin-bottom: 4px; 
  }
  .news-title { 
    font-size: 14px; 
    font-weight: bold; 
    color: var(--primary-color); 
    margin-bottom: 6px; 
  }
  .news-content { 
    font-size: 13px; 
    color: #444; 
    line-height: 1.5; 
    margin-bottom: 8px; 
  }
  .news-attach-btn { 
    display: inline-block; 
    background: #eef2f6; 
    color: #0056b3; 
    padding: 4px 8px; 
    border-radius: 4px; 
    font-size: 11px; 
    text-decoration: none; 
    font-weight: bold; 
  }
  .news-attach-btn:hover { 
    background: #d0e1f9; 
  }
</style>
</head>
<body>

<div id="searchLoadingOverlay">
  <div class="loading-card">
    <i class="fas fa-satellite-dish loading-spinner-large"></i>
    <div style="font-size:18px; font-weight:bold; color:var(--primary-color);">
      連線資料庫中...<br>
      <span style="font-size:14px; color:#666; font-weight:normal; margin-top:5px; display:inline-block;" id="searchLoadingText">正在為您找尋歷史通報</span>
    </div>
  </div>
</div>
<div id="aiLogicModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:25000; align-items:center; justify-content:center; backdrop-filter:blur(3px);">
  <div style="background:#fff; width:90%; max-width:450px; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.3); animation: popIn 0.3s;">
    <div style="background:#8e44ad; color:white; padding:15px; font-weight:bold; display:flex; justify-content:space-between; align-items:center;">
      <span><i class="fas fa-brain"></i> 智慧演算道路風險預測 - 評分邏輯</span>
      <button onclick="closeAiLogicModal()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div style="padding:20px; font-size:14px; line-height:1.6; color:#333; max-height:70vh; overflow-y:auto;">
      <p>系統自動分析歷史與即時通報的案件，計算該路段的潛在風險指數，滿分為 100 分：</p>
      <div style="background:#f9f9f9; padding:10px; border-radius:6px; margin:10px 0;">
        <b style="color:#8e44ad;">1. 基礎分數與頻率加權：</b><br>
        起算分數 60 分。同地點（50公尺內）每發生過一次重複通報或維修，加 10 分。
      </div>
      <div style="background:#f9f9f9; padding:10px; border-radius:6px; margin:10px 0;">
        <b style="color:#8e44ad;">2. 損壞類型加權：</b><br>
        • <b>土木結構 (x1.5倍)</b>：擋土牆、路基、崩塌。<br>
        • <b>路面老化 (x1.2倍)</b>：AC鋪面、坑洞、混凝土。<br>
        • <b>環境植被 (x1.0倍)</b>：雜草、路樹、其他。
      </div>
      <div style="background:#f9f9f9; padding:10px; border-radius:6px; margin:10px 0;">
        <b style="color:#8e44ad;">3. 風險等級判定：</b><br>
        • <span style="background:#9b59b6; color:white; padding:2px 6px; border-radius:4px; font-size:12px;">極高風險 (>90分)</span>：建議優先安排現勘與結構重建。<br>
        • <span style="background:#e67e22; color:white; padding:2px 6px; border-radius:4px; font-size:12px;">中高風險 (70~89分)</span>：建議納入後續巡檢與改善觀察名單。
      </div>
    </div>
  </div>
</div>

<div id="entryModal">
  <div class="entry-card">
    <div class="entry-header">
      <h2>臺南市山上區<br>公眾通行道路圖資系統</h2>
      <p>請選擇您的使用模式</p>
    </div>
    <div class="entry-actions">
      <button class="entry-btn lite" onclick="selectMode('lite')">
        <i class="fas fa-camera"></i>
        <span>案件通報<br><small>(輕量快速版)</small></span>
      </button>
      <button class="entry-btn full" onclick="selectMode('full')">
        <i class="fas fa-search-location"></i>
        <span>公開查詢<br><small>(地圖完整版)</small></span>
      </button>
    </div>
  </div>
</div>

<div id="voiceOverlay">
  <div class="voice-box">
    <div class="voice-icon-large"><i class="fas fa-microphone"></i></div>
    <div class="voice-text">語音輸入中，請說話...</div>
  </div>
</div>

<div id="overlay-mask"></div>
<button id="toggleSidebarBtn" title="切換選單"><i class="fas fa-bars"></i></button>
<button id="switchModeBtn" onclick="openEntryModal()" title="切換到公開查詢(完整版)"><i class="fas fa-exchange-alt"></i></button>

<div class="map-floating-controls">
  <button class="float-btn" id="toggleMapBtn" data-title="切換衛星/地圖"><i class="fas fa-layer-group"></i></button>
  <button class="float-btn" id="toggleCadastralBtn" data-title="地籍圖開關"><i class="fas fa-map"></i></button>
  <button class="float-btn" id="toggleClusterControlBtn" data-title="點位聚合設定"><i class="fas fa-circle-nodes"></i></button>
  <button class="float-btn" onclick="openQuickSearch()" data-title="歷史查詢" style="color:#0056b3;"><i class="fas fa-search"></i></button>
  <button class="float-btn" id="openReportBtn" data-title="案件通報" style="color:#d32f2f;"><i class="fas fa-camera"></i></button>
</div>

<div id="quickSearchModal">
  <div class="quick-search-box">
    <div class="quick-search-header">
      <span><i class="fas fa-search"></i> 案件查詢</span>
      <button onclick="closeQuickSearch()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="quick-search-body">
      <div class="quick-search-input-group">
        <input type="text" id="quickSearchInput" placeholder="請輸入案件編號...">
        <button onclick="doQuickSearch()"><i class="fas fa-arrow-right"></i></button>
      </div>
      <div class="history-list-title"><i class="fas fa-history"></i> 我的歷史通報紀錄</div>
      <div class="history-list-items" id="quickSearchHistoryList"></div>
    </div>
  </div>
</div>

<div id="commentModal">
  <div class="comment-box">
    <div class="comment-header">
      <span><i class="fas fa-comments"></i> 案件留言板</span>
      <button onclick="closeCommentModal()" style="background:none; border:none; color:white; font-size:18px; cursor:pointer;"><i class="fas fa-times"></i></button>
    </div>
    <div class="comment-policy-notice">
      <i class="fas fa-info-circle"></i> 本平台歡迎理性指教。若留言涉及人身攻擊、髒話、廣告或違法內容，管理單位保留隱藏該留言之權利，恕不另行通知。
    </div>
    <div class="comment-body" id="commentList"></div>
    <div class="chat-input-area">
      <input type="text" id="hp_comment" style="display:none;" tabindex="-1" autocomplete="off">
      <div class="chat-nickname-row">
        <div class="input-group-inner">
          <input type="text" id="chatNickname" maxlength="20" placeholder="您的暱稱 (最多20字)" onchange="saveNickname(this.value)">
          <button class="voice-btn" id="voiceBtnChatNick"><i class="fas fa-microphone"></i></button>
        </div>
        <div class="chat-star-select" id="chatStarSelect">
          <i class="far fa-star" onclick="setChatStar(1)" data-val="1"></i>
          <i class="far fa-star" onclick="setChatStar(2)" data-val="2"></i>
          <i class="far fa-star" onclick="setChatStar(3)" data-val="3"></i>
          <i class="far fa-star" onclick="setChatStar(4)" data-val="4"></i>
          <i class="far fa-star" onclick="setChatStar(5)" data-val="5"></i>
        </div>
        <input type="hidden" id="chatCurrentStar" value="0">
      </div>
      <div class="chat-msg-row">
        <div class="input-group-inner">
          <input type="text" id="chatMessage" maxlength="100" placeholder="輸入留言... (最多100字)">
          <button class="voice-btn" id="voiceBtnChatMsg"><i class="fas fa-microphone"></i></button>
        </div>
        <button class="chat-send-btn" onclick="submitChatComment()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>
</div>

<div id="reportOverlay"> 
  <div class="report-wizard-card">
    <div class="report-header">
      <div style="font-size:20px; font-weight:bold; white-space:nowrap;"><i class="fas fa-camera"></i> 案件通報</div>
      <div style="display:flex; align-items:center; gap:12px;">
        <div class="history-link-btn" onclick="openQuickSearch()"><i class="fas fa-history"></i> 我的通報</div>
        <button onclick="closeReport()" id="reportCloseBtn" style="background:none; border:none; color:white; font-size:22px; cursor:pointer; padding:0;"><i class="fas fa-times"></i></button>
      </div>
    </div>
    
    <div class="wizard-tabs">
      <div class="wizard-progress"><div class="wizard-progress-bar" id="wizardBar"></div></div>
      <div class="wizard-tab active" id="tabStep1">1. 現況照片</div>
      <div class="wizard-tab" id="tabStep2">2. 簡述案情</div>
      <div class="wizard-tab" id="tabStep3">3. 通報上傳</div>
    </div>

    <div class="wizard-body">
      <input type="text" id="hp_report" style="display:none;" tabindex="-1" autocomplete="off">
      
      <div class="wizard-step active" id="step1">
        <div class="privacy-warning"><i class="fas fa-exclamation-triangle"></i> 上傳前請務必遮蔽車牌或人臉隱私資訊</div>
        <div class="photo-upload-grid">
          <div class="photo-box-upload" id="photoBox1" onclick="triggerCamera(1)">
            <button class="delete-photo-btn" id="delBtn1" onclick="deletePhoto(1, event)"><i class="fas fa-trash-alt"></i></button>
            <i class="fas fa-plus add-photo-icon"></i>
            <div class="add-photo-text">點此拍照 (第一張)</div>
            <img id="imgPreview1">
            <input type="file" id="fileInput1" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this, 1)">
          </div>
          <div class="photo-box-upload" id="photoBox2" onclick="triggerCamera(2)">
            <button class="delete-photo-btn" id="delBtn2" onclick="deletePhoto(2, event)"><i class="fas fa-trash-alt"></i></button>
            <i class="fas fa-plus add-photo-icon"></i>
            <div class="add-photo-text">點此拍照 (第二張 備用)</div>
            <img id="imgPreview2">
            <input type="file" id="fileInput2" accept="image/*" capture="environment" style="display:none;" onchange="previewImage(this, 2)">
          </div>
        </div>
        <div style="font-size:12px; color:#94a3b8; text-align:center; margin-bottom: 15px;">※ 支援 AI 隱私去識別化與手動遮蔽功能</div>
        <button class="wizard-nav-btn" onclick="goToWizardStep(2)">➡ 下一步：描述案情</button>
      </div>

      <div class="wizard-step" id="step2">
        <div style="font-weight:bold; color:#333; margin-bottom:10px; font-size: 16px;">請簡述路況或損壞情形</div>
        <textarea id="reportDesc" class="report-textarea" maxlength="500" placeholder="(例如：路面坑洞)。最多500字。可以點擊下方麥克風用語音輸入！"></textarea>
        <div class="huge-mic-wrapper">
          <button class="huge-mic-btn" id="voiceBtnReportHuge"><i class="fas fa-microphone"></i></button>
          <div class="recording-hint" id="recordingHintText">🔴 正在聆聽，請說話...</div>
        </div>
        <div style="display:flex; gap:10px; margin-top: auto;">
          <button class="wizard-nav-btn secondary" onclick="goToWizardStep(1)" style="flex: 1; margin-top:0;">⬅ 上一步</button>
          <button class="wizard-nav-btn" onclick="goToWizardStep(3)" style="flex: 2; margin-top:0;">➡ 下一步：確認與上傳</button>
        </div>
      </div>

      <div class="wizard-step" id="step3">
        <div class="collision-warning" id="collisionWarningBox">
          <div class="collision-title"><i class="fas fa-exclamation-triangle"></i> 此地點附近近期有維修紀錄</div>
          <div style="font-size:13px; margin-bottom:8px; color:#555;">請確認是否為重複案件 (點擊可查看詳情)：</div>
          <div class="collision-list" id="nearbyHistoryList"></div>
        </div>
        <div class="confirm-data-box">
          <div class="confirm-row"><span class="confirm-label">案件編號</span><span class="confirm-val" id="reportCaseId" style="color:#94a3b8; font-style:italic;">(待系統取號)</span></div>
          <div class="confirm-row"><span class="confirm-label">通報時間</span><span class="confirm-val" id="reportTime"></span></div>
          <div class="confirm-row"><span class="confirm-label">TWD97座標</span><span class="confirm-val" id="reportTwd97" style="font-size:12px;">定位中...</span></div>
          <div class="confirm-row"><span class="confirm-label">WGS84座標</span><span class="confirm-val" id="reportWgs84" style="font-size:12px;">📍 正在為您精準定位中...</span></div>
        </div>
        <div style="margin-bottom: 15px; padding: 10px; background: #fffde7; border: 1px dashed #fbc02d; border-radius: 8px;">
          <label style="cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:bold; color:#f57f17; font-size: 14px;">
            <input type="checkbox" id="subscribeToggle" onchange="toggleEmailInput(this)" style="transform: scale(1.2);"> 🔔 訂閱進度通知 (推薦)
          </label>
          <div id="emailInputArea" style="display:none; margin-top:10px; animation:fadeIn 0.3s;">
            <input type="email" id="subscriberEmail" placeholder="請輸入 Email 接收案件編號與進度" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box;">
          </div>
        </div>
        <div style="display:flex; align-items:center; gap:10px; background:#f8fafc; padding:10px; border-radius:8px; margin-bottom: 15px;">
          <span id="mathQuestion" style="font-size:20px; font-weight:bold; color:#004080; background:#fff; padding:5px 12px; border-radius:6px; border:1px solid #cbd5e1;">...</span>
          <span style="font-weight:bold; color:#64748b;">=</span>
          <input type="number" id="mathAnswer" placeholder="答案" style="flex:1; padding:10px; border:1px solid #ccc; border-radius:6px; text-align:center; font-size:16px;">
        </div>
        <div style="display:flex; gap:10px; margin-top: auto;">
          <button class="wizard-nav-btn secondary" onclick="goToWizardStep(2)" style="flex: 1; margin-top:0;">⬅ 上一步</button>
          <button class="wizard-nav-btn" id="btnSubmitReport" onclick="submitReport()" style="flex: 2; margin-top:0; background: #22c55e; color:white; box-shadow: 0 4px 10px rgba(34,197,94,0.3);">🚀 確認上傳</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="sidebar">
  <div class="sidebar-header">
    <h3>臺南市山上區<br>公眾通行道路圖資及施工/維修案件透明</h3>
  </div>

  <div class="tabs-nav">
    <button class="tab-btn active" onclick="switchTab('tab-layers')"><i class="fas fa-layer-group"></i> 透明</button>
    <button class="tab-btn" onclick="switchTab('tab-search')"><i class="fas fa-search"></i> 搜尋</button>
    <button class="tab-btn" onclick="switchTab('tab-tools')"><i class="fas fa-tools"></i> 工具</button>
    <button class="tab-btn" onclick="switchTab('tab-dengue')"><i class="fas fa-shield-virus"></i> 登革熱</button>
    <button class="tab-btn" onclick="switchTab('tab-news')"><i class="fas fa-bullhorn"></i> 公告</button>
  </div>

  <div id="tab-layers" class="tab-content-container tab-pane active">
    <div class="card-section" style="border-left: 5px solid #ff9800;">
      <div class="card-title" style="color:#e65100;"><i class="fas fa-satellite-dish"></i> 民眾通報即時看板</div>
      <label class="toggle-switch">
        <input type="checkbox" id="realtimeToggle" onchange="toggleRealtimeLayer(this)"> 顯示即時通報案件
      </label>
      <div class="small" style="color:#666; margin-top:5px; display:flex; gap:10px;">
        <span><span style="color:#ff9800;">●</span> 派工中</span>
        <span><span style="color:#004080;">●</span> 已完工</span>
        <span><span style="color:#7f8c8d;">●</span> 待處理</span>
      </div>
    </div>

    <div class="card-section">
      <div class="card-title"><i class="fas fa-road"></i> 歷史施工/維修案件公告</div>
      <div class="small" style="margin-bottom:8px; color:#666;">勾選年份批次顯示位置 (<span style="color:#004080">●</span>近 / <span style="color:red">●</span>遠)</div>
      <div id="repairCheckboxes" style="max-height:400px; overflow-y:auto;"></div>
      <button class="secondary" id="clearRepairBtn"><i class="fas fa-eraser"></i> 清除所有顯示</button>
    </div>

    <div class="card-section">
      <div class="card-title"><i class="fas fa-calculator"></i> 里別維修統計</div>
      <div class="small" style="margin-bottom:5px; color:#666;">系統將自動排除同案件重複計算</div>
      <select id="statsVillageSelect" style="margin-bottom:10px;">
        <option value="">-- 請選擇里別 --</option>
      </select>
      <div id="statsResult" style="display:none;">
        <div class="stats-columns">
          <div class="stats-col col-general">
            <div class="stats-header">一般工程</div>
            <div id="statsGenList"></div>
          </div>
          <div class="stats-col col-emergency">
            <div class="stats-header">搶險搶修</div>
            <div id="statsEmgList"></div>
          </div>
        </div>
      </div>
      <button class="secondary" id="clearStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> 清除所有顯示</button>
    </div>
  </div>

  <div id="tab-search" class="tab-content-container tab-pane">
    <div class="search-card">
      <div class="card-title"><i class="fas fa-route"></i> 公眾通行道路圖資查詢</div>
      <select id="roadSelect"><option>載入中...</option></select>
    </div>

    <div class="search-card">
      <div class="card-title"><i class="fas fa-search-plus"></i> 案件進階搜尋</div>
      
      <div class="search-block-label"><i class="fas fa-map-marked-alt"></i> 依里別快篩</div>
      <select id="villageSelect">
        <option value="">-- 請選擇里別 --</option>
      </select>
      
      <div class="search-divider">- 或 -</div>
      
      <div class="search-block-label"><i class="fas fa-filter"></i> 依廠商快篩</div>
      <select id="contractorSelect"><option value="">-- 請選擇廠商 --</option></select>
      <div id="contractorStatsResult" style="display:none; margin-top:10px;">
        <div class="stats-columns">
          <div class="stats-col col-general">
            <div class="stats-header">一般工程</div>
            <div id="contractorGenList"></div>
          </div>
          <div class="stats-col col-emergency">
            <div class="stats-header">搶險搶修</div>
            <div id="contractorEmgList"></div>
          </div>
        </div>
        <button class="secondary" id="clearContractorStatsBtn" style="margin-top:10px;"><i class="fas fa-eraser"></i> 清除所有顯示</button>
      </div>
      
      <div class="search-divider">- 或 -</div>
      
      <div class="search-block-label"><i class="fas fa-clock"></i> 依派工時機快篩</div>
      <select id="timingSelect">
        <option value="">-- 請選擇派工時機 --</option>
      </select>
      
      <div class="search-divider">- 或 -</div>

      <div class="search-block-label"><i class="fas fa-tools"></i> 依維修類型快篩 (多選)</div>
      <div class="multiselect-group" id="typeFilterContainer">
        <div class="multiselect-header" onclick="toggleTypeFilter()">
          <span id="typeFilterLabel">請選擇維修類型 (未選)</span>
          <i class="fas fa-chevron-down"></i>
        </div>
        <div class="multiselect-content" id="typeFilterContent">
          <div class="checkbox-item select-all-row">
            <label><input type="checkbox" id="typeSelectAll" onchange="toggleAllTypes(this)"> 全選/取消</label>
          </div>
          <div id="typeCheckboxList"></div>
        </div>
      </div>

      <div class="search-divider">- 或 -</div>
      
      <div class="search-block-label"><i class="fas fa-history"></i> 我的歷史通報紀錄</div>
      <button id="myHistoryBtn" class="secondary" style="margin-top:0; background:#fff3e0; border-color:#ffcc80; color:#e65100; font-weight:bold; font-size:14px; padding:10px;" onclick="openQuickSearch()">
        <i class="fas fa-search"></i> 尋找我的歷史通報
      </button>
      
      <div class="search-divider">- 或 -</div>
      
      <div class="search-block-label"><i class="fas fa-keyboard"></i> 關鍵字搜尋</div>
      <div class="input-with-voice">
        <input type="text" id="keywordInput" placeholder="例如：案件編號(113001) 案件名稱 廠商名稱">
        <button class="voice-btn" id="voiceBtnKeyword"><i class="fas fa-microphone"></i></button>
      </div>
      <button id="searchBtn" style="margin-top: 10px;"><i class="fas fa-search"></i> 開始搜尋</button>
      
      <button id="clearSearchBtn" class="secondary" style="display:none; background:#ffebee; border-color:#ffcdd2; color:#d32f2f; margin-top:10px;"><i class="fas fa-times"></i> 清除結果</button>
      <div id="searchStatus" class="small" style="margin-top:8px; color:#004080; font-weight:bold;"></div>
    </div>
  </div>

  <div id="tab-tools" class="tab-content-container tab-pane">
    <div class="card-section">
      <div class="card-title"><i class="fas fa-map-marker-alt"></i> 座標查詢工具</div>
      <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
      <textarea id="coordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <button id="plotBtn" class="primary" style="margin-top:0;">顯示點位</button>
        <button id="clearBtn" class="secondary" style="margin-top:0;">清除</button>
      </div>
    </div>
    
    <div class="card-section">
      <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
      <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px; border-radius:8px; text-decoration:none;">
        <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
      </a>
    </div>
    
    <div class="card-section">
      <div class="card-title"><i class="fas fa-chart-network"></i> 空間群聚分析</div>
      <label class="toggle-switch">
        <input type="checkbox" id="clusterToggle"> 啟動熱區分析
      </label>
      <div class="analysis-control">
        <div style="font-size:12px; color:#666;">群聚閾值 (半徑)：</div>
        <div class="slider-container">
          <input type="range" id="clusterSlider" min="0" max="500" step="10" value="50">
          <span id="clusterValue" class="slider-value">50m</span>
        </div>
      </div>
    </div>

    <div class="card-section">
      <div class="card-title"><i class="fas fa-history"></i> 重複性案件檢核</div>
      <label class="toggle-switch" style="margin-bottom:10px;">
        <input type="checkbox" id="autoDupCheckToggle"> 啟動自動檢核重複性案件
      </label>
      <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)</div>
      <input type="text" id="dupCheckInput" placeholder="例如：181924,2555825">
      <div style="display:flex; gap:5px; margin-top:5px;">
        <button id="dupCheckBtn" class="primary" style="background:#e65100; margin-top:0;"><i class="fas fa-search"></i> 開始檢核</button>
        <button id="dupClearBtn" class="secondary" style="width:auto; margin-top:0; white-space:nowrap; flex-shrink:0;">清除</button>
      </div>
      <div id="dupCheckResult" style="margin-top:10px; font-size:13px; color:#333;"></div>
    </div>

    <div class="card-section" style="border-left: 5px solid #9b59b6;">
      <div class="card-title" style="color:#8e44ad;"><i class="fas fa-brain"></i> 智慧演算道路風險預測</div>
      <div class="small" style="margin-bottom:8px; color:#666;">
        透過演算法分析維修頻率、結構風險與植被影響，點擊列表可快速定位。
      </div>
      <label class="toggle-switch">
        <input type="checkbox" id="aiRiskToggle" onchange="toggleAiRiskLayer(this)"> 風險預警熱點
      </label>
      <div style="margin-top:10px; font-size:13px;">
        <a href="javascript:void(0)" onclick="openAiLogicModal()" style="color:#8e44ad; text-decoration:underline; font-weight:bold;">
          <i class="fas fa-info-circle"></i> 演算法與評分邏輯說明
        </a>
      </div>
      <div id="aiLoading" style="display:none; color:#8e44ad; font-size:12px; margin-top:5px;">
        <i class="fas fa-circle-notch fa-spin"></i> 運算中...
      </div>
      
      <div id="aiDashboard">
        <div class="ai-dash-filters">
          <div class="ai-filter-btn active" onclick="filterAiResults('all', this)">全部</div>
          <div class="ai-filter-btn" onclick="filterAiResults('high', this)">極高風險</div>
          <div class="ai-filter-btn" onclick="filterAiResults('road', this)">土木結構</div>
          <div class="ai-filter-btn" onclick="filterAiResults('tree', this)">環境植被</div>
        </div>
        <div id="aiResultList" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:6px; background:#fafafa;">
        </div>
      </div>
    </div>
  </div>
  
  <div id="tab-dengue" class="tab-content-container tab-pane">
    <div class="card-section">
      <div class="card-title"><i class="fas fa-map-pin"></i> 座標輸入</div>
      <div class="small" style="margin-bottom:5px;">輸入 TWD97 座標 (X,Y)，每行一組</div>
      <textarea id="dengueCoordsInput" rows="4" placeholder="例如：181924,2555825"></textarea>
      <div style="display:flex; gap:5px; margin-top:5px;">
        <button id="plotDengueBtn" class="primary" style="background:#7f8c8d; margin-top:0;">顯示點位</button>
        <button id="clearDengueBtn" class="secondary" style="margin-top:0;">清除</button>
      </div>
    </div>

    <div class="card-section">
      <div class="card-title"><i class="fas fa-home"></i> 門牌查詢</div>
      <a href="https://addressrs.moi.gov.tw/address/index.cfm?city_id=67000" target="_blank" class="popup-btn" style="background:#28a745; color:white; border:none; width:100%; box-sizing:border-box; text-align:center; display:block; padding:10px; border-radius:8px; text-decoration:none;">
        <i class="fas fa-map-marked-alt"></i> 臺南市門牌電子地圖查詢系統
      </a>
    </div>

    <div class="card-section">
      <div class="card-title"><i class="fas fa-circle-notch"></i> 選擇方圓半徑</div>
      <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
        <label class="dengue-option"><input type="radio" name="dengueRadius" value="50" onchange="updateDengueRadius()"> 50 公尺</label>
        <label class="dengue-option"><input type="radio" name="dengueRadius" value="150" onchange="updateDengueRadius()"> 150 公尺</label>
        <label class="dengue-option"><input type="radio" name="dengueRadius" value="200" onchange="updateDengueRadius()"> 200 公尺</label>
      </div>
    </div>
  </div>

  <div id="tab-news" class="tab-content-container tab-pane">
    <div class="card-section">
      <div class="card-title"><i class="fas fa-bullhorn"></i> 最新公告</div>
      <div id="newsContainer">
        <div class="news-card">
          <div class="news-date">2026/02/21</div>
          <div class="news-title">歡迎使用山上區道路圖資系統 (v0220_V8)</div>
          <div class="news-content">本系統提供即時通報、歷史案件查詢、與 AI 道路風險預測功能。如有操作問題，請參考相關說明。</div>
          <a href="#" class="news-attach-btn"><i class="fas fa-download"></i> 操作手冊預留點.pdf</a>
        </div>
      </div>
      <div style="font-size:11px; color:#999; margin-top:15px; text-align:center;">
        ※ 未來可於 Google Sheets 中直接新增公告，系統將自動同步顯示於此。
      </div>
    </div>
  </div>

  <div class="sidebar-footer">
    <div>本網頁圖資僅供參考，實際狀況應以權管機關現場鑑界為準。</div>
    <div style="margin-top:2px;">資料來源：Google Maps, OSM, 國土測繪中心, 臺南市山上區公所</div>
  </div>
</div>

<div id="map"></div>
<div id="floatingCoords"></div>
<div id="reportDetailModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10000; align-items:center; justify-content:center;">
  <div style="position:relative; max-width:960px; width:95%; max-height:90vh; overflow-y:auto; background:transparent; display:flex; flex-direction:column;">
    <button onclick="closeReportDetailModal()" style="align-self:flex-end; margin-bottom:10px; color:white; font-size:16px; background:rgba(0,0,0,0.5); border:1px solid #fff; border-radius:20px; padding:5px 15px; cursor:pointer;">
      <i class="fas fa-times"></i> 關閉視窗
    </button>
    <div class="custom-popup">
      <div class="leaflet-popup-content-wrapper">
        <div class="leaflet-popup-content" id="reportDetailContent"></div>
      </div>
    </div>
  </div>
</div>

<div id="contextMenu">
  <div class="ctx-item" id="ctxStreetView"><i class="fas fa-street-view"></i> Google 街景</div>
  <div class="ctx-item" id="ctxGoogleNav"><i class="fas fa-location-arrow"></i> Google 導航</div>
  <div class="ctx-item" id="ctxCadastral"><i class="fas fa-map"></i> 地籍圖/查詢</div>
  <div class="ctx-item" id="ctxMeasure"><i class="fas fa-ruler-horizontal"></i> 距離量測</div>
  <div class="ctx-item" id="ctxClearMarker" style="color:#d32f2f;"><i class="fas fa-trash-alt" style="color:#d32f2f;"></i> 移除標記</div>
</div>

<div id="clusterControlPanel">
  <div class="cluster-header">
    <div class="cluster-title"><i class="fas fa-circle-nodes"></i> 點位聚合設定</div>
    <div style="display:flex; align-items:center;">
      <span id="clusterRadiusVal" class="cluster-value-badge" style="margin-right: 5px;">範圍 50px</span>
      <button id="closeClusterControlBtn" class="control-btn" title="關閉" style="color:#000; font-size:12px; padding:0;"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <div style="font-size:12px; color:#666; margin-bottom:5px;">調整聚合敏感度 (滑竿往右 = 範圍大/聚合強)</div>
  <input type="range" id="clusterRadiusSlider" class="custom-range" min="20" max="150" step="10" value="50">
</div>

<div id="bottomPanel">
  <div id="bottomPanelHeader">
    <div class="header-left">
      <div id="panelTitle"><i class="fas fa-history"></i> 路線維修紀錄</div>
      <div id="timelineStats"></div>
    </div>
    <div class="header-right">
      <button id="togglePanelSizeBtn" class="control-btn" title="縮小/展開"><i class="fas fa-chevron-down"></i></button>
      <button id="closePanelBtn" class="control-btn" title="關閉"><i class="fas fa-times"></i></button>
    </div>
  </div>
  <div id="timelineFilterBar">
    <span class="filter-label"><i class="fas fa-filter"></i> 篩選：</span>
  </div>
  <div id="timelineContainer">
    <div style="padding:20px; color:#777;">請點選地圖上的藍色路線以檢視紀錄。</div>
  </div>
</div>

<div id="photoSourceModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:12000; align-items:center; justify-content:center;">
  <div style="background:#fff; width:280px; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.2); animation: popIn 0.2s;">
    <div style="background:var(--primary-color); color:#fff; padding:12px; text-align:center; font-weight:bold;">請選擇照片來源</div>
    <div style="display:flex; flex-direction:column;">
      <button onclick="selectSource('camera')" style="padding:15px; border:none; background:#fff; border-bottom:1px solid #eee; font-size:16px; cursor:pointer; color:#004080;">
        <i class="fas fa-camera"></i> 拍攝照片
      </button>
      <button onclick="selectSource('gallery')" style="padding:15px; border:none; background:#fff; border-bottom:1px solid #eee; font-size:16px; cursor:pointer; color:#e65100;">
        <i class="fas fa-images"></i> 從相簿挑選
      </button>
      <button onclick="closeSourceModal()" style="padding:15px; border:none; background:#f8fafc; color:#666; font-size:14px; cursor:pointer;">取消</button>
    </div>
  </div>
</div>

<div id="privacyEditorModal">
  <div class="pe-header">
    <button onclick="closePrivacyEditor()" style="background:none;border:none;color:white;font-size:16px;">取消</button>
    <span>照片隱私處理</span>
    <button onclick="savePrivacyImage()" style="background:none;border:none;color:#ff9800;font-size:16px;font-weight:bold;">完成</button>
  </div>
  <div class="pe-canvas-container">
    <canvas id="peCanvas"></canvas>
    <div id="peLoading" class="pe-loading"><i class="fas fa-spinner fa-spin"></i> AI 偵測中...</div>
  </div>
  <div class="pe-tools">
    <button class="pe-btn" onclick="triggerAutoBlur()">
      <i class="fas fa-robot"></i> AI 人臉馬賽克
    </button>
    <button class="pe-btn active" id="btnManualMode" onclick="setMode('manual')">
      <i class="fas fa-hand-pointer"></i> 手動塗抹(車牌)
    </button>
    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <span style="font-size:10px; color:#888; margin-bottom:2px;">筆觸</span>
      <input type="range" id="peBrushSize" min="10" max="80" value="35" title="調整筆觸大小" style="width:80px; accent-color:#ff9800;">
    </div>
    <button class="pe-btn" onclick="undoCanvas()">
      <i class="fas fa-undo"></i> 復原
    </button>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script>
// === 視窗控制與安全過濾 ===
function openAiLogicModal() { document.getElementById('aiLogicModal').style.display = 'flex'; }
function closeAiLogicModal() { document.getElementById('aiLogicModal').style.display = 'none'; }
function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/&/g, "&")
             .replace(/</g, "<")
             .replace(/>/g, ">")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
}
function sanitizeInput(text) {
  if (!text) return "";
  if (/^[=+\-@]/.test(text)) return "'" + text;
  return text;
}

// === 動態數學驗證 ===
let correctMathAnswer = 0;
let reportStartTime = 0;
let commentStartTime = 0;
let lastCommentSentTime = 0;

function initMathChallenge() {
  const n1 = Math.floor(Math.random() * 9) + 1;
  const n2 = Math.floor(Math.random() * 9) + 1;
  correctMathAnswer = n1 + n2;
  document.getElementById('mathQuestion').innerText = `${n1} + ${n2}`;
  document.getElementById('mathAnswer').value = '';
}

// === 模式切換 ===
function selectMode(mode) {
  if (mode === 'lite') {
    document.body.classList.add('lite-mode');
    if(lc) lc.start();
    openReportWizard();
  } else {
    document.body.classList.remove('lite-mode');
    document.getElementById('reportOverlay').style.display = 'none';
  }
  document.getElementById('entryModal').style.display = 'none';
}
function openEntryModal() {
  document.getElementById('entryModal').style.display = 'flex';
}

// === 全局變數與地圖初始化 ===
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwrS_ENVFM0kTvlHDwwTiIx3KzExZh-QhXdowFlHMYHXPajqBm1_g3tcpq1AQeUlL8i/exec";
const CASE_DATA_CACHE = {};
window.lockedPopupMarker = false;

const map = L.map('map', { 
  zoomControl: false, 
  doubleClickZoom: false 
}).setView([23.1025, 120.3538], 13);

const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
  attribution: '© OpenStreetMap' 
}).addTo(map);

const sat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { 
  attribution: '© Google Maps' 
});
let isSat = false;

const lc = L.control.locate({
  position: 'topright', 
  strings: { title: "我的位置" },
  icon: 'fas fa-crosshairs', 
  iconLoading: 'fas fa-spinner fa-spin',
  setView: 'untilPan', 
  keepCurrentZoomLevel: true, 
  flyTo: true, 
  cacheLocation: true,
  showPopup: false, 
  drawCircle: true, 
  drawMarker: true,
  locateOptions: { enableHighAccuracy: true, watch: true }
}).addTo(map);

document.querySelector('.map-floating-controls').prepend(lc.getContainer());
lc.getContainer().classList.remove('leaflet-bar', 'leaflet-control');

let wakeLock = null;
async function requestWakeLock() {
  if ('wakeLock' in navigator) {
    try { 
      wakeLock = await navigator.wakeLock.request('screen'); 
    } catch (err) {
      console.warn("Wake Lock failed", err);
    }
  }
}
map.on('locateactivate', requestWakeLock);

let REPAIR_CONFIG = [];
let roadsLayer = null;
let roadLayersArray = [];
let REPAIR_DATA_CACHE = {};
let ALL_CONTRACTORS = new Set();
let ALL_TIMINGS = new Set();
let ALL_TYPES = new Set();
let currentRouteAllMatches = [];
let villageGeoJSON = null;
let dupCheckLayer = L.layerGroup().addTo(map);
let dupMarkersMap = {};
let CURRENT_DUPLICATE_GROUPS = [];
let CURRENT_MAP_GROUPS = {};
let reportNearbyMatches = [];

let isMeasuring = false;
let measureStartLatLng = null;
let measureLine = null;
let measureTooltip = null;
let markersClusterGroup = null;
let activeRepairLayers = [];
let selectedTimelineMarker = null;
let lockedTimelineMarker = null;
let activePhotoId = 0;

const realtimeLayer = L.layerGroup().addTo(map);
const dengueLayer = L.layerGroup().addTo(map);
const dengueRadiusLayer = L.layerGroup().addTo(map);
const boundaryLayer = L.layerGroup().addTo(map).setZIndex(100);
const pointLayer = L.layerGroup().addTo(map).setZIndex(1000);
const repairLayer = L.layerGroup().addTo(map);
const routeMatchLayer = L.layerGroup().addTo(map).setZIndex(999);
const searchResultLayer = L.featureGroup().addTo(map);
const clusterLayer = L.featureGroup().addTo(map);
const measureLayer = L.layerGroup().addTo(map).setZIndex(1001);
let aiRiskLayer = L.featureGroup().addTo(map);

const cadastralLayer = L.tileLayer('https://wmts.nlsc.gov.tw/wmts/LAND_OPENDATA/default/GoogleMapsCompatible/{z}/{y}/{x}', { 
  attribution: '© 國土測繪中心', 
  opacity: 0.8, 
  maxZoom: 20 
});
let isCadastralVisible = false;

const DEEP_BLUE = '#004080';
const LIGHT_BLUE = '#0066cc';

proj4.defs("EPSG:3826","+proj=tmerc +lat_0=0 +lon_0=121 +k=0.9999 +x_0=250000 +y_0=0 +ellps=WGS84 +units=m +no_defs");
proj4.defs("EPSG:4326","+proj=longlat +datum=WGS84 +no_defs");

function twd97FromWgs84(lat,lng){
  const p = proj4('EPSG:4326','EPSG:3826',[lng,lat]);
  return { x: Math.round(p[0]), y: Math.round(p[1]) };
}

window.addEventListener('load', () => {
  setupVoiceInput('voiceBtnKeyword', 'keywordInput');
  setupVoiceInput('voiceBtnChatNick', 'chatNickname');
  setupVoiceInput('voiceBtnChatMsg', 'chatMessage');
  setupVoiceInput('voiceBtnReportHuge', 'reportDesc', 'recordingHintText');

  document.getElementById('searchStatus').innerHTML = '';

  const aiToggle = document.getElementById('aiRiskToggle');
  if (aiToggle) aiToggle.checked = false;
  aiRiskLayer.clearLayers();
  const aiDash = document.getElementById('aiDashboard');
  if (aiDash) aiDash.style.display = 'none';

  const params = new URLSearchParams(window.location.search);
  const searchId = params.get('search');
  
  if (searchId) {
    document.getElementById('entryModal').style.display = 'none';
    document.body.classList.remove('lite-mode'); 
    
    setTimeout(async () => {
      document.getElementById('keywordInput').value = searchId;
      switchTab('tab-search');
      
      const rtToggle = document.getElementById('realtimeToggle');
      if (!isRealtimeLoaded || !rtToggle.checked) {
        const loadingOverlay = document.getElementById('searchLoadingOverlay');
        if(loadingOverlay) loadingOverlay.style.display = 'flex';
        if(rtToggle) rtToggle.checked = true;
        await toggleRealtimeLayer(rtToggle);
        if(loadingOverlay) loadingOverlay.style.display = 'none';
      }
      
      document.getElementById('searchBtn').click();
    }, 1500);
  }
});

function attachPopupEvents(marker, sourceLayers) {
  marker.on('mouseover', function(e) {
    if (!window.lockedPopupMarker) {
      const dist = distToRoad(this.getLatLng(), roadsLayer);
      const content = createPopup({ 
        fileName: this.customData.configLabel, 
        props: this.customData.props, 
        lat: this.getLatLng().lat, 
        lng: this.getLatLng().lng, 
        dist: dist 
      });
      this.bindPopup(content, { className: 'custom-popup', maxWidth: 960 }).openPopup();
    }
  });
  
  marker.on('mouseout', function(e) {
    if (!window.lockedPopupMarker) {
      this.closePopup();
    }
  });
  
  marker.on('click', function(e) {
    L.DomEvent.stopPropagation(e);
    window.lockedPopupMarker = true;
    map.flyTo(this.getLatLng(), 18, { duration: 0.8 });
    handleNearbyMarkerClick(e, sourceLayers);
  });
}

function preloadImages(urls) {
  if (!urls || !Array.isArray(urls)) return;
  urls.forEach(url => {
    if (url && url.trim() !== "") { 
      const img = new Image(); 
      img.src = url.trim(); 
    }
  });
}

function getDirectDriveUrl(url) {
  if (!url) return '';
  let cleanUrl = url.trim();
  let id = '';
  let match1 = cleanUrl.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if (match1) id = match1[1];
  if (!id) {
    let match2 = cleanUrl.match(/[?&]id=([a-zA-Z0-9_-]+)/);
    if (match2) id = match2[1];
  }
  if (id) return `https://lh3.googleusercontent.com/d/${id}`;
  return cleanUrl;
}

function getPhotosFromProps(props) {
  if(!props) return [];
  const rawPhotos = [];
  if(props['施工前照片']) rawPhotos.push(props['施工前照片']);
  if(props['施工後照片']) rawPhotos.push(props['施工後照片']);
  return rawPhotos.join(';').split(/[;\n\r]+/).map(u => getDirectDriveUrl(u)).filter(u => u.length > 0);
}

function formatMoneyWan(val) {
  val = parseInt(val) || 0;
  if (val < 10000) return val.toLocaleString() + " 元";
  let w = Math.floor(val / 10000);
  let r = val % 10000;
  return `${w}萬${r === 0 ? "0000" : r.toLocaleString('en-US')}元`;
}

// === 補回遺失的金額轉換工具 ===
function formatMoney(val) { 
  if (!val) return 0; 
  return parseInt(val.toString().replace(/,/g, '')) || 0; 
}

window.switchMobilePhotoTab = function(el, type, uid) {
  const card = el.closest('.popup-card');
  card.querySelectorAll('.m-photo-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  const beforeView = document.getElementById(`m-view-before-${uid}`);
  const afterView = document.getElementById(`m-view-after-${uid}`);
  if(type === 'before') { 
    if(beforeView) beforeView.classList.add('active'); 
    if(afterView) afterView.classList.remove('active'); 
  } else { 
    if(beforeView) beforeView.classList.remove('active'); 
    if(afterView) afterView.classList.add('active'); 
  }
};

window.toggleDetails = function(el) {
  const content = el.closest('.popup-card').querySelector('.details-content');
  if(content.classList.contains('open')) { 
    content.classList.remove('open'); 
    el.innerHTML = '▼ 查看詳細資訊'; 
  } else { 
    content.classList.add('open'); 
    el.innerHTML = '▲ 收起詳細資訊'; 
  }
};

window.expandTypePill = function(uid, fullText) {
  const pill = document.getElementById(`type-pill-${uid}`);
  if(pill) { 
    pill.innerHTML = `<i class="fas fa-wrench"></i> ${fullText}`; 
    pill.title = fullText; 
  }
}

function generateStoreId(props) {
  if (props.storeId) return props.storeId;
  const uid = Math.random().toString(36).substr(2, 9);
  let caseId = '未知編號'; 
  try { caseId = props['案件編號'] || '無編號'; } catch(e) {}
  const cleanCaseId = String(caseId).replace(/[^a-zA-Z0-9]/g, '');
  const storeId = (cleanCaseId === '' ? 'TMP_' : cleanCaseId) + "_" + uid;
  props.storeId = storeId;
  return storeId;
}

function findMarkersByCaseId(caseId) {
  if (!caseId || caseId === '無編號' || caseId === '未知編號') return [];
  let allMarkers = [];
  const collect = (layerGroup) => { 
    layerGroup.eachLayer(layer => { 
      if (layer.customData && layer.customData.props && layer.customData.props['案件編號'] === caseId) 
        allMarkers.push(layer); 
    }); 
  };
  collect(realtimeLayer); 
  collect(searchResultLayer); 
  collect(routeMatchLayer);
  activeRepairLayers.forEach(m => { 
    if (m.customData && m.customData.props && m.customData.props['案件編號'] === caseId) 
      allMarkers.push(m); 
  });
  return [...new Set(allMarkers)].sort((a,b) => b.getLatLng().lat - a.getLatLng().lat);
}

window.jumpToCaseSibling = function(targetStoreId) {
  let targetMarker = null;
  const searchInGroup = (group) => {
    if(group.eachLayer) { 
      group.eachLayer(l => { if(l.customData && l.customData.storeId === targetStoreId) targetMarker = l; }); 
    } else if (Array.isArray(group)) { 
      group.forEach(l => { if(l.customData && l.customData.storeId === targetStoreId) targetMarker = l; }); 
    }
  };
  
  searchInGroup(realtimeLayer); 
  searchInGroup(searchResultLayer); 
  searchInGroup(routeMatchLayer); 
  searchInGroup(activeRepairLayers);

  if (targetMarker) {
    const openIt = () => { 
      if (typeof window.openDetailPopupFromMarker === 'function') {
        window.openDetailPopupFromMarker(targetMarker); 
      } else {
        targetMarker.openPopup(); 
      }
    };
    
    if (markersClusterGroup && markersClusterGroup.hasLayer(targetMarker)) {
      if (markersClusterGroup.getVisibleParent(targetMarker) !== targetMarker) { 
        markersClusterGroup.zoomToShowLayer(targetMarker, openIt); 
        return; 
      }
    }
    
    const dist = map.getCenter().distanceTo(targetMarker.getLatLng());
    if(dist < 10) {
      openIt();
    } else { 
      map.flyTo(targetMarker.getLatLng(), 18, { duration: 0.8 }); 
      map.once('moveend', openIt); 
      setTimeout(openIt, 1000); 
    }
  }
};

function createPopup(data) {
  const { fileName, props, lat, lng, dist } = data; 
  const twd = twd97FromWgs84(lat, lng);
  const uid = Math.random().toString(36).substr(2, 9);
  
  let caseId = '未知編號'; 
  try { caseId = props['案件編號'] || '無編號'; } catch(e) {}
  const cleanCaseId = String(caseId).replace(/[^a-zA-Z0-9]/g, '');
  const storeId = props.storeId || ((cleanCaseId === '' ? 'TMP_' : cleanCaseId) + "_" + uid);
  CASE_DATA_CACHE[storeId] = props;

  const siblings = findMarkersByCaseId(caseId);
  let paginationHtml = '';
  if (siblings.length > 1) {
    paginationHtml = '<div class="case-pagination">';
    siblings.forEach((m, idx) => {
      const isActive = (m.customData.storeId === storeId) ? 'active' : '';
      paginationHtml += `<div class="page-dot ${isActive}" onclick="jumpToCaseSibling('${m.customData.storeId}')">${idx + 1}</div>`;
    });
    paginationHtml += '</div>';
  }

  const status = (props['案件狀態'] || '已完工').trim();
  const contractor = props['施工廠商'] || '-';
  const supervisor = props['監造廠商'] || '-'; 
  const priceDisplay = formatMoneyWan(props['決標金額'] || '0');
  const desc = props['案情描述'] || '無';
  
  let pillClass = status.includes('施工')||status.includes('派工') ? 'pill-working' : (status.includes('搶修') ? 'pill-urgent' : 'pill-status');
  let step = (status.includes('完工') || status.includes('完成') || status.includes('結案')) ? 3 : (status.includes('未完成') || status.includes('派工') || status.includes('施工') ? 2 : 1);
  if (step === 1) { 
    if (props['完工日期']) step = 3; 
    else if (props['派工日期']) step = 2; 
  }

  let typeStr = props['搶修類型'] || '';
  let types = String(typeStr).split(/[,，]/).filter(t => t.trim() !== '');
  let typeDisplay = types.length > 1 ? `${types[0]}... +${types.length - 1}` : (types.length === 1 ? types[0] : '未分類');
  let typeClickAttr = types.length > 1 ? `id="type-pill-${uid}" onclick="expandTypePill('${uid}', '${String(typeStr).replace(/'/g, "\\'")}')"` : '';
  
  let distDisplay = (!isNaN(dist) && dist !== null) ? `<div class="info-pill pill-dist"><i class="fas fa-route"></i> 距路線 ${Math.ceil(dist)}m</div>` : '';
  
  let arrBefore = getPhotosFromProps({'施工前照片': props['施工前照片']});
  let arrAfter = getPhotosFromProps({'施工後照片': props['施工後照片']});
  if(arrBefore.length === 0 && props.photoUrl) {
    arrBefore.push(getDirectDriveUrl(props.photoUrl));
  }
  
  const renderImg = (src) => src ? `<img src="${src}" oncontextmenu="return false;">` : '<div style="width:100%;height:100%;background:#f1f5f9;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">無影像</div>';

  return `
  <div class="popup-card">
    <div class="popup-header">
      <div class="case-id-row"><div class="case-id">${caseId}</div></div>
      ${paginationHtml}
      <div class="popup-tags-row">
        <div class="info-pill ${pillClass}">${status}</div>
        <div class="info-pill pill-rating" onclick="openCommentModal('${storeId}')">
          <i class="fas fa-star"></i> <span id="rating-text-${storeId}" class="rating-score">${props['平均星等']||0} <span class="rating-count">(${props['評論數']||0})</span></span>
        </div>
        <div class="info-pill pill-type" ${typeClickAttr} title="${typeStr}"><i class="fas fa-wrench"></i> ${typeDisplay}</div>
        ${distDisplay}
        <div class="info-pill pill-source"><i class="fas fa-file-contract"></i> ${fileName || '來源未知'}</div>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-step active"><div class="step-circle"></div><div class="step-label">待處理</div><div class="step-date">${props['通報日期ROC'] || '-'}</div></div>
      <div class="progress-step ${step>=2 ? 'active' : ''}"><div class="step-circle"></div><div class="step-label">派工中</div><div class="step-date">${props['派工日期'] || '-'}</div></div>
      <div class="progress-step ${step>=3 ? 'active' : ''}"><div class="step-circle"></div><div class="step-label">已完工</div><div class="step-date">${props['完工日期'] || '-'}</div></div>
    </div>

    <div class="icon-btn-row">
      <a href="${props['採購網址']||'#'}" target="_blank" class="icon-only-btn" title="決標公告"><i class="fas fa-file-alt"></i></a>
      <a href="https://maps.nlsc.gov.tw/go/${lng}/${lat}" target="_blank" class="icon-only-btn" title="地籍圖"><i class="fas fa-map"></i></a>
      <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${lat},${lng}" target="_blank" class="icon-only-btn" title="Google 街景"><i class="fas fa-street-view"></i></a>
      <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank" class="icon-only-btn" title="導航"><i class="fas fa-location-arrow"></i></a>
    </div>

    <div class="desktop-photo-row">
      <div class="photo-half">${renderImg(arrBefore[0])}<div class="photo-label">施工前</div></div>
      <div class="photo-half">${renderImg(arrAfter[0])}<div class="photo-label">施工後</div></div>
    </div>

    <div class="mobile-photo-tabs">
      <div class="m-photo-tab active" onclick="switchMobilePhotoTab(this, 'after', '${uid}')">施工後</div>
      <div class="m-photo-tab" onclick="switchMobilePhotoTab(this, 'before', '${uid}')">施工前</div>
    </div>
    <div class="mobile-photo-area">
      <div class="mobile-photo-view active" id="m-view-after-${uid}">${renderImg(arrAfter[0])}</div>
      <div class="mobile-photo-view" id="m-view-before-${uid}">${renderImg(arrBefore[0])}</div>
    </div>

    <div class="details-toggle" onclick="toggleDetails(this)">▼ 查看詳細資訊</div>
    <div class="details-content">
      <div class="details-grid">
        <div class="grid-item"><span class="grid-label">決標金額</span><span class="grid-val">${priceDisplay}</span></div>
        <div class="grid-item"><span class="grid-label">施工廠商</span><span class="grid-val">${contractor}</span></div>
        <div class="grid-item"><span class="grid-label">監造廠商</span><span class="grid-val">${supervisor}</span></div>
        <div class="grid-item"><span class="grid-label">TWD97</span><span class="grid-val">${twd.x}, ${twd.y}</span></div>
        <div class="grid-item"><span class="grid-label">WGS84</span><span class="grid-val">${lat.toFixed(6)}, ${lng.toFixed(6)}</span></div>
        <div class="grid-item grid-item-full"><span class="grid-label">案情描述</span><div class="desc-box">${desc}</div></div>
      </div>
    </div>
  </div>
  `;
}
let currentActiveStoreId = ""; 

window.openCommentModal = function(storeId) {
  commentStartTime = Date.now();
  currentActiveStoreId = storeId;
  const props = CASE_DATA_CACHE[storeId];
  if(!props) return;
  
  document.getElementById('commentModal').style.display = 'flex';
  document.getElementById('chatNickname').value = localStorage.getItem("chatNickname") || "";
  
  let comments = [];
  try { comments = JSON.parse(props['評論內容'] || "[]"); } catch(e) {}
  renderCommentList(document.getElementById('commentList'), comments);
  
  document.getElementById('chatMessage').value = "";
  document.getElementById('hp_comment').value = ""; 
  setChatStar(0);

  const caseId = props['案件編號'];
  if(caseId && caseId !== "無編號") fetchAndRefreshComments(storeId, caseId);
};

function renderCommentList(container, comments) {
  if(comments.length === 0) {
    container.innerHTML = `<div style="text-align:center;color:#999;padding:20px;font-size:13px;">成為第一個留言的人吧！</div>`;
  } else {
    let html = "";
    comments.forEach(c => {
      const isHidden = (c.status === 'HIDDEN' || c.status === 'ABUSIVE');
      const user = escapeHtml(c.user || "熱心民眾");
      const safeText = escapeHtml(c.text);
      const safeReply = c.reply ? escapeHtml(c.reply) : "";
      const starHtml = (c.star > 0 && !isHidden) ? `<span class="chat-star">${'<i class="fas fa-star"></i>'.repeat(c.star)}</span>` : "";
      let displayContent = isHidden ? '<span class="comment-hidden-text"><i class="fas fa-exclamation-triangle"></i> 此留言因違反社群規範已被隱藏。</span>' : safeText;
      
      html += `
      <div class="chat-bubble">
        <div class="chat-avatar">${user.charAt(0)}</div>
        <div class="chat-content">
          <div class="chat-meta"><b>${user}</b></div>
          <div class="chat-box">${displayContent}${starHtml}</div>
          <div class="chat-time">${c.date}</div>
        </div>
      </div>`;
      
      if (safeReply.trim() !== "" && !isHidden) {
        html += `
        <div class="chat-bubble official">
          <div class="chat-avatar"><i class="fas fa-building"></i></div>
          <div class="chat-content">
            <div class="chat-meta"><b>公所回覆</b></div>
            <div class="chat-box">${safeReply}</div>
          </div>
        </div>`;
      }
    });
    container.innerHTML = html;
    setTimeout(() => container.scrollTop = container.scrollHeight, 100);
  }
}

window.setChatStar = function(val) {
  document.getElementById('chatCurrentStar').value = val;
  document.querySelectorAll('#chatStarSelect i').forEach(s => {
    if(parseInt(s.getAttribute('data-val')) <= val) s.classList.add('active'); 
    else s.classList.remove('active');
  });
}

window.saveNickname = function(val) { 
  if(val) localStorage.setItem("chatNickname", val); 
}

async function submitChatComment() {
  if (!currentActiveStoreId) return;
  if (document.getElementById('hp_comment').value !== "") return alert("系統偵測到異常操作 (Bot)");
  if (Date.now() - commentStartTime < 3000) return alert("請勿頻繁操作，請稍候再試。");
  
  if (Date.now() - lastCommentSentTime < 60000) {
    return alert("為免系統壅塞，請於一分鐘後再留言。");
  }

  const props = CASE_DATA_CACHE[currentActiveStoreId];
  if (!props) return;

  const rawText = document.getElementById('chatMessage').value;
  const rawNickname = document.getElementById('chatNickname').value;
  
  if(!rawText.trim() && document.getElementById('chatCurrentStar').value == 0) return alert("請輸入留言或評分！");
  if(!rawNickname.trim()) return alert("請輸入暱稱！");
  
  const text = sanitizeInput(rawText.trim());
  const nickname = sanitizeInput(rawNickname.trim());
  const star = parseInt(document.getElementById('chatCurrentStar').value);
  
  localStorage.setItem("chatNickname", nickname);
  
  const btn = document.querySelector('.chat-send-btn'); 
  btn.disabled = true;
  const originalIcon = btn.innerHTML;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

  try {
    const payload = { 
      action: "comment", 
      caseId: props['案件編號'] || currentActiveStoreId, 
      star: star, 
      comment: text, 
      nickname: nickname, 
      appKey: "TainanMap2026_SecureKey_v1", 
      siteUrl: window.location.href, 
      uid: getUserID() 
    };
    const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await response.json();

    if (result.result === "success") {
      lastCommentSentTime = Date.now();
      const now = new Date();
      const timeStr = `${now.getFullYear()}/${('0'+(now.getMonth()+1)).slice(-2)}/${('0'+now.getDate()).slice(-2)} ${('0'+now.getHours()).slice(-2)}:${('0'+now.getMinutes()).slice(-2)}`;
      
      let currentComments = [];
      try { currentComments = JSON.parse(props['評論內容'] || "[]"); } catch(e) {}
      
      currentComments.push({ star: star, text: text, date: timeStr, user: nickname });
      props['評論內容'] = JSON.stringify(currentComments);
      
      const oldTotal = parseFloat(props['平均星等']||0) * parseInt(props['評論數']||0);
      const newCount = parseInt(props['評論數']||0) + (star > 0 ? 1 : 0);
      const newAvg = newCount > 0 ? ((oldTotal + star) / newCount).toFixed(1) : props['平均星等'];
      
      props['平均星等'] = newAvg;
      if(star > 0) props['評論數'] = newCount;
      
      renderCommentList(document.getElementById('commentList'), currentComments);
      document.getElementById('chatMessage').value = ""; 
      setChatStar(0);
      
      const ratingText = document.getElementById(`rating-text-${currentActiveStoreId}`);
      if(ratingText) ratingText.innerHTML = `${newAvg} <span class="rating-count">(${currentComments.length})</span>`;
    } else {
      alert("留言失敗：" + (result.error || "未知錯誤"));
    }
  } catch(e) { 
    alert("連線錯誤，請檢查網路或稍後再試。");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalIcon;
  }
}

function closeCommentModal() { 
  document.getElementById('commentModal').style.display = 'none'; 
}

async function fetchAndRefreshComments(storeId, caseId) {
  if (!caseId || caseId === "無編號" || GOOGLE_SCRIPT_URL.includes("您的SCRIPT_ID")) return;
  const ratingText = document.getElementById(`rating-text-${storeId}`);
  if(ratingText) ratingText.style.opacity = "0.5";
  
  try {
    const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=getComments&caseId=${caseId}&t=${Date.now()}`);
    const json = await res.json();
    if (json.result === "success" && Array.isArray(json.data)) {
      const comments = json.data;
      const props = CASE_DATA_CACHE[storeId];
      let totalStars = 0, starCount = 0;
      
      comments.forEach(c => {
        if (c.star > 0 && c.status !== 'HIDDEN' && c.status !== 'ABUSIVE') { totalStars += c.star; starCount++; }
      });
      
      const avg = starCount > 0 ? (totalStars / starCount).toFixed(1) : 0;
      const visibleCount = comments.filter(c => c.status !== 'HIDDEN' && c.status !== 'ABUSIVE').length;

      if (props) { 
        props['平均星等'] = avg; 
        props['評論數'] = visibleCount; 
        props['評論內容'] = JSON.stringify(comments); 
      }
      if(ratingText) { 
        ratingText.innerHTML = `${avg} <span class="rating-count">(${visibleCount})</span>`; 
        ratingText.style.opacity = "1"; 
      }
      if (currentActiveStoreId === storeId && document.getElementById('commentModal').style.display !== 'none') {
         renderCommentList(document.getElementById('commentList'), comments);
      }
    }
  } catch (e) { 
    if(ratingText) ratingText.style.opacity = "1"; 
  }
}

let isRealtimeLoaded = false;
async function toggleRealtimeLayer(checkbox) {
  if(!checkbox.checked) {
    realtimeLayer.clearLayers();
    return;
  }
  
  if (GOOGLE_SCRIPT_URL.includes("您的SCRIPT_ID")) { 
    console.warn("未設定 Google Apps Script URL，跳過載入");
    return; 
  }
  
  document.body.style.cursor = 'wait';
  try {
    const res = await fetch(`${GOOGLE_SCRIPT_URL}?t=${Date.now()}`);
    const data = await res.json();
    realtimeLayer.clearLayers();
    if(data.features) {
      data.features.forEach(f => {
        const props = f.properties;
        const status = props['案件狀態'] || '待處理';
        let color = '#7f8c8d', radius = 8;
        
        if(status === '派工中') { color = '#ff9800'; radius = 10; } 
        else if(status === '已完工') { color = '#004080'; } 
        
        const latlng = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
        const marker = L.circleMarker(latlng, { radius: radius, fillColor: color, color: '#fff', weight: 2, fillOpacity: 0.9 }).addTo(realtimeLayer);
        const storeId = generateStoreId(props);
        CASE_DATA_CACHE[storeId] = props;
        
        marker.customData = { configLabel: "民眾通報-" + (props['案件編號']||''), props: props, storeId: storeId };
        attachPopupEvents(marker, [...realtimeLayer.getLayers(), ...activeRepairLayers]);
      });
    }
    isRealtimeLoaded = true;
  } catch(e) { 
    console.error(e); 
  } finally { 
    document.body.style.cursor = 'default'; 
  }
}

function setupVoiceInput(triggerId, targetId, hintId = null) {
  const trigger = document.getElementById(triggerId);
  const target = document.getElementById(targetId);
  const overlay = document.getElementById('voiceOverlay'); 
  const hintText = hintId ? document.getElementById(hintId) : null;
  
  if(!trigger || !target) return;
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    trigger.style.display = 'none'; return;
  }

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const recognition = new SpeechRecognition();
  recognition.lang = 'zh-TW'; 
  recognition.continuous = false; 
  recognition.interimResults = false;

  trigger.onclick = () => { 
    if (trigger.classList.contains('listening')) recognition.stop(); 
    else recognition.start(); 
  };
  
  recognition.onstart = () => { 
    trigger.classList.add('listening'); 
    if(hintText) hintText.classList.add('show');
    else if(overlay) overlay.style.display = 'flex'; 
  };
  
  recognition.onend = () => { 
    trigger.classList.remove('listening'); 
    if(hintText) hintText.classList.remove('show');
    else if(overlay) overlay.style.display = 'none'; 
  };
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    target.value = target.value + (target.value ? " " : "") + transcript;
  };
  
  recognition.onerror = () => { 
    trigger.classList.remove('listening'); 
    if(hintText) hintText.classList.remove('show');
    else if(overlay) overlay.style.display = 'none'; 
  };
}

let currentWizardStep = 1;
const openReportBtn = document.getElementById('openReportBtn');
if (openReportBtn) openReportBtn.addEventListener('click', openReportWizard);

function openReportWizard() {
  reportStartTime = Date.now();
  document.getElementById('hp_report').value = ""; 
  document.getElementById('reportOverlay').style.display = 'flex';
  resetReportForm();
}

function closeReport() { 
  document.getElementById('reportOverlay').style.display = 'none'; 
  document.getElementById('photoSourceModal').style.display = 'none';
  resetReportForm(); 
}

window.goToWizardStep = function(step) {
  if(step === 2 && currentWizardStep === 1) {
    const img1 = document.getElementById('imgPreview1').src;
    if(!img1 || !img1.startsWith('data:')) {
      if(!confirm("您尚未上傳任何現況照片，確定要跳過直接進行文字描述嗎？")) return;
    }
  }
  if(step === 3 && currentWizardStep === 2) {
    if(!document.getElementById('reportDesc').value.trim()) {
      alert("請至少簡述一下案情或損壞情形喔！"); 
      document.getElementById('reportDesc').focus();
      return;
    }
  }

  document.querySelectorAll('.wizard-tab').forEach((t, i) => t.classList.toggle('active', i+1 === step));
  document.querySelectorAll('.wizard-step').forEach((s, i) => s.classList.toggle('active', i+1 === step));
  document.getElementById('wizardBar').style.width = (step * 33.33) + '%';
  currentWizardStep = step;

  if(step === 3) {
    initStep3Data();
  }
}

function initStep3Data() {
  initMathChallenge(); 
  document.getElementById('reportCaseId').innerText = "(待系統取號)";
  document.getElementById('reportTime').innerText = new Date().toLocaleString();
  
  document.getElementById('collisionWarningBox').style.display = 'none';
  document.getElementById('nearbyHistoryList').innerHTML = '';
  reportNearbyMatches = [];

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        const twd = twd97FromWgs84(lat, lng);
        document.getElementById('reportWgs84').innerText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        document.getElementById('reportTwd97').innerText = `${twd.x}, ${twd.y}`;
        checkNearbyHistory(lat, lng);
      },
      () => { 
        document.getElementById('reportWgs84').innerText = "定位失敗，請確認 GPS 權限"; 
        document.getElementById('reportTwd97').innerText = "定位失敗"; 
      },
      { enableHighAccuracy: true }
    );
  } else { 
    document.getElementById('reportWgs84').innerText = "您的裝置不支援定位"; 
  }
}

function checkNearbyHistory(lat, lng) {
  const historyBox = document.getElementById('collisionWarningBox');
  const historyList = document.getElementById('nearbyHistoryList');
  const centerLatLng = L.latLng(lat, lng);
  const threeYearsAgo = new Date(); 
  threeYearsAgo.setFullYear(new Date().getFullYear() - 3);
  reportNearbyMatches = [];

  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if(!data || !data.features) return;
    
    data.features.forEach(f => {
      if(f.geometry.type !== 'Point') return;
      const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
      const dist = centerLatLng.distanceTo(pt);
      if(dist <= 50) {
        const dateStr = String(f.properties['完工日期'] || "").trim();
        if(dateStr.length === 7) {
          const finishDate = new Date(parseInt(dateStr.substring(0,3))+1911, parseInt(dateStr.substring(3,5))-1, parseInt(dateStr.substring(5,7)));
          if(finishDate >= threeYearsAgo) {
            reportNearbyMatches.push({ 
              label: conf.label, 
              props: f.properties, 
              lat: pt.lat, 
              lng: pt.lng, 
              dist: dist.toFixed(1), 
              isEmergency: /搶修|災害|緊急/.test(conf.label), 
              jsDate: finishDate, 
              dateStr 
            });
          }
        }
      }
    });
  });

  historyList.innerHTML = '';
  if(reportNearbyMatches.length > 0) {
    historyBox.style.display = 'block';
    reportNearbyMatches.sort((a,b) => b.jsDate - a.jsDate);
    reportNearbyMatches.forEach((item, index) => {
      const div = document.createElement('div');
      div.className = 'nearby-item';
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:bold; color:#004080;">${item.label}</div>
          <div style="font-size:11px; color:#666;">完工：${item.dateStr} | 距 ${item.dist}m</div>
        </div>
        <div class="nearby-tag ${item.isEmergency ? 'tag-emg' : 'tag-gen'}">${item.isEmergency ? '搶修' : '一般'}</div>
      `;
      div.onclick = function() { showReportDetail(index); };
      historyList.appendChild(div);
    });
  }
}

function showReportDetail(index) {
  const item = reportNearbyMatches[index];
  if(!item) return;
  const content = createPopup({ fileName: item.label, props: item.props, lat: item.lat, lng: item.lng, dist: parseFloat(item.dist) });
  document.getElementById('reportDetailContent').innerHTML = content;
  document.getElementById('reportDetailModal').style.display = 'flex';
}
function closeReportDetailModal() { 
  document.getElementById('reportDetailModal').style.display = 'none'; 
}

function triggerCamera(id) {
  const img = document.getElementById(`imgPreview${id}`);
  if (!img.src || img.style.display === 'none' || img.src === window.location.href) {
    activePhotoId = id;
    document.getElementById('photoSourceModal').style.display = 'flex';
  }
}

function selectSource(type) {
  if(!activePhotoId) return;
  const input = document.getElementById(`fileInput${activePhotoId}`);
  const modal = document.getElementById('photoSourceModal');
  if(type === 'camera') input.setAttribute('capture', 'environment'); 
  else input.removeAttribute('capture');
  modal.style.display = 'none';
  setTimeout(() => input.click(), 300);
}
function closeSourceModal() { document.getElementById('photoSourceModal').style.display = 'none'; }

let blazefaceModel = null;
let peCanvas = document.getElementById('peCanvas');
let peCtx = peCanvas.getContext('2d');
let peCurrentImg = new Image();
let peHistory = []; 
let isDrawing = false;
let currentTargetId = null; 
let peMosaicCanvas = document.createElement('canvas');
let peMosaicCtx = peMosaicCanvas.getContext('2d');

async function loadAiModel() { 
  try { 
    blazefaceModel = await blazeface.load(); 
  } catch (e) { 
    console.error("AI Model Load Failed"); 
  } 
}
loadAiModel(); 

window.previewImage = function(input, id) {
  document.getElementById('photoSourceModal').style.display = 'none';
  if (input.files && input.files[0]) {
    compressImage(input.files[0], 1024, 0.8, function(dataUrl) { 
      openPrivacyEditor(dataUrl, id); 
    });
  }
  input.value = '';
};

function openPrivacyEditor(imgUrl, id) {
  currentTargetId = id;
  const modal = document.getElementById('privacyEditorModal');
  modal.style.display = 'flex';
  peCurrentImg.onload = function() {
    const maxWidth = modal.clientWidth, maxHeight = modal.clientHeight - 120; 
    peCanvas.width = peCurrentImg.width; 
    peCanvas.height = peCurrentImg.height;
    const ratio = Math.min(maxWidth / peCurrentImg.width, maxHeight / peCurrentImg.height);
    peCanvas.style.width = (peCurrentImg.width * ratio) + 'px'; 
    peCanvas.style.height = (peCurrentImg.height * ratio) + 'px';
    peCtx.drawImage(peCurrentImg, 0, 0);
    initMosaicSource(peCurrentImg);
    saveHistory(); 
    triggerAutoBlur();
  };
  peCurrentImg.src = imgUrl;
}

function initMosaicSource(img) {
  peMosaicCanvas.width = img.width; 
  peMosaicCanvas.height = img.height;
  const scale = 0.05, w = img.width * scale, h = img.height * scale;
  const tempC = document.createElement('canvas'); 
  tempC.width = w; 
  tempC.height = h;
  const tempCtx = tempC.getContext('2d'); 
  tempCtx.drawImage(img, 0, 0, w, h);
  peMosaicCtx.imageSmoothingEnabled = false; 
  peMosaicCtx.drawImage(tempC, 0, 0, w, h, 0, 0, img.width, img.height);
}

function closePrivacyEditor() { 
  document.getElementById('privacyEditorModal').style.display = 'none'; 
  peHistory = []; 
}

async function triggerAutoBlur() {
  if (!blazefaceModel) return;
  const loading = document.getElementById('peLoading'); 
  loading.style.display = 'block';
  try {
    const predictions = await blazefaceModel.estimateFaces(peCanvas, false);
    if (predictions.length > 0) {
      predictions.forEach(p => {
        const start = p.topLeft, end = p.bottomRight;
        const size = [end[0] - start[0], end[1] - start[1]], pad = size[0] * 0.2; 
        peCtx.drawImage(peMosaicCanvas, start[0]-pad, start[1]-pad, size[0]+pad*2, size[1]+pad*2, start[0]-pad, start[1]-pad, size[0]+pad*2, size[1]+pad*2);
      });
      saveHistory();
    } 
  } catch (err) {} finally { 
    loading.style.display = 'none'; 
  }
}

function getTouchPos(canvasDom, touchEvent) {
  const rect = canvasDom.getBoundingClientRect();
  return { 
    x: (touchEvent.touches[0].clientX - rect.left) * (canvasDom.width / rect.width), 
    y: (touchEvent.touches[0].clientY - rect.top) * (canvasDom.height / rect.height) 
  };
}

peCanvas.addEventListener('touchstart', (e) => { isDrawing = true; const pos = getTouchPos(peCanvas, e); drawDot(pos.x, pos.y); e.preventDefault(); }, {passive: false});
peCanvas.addEventListener('touchmove', (e) => { if (!isDrawing) return; const pos = getTouchPos(peCanvas, e); drawDot(pos.x, pos.y); e.preventDefault(); }, {passive: false});
peCanvas.addEventListener('touchend', () => { if(isDrawing) { isDrawing = false; saveHistory(); } });
peCanvas.addEventListener('mousedown', (e) => { isDrawing = true; const rect = peCanvas.getBoundingClientRect(); drawDot((e.clientX - rect.left)*(peCanvas.width/rect.width), (e.clientY - rect.top)*(peCanvas.height/rect.height)); });
peCanvas.addEventListener('mousemove', (e) => { if(!isDrawing) return; const rect = peCanvas.getBoundingClientRect(); drawDot((e.clientX - rect.left)*(peCanvas.width/rect.width), (e.clientY - rect.top)*(peCanvas.height/rect.height)); });
peCanvas.addEventListener('mouseup', () => { if(isDrawing){ isDrawing=false; saveHistory(); } });

function drawDot(x, y) {
  const brushSize = parseInt(document.getElementById('peBrushSize').value) || 35;
  peCtx.save(); 
  peCtx.beginPath(); 
  peCtx.arc(x, y, brushSize, 0, 2 * Math.PI); 
  peCtx.clip();
  peCtx.drawImage(peMosaicCanvas, 0, 0); 
  peCtx.restore();
}

function saveHistory() { 
  if (peHistory.length > 5) peHistory.shift(); 
  peHistory.push(peCanvas.toDataURL()); 
}

function undoCanvas() {
  if (peHistory.length <= 1) return; 
  peHistory.pop(); 
  const prevUrl = peHistory[peHistory.length - 1], img = new Image();
  img.onload = () => { 
    peCtx.clearRect(0,0,peCanvas.width, peCanvas.height); 
    peCtx.drawImage(img, 0, 0); 
  };
  img.src = prevUrl;
}

function savePrivacyImage() {
  const finalDataUrl = peCanvas.toDataURL('image/jpeg', 0.8);
  const imgPreview = document.getElementById(`imgPreview${currentTargetId}`);
  const photoBox = document.getElementById(`photoBox${currentTargetId}`);
  const delBtn = document.getElementById(`delBtn${currentTargetId}`);
  
  imgPreview.src = finalDataUrl; 
  imgPreview.style.display = 'block';
  photoBox.querySelector('.add-photo-icon').style.display = 'none';
  photoBox.querySelector('.add-photo-text').style.display = 'none';
  photoBox.classList.add('has-image');
  delBtn.style.display = 'block';
  
  if(currentTargetId === 1) {
    document.getElementById('photoBox2').classList.add('bounce-hint');
    setTimeout(() => document.getElementById('photoBox2').classList.remove('bounce-hint'), 3000);
  }
  closePrivacyEditor();
}

function compressImage(file, maxWidth, quality, callback) {
  const reader = new FileReader(); 
  reader.readAsDataURL(file);
  reader.onload = function (event) {
    const img = new Image(); 
    img.src = event.target.result;
    img.onload = function () {
      let width = img.width, height = img.height;
      if (width > maxWidth) { 
        height = Math.round(height * (maxWidth / width)); 
        width = maxWidth; 
      }
      const canvas = document.createElement('canvas'); 
      canvas.width = width; 
      canvas.height = height;
      canvas.getContext('2d').drawImage(img, 0, 0, width, height); 
      callback(canvas.toDataURL('image/jpeg', quality));
    };
  };
}

window.deletePhoto = function(id, e) {
  if(e) e.stopPropagation();
  const img = document.getElementById(`imgPreview${id}`);
  const box = document.getElementById(`photoBox${id}`);
  const input = document.getElementById(`fileInput${id}`);
  const delBtn = document.getElementById(`delBtn${id}`);
  img.src = ""; 
  img.removeAttribute('src'); 
  img.style.display = 'none';
  box.querySelector('.add-photo-icon').style.display = 'block';
  box.querySelector('.add-photo-text').style.display = 'block';
  box.classList.remove('has-image'); 
  input.value = ""; 
  delBtn.style.display = 'none';
}

function resetReportForm() { 
  deletePhoto(1); 
  deletePhoto(2); 
  document.getElementById('reportDesc').value = ""; 
  document.getElementById('reportWgs84').innerText = "📍 正在為您精準定位中..."; 
  document.getElementById('reportTwd97').innerText = "定位中...";
  document.getElementById('subscribeToggle').checked = false;
  document.getElementById('emailInputArea').style.display = 'none';
  document.getElementById('subscriberEmail').value = "";
  document.getElementById('collisionWarningBox').style.display = 'none';
  goToWizardStep(1);
}

window.toggleEmailInput = function(checkbox) {
  const area = document.getElementById('emailInputArea');
  if(checkbox.checked) { 
    area.style.display = 'block'; 
    document.getElementById('subscriberEmail').focus(); 
  } else { 
    area.style.display = 'none'; 
  }
};

function getUserID() {
  let uid = localStorage.getItem('site_user_uid');
  if (!uid) { 
    uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); 
    localStorage.setItem('site_user_uid', uid); 
  }
  return uid; 
}

async function submitReport() {
  if (document.getElementById('hp_report').value !== "") return alert("系統偵測到異常操作");
  
  const userAnswer = parseInt(document.getElementById('mathAnswer').value);
  if (isNaN(userAnswer) || userAnswer !== correctMathAnswer) {
    alert("❌ 驗證失敗！\n\n請輸入正確的算式答案以證明您不是機器人。");
    document.getElementById('mathAnswer').focus(); 
    return; 
  }
  
  if (Date.now() - reportStartTime < 3000) return alert("請勿頻繁送出，請檢查資料後再試");
  if (GOOGLE_SCRIPT_URL.includes("您的SCRIPT_ID")) return alert("請先設定 Google Apps Script URL！"); 
  
  const desc = sanitizeInput(document.getElementById('reportDesc').value.trim());
  let email = "";
  if (document.getElementById('subscribeToggle').checked) {
    email = document.getElementById('subscriberEmail').value.trim();
    if(!email || !email.includes('@')) return alert("請輸入有效的 Email 以便訂閱通知。");
  }

  if (!confirm("確定要上傳此案件通報嗎？")) return;
  
  const btn = document.getElementById('btnSubmitReport'); 
  const originalText = btn.innerHTML; 
  btn.disabled = true; 
  btn.innerText = "資料上傳中...";
  
  try {
    const payload = { 
      time: document.getElementById('reportTime').innerText, 
      wgs84: document.getElementById('reportWgs84').innerText, 
      twd97: document.getElementById('reportTwd97').innerText, 
      description: desc, 
      photo1: (document.getElementById('imgPreview1').src.startsWith('data:')) ? document.getElementById('imgPreview1').src : "", 
      photo2: (document.getElementById('imgPreview2').src.startsWith('data:')) ? document.getElementById('imgPreview2').src : "",
      appKey: "TainanMap2026_SecureKey_v1", 
      siteUrl: window.location.href,        
      uid: getUserID(), 
      mathVerified: "true", 
      email: email 
    };
    
    const response = await fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) });
    const result = await response.json();
    
    if (result.result === "success") { 
      saveMyHistory(result.caseId);
      alert(`✅ 案件通報成功！\n\n案件編號：${result.caseId}\n已自動儲存至「我的歷史通報」。`); 
      closeReport(); 
    } else { 
      alert("❌ 上傳失敗: " + (result.error || "未知錯誤")); 
    }
  } catch (error) { 
    alert("❌ 連線錯誤，請檢查網路或稍後再試。"); 
  } finally { 
    btn.disabled = false; 
    btn.innerHTML = originalText; 
  }
}

function saveMyHistory(caseId) {
  let history = JSON.parse(localStorage.getItem("myReportHistory") || "[]");
  if (!history.some(h => h.id === caseId)) {
    history.push({ id: caseId, date: new Date().toLocaleDateString() });
    localStorage.setItem("myReportHistory", JSON.stringify(history));
  }
}

window.openQuickSearch = function() {
  document.getElementById('quickSearchModal').style.display = 'flex';
  const list = document.getElementById('quickSearchHistoryList');
  let history = JSON.parse(localStorage.getItem("myReportHistory") || "[]");
  
  if(history.length === 0) {
    list.innerHTML = '<div style="padding:15px; color:#999; text-align:center;">此裝置尚無歷史通報紀錄</div>';
  } else {
    list.innerHTML = history.reverse().map(h => `
      <div class="h-list-item" onclick="triggerSearch('${h.id}')">
        <span><i class="fas fa-file-alt" style="color:var(--primary-color);"></i> <b>${h.id}</b></span>
        <span style="color:#999;font-size:12px;">${h.date}</span>
      </div>
    `).join('');
  }
}

window.closeQuickSearch = () => { 
  document.getElementById('quickSearchModal').style.display = 'none'; 
}

window.triggerSearch = (keyword) => {
  document.getElementById('quickSearchInput').value = keyword;
  doQuickSearch();
}

window.doQuickSearch = async () => {
  const kw = document.getElementById('quickSearchInput').value.trim();
  if(!kw) return;
  
  closeQuickSearch();
  
  if (document.body.classList.contains('lite-mode')) {
    document.body.classList.remove('lite-mode');
    document.getElementById('reportOverlay').style.display = 'none';
  }
  
  document.getElementById('keywordInput').value = kw;
  switchTab('tab-search');

  const rtToggle = document.getElementById('realtimeToggle');
  if (!isRealtimeLoaded || !rtToggle.checked) {
    const loadingOverlay = document.getElementById('searchLoadingOverlay');
    if(loadingOverlay) loadingOverlay.style.display = 'flex';
    if(rtToggle) rtToggle.checked = true;
    await toggleRealtimeLayer(rtToggle);
    if(loadingOverlay) loadingOverlay.style.display = 'none';
  }
  
  document.getElementById('searchBtn').click();
}

document.getElementById('dupClearBtn').addEventListener('click', function() {
  dupCheckLayer.clearLayers(); 
  document.getElementById('dupCheckResult').innerHTML = ''; 
  document.getElementById('dupCheckInput').value = ''; 
  document.getElementById('autoDupCheckToggle').checked = false; 
  dupMarkersMap = {}; 
  CURRENT_DUPLICATE_GROUPS = [];
});

window.focusDupMarker = function(index) { 
  const marker = dupMarkersMap[index]; 
  if(marker) { 
    map.flyTo(marker.getLatLng(), 18); 
    marker.openPopup(); 
    if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); 
  } 
};

window.showDupDetailPopup = function(groupIdx, caseIdx) {
  const group = CURRENT_DUPLICATE_GROUPS[groupIdx]; 
  if(!group) return; 
  const item = group[caseIdx];
  const distToLine = distToRoad(item.latlng, roadsLayer); 
  const content = createPopup({ fileName: item.name, props: item.props, lat: item.latlng.lat, lng: item.latlng.lng, dist: distToLine });
  L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};

window.showMapDetailPopup = function(key, index) {
  const group = CURRENT_MAP_GROUPS[key]; 
  if(!group || !group[index]) return; 
  const item = group[index];
  const dist = distToRoad(item.latlng, roadsLayer);
  const content = createPopup({ fileName: item.configLabel, props: item.feature.properties, lat: item.latlng.lat, lng: item.latlng.lng, dist: dist });
  L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
};

document.getElementById('autoDupCheckToggle').addEventListener('change', function() {
  if(this.checked) { 
    document.getElementById('dupCheckInput').value = ''; 
    performAutoDuplicateCheck(); 
  } else { 
    dupCheckLayer.clearLayers(); 
    document.getElementById('dupCheckResult').innerHTML = ''; 
    dupMarkersMap = {}; 
    CURRENT_DUPLICATE_GROUPS = []; 
  }
});

function performAutoDuplicateCheck() {
  const resDiv = document.getElementById('dupCheckResult'); 
  resDiv.innerHTML = '<div style="padding:10px; color:#666;">掃描資料庫中...</div>';
  let coordMap = {}; 
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if(!data || !data.features) return;
    data.features.forEach(f => {
      if(f.geometry.type !== 'Point') return;
      const key = f.geometry.coordinates.join(',');
      if(!coordMap[key]) coordMap[key] = [];
      coordMap[key].push({ name: conf.label, props: f.properties, latlng: L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]) });
    });
  });
  
  let duplicates = []; 
  Object.keys(coordMap).forEach(k => { 
    if(coordMap[k].length > 1) duplicates.push(coordMap[k]); 
  });
  
  CURRENT_DUPLICATE_GROUPS = duplicates;
  dupCheckLayer.clearLayers(); 
  resDiv.innerHTML = ''; 
  dupMarkersMap = {};
  
  if(duplicates.length === 0) { 
    resDiv.innerHTML = '<div style="padding:10px; color:green;">未發現完全重疊的案件座標。</div>'; 
    return; 
  }
  
  let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">⚠️ 發現 ${duplicates.length} 組重複座標點位：</div>`;
  
  duplicates.forEach((group, idx) => {
    const pt = group[0].latlng; 
    const twd = twd97FromWgs84(pt.lat, pt.lng);
    const marker = L.circleMarker(pt, { radius: 10, color: '#d32f2f', fillColor: '#ffeb3b', fillOpacity: 0.9, weight:2 }).addTo(dupCheckLayer);
    
    let popupHTML = `<div class="info-header" style="padding:10px;background:#004080;color:white;font-weight:bold;">重複座標點位資訊 (${group.length}筆)</div><div class="info-body" style="padding:10px;max-height:250px; overflow-y:auto;"><div style="font-size:12px; color:#666; margin-bottom:5px;">點擊案件名稱可查看詳細資料</div>`;
    group.forEach((item, i) => { 
      popupHTML += `<div style="border-bottom:1px dashed #ccc; padding:8px 0; cursor:pointer;" onclick="showDupDetailPopup(${idx}, ${i})"><b style="color:#004080; text-decoration:underline;">${i+1}. ${item.name}</b><br><span style="color:#333; font-size:12px;">案件編號: ${item.props['案件編號']||'無'}<br>完工日期: ${item.props['完工日期']||'無'}</span></div>`; 
    });
    popupHTML += `</div>`;
    
    marker.bindPopup(popupHTML, { className: 'custom-popup', maxWidth: 300 }); 
    dupMarkersMap[idx] = marker;
    
    const dates = group.map(g => g.props['完工日期'] || '').sort();
    html += `<div class="dup-check-item" onclick="focusDupMarker(${idx})"><div class="dup-check-title">📍 座標重複群組 #${idx+1} <br><span style="font-size:11px; color:#555;">(TWD97: ${twd.x}, ${twd.y})</span></div><div class="dup-check-info" style="color:#d32f2f; font-weight:bold;">包含 ${group.length} 筆案件</div><div class="dup-check-info" style="font-size:11px; color:#666;">${dates[0] ? `${dates[0]} ~ ${dates[dates.length-1]}` : '日期未知'}</div></div>`;
  });
  resDiv.innerHTML = html;
}

document.getElementById('dupCheckBtn').addEventListener('click', function() {
  const autoCheck = document.getElementById('autoDupCheckToggle'); 
  if(autoCheck.checked) autoCheck.checked = false;
  
  const input = document.getElementById('dupCheckInput').value.trim();
  const resultDiv = document.getElementById('dupCheckResult'); 
  
  dupCheckLayer.clearLayers(); 
  resultDiv.innerHTML = ''; 
  dupMarkersMap = {}; 
  CURRENT_DUPLICATE_GROUPS = [];
  
  if (!input) return alert('請輸入 TWD97 座標'); 
  
  const parts = input.split(/[, \t]+/); 
  const x = parseFloat(parts[0]), y = parseFloat(parts[1]); 
  if (isNaN(x) || isNaN(y)) return alert('座標數值錯誤'); 
  
  try {
    const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]); 
    const centerLatLng = L.latLng(w[1], w[0]);
    
    map.setView(centerLatLng, 18); 
    L.circle(centerLatLng, { color: 'red', fillColor: '#f03', fillOpacity: 0.2, radius: 50 }).addTo(dupCheckLayer);
    L.marker(centerLatLng).addTo(dupCheckLayer).bindPopup(`檢核中心點<br>TWD97: ${x}, ${y}`).openPopup();
    
    const matches = []; 
    const now = new Date(); 
    const threeYearsAgo = new Date(); 
    threeYearsAgo.setFullYear(now.getFullYear() - 3);
    
    REPAIR_CONFIG.forEach(conf => {
      const data = REPAIR_DATA_CACHE[conf.value]; 
      if (!data) return;
      data.features.forEach(f => {
        if (f.geometry.type !== 'Point') return;
        const pt = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
        const dist = centerLatLng.distanceTo(pt);
        if (dist <= 50) {
          const dateStr = f.properties['完工日期'];
          if (dateStr && dateStr.length === 7) {
            const finishDate = new Date(parseInt(dateStr.substring(0, 3)) + 1911, parseInt(dateStr.substring(3, 5)) - 1, parseInt(dateStr.substring(5, 7)));
            if (finishDate >= threeYearsAgo) {
              let diffMonths = (now.getFullYear() - finishDate.getFullYear()) * 12 + (now.getMonth() - finishDate.getMonth());
              if (now.getDate() < finishDate.getDate()) diffMonths--;
              matches.push({ 
                name: conf.label, 
                props: f.properties, 
                date: dateStr, 
                timeAgo: `${Math.floor(diffMonths / 12)} 年 ${diffMonths % 12} 個月`, 
                dist: dist.toFixed(1), 
                isEmergency: /搶修|災害|緊急/.test(conf.label), 
                latlng: pt 
              });
            }
          }
        }
      });
    });
    
    if (matches.length === 0) { 
      resultDiv.innerHTML = '<div style="color:green; font-weight:bold;"><i class="fas fa-check-circle"></i> 此範圍 50m 內近 3 年無相關紀錄</div>'; 
    } else {
      matches.sort((a, b) => parseFloat(a.dist) - parseFloat(b.dist));
      let html = `<div style="color:#d32f2f; font-weight:bold; margin-bottom:5px;">⚠️ 發現 ${matches.length} 筆近 3 年紀錄：</div>`;
      matches.forEach((m, index) => {
        const marker = L.circleMarker(m.latlng, { radius: 8, color: '#d32f2f', weight: 2, fillColor: '#ffeb3b', fillOpacity: 1 }).addTo(dupCheckLayer);
        marker.bindPopup(createPopup({ fileName: m.name, props: m.props, lat: m.latlng.lat, lng: m.latlng.lng, dist: distToRoad(m.latlng, roadsLayer) }), { className: 'custom-popup', maxWidth:960 });
        dupMarkersMap[index] = marker;
        html += `<div class="dup-check-item" onclick="focusDupMarker(${index})"><div class="dup-check-title">${m.name}<span class="dup-tag ${m.isEmergency ? 'tag-emg' : 'tag-gen'}">${m.isEmergency ? '搶修' : '一般'}</span></div><div class="dup-check-info"><span>完工：${m.props['完工日期']} (距今 ${m.timeAgo})</span></div><div class="dup-check-info"><span>距離：${m.dist} 公尺</span></div></div>`;
      });
      resultDiv.innerHTML = html;
    }
  } catch (e) { 
    alert('座標轉換失敗'); 
  }
});

window.switchTab = function(tabId) {
  document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  const btn = document.querySelector(`button[onclick="switchTab('${tabId}')"]`); 
  if(btn) btn.classList.add('active');
};

const toggleBtn = document.getElementById('toggleSidebarBtn');
const overlayMask = document.getElementById('overlay-mask');
const bottomPanel = document.getElementById('bottomPanel');
const togglePanelSizeBtn = document.getElementById('togglePanelSizeBtn');
const panelIcon = togglePanelSizeBtn.querySelector('i');

function toggleSidebar() { 
  const isMobile = window.innerWidth <= 768; 
  if (isMobile) {
    document.body.classList.toggle('sidebar-open'); 
  } else {
    document.body.classList.toggle('collapsed'); 
  }
  setTimeout(() => map.invalidateSize(), 300); 
}

toggleBtn.addEventListener('click', toggleSidebar); 
overlayMask.addEventListener('click', () => document.body.classList.remove('sidebar-open'));

document.getElementById('closePanelBtn').addEventListener('click', () => { 
  bottomPanel.classList.remove('open'); 
  routeMatchLayer.clearLayers(); 
});

togglePanelSizeBtn.addEventListener('click', () => { 
  bottomPanel.classList.toggle('minimized'); 
  if (bottomPanel.classList.contains('minimized')) {
    panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up'); 
  } else {
    panelIcon.classList.replace('fa-chevron-up', 'fa-chevron-down'); 
  }
});

fetch('tainan_districts.geojson')
  .then(r=>r.json())
  .then(data=>{
    L.geoJSON(data, { 
      interactive: false, 
      style: f => { 
        const isTarget = (f.properties.TOWNNAME||f.properties.TOWN).includes('山上'); 
        return { color: '#d500f9', weight: isTarget ? 4 : 1, opacity: 1, dashArray: isTarget ? '15, 10' : '', fillOpacity: 0 }; 
      } 
    }).addTo(boundaryLayer);
  }).catch(e=>{});

const VILLAGE_COLORS = { "明和里": "#E74C3C", "山上里": "#F39C12", "南洲里": "#F1C40F", "新莊里": "#2ECC71", "平陽里": "#1ABC9C", "豐德里": "#9B59B6", "玉峯里": "#FF69B4", "玉峰里": "#FF69B4" };

fetch('t22.json').then(r => r.json()).then(topology => {
  villageGeoJSON = topojson.feature(topology, topology.objects.t22);
  const villageNames = villageGeoJSON.features.map(f => f.properties.VILLAGE || f.properties.VILLNAME).sort();
  
  const vSelSearch = document.getElementById('villageSelect');
  const vSelStats = document.getElementById('statsVillageSelect');
  
  vSelSearch.innerHTML = '<option value="">-- 請選擇里別 --</option>';
  vSelStats.innerHTML = '<option value="">-- 請選擇里別 --</option>';
  
  villageNames.forEach(v => {
    vSelSearch.appendChild(new Option(v, v)); 
    vSelStats.appendChild(new Option(v, v));
  });
  
  const villageLayer = L.geoJSON(villageGeoJSON, {
    style: function(f) { 
      const color = VILLAGE_COLORS[f.properties.VILLAGE || f.properties.VILLNAME] || "#999"; 
      return { fillColor: color, fillOpacity: 0.1, color: color, weight: 1, opacity: 0.4, dashArray: '5, 5' }; 
    },
    onEachFeature: function(f, l) { 
      l.on('mouseover', function() { this.setStyle({ fillOpacity: 0.4, weight: 2, color: '#FFD700', dashArray: '' }); }); 
      l.on('mouseout', function() { villageLayer.resetStyle(this); }); 
    }
  }).addTo(boundaryLayer);
  villageLayer.bringToBack();
}).catch(e => {});

function getVillageName(lat, lng) {
  if (!villageGeoJSON) return "讀取資料中..."; 
  const pt = turf.point([lng, lat]);
  for (const f of villageGeoJSON.features) { 
    if (turf.booleanPointInPolygon(pt, f)) {
      return `山上區 ${f.properties.VILLAGE || f.properties.VILLNAME || "未知里"}`; 
    }
  }
  return "非山上區範圍";
}

document.getElementById('villageSelect').addEventListener('change', function() {
  const selectedVillage = this.value; 
  const status = document.getElementById('searchStatus');
  const clearBtn = document.getElementById('clearSearchBtn');
  
  document.getElementById('keywordInput').value = ''; 
  document.getElementById('contractorSelect').value = ''; 
  document.getElementById('timingSelect').value = ''; 
  searchResultLayer.clearLayers();
  
  if (!selectedVillage || selectedVillage === "") { 
    status.innerHTML = ''; 
    clearBtn.style.display = 'none'; 
    return; 
  }
  
  const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage); 
  if (!villageFeature) return;
  
  let count = 0;
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if (!data || !data.features) return;
    
    data.features.forEach(f => {
      if(f.geometry.type === 'Point' && turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
        const ll = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
        L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6, interactive: false }).addTo(searchResultLayer);
        const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
        
        marker.customData = { configLabel: conf.label, props: f.properties, storeId: generateStoreId(f.properties) };
        attachPopupEvents(marker, searchResultLayer.getLayers());
        count++;
      }
    });
  });
  
  if (count > 0) { 
    map.fitBounds(L.geoJSON(villageFeature).getBounds()); 
    if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); 
    status.innerHTML = `${selectedVillage} 找到 <b style="color:#d32f2f">${count}</b> 筆`; 
    clearBtn.style.display = 'block'; 
  } else { 
    status.innerHTML = '<span style="color:red">查無資料</span>'; 
    map.fitBounds(L.geoJSON(villageFeature).getBounds()); 
  }
  
  if(clusterToggle.checked) setTimeout(calculateClusters, 100);
});

document.getElementById('statsVillageSelect').addEventListener('change', function() {
  const selectedVillage = this.value; 
  const statsResult = document.getElementById('statsResult');
  const statsGenList = document.getElementById('statsGenList');
  const statsEmgList = document.getElementById('statsEmgList');
  
  searchResultLayer.clearLayers(); 
  statsGenList.innerHTML = ''; 
  statsEmgList.innerHTML = '';
  
  if (!selectedVillage || selectedVillage === "") { 
    statsResult.style.display = 'none'; 
    return; 
  }
  
  const villageFeature = villageGeoJSON.features.find(f => (f.properties.VILLAGE || f.properties.VILLNAME) === selectedVillage); 
  if (!villageFeature) return;
  
  let globalYearTotals = {};
  let globalProcessedCases = new Set();
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if (!data || !data.features) return;
    
    const year = (conf.label.match(/(\d{3})年/) || [])[1] || '其他'; 
    const isEmergency = /搶修|災害|緊急/.test(conf.label);
    
    if (!globalYearTotals[year]) globalYearTotals[year] = { gen: 0, emg: 0 };
    
    data.features.forEach(f => {
      const caseNo = f.properties['案件編號'];
      const amount = formatMoney(f.properties['決標金額']);
      
      if (caseNo && caseNo.trim() !== "") { 
        if (!globalProcessedCases.has(caseNo)) { 
          globalProcessedCases.add(caseNo); 
          if (isEmergency) globalYearTotals[year].emg += amount; 
          else globalYearTotals[year].gen += amount; 
        } 
      } else { 
        if (isEmergency) globalYearTotals[year].emg += amount; 
        else globalYearTotals[year].gen += amount; 
      }
    });
  });
  
  let villageYearStats = {};
  let villageProcessedCases = new Set();
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if (!data || !data.features) return;
    
    const year = (conf.label.match(/(\d{3})年/) || [])[1] || '其他'; 
    const isEmergency = /搶修|災害|緊急/.test(conf.label);
    
    if (!villageYearStats[year]) villageYearStats[year] = { genCount: 0, genAmount: 0, emgCount: 0, emgAmount: 0 };
    
    data.features.forEach(f => {
      if (f.geometry.type === 'Point' && turf.booleanPointInPolygon(turf.point(f.geometry.coordinates), villageFeature)) {
        const ll = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
        L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6 }).addTo(searchResultLayer);
        
        const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
        marker.customData = { configLabel: conf.label, props: f.properties, storeId: generateStoreId(f.properties) };
        attachPopupEvents(marker, searchResultLayer.getLayers());
        
        const caseNo = f.properties['案件編號'];
        const amount = formatMoney(f.properties['決標金額']);
        let shouldAdd = false; 
        
        if (caseNo && caseNo.trim() !== "") { 
          if (!villageProcessedCases.has(caseNo)) { 
            villageProcessedCases.add(caseNo); 
            shouldAdd = true; 
          } 
        } else { 
          shouldAdd = true; 
        }
        
        if (shouldAdd) { 
          if (isEmergency) { 
            villageYearStats[year].emgCount++; 
            villageYearStats[year].emgAmount += amount; 
          } else { 
            villageYearStats[year].genCount++; 
            villageYearStats[year].genAmount += amount; 
          } 
        }
      }
    });
  });
  
  Object.keys(villageYearStats).sort().reverse().forEach(y => {
    const stats = villageYearStats[y];
    const globalTotals = globalYearTotals[y] || { gen: 1, emg: 1 };
    
    if (stats.genCount > 0) {
      const pct = globalTotals.gen > 0 ? (stats.genAmount / globalTotals.gen * 100).toFixed(0) : 0;
      statsGenList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}年度</span><span class="stat-percent-text">佔全區 ${pct}%</span></div><div class="stat-data-row">${stats.genCount} 件 / $ ${stats.genAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`;
    }
    if (stats.emgCount > 0) {
      const pct = globalTotals.emg > 0 ? (stats.emgAmount / globalTotals.emg * 100).toFixed(0) : 0;
      statsEmgList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}年度</span><span class="stat-percent-text">佔全區 ${pct}%</span></div><div class="stat-data-row">${stats.emgCount} 件 / $ ${stats.emgAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`;
    }
  });
  
  if (statsGenList.innerHTML === '') statsGenList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';
  if (statsEmgList.innerHTML === '') statsEmgList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';
  
  map.fitBounds(L.geoJSON(villageFeature).getBounds()); 
  if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); 
  statsResult.style.display = 'block';
});

document.getElementById('clearStatsBtn').addEventListener('click', function() { 
  searchResultLayer.clearLayers(); 
  document.getElementById('statsVillageSelect').value = ""; 
  document.getElementById('statsResult').style.display = 'none'; 
});

fetch('farmroads.geojson').then(r=>r.json()).then(data=>{
  roadsLayer = L.geoJSON(data, {
    style: { color: DEEP_BLUE, weight: 3, opacity: 0.9 }, 
    onEachFeature: (f, l) => {
      l.bindTooltip(f.properties?.name || "道路", { sticky: true, direction: 'top' });
      l.on('mouseover', () => { l.setStyle({ weight: 5, color: LIGHT_BLUE }); map.getContainer().style.cursor='pointer'; });
      l.on('mouseout', () => { l.setStyle({ weight: 3, color: DEEP_BLUE }); map.getContainer().style.cursor='default'; });
      l.on('click', (e) => { 
        L.DomEvent.stopPropagation(e); 
        handleMapClickSelection(roadLayersArray.indexOf(l), true); 
        if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); 
      });
    }
  }).addTo(map);
  
  roadLayersArray = roadsLayer.getLayers();
  const sel = document.getElementById('roadSelect'); 
  sel.innerHTML = '<option value="">-- 請選擇路線 --</option>';
  data.features.forEach((f, i) => sel.appendChild(new Option(f.properties?.name || `路線 ${i+1}`, i)));
}).catch(e=>{});

async function loadRepairSettings() {
  const box = document.getElementById('repairCheckboxes');
  try { 
    const res = await fetch('repair_months.json'); 
    REPAIR_CONFIG = await res.json(); 
  } catch (e) { 
    box.innerHTML = '讀取失敗'; return; 
  }
  
  if(REPAIR_CONFIG.length === 0) { box.innerHTML = '無資料'; return; }
  
  box.innerHTML = ''; 
  const grouped = {};
  REPAIR_CONFIG.forEach(item => { 
    const y = (item.label.match(/(\d{3})年/) || [])[1] || '其他'; 
    if(!grouped[y]) grouped[y] = []; 
    grouped[y].push(item); 
  });
  
  Object.keys(grouped).sort((a,b)=>b-a).forEach((y, idx) => {
    const gDiv = document.createElement('div'); 
    gDiv.className = 'year-group'; 
    if(idx===0) gDiv.classList.add('open');
    
    gDiv.innerHTML = `
      <div class="year-header" onclick="this.parentElement.classList.toggle('open')">
        <div><span class="toggle-icon">▶</span> ${y}年度</div>
        <label class="year-select-all" onclick="event.stopPropagation()">
          <input type="checkbox" onchange="toggleYear(this)"> 全選
        </label>
      </div>
      <div class="year-content">
        ${grouped[y].map(item => `
          <div class="checkbox-item">
            <input type="checkbox" value="${item.value}" class="repair-cb" onchange="updateRepairPoints()">
            <label>${item.label}</label>
          </div>`).join('')}
      </div>
    `; 
    box.appendChild(gDiv);
  });
  preloadAllDataForContractors();
}
loadRepairSettings();

window.toggleYear = function(source) { 
  source.closest('.year-group').querySelectorAll('.repair-cb').forEach(cb => cb.checked = source.checked); 
  updateRepairPoints(); 
}

function distToRoad(latlng, roadLayer) {
  if(!roadLayer || !turf) return NaN;
  try {
    let min = Infinity;
    roadLayer.eachLayer(l => {
      if(!l.feature.geometry) return;
      const geom = l.feature.geometry;
      const line = geom.type==='LineString' ? turf.lineString(geom.coordinates) : (geom.type==='MultiLineString' ? turf.multiLineString(geom.coordinates) : null);
      if(line) { 
        const d = turf.pointToLineDistance(turf.point([latlng.lng, latlng.lat]), line, {units:'meters'}); 
        if(d < min) min = d; 
      }
    });
    return min===Infinity ? NaN : min;
  } catch(e) { return NaN; }
}

function updateRepairPoints() {
  if(markersClusterGroup) { 
    markersClusterGroup.clearLayers(); 
    map.removeLayer(markersClusterGroup); 
    markersClusterGroup = null; 
  }
  
  activeRepairLayers = []; 
  CURRENT_MAP_GROUPS = {}; 
  const panel = document.getElementById('clusterControlPanel');
  const toggleBtn = document.getElementById('toggleClusterControlBtn');
  
  document.querySelectorAll('.repair-cb:checked').forEach(cb => {
    const fileKey = cb.value;
    if(REPAIR_DATA_CACHE[fileKey]) {
      const data = REPAIR_DATA_CACHE[fileKey];
      const config = REPAIR_CONFIG.find(c => c.value === fileKey);
      data.features.forEach(f => {
        if(f.geometry.type === 'Point') {
          const key = f.geometry.coordinates.join(',');
          if(!CURRENT_MAP_GROUPS[key]) CURRENT_MAP_GROUPS[key] = [];
          CURRENT_MAP_GROUPS[key].push({ feature: f, configLabel: config.label, latlng: L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]) });
        }
      });
    }
  });
  
  Object.keys(CURRENT_MAP_GROUPS).forEach(key => {
    const group = CURRENT_MAP_GROUPS[key];
    const firstItem = group[0];
    const pt = firstItem.latlng;
    const dist = distToRoad(pt, roadsLayer);
    const isFar = (!isNaN(dist) && dist > 30);
    const color = isFar ? '#ef4444' : '#004080';
    
    const icon = L.divIcon({ 
      html: `<div style="width:14px; height:14px; background:${color}; border:2px solid #fff; border-radius:50%; box-shadow:0 2px 4px rgba(0,0,0,0.2);"></div>`, 
      className: 'custom-dot-marker', iconSize: [18, 18], iconAnchor: [9, 9] 
    });
    
    const marker = L.marker(pt, { icon: icon });
    marker.customData = { group: group, configLabel: firstItem.configLabel, props: firstItem.feature.properties, storeId: generateStoreId(firstItem.feature.properties) };
    attachPopupEvents(marker, activeRepairLayers);
    marker.feature = firstItem.feature; 
    activeRepairLayers.push(marker);
  });
  
  if (activeRepairLayers.length === 0) { 
    panel.style.display = 'none'; 
    toggleBtn.classList.remove('active'); 
  }
  
  renderClusterGroup(); 
  calculateClusters(); 
}

window.handleNearbyMarkerClick = function(e, sourceLayers) {
  const clickPoint = map.latLngToContainerPoint(e.latlng);
  const candidates = [];
  
  sourceLayers.forEach(layer => {
    if (!map.getBounds().contains(layer.getLatLng())) return;
    if (map.latLngToContainerPoint(layer.getLatLng()).distanceTo(clickPoint) <= 30 && layer.customData) 
      candidates.push(layer);
  });

  if (candidates.length > 1) {
    showMultiSelectPopup(e.latlng, candidates);
    if(selectedTimelineMarker) { 
      selectedTimelineMarker.setStyle({ radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }); 
      selectedTimelineMarker = null; 
    }
  } else {
    const targetMarker = candidates.length > 0 ? candidates[0] : e.target;
    if(selectedTimelineMarker && selectedTimelineMarker !== targetMarker) { 
      selectedTimelineMarker.setStyle({ radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }); 
      selectedTimelineMarker = null; 
    }
    openDetailPopupFromMarker(targetMarker);
  }
};

window.showMultiSelectPopup = function(latlng, markers) {
  markers.forEach(m => { 
    const p = m.customData && m.customData.props; 
    if(p) preloadImages(getPhotosFromProps(p)); 
  });
  
  let html = `<div class="multi-select-popup"><div class="info-header">請選擇案件 (${markers.length})</div><div style="max-height:250px; overflow-y:auto;">`;
  
  markers.forEach((m, idx) => {
    const data = m.customData || {};
    const isGroup = data.group && data.group.length > 1;
    const title = data.configLabel || "案件";
    const props = data.props || {};
    const twd = twd97FromWgs84(m.getLatLng().lat, m.getLatLng().lng);
    window[`_temp_marker_${idx}`] = m;
    
    html += `
    <div class="multi-select-item" onclick="window.triggerMarkerPopup(${idx})">
      <div class="multi-select-title">${idx+1}. ${title} ${isGroup ? `<span style='font-size:10px;background:#d32f2f;color:fff;padding:1px 4px;border-radius:3px;'>重疊${data.group.length}筆</span>` : ''}</div>
      <div class="multi-select-meta">
        <span><i class="fas fa-barcode"></i> ${props['案件編號'] || '無編號'}</span>
        <span><i class="fas fa-calendar-alt"></i> ${props['完工日期'] || ''}</span>
        ${props['搶修類型'] ? `<span class="badge-type">${props['搶修類型']}</span>` : ''}
      </div>
      <div class="multi-select-meta" style="margin-top:2px; color:#555; font-size:10px;">
        <span><i class="fas fa-map-marker-alt"></i> TWD97: ${twd.x}, ${twd.y}</span>
      </div>
    </div>`;
  });
  L.popup({ className: 'custom-popup', maxWidth: 300 }).setLatLng(latlng).setContent(html + `</div></div>`).openOn(map);
};

window.triggerMarkerPopup = function(idx) {
  const m = window[`_temp_marker_${idx}`];
  if(m) { 
    map.closePopup(); 
    openDetailPopupFromMarker(m); 
  }
};

window.openDetailPopupFromMarker = function(marker) {
  const data = marker.customData;
  if(!data) return;
  
  if (data.group && data.group.length > 1) {
    let listHtml = `<div class="info-header" style="padding:10px;background:#004080;color:white;font-weight:bold;">重複座標點位資訊 (${data.group.length}筆)</div><div class="info-body" style="padding:10px;max-height:250px; overflow-y:auto;"><div style="font-size:12px; color:#666; margin-bottom:5px;">點擊案件名稱可查看詳細資料</div>`;
    data.group.forEach((item, index) => { 
      window[`_temp_group_item_${index}`] = item; 
      listHtml += `<div style="border-bottom:1px dashed #ccc; padding:8px 0; cursor:pointer;" onclick="openSingleGroupItem(${index})"><b style="color:#004080; text-decoration:underline;">${index+1}. ${item.configLabel}</b><br><span style="color:#333; font-size:12px;">案件編號: ${item.feature.properties['案件編號']||'無'}<br>完工日期: ${item.feature.properties['完工日期']||'無'}</span></div>`; 
    });
    L.popup({ className: 'custom-popup', maxWidth: 300 }).setLatLng(marker.getLatLng()).setContent(listHtml + `</div>`).openOn(map);
  } else {
    const dist = distToRoad(marker.getLatLng(), roadsLayer);
    const content = createPopup({ fileName: data.configLabel, props: data.props, lat: marker.getLatLng().lat, lng: marker.getLatLng().lng, dist: dist });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(marker.getLatLng()).setContent(content).openOn(map);
    fetchAndRefreshComments(data.storeId, data.props['案件編號']);
  }
};

window.openSingleGroupItem = function(index) {
  const item = window[`_temp_group_item_${index}`];
  if(item) {
    const dist = distToRoad(item.latlng, roadsLayer);
    const content = createPopup({ fileName: item.configLabel, props: item.feature.properties, lat: item.latlng.lat, lng: item.latlng.lng, dist: dist });
    L.popup({className:'custom-popup', maxWidth:960}).setLatLng(item.latlng).setContent(content).openOn(map);
    fetchAndRefreshComments(generateStoreId(item.feature.properties), item.feature.properties['案件編號']);
  }
};

function renderClusterGroup() {
  const sliderVal = parseInt(document.getElementById('clusterRadiusSlider').value);
  if (markersClusterGroup) map.removeLayer(markersClusterGroup);
  
  markersClusterGroup = L.markerClusterGroup({ 
    maxClusterRadius: sliderVal, 
    disableClusteringAtZoom: 18, 
    spiderfyOnMaxZoom: true, 
    showCoverageOnHover: false, 
    zoomToBoundsOnClick: true 
  });
  
  markersClusterGroup.addLayers(activeRepairLayers); 
  map.addLayer(markersClusterGroup);
}

document.getElementById('clusterRadiusSlider').addEventListener('input', function() { 
  document.getElementById('clusterRadiusVal').innerText = `範圍 ${this.value}px`; 
  renderClusterGroup(); 
});

document.getElementById('toggleClusterControlBtn').addEventListener('click', function() { 
  if (activeRepairLayers.length === 0) return alert("請先至「透明」分頁勾選欲顯示的案件資料。"); 
  const panel = document.getElementById('clusterControlPanel');
  const isVisible = panel.style.display === 'block'; 
  panel.style.display = isVisible ? 'none' : 'block'; 
  this.classList.toggle('active'); 
});

document.getElementById('closeClusterControlBtn').addEventListener('click', function() { 
  document.getElementById('clusterControlPanel').style.display = 'none'; 
  document.getElementById('toggleClusterControlBtn').classList.remove('active'); 
});

function renderTypeCheckboxes() {
  const container = document.getElementById('typeCheckboxList'); 
  if(!container) return; 
  container.innerHTML = '';
  
  Array.from(ALL_TYPES).sort().forEach(type => {
    container.innerHTML += `<div class="checkbox-item"><label><input type="checkbox" value="${type}" class="type-filter-cb" onchange="updateTypeSelection()"> ${type}</label></div>`;
  });
  updateTypeSelection();
}

window.toggleTypeFilter = function() { 
  document.getElementById('typeFilterContainer').classList.toggle('open'); 
};

window.toggleAllTypes = function(source) { 
  document.querySelectorAll('.type-filter-cb').forEach(cb => cb.checked = source.checked); 
  updateTypeSelection(); 
};

window.updateTypeSelection = function() {
  const checkedBoxes = document.querySelectorAll('.type-filter-cb:checked');
  const label = document.getElementById('typeFilterLabel');
  const total = document.querySelectorAll('.type-filter-cb').length;
  
  if(checkedBoxes.length === total && total > 0) {
    label.innerText = `請選擇維修類型 (全選)`; 
  } else if (checkedBoxes.length === 0) {
    label.innerText = `請選擇維修類型 (未選)`; 
  } else {
    label.innerText = `維修類型 (已選 ${checkedBoxes.length} 項)`;
  }
  
  const selectedSet = new Set(); 
  checkedBoxes.forEach(cb => selectedSet.add(cb.value));
  
  document.getElementById('keywordInput').value=''; 
  document.getElementById('villageSelect').value=''; 
  document.getElementById('contractorSelect').value=''; 
  document.getElementById('timingSelect').value=''; 
  
  if (selectedSet.size > 0) {
    performSearch(p => {
      const types = (p['搶修類型'] || '').split(/[,，]/).map(s => s.trim());
      return types.some(t => selectedSet.has(t));
    }, `維修類型篩選`);
  } else {
    clearSearchResults();
  }
};

async function preloadAllDataForContractors() {
  const cSel = document.getElementById('contractorSelect');
  const tSel = document.getElementById('timingSelect');
  
  await Promise.all(REPAIR_CONFIG.map(async item => {
    if (!REPAIR_DATA_CACHE[item.value]) { 
      try { 
        const res = await fetch(item.value + '.geojson'); 
        if(res.ok) { 
          const json = await res.json(); 
          REPAIR_DATA_CACHE[item.value] = json; 
          json.features?.forEach(f => { 
            const c = f.properties['施工廠商']?.trim();
            const t = f.properties['派工時機']?.trim();
            const typeRaw = f.properties['搶修類型']?.trim(); 
            if(c) ALL_CONTRACTORS.add(c); 
            if(t) ALL_TIMINGS.add(t);
            if(typeRaw) typeRaw.split(/[,，]/).forEach(p => { if(p.trim()) ALL_TYPES.add(p.trim()); });
          }); 
        } 
      } catch(e){}
    }
  }));
  
  cSel.innerHTML = '<option value="">-- 請選擇廠商 --</option>' + Array.from(ALL_CONTRACTORS).sort().map(c => `<option value="${c}">${c}</option>`).join('');
  cSel.addEventListener('change', function() { 
    if(this.value) { 
      document.getElementById('keywordInput').value=''; 
      document.getElementById('villageSelect').value=''; 
      document.getElementById('timingSelect').value=''; 
      resetTypeCheckboxesToNone(); 
      performSearch(p=>p['施工廠商']?.trim()===this.value, `廠商：${this.value}`); 
      updateContractorStats(this.value); 
    } else { 
      clearSearchResults(); 
    } 
  });
  
  tSel.innerHTML = '<option value="">-- 請選擇派工時機 --</option>' + Array.from(ALL_TIMINGS).sort().map(t => `<option value="${t}">${t}</option>`).join('');
  tSel.addEventListener('change', function() {
    if(this.value) { 
      document.getElementById('keywordInput').value=''; 
      document.getElementById('villageSelect').value=''; 
      document.getElementById('contractorSelect').value=''; 
      resetTypeCheckboxesToNone(); 
      performSearch(p=>p['派工時機']?.trim()===this.value, `派工時機：${this.value}`); 
    } else { 
      clearSearchResults(); 
    } 
  });
  
  renderTypeCheckboxes();
}

function resetTypeCheckboxesToNone() {
  if(document.getElementById('typeSelectAll')) { 
    document.getElementById('typeSelectAll').checked = false; 
    document.querySelectorAll('.type-filter-cb').forEach(cb => cb.checked = false); 
    document.getElementById('typeFilterLabel').innerText = `請選擇維修類型 (未選)`; 
  }
}

function updateContractorStats(contractorName) {
  const statsResult = document.getElementById('contractorStatsResult');
  const genList = document.getElementById('contractorGenList');
  const emgList = document.getElementById('contractorEmgList');
  
  genList.innerHTML = ''; 
  emgList.innerHTML = '';
  
  if (!contractorName) { 
    statsResult.style.display = 'none'; 
    return; 
  }
  
  let globalYearTotals = {};
  let globalProcessedCases = new Set();
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if (!data || !data.features) return;
    const year = (conf.label.match(/(\d{3})年/) || [])[1] || '其他'; 
    const isEmergency = /搶修|災害|緊急/.test(conf.label);
    
    if (!globalYearTotals[year]) globalYearTotals[year] = { gen: 0, emg: 0 };
    
    data.features.forEach(f => {
      const caseNo = f.properties['案件編號'];
      const amount = formatMoney(f.properties['決標金額']);
      if (caseNo && caseNo.trim() !== "") { 
        if (!globalProcessedCases.has(caseNo)) { 
          globalProcessedCases.add(caseNo); 
          if (isEmergency) globalYearTotals[year].emg += amount; 
          else globalYearTotals[year].gen += amount; 
        } 
      } else { 
        if (isEmergency) globalYearTotals[year].emg += amount; 
        else globalYearTotals[year].gen += amount; 
      }
    });
  });
  
  let contractorYearStats = {};
  let contractorProcessedCases = new Set();
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if (!data || !data.features) return;
    const year = (conf.label.match(/(\d{3})年/) || [])[1] || '其他'; 
    const isEmergency = /搶修|災害|緊急/.test(conf.label);
    
    if (!contractorYearStats[year]) contractorYearStats[year] = { genCount: 0, genAmount: 0, emgCount: 0, emgAmount: 0 };
    
    data.features.forEach(f => {
      if (f.properties['施工廠商']?.trim() === contractorName) {
        const caseNo = f.properties['案件編號'];
        const amount = formatMoney(f.properties['決標金額']);
        let shouldAdd = false; 
        
        if (caseNo && caseNo.trim() !== "") { 
          if (!contractorProcessedCases.has(caseNo)) { 
            contractorProcessedCases.add(caseNo); 
            shouldAdd = true; 
          } 
        } else { 
          shouldAdd = true; 
        }
        
        if (shouldAdd) { 
          if (isEmergency) { 
            contractorYearStats[year].emgCount++; 
            contractorYearStats[year].emgAmount += amount; 
          } else { 
            contractorYearStats[year].genCount++; 
            contractorYearStats[year].genAmount += amount; 
          } 
        }
      }
    });
  });
  
  Object.keys(contractorYearStats).sort().reverse().forEach(y => {
    const stats = contractorYearStats[y];
    const globalTotals = globalYearTotals[y] || { gen: 1, emg: 1 };
    if (stats.genCount > 0) { 
      const pct = globalTotals.gen > 0 ? (stats.genAmount / globalTotals.gen * 100).toFixed(0) : 0; 
      genList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}年度</span><span class="stat-percent-text">市佔 ${pct}%</span></div><div class="stat-data-row">${stats.genCount} 件 / $ ${stats.genAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`; 
    }
    if (stats.emgCount > 0) { 
      const pct = globalTotals.emg > 0 ? (stats.emgAmount / globalTotals.emg * 100).toFixed(0) : 0; 
      emgList.innerHTML += `<div class="stat-year-row"><div class="stat-year-title"><span>${y}年度</span><span class="stat-percent-text">市佔 ${pct}%</span></div><div class="stat-data-row">${stats.emgCount} 件 / $ ${stats.emgAmount.toLocaleString()}</div><div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${pct}%"></div></div></div>`; 
    }
  });
  
  if (genList.innerHTML === '') genList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';
  if (emgList.innerHTML === '') emgList.innerHTML = '<div style="color:#999;font-size:12px;text-align:center;padding:10px;">無資料</div>';
  statsResult.style.display = 'block';
}

function clearSearchResults() { 
  searchResultLayer.clearLayers(); 
  document.getElementById('keywordInput').value = ''; 
  document.getElementById('contractorSelect').value = ''; 
  document.getElementById('villageSelect').value = ''; 
  document.getElementById('timingSelect').value = ''; 
  resetTypeCheckboxesToNone(); 
  document.getElementById('searchStatus').innerHTML = ''; 
  document.getElementById('clearSearchBtn').style.display = 'none'; 
  document.getElementById('contractorStatsResult').style.display = 'none'; 
}

document.getElementById('clearSearchBtn').addEventListener('click', clearSearchResults);

async function performSearch(predicate, label) {
  const status = document.getElementById('searchStatus');
  const btn = document.getElementById('searchBtn');
  
  btn.disabled = true; 
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
  status.innerText = '搜尋中...'; 
  searchResultLayer.clearLayers();
  
  let count = 0;
  let targetMarker = null;

  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if(!data || !data.features) return;
    
    data.features.forEach(f => {
      if(f.geometry.type === 'Point' && predicate(f.properties)) {
        const ll = L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]);
        L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6, interactive: false }).addTo(searchResultLayer);
        
        const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
        marker.customData = { configLabel: conf.label, props: f.properties, storeId: generateStoreId(f.properties) };
        attachPopupEvents(marker, searchResultLayer.getLayers());
        marker.feature = f; 
        targetMarker = marker; 
        count++;
      }
    });
  });

  realtimeLayer.eachLayer(layer => {
    if (layer.customData && layer.customData.props && predicate(layer.customData.props)) {
      const ll = layer.getLatLng();
      L.circleMarker(ll, { radius: 18, fillColor: '#ffd700', color: '#ff8c00', weight: 2, fillOpacity: 0.6, interactive: false }).addTo(searchResultLayer);
      
      const marker = L.circleMarker(ll, { radius: 6, fillColor: '#d32f2f', color: '#fff', weight: 1, fillOpacity: 1 }).addTo(searchResultLayer);
      marker.customData = layer.customData;
      attachPopupEvents(marker, searchResultLayer.getLayers());
      marker.feature = { geometry: { type: 'Point', coordinates: [ll.lng, ll.lat] }, properties: layer.customData.props };
      targetMarker = marker;
      count++;
    }
  });
  
  if(count > 0) { 
    if (count === 1 && targetMarker) {
      window.lockedPopupMarker = true;
      map.flyTo(targetMarker.getLatLng(), 18, { duration: 0.8 });
      setTimeout(() => {
        openDetailPopupFromMarker(targetMarker);
      }, 900);
    } else {
      map.fitBounds(searchResultLayer.getBounds()); 
    }

    if(window.innerWidth <= 768) document.body.classList.remove('sidebar-open'); 
    status.innerHTML = `找到 <b style="color:#d32f2f">${count}</b> 筆`; 
    document.getElementById('clearSearchBtn').style.display = 'block'; 
  } else {
    status.innerHTML = '<span style="color:red">查無資料</span>';
  }
  
  btn.disabled = false; 
  btn.innerHTML = '<i class="fas fa-search"></i> 開始搜尋';
  
  if(clusterToggle.checked) setTimeout(calculateClusters, 100);
}

document.getElementById('searchBtn').addEventListener('click', async () => {
  const kw = document.getElementById('keywordInput').value.trim().toLowerCase();
  if(!kw) return alert('請輸入關鍵字');
  
  document.getElementById('contractorSelect').value = ''; 
  document.getElementById('villageSelect').value = ''; 
  document.getElementById('timingSelect').value = ''; 
  resetTypeCheckboxesToNone(); 
  document.getElementById('contractorStatsResult').style.display = 'none';
  
  const rtToggle = document.getElementById('realtimeToggle');
  if (!isRealtimeLoaded || !rtToggle.checked) {
    const loadingOverlay = document.getElementById('searchLoadingOverlay');
    if(loadingOverlay) {
      document.getElementById('searchLoadingText').innerText = "正在為您找尋相關通報";
      loadingOverlay.style.display = 'flex';
    }
    if(rtToggle) rtToggle.checked = true;
    await toggleRealtimeLayer(rtToggle);
    if(loadingOverlay) loadingOverlay.style.display = 'none';
  }

  performSearch(p => Object.values(p).join(' ').toLowerCase().includes(kw), kw);
});

document.getElementById('roadSelect').addEventListener('change', (e) => handleMapClickSelection(e.target.value, false));

function handleMapClickSelection(idx, isInteractive) {
  if(idx==="" || idx===null) return; 
  
  if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3}));
  
  const target = roadLayersArray[idx];
  if(target) {
    if (document.body.classList.contains('lite-mode')) {
      target.setStyle({ color: 'red', weight: 6 }); 
      map.fitBounds(target.getBounds());
      L.popup().setLatLng(target.getBounds().getCenter()).setContent(`<div style="text-align:center;"><b>${target.feature.properties.name || "道路"}</b><br><span style="font-size:12px;color:#666;">公眾通行道路範圍。<br>如需查詢歷史維修紀錄，請切換至「公開查詢版」。</span></div>`).openOn(map);
      return;
    }
    
    target.setStyle({ color: 'red', weight: 6 }); 
    map.fitBounds(target.getBounds()); 
    target.openPopup();
    
    if (isInteractive) { 
      document.getElementById('panelTitle').innerHTML = `<i class="fas fa-history"></i> ${target.feature.properties.name}`; 
      bottomPanel.classList.remove('minimized'); 
      panelIcon.classList.replace('fa-chevron-down', 'fa-chevron-up'); 
      bottomPanel.classList.add('open'); 
      showTimeline(target); 
    } else { 
      bottomPanel.classList.remove('open'); 
      routeMatchLayer.clearLayers(); 
    }
  }
}

// === 地圖點擊與右鍵選單 ===
map.on('click', (e) => {
  if(isMeasuring) { 
    if(measureStartLatLng) finishMeasure(e.latlng); 
  } else { 
    window.lockedPopupMarker = false;
    
    document.getElementById('contextMenu').style.display='none'; 
    document.getElementById('roadSelect').value = ""; 
    if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({ color: DEEP_BLUE, weight: 3 })); 
    map.closePopup(); 
    
    if(lockedTimelineMarker) { 
      lockedTimelineMarker.setStyle({ radius: 14, color: '#fff',fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }); 
      lockedTimelineMarker = null; 
    }
    if(selectedTimelineMarker) { 
      selectedTimelineMarker.setStyle({ radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 }); 
      selectedTimelineMarker = null; 
    }
    
    bottomPanel.classList.remove('open'); 
    routeMatchLayer.clearLayers(); 
  }
});

const ctxMenu = document.getElementById('contextMenu'); 
let clickedLatLng = null;

map.on('contextmenu', (e) => {
  ctxMenu.style.display = 'none'; 
  pointLayer.clearLayers(); 
  measureLayer.clearLayers(); 
  isMeasuring = false; 
  document.body.classList.remove('measuring'); 
  measureStartLatLng = null;
  
  const latlng = e.latlng; 
  const twd = twd97FromWgs84(latlng.lat, latlng.lng); 
  const villageName = getVillageName(latlng.lat, latlng.lng);
  
  const marker = L.marker(latlng, { draggable: true }).addTo(pointLayer); 
  marker.bindPopup(`<div style="font-weight:bold; color:#004080; margin-bottom:5px;">位置資訊</div><div style="font-size:13px;">TWD97: ${twd.x}, ${twd.y}</div><div style="font-size:13px;">WGS84: ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</div><div style="font-size:13px;">行政區: ${villageName}</div><div style="font-size:12px; color:#666; margin-top:5px;">(再點右鍵開啟功能選單)</div>`).openPopup();
  
  marker.on('contextmenu', (ev) => { 
    L.DomEvent.stopPropagation(ev); 
    clickedLatLng = ev.latlng; 
    ctxMenu.style.display = 'block'; 
    ctxMenu.style.left = ev.originalEvent.clientX + 'px'; 
    ctxMenu.style.top = ev.originalEvent.clientY + 'px'; 
  });
});

document.getElementById('ctxStreetView').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxGoogleNav').onclick = () => { if(clickedLatLng) window.open(`https://www.google.com/maps/dir/?api=1&destination=${clickedLatLng.lat},${clickedLatLng.lng}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxCadastral').onclick = () => { if(clickedLatLng) window.open(`https://maps.nlsc.gov.tw/go/${clickedLatLng.lng}/${clickedLatLng.lat}`, '_blank'); ctxMenu.style.display='none'; }
document.getElementById('ctxClearMarker').onclick = () => { pointLayer.clearLayers(); measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring'); measureStartLatLng = null; ctxMenu.style.display='none'; }

document.getElementById('ctxMeasure').onclick = () => { 
  ctxMenu.style.display = 'none'; 
  isMeasuring = true; 
  measureStartLatLng = clickedLatLng; 
  document.body.classList.add('measuring'); 
  L.circleMarker(clickedLatLng, {color: 'green', radius: 5, fillOpacity: 1}).addTo(measureLayer); 
};

function finishMeasure(endLatLng) {
  if(!isMeasuring || !measureStartLatLng) return; 
  const dist = measureStartLatLng.distanceTo(endLatLng).toFixed(1); 
  if(dist == 0) return;
  
  L.polyline([measureStartLatLng, endLatLng], {color: 'red', weight: 3}).addTo(measureLayer);
  L.marker([(measureStartLatLng.lat + endLatLng.lat) / 2, (measureStartLatLng.lng + endLatLng.lng) / 2], {
    icon: L.divIcon({ 
      className: 'measure-label', 
      html: `${dist} m <span class="measure-close-btn" onclick="measureLayer.clearLayers(); isMeasuring = false; document.body.classList.remove('measuring');">X</span>`, 
      iconSize: [100, 20], 
      iconAnchor: [50, 10] 
    })
  }).addTo(measureLayer); 
  
  isMeasuring = false; 
  document.body.classList.remove('measuring'); 
  
  if(measureLine) map.removeLayer(measureLine); 
  if(measureTooltip) map.removeLayer(measureTooltip); 
  measureLine = null; 
  measureTooltip = null; 
  measureStartLatLng = null;
}

map.on('mousemove', e => {
  if(window.innerWidth > 768) { 
    const t = twd97FromWgs84(e.latlng.lat, e.latlng.lng); 
    const el = document.getElementById('floatingCoords'); 
    el.style.display = 'block'; 
    el.innerHTML = `TWD97: ${t.x}, ${t.y}`; 
  }
  
  if(isMeasuring && measureStartLatLng) {
    if(measureLine) {
      measureLine.setLatLngs([measureStartLatLng, e.latlng]); 
    } else {
      measureLine = L.polyline([measureStartLatLng, e.latlng], {color: 'red', dashArray: '5, 10'}).addTo(map);
    }
    
    const dist = measureStartLatLng.distanceTo(e.latlng).toFixed(1);
    
    if(measureTooltip) {
      measureTooltip.setLatLng(e.latlng).setContent(`${dist} m`); 
    } else {
      measureTooltip = L.tooltip({permanent:true, direction:'right'}).setLatLng(e.latlng).setContent(`${dist} m`).addTo(map);
    }
  }
});

document.getElementById('toggleMapBtn').onclick = function() { 
  if(isSat) { map.removeLayer(sat); osm.addTo(map); this.classList.remove('active'); } 
  else { map.removeLayer(osm); sat.addTo(map); this.classList.add('active'); } 
  isSat = !isSat; 
};

document.getElementById('toggleCadastralBtn').onclick = function() { 
  if(isCadastralVisible) { map.removeLayer(cadastralLayer); this.classList.remove('active'); } 
  else { cadastralLayer.addTo(map); this.classList.add('active'); } 
  isCadastralVisible = !isCadastralVisible; 
};

document.getElementById('plotBtn').onclick = () => {
  pointLayer.clearLayers(); 
  const input = document.getElementById('coordsInput').value.trim(); 
  if (!input) return;
  
  const lines = input.split(/\r?\n/).filter(line => line.trim() !== ''); 
  const bounds = L.latLngBounds(); 
  let markerCount = 0;
  
  lines.forEach(line => {
    const parts = line.trim().split(/[, \t]+/).filter(p => p !== '');
    if (parts.length >= 2) {
      const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
      if (!isNaN(x) && !isNaN(y)) {
        try {
          const w = proj4('EPSG:3826', 'EPSG:4326', [x, y]); 
          const latlng = L.latLng(w[1], w[0]);
          L.marker(latlng).addTo(pointLayer).bindPopup(`X:${x}, Y:${y}<br>行政區: ${getVillageName(w[1], w[0])}`); 
          markerCount++; 
          bounds.extend(latlng);
        } catch (e) { }
      }
    }
  });
  
  if (markerCount > 0) { 
    if (markerCount === 1) { 
      map.setView(bounds.getCenter(), 16); 
      pointLayer.getLayers()[0].openPopup(); 
    } else { 
      map.fitBounds(bounds, { padding: [50, 50] }); 
    } 
  } else { 
    alert('請輸入有效的 TWD97 座標'); 
  }
};

window.updateDengueRadius = function() {
  dengueRadiusLayer.clearLayers();
  const checked = document.querySelector('input[name="dengueRadius"]:checked');
  if(!checked) return;
  const radius = parseInt(checked.value);
  
  dengueLayer.eachLayer(marker => {
    L.circle(marker.getLatLng(), {
      radius: radius,
      color: '#e74c3c',
      fillColor: '#e74c3c',
      fillOpacity: 0.1,
      weight: 2,
      dashArray: '5, 5'
    }).addTo(dengueRadiusLayer);
  });
};

document.getElementById('plotDengueBtn').onclick = () => {
  dengueLayer.clearLayers(); 
  const val = document.getElementById('dengueCoordsInput').value.trim(); 
  if(!val) return;
  
  let plotted = false;
  val.split(/\r?\n/).forEach(line => {
    const parts = line.split(/[, \t]+/);
    if(parts.length>=2) {
      const x = parseFloat(parts[0]), y = parseFloat(parts[1]);
      if(!isNaN(x)&&!isNaN(y)) {
        const w = proj4('EPSG:3826','EPSG:4326',[x,y]);
        L.marker([w[1],w[0]], {icon: L.divIcon({ className: 'custom-div-icon', html: "<div class='gray-dot-marker'></div>", iconSize: [14, 14], iconAnchor: [7, 7] })}).addTo(dengueLayer).bindPopup(`確診戶座標: ${x}, ${y}`); 
        map.setView([w[1],w[0]], 16);
        plotted = true;
      }
    }
  });
  
  if (plotted) {
    updateDengueRadius();
  }
};

document.getElementById('clearDengueBtn').onclick = () => { 
  dengueLayer.clearLayers(); 
  dengueRadiusLayer.clearLayers(); 
  document.getElementById('dengueCoordsInput').value=''; 
  document.querySelectorAll('input[name="dengueRadius"]').forEach(r => r.checked = false); 
};

document.getElementById('clearBtn').onclick = () => { 
  pointLayer.clearLayers(); 
  document.getElementById('coordsInput').value=''; 
};

document.getElementById('clearRepairBtn').addEventListener('click', () => {
  if(markersClusterGroup) { 
    markersClusterGroup.clearLayers(); 
    map.removeLayer(markersClusterGroup); 
    markersClusterGroup = null; 
  }
  
  activeRepairLayers = []; 
  document.getElementById('clusterControlPanel').style.display = 'none'; 
  document.getElementById('toggleClusterControlBtn').classList.remove('active');
  document.querySelectorAll('.repair-cb').forEach(cb => cb.checked = false); 
  document.querySelectorAll('.year-select-all input').forEach(cb => cb.checked = false);
  
  clearSearchResults(); 
  pointLayer.clearLayers(); 
  measureLayer.clearLayers(); 
  document.getElementById('coordsInput').value = '';
  
  if(roadsLayer) roadsLayer.eachLayer(l => l.setStyle({color: DEEP_BLUE, weight:3})); 
  document.getElementById('roadSelect').value = "";
  
  clusterLayer.clearLayers(); 
  if(clusterToggle.checked) clusterToggle.checked = false;
  
  document.getElementById('clearDengueBtn').click(); 
  bottomPanel.classList.remove('open'); 
  map.closePopup();
  
  if(document.getElementById('aiRiskToggle').checked) { 
    document.getElementById('aiRiskToggle').checked = false; 
    aiRiskLayer.clearLayers(); 
    document.getElementById('aiDashboard').style.display = 'none'; 
  }
});

const clusterToggle = document.getElementById('clusterToggle');
const clusterSlider = document.getElementById('clusterSlider');
const clusterValue = document.getElementById('clusterValue');

clusterToggle.addEventListener('change', () => { 
  if(clusterToggle.checked) calculateClusters(); 
  else clusterLayer.clearLayers(); 
});

clusterSlider.addEventListener('input', () => { 
  clusterValue.innerText = `${clusterSlider.value}m`; 
  if(clusterToggle.checked) { 
    clearTimeout(window.clusterTimer); 
    window.clusterTimer = setTimeout(calculateClusters, 100); 
  } 
});

function calculateClusters() {
  clusterLayer.clearLayers(); 
  if(!clusterToggle.checked) return; 
  const radius = parseInt(clusterSlider.value); 
  if(radius === 0) return; 
  
  document.body.style.cursor = 'wait';
  
  setTimeout(() => {
    try {
      const points = [];
      activeRepairLayers.forEach(m => { 
        if(m.feature && m.feature.geometry.type === 'Point') points.push(m.feature); 
      });
      searchResultLayer.eachLayer(l => { 
        if(l.feature && l.feature.geometry.type === 'Point') points.push(l.feature); 
      });
      
      if(points.length === 0) { 
        alert("⚠️ 尚未載入任何案件資料！"); 
        clusterToggle.checked = false; 
        document.body.style.cursor = 'default'; 
        return; 
      }
      
      const fc = turf.featureCollection(points);
      const buffered = turf.buffer(fc, radius / 1000, {units: 'kilometers', steps: 10});
      
      let resultGeoJSON = null; 
      try { 
        if (buffered.features.length > 0) { 
          let merged = buffered.features[0]; 
          for (let i = 1; i < buffered.features.length; i++) {
            merged = turf.union(merged, buffered.features[i]); 
          }
          resultGeoJSON = merged; 
        } 
      } catch (unionError) { 
        resultGeoJSON = buffered; 
      }
      
      if (resultGeoJSON) {
        L.geoJSON(resultGeoJSON, { 
          style: { color: 'none', weight: 0, fillColor: '#d32f2f', fillOpacity: 0.3 }, 
          interactive: false 
        }).addTo(clusterLayer).bringToBack();
      }
    } catch (e) { 
      console.error(e); 
    } finally { 
      document.body.style.cursor = 'default'; 
    }
  }, 50);
}

document.getElementById('repairCheckboxes').addEventListener('change', () => { 
  if(clusterToggle.checked) { 
    clearTimeout(window.clusterTimer); 
    window.clusterTimer = setTimeout(calculateClusters, 200); 
  } 
});

// === 【V8 修復】AI 風險預警顯示修復 ===
function toggleAiRiskLayer(checkbox) {
  aiRiskLayer.clearLayers(); 
  document.getElementById('aiDashboard').style.display = 'none'; 
  if(!checkbox.checked) return;
  
  let hasData = false; 
  Object.keys(REPAIR_DATA_CACHE).forEach(key => { 
    if(REPAIR_DATA_CACHE[key].features && REPAIR_DATA_CACHE[key].features.length > 0) hasData = true; 
  });
  
  if(!hasData) { 
    alert("⚠️ 無法進行 AI 分析！\n系統尚未載入任何歷史案件資料。"); 
    checkbox.checked = false; 
    return; 
  }
  
  document.getElementById('aiLoading').style.display = 'block';
  
  setTimeout(() => {
    let allPoints = [];
    Object.keys(REPAIR_DATA_CACHE).forEach(key => {
      if(REPAIR_DATA_CACHE[key].features) {
        REPAIR_DATA_CACHE[key].features.forEach(f => {
          if(f.geometry.type === 'Point') {
            allPoints.push({ lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0], type: f.properties['搶修類型'] || '', props: f.properties });
          }
        });
      }
    });
    
    let clusters = [];
    allPoints.forEach(p => {
      let added = false;
      for(let c of clusters) {
        if(L.latLng(p.lat, p.lng).distanceTo(L.latLng(c.lat, c.lng)) < 50) {
          c.points.push(p); 
          c.lat = (c.lat * (c.points.length-1) + p.lat) / c.points.length; 
          c.lng = (c.lng * (c.points.length-1) + p.lng) / c.points.length; 
          added = true; 
          break;
        }
      }
      if(!added) clusters.push({ lat: p.lat, lng: p.lng, points: [p] });
    });
    
    let riskResults = [];
    clusters.forEach(c => {
      let score = 60; 
      if(c.points.length > 1) score += (c.points.length - 1) * 10;
      
      let typeCounts = { 'struct': 0, 'pave': 0, 'env': 0 };
      let maxWeight = 1.0;
      
      c.points.forEach(p => {
        if(/擋土牆|路基|崩塌|護坡/.test(p.type)) { typeCounts.struct++; if(maxWeight < 1.5) maxWeight = 1.5; } 
        else if(/AC|PC|瀝青|混凝土|坑洞|路面/.test(p.type)) { typeCounts.pave++; if(maxWeight < 1.2) maxWeight = 1.2; } 
        else { typeCounts.env++; }
      });
      
      score = Math.min(99, Math.floor(score * maxWeight));
      
      let dominantType = 'pave';
      let maxCount = typeCounts.pave;
      if(typeCounts.struct > maxCount) { dominantType = 'struct'; maxCount = typeCounts.struct; }
      if(typeCounts.env > maxCount) { dominantType = 'env'; maxCount = typeCounts.env; }
      
      if(score >= 70) {
        const level = score > 90 ? 'high' : 'med';
        const advice = dominantType === 'struct' ? "多次發生結構性搶修，建議進行透地雷達檢測或邊坡監測，評估整體重建。" : (dominantType === 'pave' ? "鋪面破損頻率高，可能有排水不良或路基軟弱問題，建議評估刨鋪改善。" : "常有雜草或路樹問題，建議納入定期除草修剪排程。");
        
        // 【修改點】將 score 轉為 String(score) 解決地圖標記無法繪製的錯誤
        const marker = L.marker([c.lat, c.lng], {
          icon: L.divIcon({ className: level === 'high' ? 'ai-pulse-marker' : 'ai-pulse-marker ai-marker-med', html: String(score), iconSize: [24, 24] })
        });
        
        marker.bindPopup(`<div class="ai-report-header"><i class="fas fa-robot"></i> 智慧演算分析報告</div><div class="ai-report-body"><div class="ai-stat-row"><span>風險指數</span> <span class="ai-stat-val">${score}/100</span></div><div class="ai-stat-row"><span>主要成因</span> <span>${dominantType === 'struct' ? '土木結構' : (dominantType === 'pave' ? '路面老化' : '環境植被')} (${c.points.length}次維修)</span></div><div class="ai-advice-box"><b>系統建議：</b><br>${advice}</div></div>`, {className:'custom-popup', maxWidth:300});
        
        aiRiskLayer.addLayer(marker);
        riskResults.push({ score, type: dominantType === 'struct' ? 'road' : 'tree', level, lat: c.lat, lng: c.lng, roadName: `維修熱點 (x${c.points.length})` });
      }
    });
    
    riskResults.sort((a,b) => b.score - a.score);
    document.getElementById('aiResultList').innerHTML = riskResults.length === 0 ? '<div style="padding:10px;text-align:center;color:#666;">經分析歷史數據，目前無顯著高風險熱點。</div>' : riskResults.map(p => `<div class="ai-list-item" data-type="${p.type}" data-level="${p.level}" onclick="zoomToAiMarker(${p.lat}, ${p.lng})"><div><span class="ai-score-badge ${p.level === 'high' ? 'badge-high' : 'badge-med'}">${p.level === 'high' ? '極高' : '中高'}</span> <b>${p.roadName}</b></div><div style="color:#666;">指數 ${p.score}</div></div>`).join('');
    document.getElementById('aiDashboard').style.display = 'block'; 
    document.getElementById('aiLoading').style.display = 'none';
  }, 1000); 
}

window.zoomToAiMarker = function(lat, lng) {
  map.flyTo([lat, lng], 18);
  aiRiskLayer.eachLayer(l => {
    if(Math.abs(l.getLatLng().lat - lat) < 0.000001 && Math.abs(l.getLatLng().lng - lng) < 0.000001) l.openPopup();
  });
};

window.filterAiResults = function(filter, btn) {
  document.querySelectorAll('.ai-list-item').forEach(item => {
    if(filter === 'all' || (filter === 'high' && item.getAttribute('data-level') === 'high') || (filter === 'road' && item.getAttribute('data-type') === 'road') || (filter === 'tree' && item.getAttribute('data-type') === 'tree')) {
      item.style.display = 'flex';
    } else {
      item.style.display = 'none';
    }
  });
  document.querySelectorAll('.ai-filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
};

// === 【V9 修復】修復時間軸與十字路口統計 (降維拆解法，徹底解決 Turf.js 報錯) ===
function showTimeline(routeLayer) {
  const cont = document.getElementById('timelineContainer');
  const filterBar = document.getElementById('timelineFilterBar');
  
  cont.innerHTML = '<div style="padding:20px;">讀取中...</div>'; 
  routeMatchLayer.clearLayers();
  
  const routeFeature = routeLayer.toGeoJSON(); 
  currentRouteAllMatches = [];
  
  REPAIR_CONFIG.forEach(conf => {
    const data = REPAIR_DATA_CACHE[conf.value]; 
    if(!data) return;
    
    data.features.forEach(f => {
      if(f.geometry.type !== 'Point') return;
      const pt = turf.point(f.geometry.coordinates);
      
      try {
        // 【V9 核心修復：降維拆解法】判斷如果是 MultiLineString 就拆成多條 LineString 分別算距離
        let dist = Infinity;
        if (routeFeature.geometry.type === 'LineString') {
            dist = turf.pointToLineDistance(pt, routeFeature, {units: 'meters'});
        } else if (routeFeature.geometry.type === 'MultiLineString') {
            routeFeature.geometry.coordinates.forEach(coords => {
                const singleLine = turf.lineString(coords);
                const d = turf.pointToLineDistance(pt, singleLine, {units: 'meters'});
                if (d < dist) dist = d;
            });
        }
        
        // 方案 2 實作：視覺上只要距離小於 50m 都顯示
        if(dist <= 50) {
          const absoluteClosestDist = distToRoad(L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]), roadsLayer);
          // 如果差距大於 2 公尺，代表它離別條路更近，我們標記為「交叉路口共用案」且不納入金額統計
          const isSharedCrossroad = (dist - absoluteClosestDist) > 2.0;

          currentRouteAllMatches.push({ 
            label: conf.label, 
            props: f.properties, 
            lat: f.geometry.coordinates[1], 
            lng: f.geometry.coordinates[0], 
            dist: dist,
            isSharedCrossroad: isSharedCrossroad
          });
        }
      } catch (err) {
        console.warn('座標計算異常:', err);
      }
    });
  });
  
  filterBar.innerHTML = '<span class="filter-label"><i class="fas fa-filter"></i> 篩選：</span>';
  
  const getUniqueValues = (data, key) => { 
    const set = new Set(); 
    data.forEach(item => { 
      let val = key === 'label' ? item.label : item.props[key]; 
      if(val) set.add(val.toString().trim()); 
    }); 
    return Array.from(set).sort().reverse(); 
  };
  
  const createSelect = (options, placeholder, onChange) => {
    const sel = document.createElement('select'); 
    sel.className = 'timeline-select-pill'; 
    sel.appendChild(new Option(placeholder, 'all'));
    options.forEach(opt => sel.appendChild(new Option(opt, opt))); 
    sel.addEventListener('change', onChange); 
    return sel;
  };
  
  const selYear = createSelect(getUniqueValues(currentRouteAllMatches, 'label'), '年度/案件來源 (全選)', filterData);
  const selTiming = createSelect(getUniqueValues(currentRouteAllMatches, '派工時機'), '派工時機 (全選)', filterData);
  const selType = createSelect(getUniqueValues(currentRouteAllMatches, '搶修類型'), '搶修類型 (全選)', filterData);
  
  filterBar.append(selYear, selTiming, selType);
  
  function filterData() { 
    renderTimeline(currentRouteAllMatches.filter(m => 
      (selYear.value === 'all' || m.label === selYear.value) && 
      (selTiming.value === 'all' || m.props['派工時機'] === selTiming.value) && 
      (selType.value === 'all' || m.props['搶修類型'] === selType.value)
    )); 
  }
  
  renderTimeline(currentRouteAllMatches);
}

function renderTimeline(matches) {
  const cont = document.getElementById('timelineContainer');
  const statsDiv = document.getElementById('timelineStats');
  
  cont.innerHTML = ''; 
  routeMatchLayer.clearLayers(); 
  selectedTimelineMarker = null; 
  lockedTimelineMarker = null;
  
  if(matches.length === 0) { 
    cont.innerHTML = '<div style="padding:20px;">無符合篩選條件的紀錄</div>'; 
    statsDiv.innerHTML = '總花費：<span>$0</span> | 維修：<span>0 次</span>'; 
    return; 
  }
  
  matches.sort((a,b) => String(b.props['完工日期']||'').localeCompare(String(a.props['完工日期']||'')));
  
  let totalCost = 0, genCost = 0, genCount = 0, emgCost = 0, emgCount = 0, processedCases = new Set();
  
  matches.forEach(m => {
    // 方案2：如果是交叉路口，不納入專屬本路段的金額與次數統計
    if (m.isSharedCrossroad) return;

    const caseNo = m.props['案件編號'];
    const money = formatMoney(m.props['決標金額']);
    const isEmergency = /搶修|災害|緊急/.test(String(m.label || ""));
    
    if (!caseNo || (caseNo && !processedCases.has(caseNo))) { 
      if(caseNo) processedCases.add(caseNo); 
      totalCost += money; 
      if(isEmergency) { emgCount++; emgCost += money; } 
      else { genCount++; genCost += money; }
    }
  });
  
  const realCount = genCount + emgCount;
  statsDiv.innerHTML = `<span style="color:#ffeb3b; font-weight:bold;">專屬本路段總計 $${totalCost.toLocaleString()} (${realCount}次)</span> <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> <span style="color:#b3e5fc;">一般 $${genCost.toLocaleString()} (${genCount}次)</span> <span class="stat-divider" style="opacity:0.5; margin:0 5px;">|</span> <span style="color:#ffcdd2;">搶修 $${emgCost.toLocaleString()} (${emgCount}次)</span>`;
  
  matches.forEach(m => {
    const normalStyle = { radius: 14, color: '#fff', fillColor: DEEP_BLUE, weight:1, fillOpacity:0.9 };
    const highlightStyle = { radius: 20, color:'#ffd700', weight:4, fillColor:'#d32f2f' };
    
    const marker = L.circleMarker([m.lat, m.lng], normalStyle).addTo(routeMatchLayer);
    marker.customData = { configLabel: m.label, props: m.props, storeId: generateStoreId(m.props) };
    
    marker.on('click', (e) => handleNearbyMarkerClick(e, routeMatchLayer.getLayers()));
    marker.bindPopup(createPopup({ fileName: m.label, props: m.props, lat: m.lat, lng: m.lng, dist: m.dist }), { className: 'custom-popup', maxWidth: 960 });
    
    const isEmergency = /搶修|災害|緊急/.test(String(m.label || ""));
    const itemDiv = document.createElement('div'); 
    itemDiv.className = `h-item ${isEmergency ? 'alert-right' : ''}`;
    
    // 方案2：顯示從寬，加上(交叉路口)標示
    let badgeHTML = m.props['派工時機'] || (isEmergency ? '搶修' : '一般');
    if (m.isSharedCrossroad) badgeHTML += ` <span style="font-size:9px;opacity:0.8;">(路口)</span>`;

    itemDiv.innerHTML = `
        <div class="h-date">${m.props['完工日期'] || '日期未知'}</div>
        <div class="h-line-container">
            <div class="h-dot ${formatMoney(m.props['決標金額']) > 5000000 ? 'dot-lg' : (formatMoney(m.props['決標金額']) > 1000000 ? 'dot-md' : 'dot-sm')}" style="background:${isEmergency?'#d32f2f':'var(--primary-color)'}; ${m.isSharedCrossroad ? 'opacity:0.5; border-style:dashed;' : ''}"></div>
        </div>
        <div class="h-badge ${isEmergency?'badge-urgent':'badge-normal'}" style="${m.isSharedCrossroad ? 'background:#888;' : ''}">${badgeHTML}</div>
    `;
    
    itemDiv.onmouseenter = () => { 
        if(!lockedTimelineMarker) { 
            if(selectedTimelineMarker && selectedTimelineMarker !== marker) selectedTimelineMarker.setStyle(normalStyle); 
            selectedTimelineMarker = marker; 
            marker.setStyle(highlightStyle); 
            marker.openPopup(); 
        } 
    };
    
    itemDiv.onmouseleave = () => { 
        if(!lockedTimelineMarker) { 
            marker.setStyle(normalStyle); 
            marker.closePopup(); 
            selectedTimelineMarker = null; 
        } 
    };
    
    itemDiv.onclick = () => { 
        if(lockedTimelineMarker && lockedTimelineMarker !== marker) lockedTimelineMarker.setStyle(normalStyle); 
        lockedTimelineMarker = marker; 
        selectedTimelineMarker = marker; 
        marker.setStyle(highlightStyle); 
        map.flyTo([m.lat, m.lng], 18); 
        marker.openPopup(); 
    };
    
    cont.appendChild(itemDiv);
  });
}
</script>
</body>
</html>
